---
title: Kubernetes - kube-proxy
date: 2021-04-01 17:29:11
categories: 
	- [gRPC]
tags:
  - microservices
  - Kubernetes
  - k8s
author: Jony
---


# 背景

`kube-proxy` 是负责 k8s 集群内通信规则创建的组建，k8s 官方文档解释

> Kubernetes 网络代理在每个节点上运行。网络代理反映了每个节点上 Kubernetes API 中定义的服务，
> 并且可以执行简单的 TCP、UDP 和 SCTP 流转发，或者在一组后端进行 循环 TCP、UDP 和 SCTP 转发。

但是 kube-proxy 本身并不负责流量转发等工作。

# 原理

`kube-proxy` 的工作就是 `watch` APIServer 中的 `svc` 和 `endpoint` 的创建。在 `watch` 到
后端有相应的 `svc` 和 `Endpoint`创建之后会在当前节点创建相应的规则，如果当前通信机制使用的是 `iptables`
那么久创建相应的 `iptables rules` 。如果通信组件使用的是 `ipvs` 那么久创建相应的 `ipvs` 规则。
用作流量转发和负载均衡。

关于 ipvs 相关原理参考：[https://xie.infoq.cn/article/89e58c81cd2b1f13a5a847445](https://xie.infoq.cn/article/89e58c81cd2b1f13a5a847445)


`iptables` 原理相对的简单，但是规则比较复杂而且多。将针对性的挑选进行解释。
部署 `yaml` 配置如下：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
```

现在有如下 `svc` 和 `endpoint`：

```bash
$ kubectl get svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
nginx        ClusterIP   10.107.122.198   <none>        80/TCP    9d

$ kubectl get po -o wide
NAME                     READY   STATUS    RESTARTS   AGE   IP                NODE    NOMINATED NODE   READINESS GATES
nginx-6fcfb8df58-mw8js   1/1     Running   0          45h   192.168.236.133   k8s02   <none>           <none>
nginx-6fcfb8df58-qqbbd   1/1     Running   0          45h   192.168.236.136   k8s02   <none>           <none>
```

对应的 `iptables rules`

```bash
# 入口链
Chain PREROUTING (policy ACCEPT)
target         prot     opt     source           destination         
KUBE-SERVICES  all      --    0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
# 出口链
Chain OUTPUT (policy ACCEPT)
target         prot     opt   source              destination         
KUBE-SERVICES  all      --    0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
# Endpoint 规则
Chain KUBE-SEP-UGFJDGWZKFFMLNCL (1 references)
target          prot      opt     source              destination         
KUBE-MARK-MASQ  all       --    192.168.236.133       0.0.0.0/0            /* default/nginx: */
DNAT            tcp       --    0.0.0.0/0             0.0.0.0/0            /* default/nginx: */ tcp to:192.168.236.133:80
# Endpoint 规则
Chain KUBE-SEP-ATB57SP3HHRBIRYE (1 references)
target          prot      opt     source              destination         
KUBE-MARK-MASQ  all       --    192.168.236.136       0.0.0.0/0            /* default/nginx: */
DNAT            tcp       --     0.0.0.0/0            0.0.0.0/0            /* default/nginx: */ tcp to:192.168.236.136:80
# Service 规则
Chain KUBE-SERVICES (2 references)
target                      prot    opt   source              destination     
KUBE-MARK-MASQ              tcp     --    !192.168.0.0/16      10.107.122.198       /* default/nginx: cluster IP */ tcp dpt:80
KUBE-SVC-4N57TFCL4MD7ZTDA   tcp     --    0.0.0.0/0            10.107.122.198       /* default/nginx: cluster IP */ tcp dpt:80
# Service 负载均衡
Chain KUBE-SVC-4N57TFCL4MD7ZTDA (1 references)
target                     prot    opt    source             destination         
KUBE-SEP-UGFJDGWZKFFMLNCL  all      --   0.0.0.0/0            0.0.0.0/0            /* default/nginx: */ statistic mode random probability 0.50000000000
KUBE-SEP-ATB57SP3HHRBIRYE  all      --   0.0.0.0/0            0.0.0.0/0            /* default/nginx: */

```

首先 `iptalbes` 对应的工作流程就是创建一个一个 `chain` 来完成指定的工作。

iptables 命令规则如下：

```bash
iptables [-t table] command [match] [target/jump] 
```
表有: `nat`、`mangle`、`filter`、`raw`

根据 `svc` 和 `Endpoint` 和展示出的 `iptables` 信息。可以参考规则如下：
添加 `root` **Chain**：`KUBE-SERVICES`
命令如下：

```bash
iptables -t nat -N KUBE-SERVICES
```

`KUBE-SERVICES` 是总链，也就是所有 `k8s` 规则链的 `root`。从而也就说明所有出入的流量都需要经过当前 `Chain` 的遍历。

```bash
iptables -t nat  -A PREROUTING -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SERVICES
iptables -t nat  -A OUTPUT -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SERVICES
```

任意协议、任意来源、任意目标，任意流量只要与当前节点接触就会触发跳转 `KUBE-SERVICES` **Chain**。

`KUBE-SERVICES` 主要就是为了与 `k8s` 的 `svc` 想对应。每个 `svc` 需要创建自己的规则 **Chain**。所以首先创建一个 `nginx` **Chain**：

```bash
iptables -t nat -N KUBE-SVC-NGINX
```

除了 `svc` 之外还有 `endpoint` 应为当前 `Endpoint` 对外的地址只限于对外访问，对内并不存在地址，所以还需要添加两个 `Endpoint` 对应的
`iptables` 规则：

```bash
iptables -t nat -N KUBE-SEP-NGINX-1
iptables -t nat -N KUBE-SEP-NGINX-2
```

展示下目前的规则列表：

```bash
iptables -L  -t nat -n 
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain KUBE-SEP-NGINX-1 (0 references)
target     prot opt source               destination         

Chain KUBE-SEP-NGINX-2 (0 references)
target     prot opt source               destination         

Chain KUBE-SERVICES (2 references)
target     prot opt source               destination         

Chain KUBE-SVC-NGINX (0 references)
target     prot opt source               destination 
```

基本差不多成型了，只要在每个 **Chain** 下面添加对应的实例信息即可
`KUBE-SEP-NGINX-1`、`KUBE-SEP-NGINX-2` 监听对应的 `IP` 地址，然后转发到当前 `Node` 的 `Port`。
上方 `Service` 规则如下：
1. 监听 `tcp` 协议
2. 访问 `Service` Port 转发至 `Node` Port
分别添加：

```bash
# DNAT            tcp       --    0.0.0.0/0             0.0.0.0/0   tcp to:192.168.236.133:80

iptables -t nat  -A KUBE-SEP-NGINX-1 -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -j DNAT --to-destination 192.168.236.133:80
iptables -t nat  -A KUBE-SEP-NGINX-2 -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -j DNAT --to-destination 192.168.236.136:80
```

`KUBE-SEP-NGINX-1`、`KUBE-SEP-NGINX-2` 下面都有实例了，下面只要定制在访问 SVC 是重定向到 `KUBE-SEP-NGINX-1`、
`KUBE-SEP-NGINX-2` 即可。

```bash
iptables -t nat  -A KUBE-SVC-NGINX -p all  -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SEP-NGINX-1
iptables -t nat  -A KUBE-SVC-NGINX -p all  -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SEP-NGINX-2
```

`svc` 的规则下面也有实例，但是也没有被添加到 `root` 也就是 `KUBE-SERVICES` 下无法被遍历到，添加命令如下：

```bash
iptables -t nat  -A KUBE-SERVICES -p tcp ! -s 192.168.0.0/16 -d 10.107.122.198 --dport 80 -j KUBE-SVC-NGINX
```

最终规则如下：
```bash
$ iptables -L -n -t nat

```

当然这里还没有结束，还需要添加 Mark 标记
```bash
iptables -t nat -N KUBE-MARK-MASQ
iptables -t nat -A KUBE-MARK-MASQ -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j MARK --or-mark 0x4000
iptables -t nat -A KUBE-SERVICES -p TCP -s 0.0.0.0/0 -d 10.107.122.198 --dport 80 -j KUBE-MARK-MASQ
iptables -t nat -A KUBE-SEP-NGINX-1 -p all -s 192.168.236.133 -j KUBE-MARK-MASQ 
iptables -t nat -A KUBE-SEP-NGINX-2 -p all -s 192.168.236.136 -j KUBE-MARK-MASQ
```


运行结果：

```bash
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain KUBE-MARK-MASQ (3 references)
target     prot opt source               destination         
MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000

Chain KUBE-SEP-NGINX-1 (1 references)
target     prot opt source               destination         
KUBE-MARK-MASQ  all  --  192.168.236.133      0.0.0.0/0           
DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            to:192.168.236.133:80  // 还差 tcp

Chain KUBE-SEP-NGINX-2 (1 references)
target     prot opt source               destination         
KUBE-MARK-MASQ  all  --  192.168.236.136      0.0.0.0/0           
DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            to:192.168.236.136:80  // 还差 tcp

Chain KUBE-SERVICES (2 references)
target     prot opt source               destination         
KUBE-MARK-MASQ  tcp  --  0.0.0.0/0            10.107.122.198       tcp dpt:80
KUBE-SVC-NGINX  tcp  -- !192.168.0.0/16       10.107.122.198       tcp dpt:80

Chain KUBE-SVC-NGINX (1 references)
target     prot opt source               destination         
KUBE-SEP-NGINX-1  all  --  0.0.0.0/0            0.0.0.0/0           
KUBE-SEP-NGINX-2  all  --  0.0.0.0/0            0.0.0.0/0  
```









