<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>负载均衡 katran： BPF 代码解析 [ Benjmmi 的博客 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
<meta name="generator" content="Hexo 8.1.1"></head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/favicon.ico"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">首页</a>
        
          
          
          
          
          
          
          <a href="/archives">归档</a>
        
          
          
          
          
          
          
          <a href="/about">关于</a>
        
          
          
          
          
          
          <a target="_blank" rel="noopener" href="https://github.com/Benjmmi">Codes</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">负载均衡 katran： BPF 代码解析</h1>
<article class="post markdown-style">
  <h1 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h1><ul>
<li>连接维护和删除</li>
<li>流量转发，ip-in-ip 模式</li>
<li>MAP 读写和配置</li>
</ul>
<p><strong>主要解析文件：<a target="_blank" rel="noopener" href="https://github.com/facebookincubator/katran/blob/master/katran/lib/bpf/balancer_kern.c">balancer_kern.c</a></strong></p>
<h1 id="XDP-复习"><a href="#XDP-复习" class="headerlink" title="XDP 复习"></a>XDP 复习</h1><h2 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h2><ul>
<li>Native XDP：最长使用的工作模式，在网络驱动的早期接受路径上。10G 或更高速的网卡基本都支持</li>
<li>Offloaded XDP：XDP 直接工作 offload 到网卡，类似工作 DPDK </li>
<li>Generic XDP： 在不支持 native 和 offload 的情况下，由内核提供 generic XDP 选项。工作<br>在网络协议栈的很后面，经常用于开发和测试</li>
</ul>
<h2 id="触发点"><a href="#触发点" class="headerlink" title="触发点"></a>触发点</h2><p>内核由两个触发点，分别作用于 ingress 和 egress。XDP 只能作用于 ingress 触发点：</p>
<ul>
<li>ingress 触发点：<code>sch_handle_ingress()</code>：由 <code>__netif_receive_skb_core()</code> 触发</li>
<li>egress 触发点：<code>sch_handle_egress()</code>：由 <code>_dev_queue_xmit</code> 触发。</li>
</ul>
<h2 id="返回码"><a href="#返回码" class="headerlink" title="返回码"></a>返回码</h2><p>执行 XDP 程序后返回一个结果，用于接下来的数据处理。</p>
<ul>
<li><code>XDP_DROP</code>: 表示无条件丢弃包</li>
<li><code>XDP_PASS</code>: 表示包可以接收将送入网络协议栈。当前函数会分配一个 skb，然后送到 <code>GRO</code> 引擎</li>
<li><code>XDP_TX</code>: 收到包的网卡直接将包在发送出去。多用于 <code>防火墙</code> + <code>负载均衡</code> 程序，过程中可以<br>重写包，支持发卡模式，从哪个设备进来从哪出去</li>
<li><code>XDP_REDIRECT</code>：与 <code>XDP_TX</code> 类似，通过另一个网卡发出去。还支持重定向到另一个 CPU 处理<br>网络协议包</li>
<li><code>XDP_ABORTED</code>: 表示程序异常，</li>
</ul>
<h1 id="katran-BPF-程序分析"><a href="#katran-BPF-程序分析" class="headerlink" title="katran BPF 程序分析"></a>katran BPF 程序分析</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;xdp-balancer&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">balancer_ingress</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span> &#123;</span><br><span class="line">  <span class="type">void</span> *data = (<span class="type">void</span> *)(<span class="type">long</span>)ctx-&gt;data; <span class="comment">//  数据开始位置</span></span><br><span class="line">  <span class="type">void</span> *data_end = (<span class="type">void</span> *)(<span class="type">long</span>)ctx-&gt;data_end; <span class="comment">// 数据结束位置</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> =</span> data;</span><br><span class="line">  __u32 eth_proto;</span><br><span class="line">  __u32 nh_off;</span><br><span class="line">  nh_off = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data + nh_off &gt; data_end) &#123;</span><br><span class="line">    <span class="comment">// 数据不完整</span></span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  eth_proto = eth-&gt;h_proto;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (eth_proto == BE_ETH_P_IP) &#123;</span><br><span class="line">    <span class="comment">// 处理 IPv4 数据包</span></span><br><span class="line">    <span class="keyword">return</span> process_packet(data, nh_off, data_end, <span class="literal">false</span>, ctx);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eth_proto == BE_ETH_P_IPV6) &#123;</span><br><span class="line">    <span class="comment">// 处理 IPv5 数据包</span></span><br><span class="line">    <span class="keyword">return</span> process_packet(data, nh_off, data_end, <span class="literal">true</span>, ctx);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 直接送入网络协议栈</span></span><br><span class="line">    <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">process_packet</span><span class="params">(<span class="type">void</span> *data, __u64 off, <span class="type">void</span> *data_end,</span></span><br><span class="line"><span class="params">                                 <span class="type">bool</span> is_ipv6, <span class="keyword">struct</span> xdp_md *xdp)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ctl_value</span> *<span class="title">cval</span>;</span> <span class="comment">// ctl数组的值，可以包含例如默认路由器的mac地址或其他标志。</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">real_definition</span> *<span class="title">dst</span> =</span> <span class="literal">NULL</span>; <span class="comment">// 在ch环中查找客户端数据包</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">packet_description</span> <span class="title">pckt</span> =</span> &#123;&#125;; <span class="comment">// 客户的包元数据</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vip_definition</span> <span class="title">vip</span> =</span> &#123;&#125;; <span class="comment">// vip定义查找</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vip_meta</span> *<span class="title">vip_info</span>;</span> <span class="comment">// vip的查找结果</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">lb_stats</span> *<span class="title">data_stats</span>;</span> <span class="comment">// 每个VIP统计</span></span><br><span class="line">  __u64 iph_len;</span><br><span class="line">  __u8 protocol;</span><br><span class="line">  __u16 original_sport;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> action;</span><br><span class="line">  __u32 vip_num;</span><br><span class="line">  __u32 mac_addr_pos = <span class="number">0</span>;</span><br><span class="line">  __u16 pkt_bytes;</span><br><span class="line">  <span class="comment">// 处理 l3 协议头</span></span><br><span class="line">  action = process_l3_headers(</span><br><span class="line">    &amp;pckt, &amp;protocol, off, &amp;pkt_bytes, data, data_end, is_ipv6);</span><br><span class="line">  <span class="comment">// 如果对其有 XDP 处理结果</span></span><br><span class="line">  <span class="keyword">if</span> (action &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> action;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 数据流协议。指向 L4 协议内容</span></span><br><span class="line">  protocol = pckt.flow.proto;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> INLINE_DECAP_IPIP <span class="comment">// 允许在XDP上下文中进行内联ipip解封装</span></span></span><br><span class="line">  <span class="comment">/* This is to workaround a verifier issue for 5.2.</span></span><br><span class="line"><span class="comment">   * The reason is that 5.2 verifier does not handle register</span></span><br><span class="line"><span class="comment">   * copy states properly while 5.6 handles properly.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * For the following source code:</span></span><br><span class="line"><span class="comment">   *   if (protocol == IPPROTO_IPIP || protocol == IPPROTO_IPV6) &#123;</span></span><br><span class="line"><span class="comment">   *     ...</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * llvm12 may generate the following simplified code sequence</span></span><br><span class="line"><span class="comment">   *   100  r5 = *(u8 *)(r9 +51)  // r5 is the protocol</span></span><br><span class="line"><span class="comment">   *   120  r4 = r5</span></span><br><span class="line"><span class="comment">   *   121  if r4 s&gt; 0x10 goto target1</span></span><br><span class="line"><span class="comment">   *   122  *(u64 *)(r10 -184) = r5</span></span><br><span class="line"><span class="comment">   *   123  if r4 == 0x4 goto target2</span></span><br><span class="line"><span class="comment">   *   ...</span></span><br><span class="line"><span class="comment">   *   target2:</span></span><br><span class="line"><span class="comment">   *   150  r1 = *(u64 *)(r10 -184)</span></span><br><span class="line"><span class="comment">   *   151  if (r1 != 4) &#123; __unreachable__&#125;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * For the path 123-&gt;150-&gt;151, 5.6 correctly noticed</span></span><br><span class="line"><span class="comment">   * at insn 150: r4, r5, *(u64 *)(r10 -184) all have value 4.</span></span><br><span class="line"><span class="comment">   * while 5.2 has *(u64 *)(r10 -184) holding &quot;r5&quot; which could be</span></span><br><span class="line"><span class="comment">   * any value 0-255. In 5.2, &quot;__unreachable&quot; code is verified</span></span><br><span class="line"><span class="comment">   * and it caused verifier failure.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (protocol == IPPROTO_IPIP) &#123;</span><br><span class="line">    <span class="type">bool</span> pass = <span class="literal">true</span>;</span><br><span class="line">    action = check_decap_dst(&amp;pckt, is_ipv6, &amp;pass);</span><br><span class="line">    <span class="keyword">if</span> (action &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> action;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> process_encaped_ipip_pckt(</span><br><span class="line">        &amp;data, &amp;data_end, xdp, &amp;is_ipv6, &amp;protocol, pass);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol == IPPROTO_IPV6) &#123;</span><br><span class="line">    <span class="type">bool</span> pass = <span class="literal">true</span>;</span><br><span class="line">    action = check_decap_dst(&amp;pckt, is_ipv6, &amp;pass);</span><br><span class="line">    <span class="keyword">if</span> (action &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> action;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> process_encaped_ipip_pckt(</span><br><span class="line">        &amp;data, &amp;data_end, xdp, &amp;is_ipv6, &amp;protocol, pass);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// INLINE_DECAP_IPIP</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转化协议包至数据结构</span></span><br><span class="line">  <span class="keyword">if</span> (protocol == IPPROTO_TCP) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!parse_tcp(data, data_end, is_ipv6, &amp;pckt)) &#123;</span><br><span class="line">      <span class="comment">// 转换成 TCP 结构失败</span></span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol == IPPROTO_UDP) &#123;</span><br><span class="line">    <span class="comment">// 转成 UDP 结构失败</span></span><br><span class="line">    <span class="keyword">if</span> (!parse_udp(data, data_end, is_ipv6, &amp;pckt)) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> INLINE_DECAP_GUE</span></span><br><span class="line">    <span class="keyword">if</span> (pckt.flow.port16[<span class="number">1</span>] == bpf_htons(GUE_DPORT)) &#123;</span><br><span class="line">      <span class="type">bool</span> pass = <span class="literal">true</span>;</span><br><span class="line">      action = check_decap_dst(&amp;pckt, is_ipv6, &amp;pass);</span><br><span class="line">      <span class="keyword">if</span> (action &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> process_encaped_gue_pckt(&amp;data, &amp;data_end, xdp, is_ipv6, pass);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span> <span class="comment">// of INLINE_DECAP_GUE</span></span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// send to tcp/ip stack</span></span><br><span class="line">    <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 已经转换成 4 层协议结构</span></span><br><span class="line">  <span class="comment">// 获取目标 VIP ，需要根据协议内容判断是否是 IPv6</span></span><br><span class="line">  <span class="keyword">if</span> (is_ipv6) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(vip.vipv6, pckt.flow.dstv6, <span class="number">16</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 获取 VIP </span></span><br><span class="line">    vip.vip = pckt.flow.dst;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 端口协议</span></span><br><span class="line">  vip.port = pckt.flow.port16[<span class="number">1</span>];</span><br><span class="line">  vip.proto = pckt.flow.proto;</span><br><span class="line">  <span class="comment">// 查找 VIP 后面的 Real IP</span></span><br><span class="line">  vip_info = bpf_map_lookup_elem(&amp;vip_map, &amp;vip);</span><br><span class="line">  <span class="keyword">if</span> (!vip_info) &#123;</span><br><span class="line">    <span class="comment">// Real IP 不存在</span></span><br><span class="line">    vip.port = <span class="number">0</span>; <span class="comment">// 这步的目的因为 DR 模式忽略了端口号</span></span><br><span class="line">    vip_info = bpf_map_lookup_elem(&amp;vip_map, &amp;vip);</span><br><span class="line">    <span class="keyword">if</span> (!vip_info) &#123;</span><br><span class="line">      <span class="comment">// 如果还没有找到就送到上传协议栈处理</span></span><br><span class="line">      <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果只使用DST端口进行哈希计算</span></span><br><span class="line">    <span class="keyword">if</span> (!(vip_info-&gt;flags &amp; F_HASH_DPORT_ONLY)) &#123;</span><br><span class="line">      <span class="comment">// VIP, which doesnt care about dst port (all packets to this VIP w/ diff</span></span><br><span class="line">      <span class="comment">// dst port but from the same src port/ip must go to the same real</span></span><br><span class="line">      <span class="comment">// VIP，它不关心dst端口（所有到这个VIP的数据包都有不同的dst端口，但来自同一个src端口/ip的数据包必须转到同一个real</span></span><br><span class="line">      pckt.flow.port16[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 超出最大数据包承载量</span></span><br><span class="line">  <span class="comment">// 如果定义了可以使用 ICMP 处理，那么就会返回 ICMP 处理结果</span></span><br><span class="line">  <span class="keyword">if</span> (data_end - data &gt; MAX_PCKT_SIZE) &#123;</span><br><span class="line">    REPORT_PACKET_TOOBIG(xdp, data, data_end - data, <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ICMP_TOOBIG_GENERATION</span></span><br><span class="line">    __u32 stats_key = MAX_VIPS + ICMP_TOOBIG_CNTRS;</span><br><span class="line">    data_stats = bpf_map_lookup_elem(&amp;stats, &amp;stats_key);</span><br><span class="line">    <span class="keyword">if</span> (!data_stats) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 啥意思</span></span><br><span class="line">    <span class="keyword">if</span> (is_ipv6) &#123;</span><br><span class="line">      data_stats-&gt;v2 += <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      data_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> send_icmp_too_big(xdp, is_ipv6, data_end - data);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __u32 stats_key = MAX_VIPS + LRU_CNTRS;  <span class="comment">// 512 + 0 ? lru缓存命中相关计数器的偏移量</span></span><br><span class="line">  <span class="comment">// 查找每个 VIP 的数据统计 , v1 v2 指的是什么意思？</span></span><br><span class="line">  data_stats = bpf_map_lookup_elem(&amp;stats, &amp;stats_key);</span><br><span class="line">  <span class="keyword">if</span> (!data_stats) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// total packets // 总的处理的数据包数量</span></span><br><span class="line">  data_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Lookup dst based on id in packet QUIC 负载均衡</span></span><br><span class="line">  <span class="keyword">if</span> ((vip_info-&gt;flags &amp; F_QUIC_VIP)) &#123;</span><br><span class="line">    __u32 quic_stats_key = MAX_VIPS + QUIC_ROUTE_STATS;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lb_stats</span>* <span class="title">quic_stats</span> =</span> bpf_map_lookup_elem(&amp;stats, &amp;quic_stats_key);</span><br><span class="line">    <span class="keyword">if</span> (!quic_stats) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> real_index;</span><br><span class="line">    real_index = parse_quic(data, data_end, is_ipv6, &amp;pckt);</span><br><span class="line">    <span class="keyword">if</span> (real_index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      increment_quic_cid_version_stats(real_index);</span><br><span class="line">      __u32 key = real_index;</span><br><span class="line">      __u32 *real_pos = bpf_map_lookup_elem(&amp;server_id_map, &amp;key);</span><br><span class="line">      <span class="keyword">if</span> (real_pos) &#123;</span><br><span class="line">        key = *real_pos;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="number">0</span>) &#123;</span><br><span class="line">          increment_quic_cid_drop_real_0();</span><br><span class="line">          <span class="comment">// increment counter for the CH based routing</span></span><br><span class="line">          quic_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          pckt.real_index = key;</span><br><span class="line">          dst = bpf_map_lookup_elem(&amp;reals, &amp;key);</span><br><span class="line">          <span class="keyword">if</span> (!dst) &#123;</span><br><span class="line">            increment_quic_cid_drop_no_real();</span><br><span class="line">            REPORT_QUIC_PACKET_DROP_NO_REAL(xdp, data, data_end - data, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">          &#125;</span><br><span class="line">          quic_stats-&gt;v2 += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// increment counter for the CH based routing</span></span><br><span class="line">        quic_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      quic_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// save the original sport before making real selection, possibly changing its value.</span></span><br><span class="line">  <span class="comment">// 在做出真正的选择之前，保存原来的旧值，可能会改变它的价值。</span></span><br><span class="line">  original_sport = pckt.flow.port16[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dst) &#123;</span><br><span class="line">    <span class="comment">// 使用quic的连接处理</span></span><br><span class="line">    <span class="keyword">if</span> ((vip_info-&gt;flags &amp; F_HASH_NO_SRC_PORT)) &#123;</span><br><span class="line">      <span class="comment">// service, where diff src port, but same ip must go to the same real,</span></span><br><span class="line">      <span class="comment">// e.g. gfs</span></span><br><span class="line">      pckt.flow.port16[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    __u32 cpu_num = bpf_get_smp_processor_id();</span><br><span class="line">    <span class="type">void</span> *lru_map = bpf_map_lookup_elem(&amp;lru_mapping, &amp;cpu_num);</span><br><span class="line">    <span class="keyword">if</span> (!lru_map) &#123;</span><br><span class="line">      lru_map = &amp;fallback_cache;</span><br><span class="line">      __u32 lru_stats_key = MAX_VIPS + FALLBACK_LRU_CNTR;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">lb_stats</span> *<span class="title">lru_stats</span> =</span> bpf_map_lookup_elem(&amp;stats, &amp;lru_stats_key);</span><br><span class="line">      <span class="keyword">if</span> (!lru_stats) &#123;</span><br><span class="line">        <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// We were not able to retrieve per cpu/core lru and falling back to</span></span><br><span class="line">      <span class="comment">// default one. This counter should never be anything except 0 in prod.</span></span><br><span class="line">      <span class="comment">// We are going to use it for monitoring.</span></span><br><span class="line">      lru_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TCP_SERVER_ID_ROUTING</span></span><br><span class="line">    <span class="comment">// First try to lookup dst in the tcp_hdr_opt (if enabled)</span></span><br><span class="line">    <span class="keyword">if</span> (pckt.flow.proto == IPPROTO_TCP &amp;&amp; !(pckt.flags &amp; F_SYN_SET)) &#123;</span><br><span class="line">      __u32 routing_stats_key = MAX_VIPS + TCP_SERVER_ID_ROUTE_STATS;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">lb_stats</span>* <span class="title">routing_stats</span> =</span></span><br><span class="line">          bpf_map_lookup_elem(&amp;stats, &amp;routing_stats_key);</span><br><span class="line">      <span class="keyword">if</span> (!routing_stats) &#123;</span><br><span class="line">        <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (tcp_hdr_opt_lookup(</span><br><span class="line">              data,</span><br><span class="line">              data_end,</span><br><span class="line">              is_ipv6,</span><br><span class="line">              &amp;dst,</span><br><span class="line">              &amp;pckt,</span><br><span class="line">              vip_info-&gt;flags &amp; F_LRU_BYPASS,</span><br><span class="line">              lru_map) == FURTHER_PROCESSING) &#123;</span><br><span class="line">        routing_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        routing_stats-&gt;v2 += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// TCP_SERVER_ID_ROUTING</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, try to lookup dst in the lru_cache</span></span><br><span class="line">    <span class="keyword">if</span> (!dst &amp;&amp; !(pckt.flags &amp; F_SYN_SET) &amp;&amp;</span><br><span class="line">        !(vip_info-&gt;flags &amp; F_LRU_BYPASS)) &#123;</span><br><span class="line">      <span class="comment">// 连接表，查找</span></span><br><span class="line">      connection_table_lookup(&amp;dst, &amp;pckt, lru_map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if dst is not found, route via consistent-hashing of the flow.</span></span><br><span class="line">    <span class="keyword">if</span> (!dst) &#123;</span><br><span class="line">      <span class="keyword">if</span> (pckt.flow.proto == IPPROTO_TCP) &#123;</span><br><span class="line">        __u32 lru_stats_key = MAX_VIPS + LRU_MISS_CNTR;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">lb_stats</span> *<span class="title">lru_stats</span> =</span> bpf_map_lookup_elem(</span><br><span class="line">          &amp;stats, &amp;lru_stats_key);</span><br><span class="line">        <span class="keyword">if</span> (!lru_stats) &#123;</span><br><span class="line">          <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pckt.flags &amp; F_SYN_SET) &#123;</span><br><span class="line">          <span class="comment">// miss because of new tcp session</span></span><br><span class="line">          lru_stats-&gt;v1 += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// miss of non-syn tcp packet. could be either because of LRU trashing</span></span><br><span class="line">          <span class="comment">// or because another katran is restarting and all the sessions</span></span><br><span class="line">          <span class="comment">// have been reshuffled</span></span><br><span class="line">          REPORT_TCP_NONSYN_LRUMISS(xdp, data, data_end - data, <span class="literal">false</span>);</span><br><span class="line">          lru_stats-&gt;v2 += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(!get_packet_dst(&amp;dst, &amp;pckt, vip_info, is_ipv6, lru_map)) &#123;</span><br><span class="line">        <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// lru misses (either new connection or lru is full and starts to trash)</span></span><br><span class="line">      data_stats-&gt;v2 += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 默认第 0 ifindex</span></span><br><span class="line">  cval = bpf_map_lookup_elem(&amp;ctl_array, &amp;mac_addr_pos);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!cval) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// vip 序列号</span></span><br><span class="line">  vip_num = vip_info-&gt;vip_num;</span><br><span class="line">  data_stats = bpf_map_lookup_elem(&amp;stats, &amp;vip_num);</span><br><span class="line">  <span class="keyword">if</span> (!data_stats) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line">  data_stats-&gt;v1 += <span class="number">1</span>; <span class="comment">// 包数量</span></span><br><span class="line">  data_stats-&gt;v2 += pkt_bytes; <span class="comment">// 包大小</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// per real statistics</span></span><br><span class="line">  <span class="comment">// 每个 Real IP 统计</span></span><br><span class="line">  data_stats = bpf_map_lookup_elem(&amp;reals_stats, &amp;pckt.real_index);</span><br><span class="line">  <span class="keyword">if</span> (!data_stats) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line">  data_stats-&gt;v1 += <span class="number">1</span>; <span class="comment">// 包数量</span></span><br><span class="line">  data_stats-&gt;v2 += pkt_bytes; <span class="comment">// 包大小</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LOCAL_DELIVERY_OPTIMIZATION</span></span><br><span class="line">  <span class="keyword">if</span> ((vip_info-&gt;flags &amp; F_LOCAL_VIP) &amp;&amp; (dst-&gt;flags &amp; F_LOCAL_REAL)) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="comment">// restore the original sport value to use it as a seed for the GUE sport</span></span><br><span class="line">  <span class="comment">// 恢复旧值，作为 GUE 的替换</span></span><br><span class="line">  pckt.flow.port16[<span class="number">0</span>] = original_sport;</span><br><span class="line">  <span class="comment">// 修改为目标 mac </span></span><br><span class="line">  <span class="comment">// 重新计算校验和</span></span><br><span class="line">  <span class="keyword">if</span> (dst-&gt;flags &amp; F_IPV6) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!PCKT_ENCAP_V6(xdp, cval, is_ipv6, &amp;pckt, dst, pkt_bytes)) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!PCKT_ENCAP_V4(xdp, cval, &amp;pckt, dst, pkt_bytes)) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> XDP_TX;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="../../../08/core/network/2021-09-08-network7/">上一篇</a>
    

    
    <p>上次更新 2024-08-26</p>
    
    
        <a class="extend next post-next" href="../2021-09-04-katran0/">下一篇</a>
    
    </div>


    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:2228598786@qq.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/Benjmmi" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © Benjmmi 2017 - 2025
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>

  <script src='https://unpkg.com/mermaid@11.12.1/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>
    </div>
</body>
</html>
