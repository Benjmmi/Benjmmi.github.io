<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>katran ebpf 源码阅读 1 [ Benjmmi 的博客 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
<meta name="generator" content="Hexo 8.1.1"></head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/favicon.ico"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">首页</a>
        
          
          
          
          
          
          
          <a href="/archives">归档</a>
        
          
          
          
          
          
          
          <a href="/about">关于</a>
        
          
          
          
          
          
          <a target="_blank" rel="noopener" href="https://github.com/Benjmmi">Codes</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">katran ebpf 源码阅读 1</h1>
<article class="post markdown-style">
  <p>katran 是优秀 L4 负载均衡器，由 Facebook 开源出来的，在研究 ebpf 的同时，一起研究下其实现方式：<br>基础的 ebpf 中的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 浏览元数据，应该存储的是 4 元组数据信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flow_key</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __be32 src; <span class="comment">// 来源地址</span></span><br><span class="line">    __be32 srcv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __be32 dst;<span class="comment">//目标地址</span></span><br><span class="line">    __be32 dstv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __u32 ports; <span class="comment">// 端口号，具体是来源的还是目标的往下看</span></span><br><span class="line">    __u16 port16[<span class="number">2</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  __u8 proto; <span class="comment">// 协议</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端包的描述结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_description</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">flow_key</span> <span class="title">flow</span>;</span> <span class="comment">// 基础的流信息</span></span><br><span class="line">  __u32 real_index; <span class="comment">// 真实的网卡</span></span><br><span class="line">  __u8 flags; <span class="comment">// 什么标记??</span></span><br><span class="line">  <span class="comment">// dscp / ToS value in client&#x27;s packet</span></span><br><span class="line">  __u8 tos; <span class="comment">// TOS </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tl 数组的值，可以包含例如 默认路由器的mac地址或其他标志</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ctl_value</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __u64 value;</span><br><span class="line">    __u32 ifindex;</span><br><span class="line">    __u8 mac[<span class="number">6</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vip 的定义，用于查找</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vip_definition</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span> <span class="comment">// 虚拟 IP </span></span><br><span class="line">    __be32 vip;</span><br><span class="line">    __be32 vipv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  __u16 port; <span class="comment">// 虚拟 IP 端口</span></span><br><span class="line">  __u8 proto; <span class="comment">// 虚拟IP支持的协议</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VIP  查找结果</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vip_meta</span> &#123;</span></span><br><span class="line">  __u32 flags; <span class="comment">// </span></span><br><span class="line">  __u32 vip_num; <span class="comment">//VIP 的数量？？</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 LRU_MAP 发送客户端数据包的位置</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">real_pos_lru</span> &#123;</span></span><br><span class="line">  __u32 pos;</span><br><span class="line">  __u64 atime;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 ch ring 中的查找中将客户端的数据包发送到哪里。</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">real_definition</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span> <span class="comment">//</span></span><br><span class="line">    __be32 dst;</span><br><span class="line">    __be32 dstv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  __u8 flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每vip统计</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lb_stats</span> &#123;</span></span><br><span class="line">  __u64 v1;</span><br><span class="line">  __u64 v2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于 ipv4 lpm 查找的密钥</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4_lpm_key</span> &#123;</span></span><br><span class="line">  __u32 prefixlen;</span><br><span class="line">  __be32 addr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于 ipv6 lpm 查找的密钥</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v6_lpm_key</span> &#123;</span></span><br><span class="line">  __u32 prefixlen;</span><br><span class="line">  __be32 addr[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 地址</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __be32 addr;</span><br><span class="line">    __be32 addrv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关于数据包的元数据，通过事件管道复制到用户空间</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_metadata</span> &#123;</span></span><br><span class="line">  __u32 event;</span><br><span class="line">  __u32 pkt_size;</span><br><span class="line">  __u32 data_len;</span><br><span class="line">&#125; __attribute__((__packed__));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GUE报文保存的路由信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flow_debug_info</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __be32 l4_hop;</span><br><span class="line">    __be32 l4_hopv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    __be32 this_hop;</span><br><span class="line">    __be32 this_hopv6[<span class="number">4</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>虽然上面的数据结构给出了结构定义，但是并没给出如何关联起来。所以如何关联起来应该使用了  MAP 查找</p>
<p>看下 MAP 结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// map，其中包含我们正在为其进行负载平衡的所有vip</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_HASH);</span><br><span class="line">  __type(key, <span class="keyword">struct</span> vip_definition);</span><br><span class="line">  __type(value, <span class="keyword">struct</span> vip_meta);</span><br><span class="line">  __uint(max_entries, MAX_VIPS);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; vip_map <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>所有的 VIP 定义都存在这个HASH 中</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包含 cpu 核心到 lru 映射的映射</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_ARRAY_OF_MAPS);</span><br><span class="line">  __uint(key_size, <span class="keyword">sizeof</span>(__u32));</span><br><span class="line">  __uint(value_size, <span class="keyword">sizeof</span>(__u32));</span><br><span class="line">  __uint(max_entries, MAX_SUPPORTED_CPUS);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; lru_mapping <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>为了提高查询速度，为每个 CPU 单独设置了一个 MAP，这样的情况下就避免了多CPU 获取锁的问题</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 备份 lru。 用户单元测试</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_LRU_HASH);</span><br><span class="line">  __type(key, <span class="keyword">struct</span> flow_key);</span><br><span class="line">  __type(value, <span class="keyword">struct</span> real_pos_lru);</span><br><span class="line">  __uint(max_entries, DEFAULT_LRU_SIZE);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; fallback_cache <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包含所有 vip 到真实映射的映射</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_ARRAY);</span><br><span class="line">  __type(key, __u32);</span><br><span class="line">  __type(value, __u32);</span><br><span class="line">  __uint(max_entries, CH_RINGS_SIZE);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; ch_rings <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里map 映射了 vip-realip 。通过指针的方式进行了存储。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包含不透明真实的 id 到真实映射的映射</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_ARRAY);</span><br><span class="line">  __type(key, __u32);</span><br><span class="line">  __type(value, <span class="keyword">struct</span> real_definition);</span><br><span class="line">  __uint(max_entries, MAX_REALS);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; reals <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 映射每个真实的 pps/bps 统计数据</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);</span><br><span class="line">  __type(key, __u32);</span><br><span class="line">  __type(value, <span class="keyword">struct</span> lb_stats);</span><br><span class="line">  __uint(max_entries, MAX_REALS);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; reals_stats <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 带有每个VIP统计数据的地图</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);</span><br><span class="line">  __type(key, __u32);</span><br><span class="line">  __type(value, <span class="keyword">struct</span> lb_stats);</span><br><span class="line">  __uint(max_entries, STATS_MAP_SIZE);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; stats <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将服务器 ID 映射到真实的 ID 映射。 id 可以嵌入到 QUIC 或 </span></span><br><span class="line"><span class="comment">// TCP（如果启用）数据包的标头中，用于路由现有流的数据包</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_ARRAY);</span><br><span class="line">  __type(key, __u32);</span><br><span class="line">  __type(value, __u32);</span><br><span class="line">  __uint(max_entries, MAX_QUIC_REALS);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; server_id_map <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于最长匹配查找，查找出对应的 VIP</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_LPM_TRIE);</span><br><span class="line">  __type(key, <span class="keyword">struct</span> v4_lpm_key);</span><br><span class="line">  __type(value, __u32);</span><br><span class="line">  __uint(max_entries, MAX_LPM_SRC);</span><br><span class="line">  __uint(map_flags, BPF_F_NO_PREALLOC);</span><br><span class="line">&#125; lpm_src_v4 <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_LPM_TRIE);</span><br><span class="line">  __type(key, <span class="keyword">struct</span> v6_lpm_key);</span><br><span class="line">  __type(value, __u32);</span><br><span class="line">  __uint(max_entries, MAX_LPM_SRC);</span><br><span class="line">  __uint(map_flags, BPF_F_NO_PREALLOC);</span><br><span class="line">&#125; lpm_src_v6 <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局LRU ，支持 per CPU 的并发查找</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_ARRAY_OF_MAPS);</span><br><span class="line">  __uint(key_size, <span class="keyword">sizeof</span>(__u32));</span><br><span class="line">  __uint(value_size, <span class="keyword">sizeof</span>(__u32));</span><br><span class="line">  __uint(max_entries, MAX_SUPPORTED_CPUS);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; global_lru_maps <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __uint(type, BPF_MAP_TYPE_LRU_HASH);</span><br><span class="line">  __type(key, <span class="keyword">struct</span> flow_key);</span><br><span class="line">  __type(value, __u32);</span><br><span class="line">  __uint(max_entries, DEFAULT_GLOBAL_LRU_SIZE);</span><br><span class="line">  __uint(map_flags, NO_FLAGS);</span><br><span class="line">&#125; fallback_glru <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br></pre></td></tr></table></figure>
</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="../2021-04-01-benchmarks_katran/">上一篇</a>
    

    
    <p>上次更新 2024-08-26</p>
    
    
        <a class="extend next post-next" href="../../microservices/2021-04-01-miscro1/">下一篇</a>
    
    </div>


    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:2228598786@qq.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/Benjmmi" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © Benjmmi 2017 - 2025
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>

  <script src='https://unpkg.com/mermaid@11.12.1/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>
    </div>
</body>
</html>
