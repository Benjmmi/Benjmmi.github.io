<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>Kubernetes - kube-proxy [ Benjmmi 的博客 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
<meta name="generator" content="Hexo 8.1.1"></head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/favicon.ico"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">首页</a>
        
          
          
          
          
          
          
          <a href="/archives">归档</a>
        
          
          
          
          
          
          
          <a href="/about">关于</a>
        
          
          
          
          
          
          <a target="_blank" rel="noopener" href="https://github.com/Benjmmi">Codes</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">Kubernetes - kube-proxy</h1>
<article class="post markdown-style">
  <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p><code>kube-proxy</code> 是负责 k8s 集群内通信规则创建的组建，k8s 官方文档解释</p>
<blockquote>
<p>Kubernetes 网络代理在每个节点上运行。网络代理反映了每个节点上 Kubernetes API 中定义的服务，<br>并且可以执行简单的 TCP、UDP 和 SCTP 流转发，或者在一组后端进行 循环 TCP、UDP 和 SCTP 转发。</p>
</blockquote>
<p>但是 kube-proxy 本身并不负责流量转发等工作。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p><code>kube-proxy</code> 的工作就是 <code>watch</code> APIServer 中的 <code>svc</code> 和 <code>endpoint</code> 的创建。在 <code>watch</code> 到<br>后端有相应的 <code>svc</code> 和 <code>Endpoint</code>创建之后会在当前节点创建相应的规则，如果当前通信机制使用的是 <code>iptables</code><br>那么久创建相应的 <code>iptables rules</code> 。如果通信组件使用的是 <code>ipvs</code> 那么久创建相应的 <code>ipvs</code> 规则。<br>用作流量转发和负载均衡。</p>
<p>关于 ipvs 相关原理参考：<a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/89e58c81cd2b1f13a5a847445">https://xie.infoq.cn/article/89e58c81cd2b1f13a5a847445</a></p>
<p><code>iptables</code> 原理相对的简单，但是规则比较复杂而且多。将针对性的挑选进行解释。<br>部署 <code>yaml</code> 配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>现在有如下 <code>svc</code> 和 <code>endpoint</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx        ClusterIP   10.107.122.198   &lt;none&gt;        80/TCP    9d</span><br><span class="line"></span><br><span class="line">$ kubectl get po -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP                NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-6fcfb8df58-mw8js   1/1     Running   0          45h   192.168.236.133   k8s02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6fcfb8df58-qqbbd   1/1     Running   0          45h   192.168.236.136   k8s02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>对应的 <code>iptables rules</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 入口链</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target         prot     opt     <span class="built_in">source</span>           destination         </span><br><span class="line">KUBE-SERVICES  all      --    0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class="line"><span class="comment"># 出口链</span></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target         prot     opt   <span class="built_in">source</span>              destination         </span><br><span class="line">KUBE-SERVICES  all      --    0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class="line"><span class="comment"># Endpoint 规则</span></span><br><span class="line">Chain KUBE-SEP-UGFJDGWZKFFMLNCL (1 references)</span><br><span class="line">target          prot      opt     <span class="built_in">source</span>              destination         </span><br><span class="line">KUBE-MARK-MASQ  all       --    192.168.236.133       0.0.0.0/0            /* default/nginx: */</span><br><span class="line">DNAT            tcp       --    0.0.0.0/0             0.0.0.0/0            /* default/nginx: */ tcp to:192.168.236.133:80</span><br><span class="line"><span class="comment"># Endpoint 规则</span></span><br><span class="line">Chain KUBE-SEP-ATB57SP3HHRBIRYE (1 references)</span><br><span class="line">target          prot      opt     <span class="built_in">source</span>              destination         </span><br><span class="line">KUBE-MARK-MASQ  all       --    192.168.236.136       0.0.0.0/0            /* default/nginx: */</span><br><span class="line">DNAT            tcp       --     0.0.0.0/0            0.0.0.0/0            /* default/nginx: */ tcp to:192.168.236.136:80</span><br><span class="line"><span class="comment"># Service 规则</span></span><br><span class="line">Chain KUBE-SERVICES (2 references)</span><br><span class="line">target                      prot    opt   <span class="built_in">source</span>              destination     </span><br><span class="line">KUBE-MARK-MASQ              tcp     --    !192.168.0.0/16      10.107.122.198       /* default/nginx: cluster IP */ tcp dpt:80</span><br><span class="line">KUBE-SVC-4N57TFCL4MD7ZTDA   tcp     --    0.0.0.0/0            10.107.122.198       /* default/nginx: cluster IP */ tcp dpt:80</span><br><span class="line"><span class="comment"># Service 负载均衡</span></span><br><span class="line">Chain KUBE-SVC-4N57TFCL4MD7ZTDA (1 references)</span><br><span class="line">target                     prot    opt    <span class="built_in">source</span>             destination         </span><br><span class="line">KUBE-SEP-UGFJDGWZKFFMLNCL  all      --   0.0.0.0/0            0.0.0.0/0            /* default/nginx: */ statistic mode random probability 0.50000000000</span><br><span class="line">KUBE-SEP-ATB57SP3HHRBIRYE  all      --   0.0.0.0/0            0.0.0.0/0            /* default/nginx: */</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先 <code>iptalbes</code> 对应的工作流程就是创建一个一个 <code>chain</code> 来完成指定的工作。</p>
<p>iptables 命令规则如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] <span class="built_in">command</span> [match] [target/jump] </span><br></pre></td></tr></table></figure>
<p>表有: <code>nat</code>、<code>mangle</code>、<code>filter</code>、<code>raw</code></p>
<p>根据 <code>svc</code> 和 <code>Endpoint</code> 和展示出的 <code>iptables</code> 信息。可以参考规则如下：<br>添加 <code>root</code> <strong>Chain</strong>：<code>KUBE-SERVICES</code><br>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -N KUBE-SERVICES</span><br></pre></td></tr></table></figure>

<p><code>KUBE-SERVICES</code> 是总链，也就是所有 <code>k8s</code> 规则链的 <code>root</code>。从而也就说明所有出入的流量都需要经过当前 <code>Chain</code> 的遍历。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat  -A PREROUTING -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SERVICES</span><br><span class="line">iptables -t nat  -A OUTPUT -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SERVICES</span><br></pre></td></tr></table></figure>

<p>任意协议、任意来源、任意目标，任意流量只要与当前节点接触就会触发跳转 <code>KUBE-SERVICES</code> <strong>Chain</strong>。</p>
<p><code>KUBE-SERVICES</code> 主要就是为了与 <code>k8s</code> 的 <code>svc</code> 想对应。每个 <code>svc</code> 需要创建自己的规则 <strong>Chain</strong>。所以首先创建一个 <code>nginx</code> <strong>Chain</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -N KUBE-SVC-NGINX</span><br></pre></td></tr></table></figure>

<p>除了 <code>svc</code> 之外还有 <code>endpoint</code> 应为当前 <code>Endpoint</code> 对外的地址只限于对外访问，对内并不存在地址，所以还需要添加两个 <code>Endpoint</code> 对应的<br><code>iptables</code> 规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -N KUBE-SEP-NGINX-1</span><br><span class="line">iptables -t nat -N KUBE-SEP-NGINX-2</span><br></pre></td></tr></table></figure>

<p>展示下目前的规则列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">iptables -L  -t nat -n </span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-NGINX-1 (0 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-NGINX-2 (0 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain KUBE-SERVICES (2 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain KUBE-SVC-NGINX (0 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination </span><br></pre></td></tr></table></figure>

<p>基本差不多成型了，只要在每个 <strong>Chain</strong> 下面添加对应的实例信息即可<br><code>KUBE-SEP-NGINX-1</code>、<code>KUBE-SEP-NGINX-2</code> 监听对应的 <code>IP</code> 地址，然后转发到当前 <code>Node</code> 的 <code>Port</code>。<br>上方 <code>Service</code> 规则如下：</p>
<ol>
<li>监听 <code>tcp</code> 协议</li>
<li>访问 <code>Service</code> Port 转发至 <code>Node</code> Port<br>分别添加：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DNAT            tcp       --    0.0.0.0/0             0.0.0.0/0   tcp to:192.168.236.133:80</span></span><br><span class="line"></span><br><span class="line">iptables -t nat  -A KUBE-SEP-NGINX-1 -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -m tcp -j DNAT --to-destination 192.168.236.133:80</span><br><span class="line">iptables -t nat  -A KUBE-SEP-NGINX-2 -p tcp -s 0.0.0.0/0 -d 0.0.0.0/0 -m tcp -j DNAT --to-destination 192.168.236.136:80</span><br></pre></td></tr></table></figure>

<p><code>KUBE-SEP-NGINX-1</code>、<code>KUBE-SEP-NGINX-2</code> 下面都有实例了，下面只要定制在访问 SVC 是重定向到 <code>KUBE-SEP-NGINX-1</code>、<br><code>KUBE-SEP-NGINX-2</code> 即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat  -A KUBE-SVC-NGINX -p all  -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SEP-NGINX-1</span><br><span class="line">iptables -t nat  -A KUBE-SVC-NGINX -p all  -s 0.0.0.0/0 -d 0.0.0.0/0 -j KUBE-SEP-NGINX-2</span><br></pre></td></tr></table></figure>

<p><code>svc</code> 的规则下面也有实例，但是也没有被添加到 <code>root</code> 也就是 <code>KUBE-SERVICES</code> 下无法被遍历到，添加命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat  -A KUBE-SERVICES -p tcp ! -s 192.168.0.0/16 -d 10.107.122.198 --dport 80 -j KUBE-SVC-NGINX</span><br></pre></td></tr></table></figure>

<p>最终规则如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -L -n -t nat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当然这里还没有结束，还需要添加 Mark 标记</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -N KUBE-MARK-MASQ</span><br><span class="line">iptables -t nat -A KUBE-MARK-MASQ -p all -s 0.0.0.0/0 -d 0.0.0.0/0 -j MARK --or-mark 0x4000</span><br><span class="line">iptables -t nat -A KUBE-SERVICES -p TCP -s 0.0.0.0/0 -d 10.107.122.198 --dport 80 -j KUBE-MARK-MASQ</span><br><span class="line">iptables -t nat -A KUBE-SEP-NGINX-1 -p all -s 192.168.236.133 -j KUBE-MARK-MASQ </span><br><span class="line">iptables -t nat -A KUBE-SEP-NGINX-2 -p all -s 192.168.236.136 -j KUBE-MARK-MASQ</span><br></pre></td></tr></table></figure>


<p>运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain KUBE-MARK-MASQ (3 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-NGINX-1 (1 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-MARK-MASQ  all  --  192.168.236.133      0.0.0.0/0           </span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp to:192.168.236.133:80</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-NGINX-2 (1 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-MARK-MASQ  all  --  192.168.236.136      0.0.0.0/0           </span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp to:192.168.236.136:80</span><br><span class="line"></span><br><span class="line">Chain KUBE-SERVICES (2 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-MARK-MASQ  tcp  --  0.0.0.0/0            10.107.122.198       tcp dpt:80</span><br><span class="line">KUBE-SVC-NGINX  tcp  -- !192.168.0.0/16       10.107.122.198       tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain KUBE-SVC-NGINX (1 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-SEP-NGINX-1  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">KUBE-SEP-NGINX-2  all  --  0.0.0.0/0            0.0.0.0/0 </span><br></pre></td></tr></table></figure>


<h1 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h1><p>在没有负载均衡的策略下 <code>iptables</code> 匹配到规则就会发生跳转和执行，也就是说永远会触发第一条规则，<br>这显然不符合我们所期望的负载均衡。</p>
<p>解决这个问题需要引入 <code>iptables</code> 的负载均衡模块：<code>statistic</code> ，这个模块会根据统计的信息跳过或者执行<br>其中一条规则。</p>
<p>这个模块只有两个基本的负载均衡算法：</p>
<ul>
<li>random：基于概率跳过这个规则</li>
<li>nth：基于轮询跳过这个规则</li>
</ul>
<blockquote>
<p><strong>这个负载均衡仅在TCP链接建立阶段生效，一旦链接建立了，这个链接将会一直被转发到同一个后端服务器</strong></p>
</blockquote>
<h1 id="随机"><a href="#随机" class="headerlink" title="随机"></a>随机</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment <span class="string">&quot;default/nginx:&quot;</span> -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-UGFJDGWZKFFMLNCL</span><br><span class="line">iptables -A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment <span class="string">&quot;default/nginx:&quot;</span> -j KUBE-SEP-ATB57SP3HHRBIRYE</span><br></pre></td></tr></table></figure>

<p><strong>–mode random</strong>: 基于概率跳过这个规则<br><strong>–probability 0.50000000000</strong>：有 <code>50%</code> 概率跳过这个规则</p>
<h1 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -p tcp -m state --state NEW -m statistic --mode nth --every 2 --packet 0 -j CONNMARK1</span><br><span class="line">iptables -t mangle -A PREROUTING -p tcp -m state --state NEW -m statistic --mode nth --every 2 --packet 1 -j CONNMARK2</span><br></pre></td></tr></table></figure>

<p><strong>–mode nth</strong>：使用轮询算法<br><strong>–every 2 –packet 0</strong>：每<code>2</code>个包匹配 <code>0</code> 个</p>
<h1 id="看看源码"><a href="#看看源码" class="headerlink" title="看看源码"></a>看看源码</h1><p>kube-proxy 的主要功能是监听服务和端点事件，然后将代理策略委托给机器。底层调用<code>docker/libnetwork</code>和l<code>ibnetwork</code><br>最后调用<code>netlink</code>和<code>netns</code>来实现创建ipvs等动作</p>
<p><strong>代码入口：<code>cmd/kube-proxy/app/server.go Run()</code> 函数</strong>，通过命令行参数初始化proxyServer的配置</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">proxyServer, err := NewProxyServer(o)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ProxyServer <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// k8s client</span></span><br><span class="line">  Client                 clientset.Interface</span><br><span class="line">  EventClient            v1core.EventsGetter</span><br><span class="line">  <span class="comment">// iptables and ipvs related interface</span></span><br><span class="line">  IptInterface           utiliptables.Interface</span><br><span class="line">  IpvsInterface          utilipvs.Interface</span><br><span class="line">  IpsetInterface         utilipset.Interface</span><br><span class="line">  execer                 exec.Interface</span><br><span class="line">  <span class="comment">// 同步器处理</span></span><br><span class="line">  Proxier                proxy.Provider</span><br><span class="line">  Broadcaster            events.EventBroadcaster</span><br><span class="line">  Recorder               events.EventRecorder</span><br><span class="line">  <span class="comment">// k8s 状态跟踪配置</span></span><br><span class="line">  ConntrackConfiguration kubeproxyconfig.KubeProxyConntrackConfiguration</span><br><span class="line">  Conntracker            Conntracker <span class="comment">// if nil, ignored</span></span><br><span class="line">  <span class="comment">// 代理模式</span></span><br><span class="line">  ProxyMode              <span class="type">string</span></span><br><span class="line">  NodeRef                *v1.ObjectReference</span><br><span class="line">  MetricsBindAddress     <span class="type">string</span></span><br><span class="line">  BindAddressHardFail    <span class="type">bool</span></span><br><span class="line">  EnableProfiling        <span class="type">bool</span></span><br><span class="line">  UseEndpointSlices      <span class="type">bool</span></span><br><span class="line">  OOMScoreAdj            *<span class="type">int32</span></span><br><span class="line">  ConfigSyncPeriod       time.Duration</span><br><span class="line">  HealthzServer          healthcheck.ProxierHealthUpdater</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>












</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="../2021-04-01-k8s1/">上一篇</a>
    

    
    <p>上次更新 2024-08-26</p>
    
    
        <a class="extend next post-next" href="../2021-04-01-k8s0/">下一篇</a>
    
    </div>


    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:2228598786@qq.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/Benjmmi" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © Benjmmi 2017 - 2025
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>

  <script src='https://unpkg.com/mermaid@11.12.1/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>
    </div>
</body>
</html>
