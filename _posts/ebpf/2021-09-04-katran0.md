---
title: 负载均衡 katran： 了解学习和思考
date: 2021-09-04 22:33:40
categories:  'eBPF'
tags:
  - ebpf
  - katran
  - lvs
author: Jony
---

# 术语

- NUMA: (Non-uniform memory access) 非统一内存访问架构,是一种为多处理器的电脑设计的内存架构，
  内存访问时间取决于内存相对于处理器的位置。

- `RSS`: 接收端扩展（RSS）是网卡中的一个重要的优化，指在通过每个数据链路的数据包转发到单独的 CPU从而在
  CPU 之间均有的分配负载。从而在 CPU 之前均衡的分配负载



# 介绍

Katran 是一项负载均衡技术，类似于 LVS 等软件，目前 LVS 已经成为 Linux 内核模块。

负载均衡是一种服务器和网络设备的集群技术。负载均衡将特定的业务（网络服务、网络流量等）分担给多个服务
器或者网络设备。从而提高了业务处理的能力，保证了业务的高可用性。常用的负载均衡有开源的 Nginx、
LVS、Haproxy。以及商业的硬件设备 F5、Netscale。

负载均衡设备对网络处理能力需要极高的要求，甚至于重写网络内核。负载均衡所带来的收益也是十分明显
网络的单机模式到集群模式处理减少成本、降低风险、提高系统稳定性，都能为公司带来非常高的价值。
[摘要:负载均衡的故事](https://blog.csdn.net/sinat_34763749/article/details/80529562)


Katran 完全重新设计了转发平民啊。应用了目前较新的技术：XDP 和 eBPF 技术，这两个技术的结合
使得负载均衡有了几个优点：极早数据包处理、内核中运行处理高效、复用内核功能节约开发成本、稳定性
高、可扩展性高、成本低廉但更稳定的 Maglev 哈希，更具有弹性的本地状态，对 `RSS` 友好的封装。


# 特点

- `Katran` 只有 DR（Direct Server Response） 工作模式
- 基于 L3 协议，而不是 L2 协议，决定网 VIP 的数据包都要发送到 `Katran`
- 不支持分段、无法自行对数据分段。（解决方案：增加 `MTU` 或 更改来自后端的 `TCPMSS`）
- `Katran` 不支持带有IP选项集的数据包。最大数据包大小不得超过 `3.5 KB`
- 用于一体化负载均衡系统，即单一接口将用于“从用户到L4LB（入口）”的流量和“从L4LB到L7LB（出口）”的流量。

## 优点

1. 快：XDP 工作在 NIC 接受之后。也可以降低到 `驱动模式` 工作
2. 性能随网卡RX队列的数量线性增长: katran 属于无锁工作模式，每个接收到的包都会调用 BPF 程序
3. RSS友好封装: katran使用ipip封装进行从L4 lb到L7 lb的数据包转发。
4. 固定大小（启动时可配置大小）连接跟踪表，带有用于逐出旧条目的LRU策略。
5. 优化的 Maglev Hash 表用于连接跟踪：它为我们提供了良好的故障恢复能力和出色的负载均衡功能。
  哈希已修改为能够支持后端(L7磅)服务器的不等权重
6. 不需要在接收路径上进行忙循环：如果没有要服务的流量，负载均衡器几乎不会消耗任何CPU。
7. Katran(通常还有XDP)允许您在同一台服务器上运行任何应用程序，而不会造成任何性能
  损失(与其他一些“内核绕过”技术相比)



# 工作模式

![katran_pktflow.png](/Benjamin.Yim/assets/images/epbf/katran_pktflow.png)

1. katran 接收包
2. 验证访问目标 IP 是否存在本机配置的 VIP 中
3. 检查是否已经存在会话记录
4. 如果是一个新的会话，就使用 `5元组` 进行 hash 计算
5. 根据 hash 值，选择一个真实的后端服务器
6. 更新到会话记录，用于简单的查找下次会话
7. 将保温封装到另一个 IP 报文中，发送到后端


# 思考

katran 宣传是工作在 DSR 模式下，但是使用了 `ip-in-ip` 对其进行了封装，还需要后端配置 `lo`
优点想 `Tunnel` 模式。也是单臂模式，响应不服药负载均衡器。`可能是为了解决包过大的问题`。为了
达到高性能模式还绑定了单个 CPU 处理数据包，优点类似 `DPDK` 模式。总体性能需要压测之后才能全面
了解。

## 需要思考

XDP 需要使用的 MAP 内存是受限的，这个解决了么。如果大批量的数据虽然使用 LRU 但是对于链路跟踪
会不会产生数据丢失。如果支持 NAT 模式，整个会话记录和链路跟踪的处理方式。核心程序应该在 BPF 代码
前端语言只需要简单封装就可以。可否支持 UDP 和 L7 负载。共享模式需要解析。








