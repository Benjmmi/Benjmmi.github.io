I"Ğ#<h1 id="io_uring-çš„åº•å±‚æ¥å£">io_uring çš„åº•å±‚æ¥å£</h1>

<p>æ­£å¦‚åœ¨å‰ä¸€ä¸ªæ–‡ç« ä¸­æ‰€å»ºè®®çš„é‚£æ ·ï¼Œæ‚¨ä¸å¤ªå¯èƒ½åœ¨æ­£å¼çš„ç¨‹åºä¸­ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">io_uring</code> åº•å±‚çš„ APIã€‚ä½†æ˜¯çŸ¥é“æ¥å£çœŸæ­£ä½¿ç”¨èµ·æ¥æ˜¯ä»€ä¹ˆæ ·çš„æ–¹å¼æ€»æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¿…é¡»é€šè¿‡å…±äº«ç¯ç¼“å†²åŒºå’Œç›¸å…³çš„ <code class="language-plaintext highlighter-rouge">io_uring</code> ç³»ç»Ÿè°ƒç”¨æ¥å¤„ç† <code class="language-plaintext highlighter-rouge">io_uring</code> ç›´æ¥å‘ˆç°ç»™ç¨‹åºçš„æ¥å£ã€‚ä¸€ä¸ªå¾ˆå¥½ã€ç®€å•çš„ä¾‹å­ï¼Œå¯ä»¥å¾ˆå¥½åœ°å±•ç¤ºè¿™ä¸ªæ¥å£ã€‚ä¸ºæ­¤ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¨¡æ‹Ÿ Unix cat å®ç”¨ç¨‹åºçš„ç¤ºä¾‹ã€‚ä¸ºäº†ä¿æŒç®€å•ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç¨‹åºï¼Œä¸€æ¬¡æ˜¾ç¤ºä¸€ä¸ªæ“ä½œï¼Œç­‰å¾…å®ƒå®Œæˆå¹¶æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ“ä½œç­‰ç­‰ã€‚è™½ç„¶ä¸€ä¸ªçœŸæ­£çš„ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ­¥/é˜»å¡è°ƒç”¨æ¥ä»¥è¿™ç§æ–¹å¼å®Œæˆå·¥ä½œï¼Œä½†è¿™ä¸ªç¨‹åºçš„ä¸»è¦ç›®çš„æ˜¯è®©æ‚¨ç†Ÿæ‚‰ i/o æ¥å£ï¼Œè€Œä¸ä¼šå—åˆ°å…¶ä»–ç¨‹åºé€»è¾‘çš„å¹²æ‰°ã€‚</p>

<h2 id="ç†Ÿæ‚‰readv2ç³»ç»Ÿè°ƒç”¨">ç†Ÿæ‚‰<a href="http://man7.org/linux/man-pages/man2/readv.2.html">readvï¼ˆ2ï¼‰</a>ç³»ç»Ÿè°ƒç”¨</h2>

<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸ªç¤ºä¾‹ï¼Œæ‚¨éœ€è¦ç†Ÿæ‚‰ <code class="language-plaintext highlighter-rouge">[readvï¼ˆ2ï¼‰](http://man7.org/linux/man-pages/man2/readv.2.html)</code>ç³»ç»Ÿè°ƒç”¨ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰å®ƒï¼Œæˆ‘å»ºè®®ä½ è¯»<a href="https://unixism.net/2020/04/io-uring-by-example-part-1-introduction/">ä¸€ä¸ªæ›´é€šä¿—çš„ä»‹ç»</a>ï¼Œç„¶åå›åˆ°è¿™é‡Œç»§ç»­ã€‚</p>

<h2 id="åº•å±‚æ¥å£ä»‹ç»">åº•å±‚æ¥å£ä»‹ç»</h2>
<p>å®ƒçš„æ¥å£å¾ˆç®€å•ã€‚æœ‰ä¸€ä¸ªæäº¤é˜Ÿåˆ—å’Œä¸€ä¸ªå®Œæˆé˜Ÿåˆ—ã€‚åœ¨æäº¤é˜Ÿåˆ—ä¸­ï¼Œæ‚¨å¯ä»¥æäº¤ä½ æƒ³è¦å®Œæˆçš„å„ç§æ“ä½œçš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬å½“å‰çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ <a href="http://man7.org/linux/man-pages/man2/readv.2.html">readvï¼ˆ2ï¼‰</a>è¯»å–æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬æ”¾ç½®ä¸€ä¸ªæäº¤é˜Ÿåˆ—è¯·æ±‚ï¼Œå°†å…¶æè¿°ä¸ºæäº¤é˜Ÿåˆ—æ¡ç›®(SQE)çš„ä¸€éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥æ”¾ç½®å¤šä¸ªè¯·æ±‚ã€‚æ ¹æ®é˜Ÿåˆ—æ·±åº¦(æ‚¨å¯ä»¥å®šä¹‰)å…è®¸çš„è¯·æ±‚æ•°é‡ã€‚è¿™äº›æ“ä½œå¯ä»¥æ˜¯è¯»ã€å†™ç­‰æ“ä½œçš„æ··åˆã€‚è¿™äº›æ“ä½œå¯ä»¥æ˜¯è¯»ã€å†™ç­‰æ“ä½œçš„æ··åˆã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨ <code class="language-plaintext highlighter-rouge">[io_uring_enter()](https://unixism.net/loti/ref-iouring/io_uring_enter.html#c.io_uring_enter)</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå‘Šè¯‰å†…æ ¸æˆ‘ä»¬å·²ç»å‘æäº¤é˜Ÿåˆ—æ·»åŠ äº†è¯·æ±‚ã€‚ä¸€æ—¦å®ƒå®Œæˆäº†è¿™äº›è¯·æ±‚çš„å¤„ç†ï¼Œå®ƒå°†ç»“æœä½œä¸º CQE çš„ä¸€éƒ¨åˆ†æ”¾ç½®åœ¨å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œæˆ–è€…ä¸ºæ¯ä¸ªç›¸åº”çš„ SQE æ”¾ç½®ä¸€ä¸ªå®Œæˆé˜Ÿåˆ—æ¡ç›®ã€‚è¿™äº› CQEs å¯ä»¥ç«‹å³ä»ç”¨æˆ·ç©ºé—´è®¿é—®ï¼Œå› ä¸ºå®ƒä»¬è¢«æ”¾ç½®åœ¨ä¸€ä¸ªç”±å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«çš„ç¼“å†²åŒºä¸­ã€‚</p>

<p>æˆ‘ä»¬åœ¨å‰é¢å·²ç»è®¨è®ºäº† io_uring çš„è¿™ä¸ªç‰¹æ®Šä¼˜ç‚¹ï¼Œä½†æ˜¯èªæ˜çš„è¯»è€…ä¼šæ³¨æ„åˆ°è¿™æ ·ä¸€ä¸ªæ¥å£: ç”¨å¤šä¸ª i/o è¯·æ±‚å¡«å……åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨çš„æ¥å£ï¼Œè€Œä¸æ˜¯å¯¹æ¯ä¸ªI/Oè¯·æ±‚è¿›è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±å·²ç»å¾ˆé«˜æ•ˆäº†ã€‚ä¸ºäº†è¿›ä¸€æ­¥æé«˜æ•ˆç‡ï¼Œ<code class="language-plaintext highlighter-rouge">io_uring</code> æ”¯æŒäº†ä¸€ç§æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå†…æ ¸ä¼šå¯¹ä½ åŠ å…¥æäº¤é˜Ÿåˆ—çš„æ¡ç›®è¿›è¡Œè½®è¯¢ï¼Œ
è€Œä½ ç”šè‡³ä¸éœ€è¦è°ƒç”¨ <strong><code class="language-plaintext highlighter-rouge">[io_uring_enter ()](https://unixism.net/loti/ref-iouring/io_uring_enter.html#c.io_uring_enter)</code></strong>æ¥é€šçŸ¥å†…æ ¸æ›´æ–°çš„æäº¤é˜Ÿåˆ—æ¡ç›®ã€‚å¦ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ
åœ¨ <strong>Specter</strong> å’Œ <strong>Meltdown</strong> ç¡¬ä»¶æ¼æ´è¢«å‘ç°å¹¶ä¸”æ“ä½œç³»ç»Ÿä¸ºå…¶åˆ›å»ºäº†è§£å†³æ–¹æ¡ˆä¹‹åï¼Œç³»ç»Ÿè°ƒç”¨æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½è¦æ˜‚è´µã€‚å› æ­¤ï¼Œå¯¹äºé«˜æ€§èƒ½åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡ç¡®å®æ˜¯ä¸€ä»¶å¤§äº‹ã€‚</p>

<p>åœ¨æ‰§è¡Œè¿™äº›æ“ä½œä¹‹å‰ï¼Œéœ€è¦è®¾ç½®é˜Ÿåˆ—ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯å…·æœ‰ä¸€å®šæ·±åº¦/é•¿åº¦çš„ç¯å½¢ç¼“å†²åŒºã€‚
æ‚¨å¯ä»¥è°ƒç”¨ <strong><code class="language-plaintext highlighter-rouge">[io_ uring_setup ()](https://unixism.net/loti/ref-iouring/io_uring_setup.html#c.io_uring_setup)</code></strong>ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆæ­¤æ“ä½œã€‚æˆ‘ä»¬é€šè¿‡å°†æäº¤é˜Ÿåˆ—æ¡ç›®æ·»åŠ åˆ°å¾ªç¯ç¼“å†²åŒºå¹¶ä»å®Œæˆé˜Ÿ
åˆ—å¾ªç¯ç¼“å†²åŒºè¯»å–å®Œæˆé˜Ÿåˆ—æ¡ç›®æ¥å®ŒæˆçœŸæ­£çš„å·¥ä½œã€‚è¿™æ˜¯å¯¹è¿™ä¸ªio_uringæ¥å£è®¾è®¡çš„æ¦‚è¿°ã€‚</p>

<h2 id="å®Œæˆé˜Ÿåˆ—æ¡ç›®">å®Œæˆé˜Ÿåˆ—æ¡ç›®</h2>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå…³äºå¦‚ä½•å·¥ä½œçš„å¿ƒæ™ºæ¨¡å‹ï¼Œè®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°çœ‹çœ‹è¿™æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚ä¸æäº¤é˜Ÿåˆ—æ¡ç›®(SQE)ç›¸æ¯”ï¼Œ
å®Œæˆé˜Ÿåˆ—æ¡ç›®(CQE)éå¸¸ç®€å•ã€‚é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ã€‚SQE æ˜¯ä¸€ä¸ª <strong><code class="language-plaintext highlighter-rouge">io_uring_sqe</code></strong> ç»“æ„çš„å®ä¾‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæäº¤è¯·æ±‚ã€‚
å°†å…¶æ·»åŠ åˆ°æäº¤ç¯ç¼“å†²åŒºã€‚CQE æ˜¯ä¸€ä¸ª <strong>io_uring_cqe</strong> ç»“æ„çš„å®ä¾‹ï¼Œå†…æ ¸å¯¹æ·»åŠ åˆ°æäº¤é˜Ÿåˆ—ä¸­çš„æ¯ä¸ª <strong><code class="language-plaintext highlighter-rouge">io_uring_sqe</code></strong> ç»“æ„å®ä¾‹è¿›è¡Œå“åº”ã€‚å®ƒåŒ…å«æ‚¨é€šè¿‡ SQE å®ä¾‹è¯·æ±‚çš„æ“ä½œçš„ç»“æœã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="p">{</span>
  <span class="n">__u64</span>  <span class="n">user_data</span><span class="p">;</span>   <span class="cm">/* sqe-&gt;user_data submission passed back */</span>
  <span class="n">__s32</span>  <span class="n">res</span><span class="p">;</span>         <span class="cm">/* æ­¤äº‹ä»¶çš„ç»“æœä»£ç  */</span>
  <span class="n">__u32</span>  <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="å°†å®Œæˆä¸æäº¤ç›¸å…³è”">å°†å®Œæˆä¸æäº¤ç›¸å…³è”</h2>

<p>æ­£å¦‚åœ¨ä»£ç æ³¨é‡Šä¸­æåˆ°çš„ï¼Œ<strong>user_data</strong> å­—æ®µæ˜¯æŒ‰åŸæ ·ä» SQE ä¼ é€’åˆ° CQE å®ä¾‹çš„ã€‚å‡è®¾æ‚¨åœ¨æäº¤é˜Ÿåˆ—ä¸­æäº¤äº†ä¸€ç»„è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™äº›è¯·æ±‚ä¸ä¸€å®šä»¥ç›¸åŒçš„é¡ºåºå®Œæˆï¼Œ
ä¹Ÿä¸å¿…ä»¥ CQEs çš„èº«ä»½å‡ºç°åœ¨å®Œæˆé˜Ÿåˆ—ä¸­ã€‚ä»¥ä¸‹é¢çš„åœºæ™¯ä¸ºä¾‹: æ‚¨çš„æœºå™¨ä¸Šæœ‰ä¸¤ä¸ªç£ç›˜: ä¸€ä¸ªæ˜¯æ…¢é€Ÿæ—‹è½¬çš„ç¡¬ç›˜é©±åŠ¨å™¨ï¼Œå¦ä¸€ä¸ªæ˜¯è¶…å¿«çš„ SSDã€‚
æ‚¨åœ¨æäº¤é˜Ÿåˆ—ä¸­æäº¤2ä¸ªè¯·æ±‚ã€‚ç¬¬ä¸€ä¸ªåœ¨æ…¢é€Ÿæ—‹è½¬çš„ç¡¬ç›˜ä¸Šè¯»å–100kB çš„æ–‡ä»¶ï¼Œç¬¬äºŒä¸ªåœ¨å¿«é€Ÿå›ºæ€ç¡¬ç›˜ä¸Šè¯»å–åŒæ ·å¤§å°çš„æ–‡ä»¶ã€‚
å¦‚æœç»´æŠ¤æ’åºï¼Œå³ä½¿æ¥è‡ª SSD æ–‡ä»¶çš„æ•°æ®ä¼šæ›´æ—©åˆ°è¾¾ï¼Œå†…æ ¸æ˜¯å¦åº”è¯¥ç­‰å¾…æ¥è‡ªæ—‹è½¬ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶çš„æ•°æ®å˜å¾—å¯ç”¨ï¼Ÿè¿™æ˜¯ä¸ªä¸å¥½çš„æƒ³æ³•ï¼Œ
å› ä¸ºè¿™ä¼šé˜»æ­¢æˆ‘ä»¬ä»¥æœ€å¿«çš„é€Ÿåº¦è¿è¡Œã€‚å› æ­¤ï¼Œå½“ CQEs å¯ç”¨æ—¶ï¼Œå®ƒä»¬å¯ä»¥æŒ‰ä»»æ„é¡ºåºåˆ°è¾¾ã€‚æ— è®ºå“ªä¸ªæ“ä½œå®Œæˆï¼Œå…¶ç»“æœéƒ½ä¼šåœ¨ CQ ä¸Šå…¬å¸ƒã€‚
ç”±äº CQEs çš„åˆ°è¾¾æ²¡æœ‰ç‰¹å®šçš„é¡ºåºï¼Œç°åœ¨ä½ å·²ç»çŸ¥é“äº†ä»ä¸Šé¢çš„ <strong>io_uring_cqe</strong> ç»“æ„ä¸­çœ‹åˆ°çš„ CQE æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œä½ å¦‚ä½•è¯†åˆ«ä¸€ä¸ªç‰¹å®š CQE å¯¹åº”çš„ SQE è¯·æ±‚ï¼Ÿä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ SQEs å’Œ CQEs å…±æœ‰çš„ <strong>user_data</strong> å­—æ®µæ¥æ ‡è¯†å®Œæˆæƒ…å†µã€‚å¹¶ä¸æ˜¯è¯´ä½ è¦è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„ ID æˆ–è€…å…¶ä»–ä»€ä¹ˆï¼Œè€Œæ˜¯ä½ é€šå¸¸ä¼šä¼ é€’ä¸€ä¸ªæŒ‡é’ˆã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿåˆ°å›°æƒ‘ï¼Œé‚£å°±ç­‰ç€çœ‹åé¢çš„ä¾‹å­å§ã€‚</p>

<p>å®Œæˆé˜Ÿåˆ—æ¡ç›®å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒä¸»è¦å…³æ³¨ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œè¿™ä¸ªè¿”å›å€¼åœ¨ res å­—æ®µä¸­è¿”å›ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨è¯»å–æ“ä½œé˜Ÿåˆ—æˆåŠŸæ‰§è¡Œå®Œæˆï¼Œé‚£ä¹ˆå®ƒå°†åŒ…å«è¯»å–çš„å­—èŠ‚æ•°ã€‚å¦‚æœæœ‰é”™è¯¯ï¼Œå®ƒå°†åŒ…å«ä¸€ä¸ªè´Ÿçš„é”™è¯¯å·ã€‚æœ¬è´¨ä¸Šï¼Œ<strong><a href="http://man7.org/linux/man-pages/man2/read.2.html">read(2)</a></strong>ç³»ç»Ÿè°ƒç”¨è‡ªèº«çš„å†…å®¹å°†è¿”å›ã€‚</p>

<h2 id="æ’åº">æ’åº</h2>

<p>è™½ç„¶æˆ‘æåˆ°äº† CQEs å¯ä»¥ä»¥ä»»ä½•é¡ºåºåˆ°è¾¾ï¼Œä½†æ˜¯æ‚¨å¯ä»¥å¼ºåˆ¶ä½¿ç”¨ SQE æ’åºå¯¹æŸäº›æ“ä½œè¿›è¡Œæ’åºï¼Œå®é™…ä¸Šæ˜¯å°†å®ƒä»¬é“¾æ¥èµ·æ¥ã€‚æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§<a href="https://unixism.net/loti/tutorial/link_liburing.html#link-liburing">é“¾æ¥</a>è¯·æ±‚æ•™ç¨‹ã€‚</p>

<h2 id="æäº¤é˜Ÿåˆ—æ¡ç›®">æäº¤é˜Ÿåˆ—æ¡ç›®</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">iovec</span> <span class="p">{</span>
     <span class="kt">void</span>  <span class="o">*</span><span class="n">iov_base</span><span class="p">;</span>    <span class="cm">/*å¼€å§‹åœ°å€ */</span>
     <span class="kt">size_t</span> <span class="n">iov_len</span><span class="p">;</span>     <span class="cm">/*è¦ä¼ è¾“çš„å­—èŠ‚æ•° */</span>
<span class="p">};</span>
</code></pre></div></div>
<p>iovec æ¯ä¸ªç»“æ„åªæŒ‡å‘ä¸€ä¸ªç¼“å†²åŒºã€‚åŸºå€å’Œé•¿åº¦ã€‚</p>

<p>submission é˜Ÿåˆ—æ¡ç›®æ¯” completion é˜Ÿåˆ—æ¡ç›®ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒéœ€è¦è¶³å¤Ÿé€šç”¨ï¼Œä»¥è¡¨ç¤ºå’Œå¤„ç†ç›®å‰ Linux å¯èƒ½é‡‡ç”¨çš„å„ç§ i/oæ“ä½œï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="p">{</span>
  <span class="n">__u8</span>  <span class="n">opcode</span><span class="p">;</span>   <span class="cm">/* æŒ‡å®šæ“ä½œç±»å‹ */</span>
  <span class="n">__u8</span>  <span class="n">flags</span><span class="p">;</span>    <span class="cm">/* IOSQE_ æ ‡è®° */</span>
  <span class="n">__u16</span>  <span class="n">ioprio</span><span class="p">;</span>  <span class="cm">/* ioprio è¯·æ±‚ */</span>
  <span class="n">__s32</span>  <span class="n">fd</span><span class="p">;</span>      <span class="cm">/* è¦æ‰§è¡Œ IO çš„æ–‡ä»¶æè¿°ç¬¦ */</span>
  <span class="n">__u64</span>  <span class="n">off</span><span class="p">;</span>     <span class="cm">/* æ–‡ä»¶åç§» */</span>
  <span class="n">__u64</span>  <span class="n">addr</span><span class="p">;</span>    <span class="cm">/* æŒ‡å‘ç¼“å†²åŒºæˆ–è€…iovecs */</span>
  <span class="n">__u32</span>  <span class="n">len</span><span class="p">;</span>     <span class="cm">/* ç¼“å†²åŒºå¤§å°æˆ–è€…iovecs æ•°é‡ */</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">__kernel_rwf_t</span>  <span class="n">rw_flags</span><span class="p">;</span>
    <span class="n">__u32</span>    <span class="n">fsync_flags</span><span class="p">;</span>
    <span class="n">__u16</span>    <span class="n">poll_events</span><span class="p">;</span>
    <span class="n">__u32</span>    <span class="n">sync_range_flags</span><span class="p">;</span>
    <span class="n">__u32</span>    <span class="n">msg_flags</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="n">__u64</span>  <span class="n">user_data</span><span class="p">;</span>   <span class="cm">/* å®Œæˆæ—¶ä¼ å›çš„æ•°æ®  */</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">__u16</span>  <span class="n">buf_index</span><span class="p">;</span> <span class="cm">/* ç´¢å¼•åˆ°å›ºå®šç¼“å†²åŒºï¼ˆå¦‚æœä½¿ç”¨ï¼‰ */</span>
    <span class="n">__u64</span>  <span class="n">__pad2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>

<p>æˆ‘çŸ¥é“è¿™ä¸ªç»“æ„çœ‹èµ·æ¥å¾ˆç¹æ‚ã€‚é€šå¸¸ä½¿ç”¨çš„å­—æ®µåªæœ‰å°‘æ•°ï¼Œè¿™å¾ˆå®¹æ˜“ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è§£é‡Šï¼Œ
æ¯”å¦‚æˆ‘ä»¬æ­£åœ¨å¤„ç†çš„è¿™ä¸ªå­—æ®µ: catã€‚å½“ä½ æƒ³ä½¿ç”¨ <a href="http://man7.org/linux/man-pages/man2/readv.2.html">readv(2)</a>ç³»ç»Ÿè°ƒç”¨è¯»å–ä¸€ä¸ªæ–‡ä»¶æ—¶:</p>

<ul>
  <li>opcode ç”¨äºæŒ‡å®šæ“ä½œï¼Œåœ¨è¿™ä¸ªcase ä¸­ï¼Œ <a href="http://man7.org/linux/man-pages/man2/readv.2.html">readv(2)</a> ä½¿ç”¨çš„æ˜¯ <strong>IORING_OP_READV</strong> å¸¸é‡</li>
  <li>fd ç”¨äºæŒ‡å®šè¡¨ç¤ºè¦ä»ä¸­è¯»å–çš„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦</li>
  <li>addr ç”¨äºæŒ‡å‘ iovec ç»“æ„çš„æ•°ç»„ï¼Œè¿™äº›ç»“æ„åŒ…å«æˆ‘ä»¬ä¸º i/o åˆ†é…çš„ç¼“å†²åŒºçš„åœ°å€å’Œé•¿åº¦ã€‚</li>
  <li>len  ç”¨äºä¿å­˜ iovec ç»“æ„çš„æ•°ç»„çš„é•¿åº¦ã€‚</li>
</ul>

<p>è¿™å¹¶ä¸æ˜¯å¾ˆéš¾ï¼Œä¸æ˜¯å—ï¼Ÿä½ å¡«å†™è¿™äº›å€¼ï¼Œè®© io_uring çŸ¥é“è¯¥åšä»€ä¹ˆã€‚ä½ å¯ä»¥å°†å¤šä¸ªSQE åŠ å…¥é˜Ÿåˆ—ï¼Œæœ€åå½“ä½ æƒ³è®©å†…æ ¸å¼€å§‹å¤„ç†ä½  SQE é˜Ÿåˆ—çš„è¯·æ±‚æ—¶ï¼Œè°ƒç”¨ <strong><code class="language-plaintext highlighter-rouge">[io_uring_enter()](https://unixism.net/loti/ref-iouring/io_uring_enter.html#c.io_uring_enter)</code></strong> ã€‚</p>

<h2 id="ä½¿ç”¨-io_uring-å®ç°-cat-å‘½ä»¤">ä½¿ç”¨ io_uring å®ç° cat å‘½ä»¤</h2>

<p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é€šè¿‡ä½¿ç”¨åº•å±‚ <strong>io_uring</strong> æ¥å£çš„æ¥å®ç°ç±»ä¼¼ cat å®ç”¨ç¨‹åºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/uio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="cm">/* å¦‚æœä½ ç¼–è¯‘å¤±è´¥ç¼ºå°‘è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œé‚£ä¹ˆæ˜¯å› ä¸ºä½ å¾—å†…æ ¸ç‰ˆæœ¬å¤ªä½äº†
* */</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/io_uring.h&gt;</span><span class="cp">
</span>
<span class="cp">#define QUEUE_DEPTH 1
#define BLOCK_SZ    1024
</span>
<span class="cm">/*  x86è§„èŒƒ */</span>
<span class="cp">#define read_barrier()  __asm__ __volatile__("":::"memory")
#define write_barrier() __asm__ __volatile__("":::"memory")
</span>

<span class="cm">/**
struct io_uring_sqe {
  __u8  opcode;   // sqe æ“ä½œç±»å‹ä»£ç 
  __u8  flags;    // IOSQE_ flags 
  __u16  ioprio;  // è¯·æ±‚ioprio
  __s32  fd;      // æ‰§è¡ŒIOæ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦
  __u64  off;     // æ–‡ä»¶ä¸­çš„åç§»é‡ 
  __u64  addr;    // æŒ‡å‘ç¼“å†²åŒºæˆ–iovecsçš„æŒ‡é’ˆ
  __u32  len;     // ç¼“å†²åŒºå¤§å°æˆ–iovecsæ•°é‡
  union {
    __kernel_rwf_t  rw_flags;
    __u32    fsync_flags;
    __u16    poll_events;
    __u32    sync_range_flags;
    __u32    msg_flags;
  };
  __u64  user_data;   // å®Œæˆæ—¶è¦ä¼ å›çš„æ•°æ®
  union {
    __u16  buf_index; // ç´¢å¼•åˆ°å›ºå®šç¼“å†²åŒº(å¦‚æœä½¿ç”¨)
    __u64  __pad2[3];
  };
};



struct io_uring_params {
  __u32 sq_entries;
  __u32 cq_entries;
  __u32 flags;
  __u32 sq_thread_cpu;
  __u32 sq_thread_idle;
  __u32 resv[5];
  struct io_sqring_offsets sq_off;
  struct io_cqring_offsets cq_off;
};

*/</span>

<span class="k">struct</span> <span class="n">app_io_sq_ring</span> <span class="p">{</span> <span class="c1">// Submission ring</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ring_mask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ring_entries</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">app_io_cq_ring</span> <span class="p">{</span> <span class="c1">// completions ring</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ring_mask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ring_entries</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqes</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">submitter</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ring_fd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">app_io_sq_ring</span> <span class="n">sq_ring</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqes</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">app_io_cq_ring</span> <span class="n">cq_ring</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">file_info</span> <span class="p">{</span>
    <span class="kt">off_t</span> <span class="n">file_sz</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovecs</span><span class="p">[];</span>      <span class="cm">/* Referred by readv/writev */</span>
<span class="p">};</span>

<span class="cm">/*
* è¿™æ®µä»£ç æ˜¯åœ¨io_uringç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ä¸å±äºæ ‡å‡†Cåº“çš„æ—¶å€™ç¼–å†™çš„ã€‚ 
* æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¨å‡ºäº†è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨å°è£…å‡½æ•°ã€‚
* */</span>

<span class="kt">int</span> <span class="nf">io_uring_setup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_uring_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_io_uring_setup</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">io_uring_enter</span><span class="p">(</span><span class="kt">int</span> <span class="n">ring_fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to_submit</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_complete</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_io_uring_enter</span><span class="p">,</span> <span class="n">ring_fd</span><span class="p">,</span> <span class="n">to_submit</span><span class="p">,</span> <span class="n">min_complete</span><span class="p">,</span>
                <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
* è¿”å›ä¼ å…¥çš„æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶å¤§å°ã€‚ä¹Ÿèƒ½æ­£ç¡®å¤„ç†å¸¸è§„æ–‡ä»¶å’Œé©±åŠ¨è®¾å¤‡ã€‚å¾ˆå¥½ã€‚
*
* */</span>

<span class="kt">off_t</span> <span class="nf">get_file_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"fstat"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BLKGETSIZE64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"ioctl"</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
* io_uringéœ€è¦è¿›è¡Œå¤§é‡çš„è®¾ç½®ï¼Œè¿™äº›è®¾ç½®çœ‹èµ·æ¥ç›¸å½“å¤æ‚ï¼Œä½†å¹¶ä¸éƒ½å¾ˆéš¾ç†è§£ã€‚
* å› ä¸ºæ‰€æœ‰è¿™äº›æ¡ˆä¾‹ä»£ç ï¼Œ éƒ½åœ¨ io_uringçš„ä½œè€…åˆ›å»ºçš„liburingä¸­ï¼Œè€Œä¸” liburing ç›¸å¯¹å®¹æ˜“ä½¿ç”¨ã€‚
* ä½†æ˜¯ï¼Œæ‚¨åº”è¯¥èŠ±äº›æ—¶é—´æ¥ç†è§£è¿™æ®µä»£ç ã€‚
* äº†è§£å®ƒçš„å·¥ä½œåŸç†æ€»æ˜¯å¥½çš„ã€‚å‡ºå»å¥½å¹ç‰›é€¼
* */</span>

<span class="kt">int</span> <span class="nf">app_setup_uring</span><span class="p">(</span><span class="k">struct</span> <span class="n">submitter</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">app_io_sq_ring</span> <span class="o">*</span><span class="n">sring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sq_ring</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">app_io_cq_ring</span> <span class="o">*</span><span class="n">cring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cq_ring</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_uring_params</span> <span class="n">p</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">sq_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">cq_ptr</span><span class="p">;</span>

    <span class="cm">/*
    * æˆ‘ä»¬éœ€è¦å°† io_uring_params ç»“æ„ä¼ é€’ç»™çš„io_uring_setupï¼ˆï¼‰è°ƒç”¨å¹¶åˆå§‹åŒ–ä¸º0ã€‚ 
    * å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä»»ä½•æ ‡å¿—ï¼Œä½†æ˜¯å¯¹äºæœ¬ç¤ºä¾‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦ï¼Œå› ä¸ºè¿™é‡Œåªæ˜¯åšäº†ç®€å•çš„äº†è§£ã€‚
    * 
    * */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>

    <span class="c1">// io_uring_setup è¿”å›å€¼å°†ç”¨äºè°ƒç”¨ mmap å°†ä¸¤ä¸ªç¯ç¼“å†²åŒºå’Œä¸€ç»„æäº¤é˜Ÿåˆ—æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´</span>
    <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span> <span class="o">=</span> <span class="n">io_uring_setup</span><span class="p">(</span><span class="n">QUEUE_DEPTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"io_uring_setup"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*
    * io_uring é€šè¿‡ä¸¤ä¸ª kernel-user å…±äº«ç©ºé—´å½¢æˆç¯å½¢ç¼“å†²åŒºé€šä¿¡ã€‚åœ¨æœ€è¿‘çš„å†…æ ¸ä¸­ï¼Œå¯ä»¥ç”¨ mmap() è°ƒç”¨æ¥
    * è”åˆæ˜ å°„è¿™ä¸ªç¯å½¢ç¼“å†²åŒºã€‚åœ¨ç›´æ¥æ“ä½œå®Œæˆé˜Ÿåˆ—æ—¶ï¼Œæäº¤é˜Ÿåˆ—æœ‰ä¸€ä¸ªä»‹äºä¸¤è€…ä¹‹é—´çš„é—´æ¥æ•°ç»„ã€‚æˆ‘ä»¬æŠŠå®ƒä¹Ÿæ˜ å°„è¿›å»ã€‚
    * */</span>

    <span class="kt">int</span> <span class="n">sring_sz</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">array</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">cring_sz</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_off</span><span class="p">.</span><span class="n">cqes</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring_cqe</span><span class="p">);</span>

    <span class="cm">/* 
    * åœ¨å†…æ ¸ç‰ˆæœ¬ 5.4 åŠä»¥ä¸Šï¼Œå¯èƒ½ä½¿ç”¨ä¸€ä¸ª mmap()  æ¥æ˜ å°„ completion ç¼“å†²åŒºå’Œ submissionç¼“å†²åŒº.
    * å¦‚æœå»æ£€æµ‹å†…æ ¸ç‰ˆæœ¬è¿˜ä¸å¦‚ç›´æ¥ä½¿ç”¨ io_uring_params ç»“æ„çš„ç‰¹å¾å­—æ®µï¼Œè¿™æ˜¯ä¸€ä¸ªä½æ©ç ã€‚å¦‚æœè®¾ç½®äº† IORING_FEAT_SINGLE_MMAP 
    * é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä¸ç”¨å†è°ƒç”¨ç¬¬äºŒä¸ªmmap()æ¥æ˜ å°„ CQ ringã€‚
    * */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">IORING_FEAT_SINGLE_MMAP</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cring_sz</span> <span class="o">&gt;</span> <span class="n">sring_sz</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sring_sz</span> <span class="o">=</span> <span class="n">cring_sz</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">cring_sz</span> <span class="o">=</span> <span class="n">sring_sz</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* 
    * submission é˜Ÿåˆ—å’Œ completion é˜Ÿåˆ—å¯ä»¥æ˜ å°„åˆ° ring ç¼“å†²åŒºï¼Œä½†æ˜¯è€ç‰ˆæœ¬çš„å†…æ ¸åªèƒ½æ˜ å°„åˆ°é˜Ÿåˆ—ä¸­ã€‚
    * */</span>
    <span class="n">sq_ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sring_sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
            <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="n">IORING_OFF_SQ_RING</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sq_ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">IORING_FEAT_SINGLE_MMAP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cq_ptr</span> <span class="o">=</span> <span class="n">sq_ptr</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* åœ¨æ—§çš„å†…æ ¸ä¸­åˆ†åˆ«æ˜ å°„å®Œæˆé˜Ÿåˆ—ç¯ç¼“å†²åŒº */</span>
        <span class="n">cq_ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cring_sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
                <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="n">IORING_OFF_CQ_RING</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cq_ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/*  å°†æœ‰ç”¨çš„å­—æ®µä¿å­˜åœ¨å…¨å±€app_io_sq_ringç»“æ„ä¸­ï¼Œä»¥ä¾¿ä»¥åæ–¹ä¾¿åœ°å¼•ç”¨*/</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">sq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">sq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">ring_mask</span> <span class="o">=</span> <span class="n">sq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">ring_mask</span><span class="p">;</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">ring_entries</span> <span class="o">=</span> <span class="n">sq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">ring_entries</span><span class="p">;</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">sq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">array</span> <span class="o">=</span> <span class="n">sq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_off</span><span class="p">.</span><span class="n">array</span><span class="p">;</span>

    <span class="cm">/* æ˜ å°„åˆ°æäº¤é˜Ÿåˆ—æ¡ç›®æ•°ç»„ä¸­ */</span>
    <span class="n">s</span><span class="o">-&gt;</span><span class="n">sqes</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring_sqe</span><span class="p">),</span>
            <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="n">IORING_OFF_SQES</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sqes</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* å°†æœ‰ç”¨çš„å­—æ®µä¿å­˜åœ¨å…¨å±€çš„app_io_cq_ringç»“æ„ä¸­ï¼Œä»¥ä¾¿ä»¥åæ–¹ä¾¿åœ°å¼•ç”¨ */</span>
    <span class="n">cring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">cq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_off</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
    <span class="n">cring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">cq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_off</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
    <span class="n">cring</span><span class="o">-&gt;</span><span class="n">ring_mask</span> <span class="o">=</span> <span class="n">cq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_off</span><span class="p">.</span><span class="n">ring_mask</span><span class="p">;</span>
    <span class="n">cring</span><span class="o">-&gt;</span><span class="n">ring_entries</span> <span class="o">=</span> <span class="n">cq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_off</span><span class="p">.</span><span class="n">ring_entries</span><span class="p">;</span>
    <span class="n">cring</span><span class="o">-&gt;</span><span class="n">cqes</span> <span class="o">=</span> <span class="n">cq_ptr</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">cq_off</span><span class="p">.</span><span class="n">cqes</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
* å°†é•¿åº¦ä¸ºlençš„å­—ç¬¦ä¸²è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ç¼“å†²è¾“å‡ºä»¥æé«˜æ•ˆç‡ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦é€å­—ç¬¦è¾“å‡ºã€‚
* */</span>
<span class="kt">void</span> <span class="nf">output_to_console</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fputc</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*
* ä» completion é˜Ÿåˆ—è¯»å–ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä» completion é˜Ÿåˆ—ä¸­è¯»å–å®Œæˆäº‹ä»¶ï¼Œ
* è·å–åŒ…å«æ–‡ä»¶æ•°æ®çš„æ•°æ®ç¼“å†²åŒºï¼Œå¹¶å°†å…¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚
* */</span>

<span class="kt">void</span> <span class="nf">read_from_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">submitter</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">file_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">app_io_cq_ring</span> <span class="o">*</span><span class="n">cring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cq_ring</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">head</span><span class="p">,</span> <span class="n">reaped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">head</span> <span class="o">=</span> <span class="o">*</span><span class="n">cring</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="n">read_barrier</span><span class="p">();</span>
        <span class="cm">/*
        * è®°ä½ï¼Œè¿™æ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºã€‚å¦‚æœhead == tailï¼Œåˆ™è¡¨ç¤ºç¼“å†²åŒºä¸ºç©ºã€‚
        * */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">==</span> <span class="o">*</span><span class="n">cring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="cm">/* è·å–ä¸€ä¸ªæ¡ç›® */</span>
        <span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cring</span><span class="o">-&gt;</span><span class="n">cqes</span><span class="p">[</span><span class="n">head</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cq_ring</span><span class="p">.</span><span class="n">ring_mask</span><span class="p">];</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file_info</span><span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">)));</span>

        <span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">file_sz</span> <span class="o">/</span> <span class="n">BLOCK_SZ</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">file_sz</span> <span class="o">%</span> <span class="n">BLOCK_SZ</span><span class="p">)</span> <span class="n">blocks</span><span class="o">++</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">output_to_console</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

        <span class="n">head</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="o">*</span><span class="n">cring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
    <span class="n">write_barrier</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*
* æäº¤åˆ° submission é˜Ÿåˆ—.
* åœ¨è¿™ä¸ªæ–¹æ³•, æˆ‘ä»¬æäº¤è¯·æ±‚åˆ° submission é˜Ÿåˆ—. 
* æ‚¨å¯ä»¥æäº¤å¤šç§ç±»å‹çš„è¯·æ±‚ã€‚æˆ‘ä»¬çš„å°†æ˜¯readv()è¯·æ±‚ï¼Œæˆ‘ä»¬é€šè¿‡IORING_OP_READVæ¥æŒ‡å®šã€‚
*
* */</span>
<span class="kt">int</span> <span class="nf">submit_to_sq</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file_path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">submitter</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">file_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">file_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file_fd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">app_io_sq_ring</span> <span class="o">*</span><span class="n">sring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sq_ring</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">current_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">next_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">off_t</span> <span class="n">file_sz</span> <span class="o">=</span> <span class="n">get_file_size</span><span class="p">(</span><span class="n">file_fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file_sz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">off_t</span> <span class="n">bytes_remaining</span> <span class="o">=</span> <span class="n">file_sz</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">file_sz</span> <span class="o">/</span> <span class="n">BLOCK_SZ</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file_sz</span> <span class="o">%</span> <span class="n">BLOCK_SZ</span><span class="p">)</span> <span class="n">blocks</span><span class="o">++</span><span class="p">;</span>

    <span class="n">fi</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fi</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">)</span> <span class="o">*</span> <span class="n">blocks</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fi</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fi</span><span class="o">-&gt;</span><span class="n">file_sz</span> <span class="o">=</span> <span class="n">file_sz</span><span class="p">;</span>

    <span class="cm">/*
    * å¯¹äºéœ€è¦è¯»å–çš„æ¯ä¸ªæ–‡ä»¶å—ï¼Œæˆ‘ä»¬åˆ†é…ä¸€ä¸ªiovecç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“è¢«ç´¢å¼•åˆ°iovecsæ•°ç»„ä¸­ã€‚
    * æ­¤æ•°ç»„ä½œä¸ºæäº¤çš„ä¸€éƒ¨åˆ†ä¼ å…¥ã€‚å¦‚æœæ‚¨ä¸ç†è§£è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦æŸ¥çœ‹readv()å’Œwritev()ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
    * */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">bytes_remaining</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">off_t</span> <span class="n">bytes_to_read</span> <span class="o">=</span> <span class="n">bytes_remaining</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes_to_read</span> <span class="o">&gt;</span> <span class="n">BLOCK_SZ</span><span class="p">)</span>
            <span class="n">bytes_to_read</span> <span class="o">=</span> <span class="n">BLOCK_SZ</span><span class="p">;</span>

        <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">current_block</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">bytes_to_read</span><span class="p">;</span>

        <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">posix_memalign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">BLOCK_SZ</span><span class="p">,</span> <span class="n">BLOCK_SZ</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"posix_memalign"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">current_block</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

        <span class="n">current_block</span><span class="o">++</span><span class="p">;</span>
        <span class="n">bytes_remaining</span> <span class="o">-=</span> <span class="n">bytes_to_read</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* å°†æˆ‘ä»¬çš„ submission é˜Ÿåˆ—æ¡ç›®æ·»åŠ åˆ°SQE ringç¼“å†²åŒºçš„å°¾éƒ¨ */</span>
    <span class="n">next_tail</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">=</span> <span class="o">*</span><span class="n">sring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
    <span class="n">next_tail</span><span class="o">++</span><span class="p">;</span>
    <span class="n">read_barrier</span><span class="p">();</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sq_ring</span><span class="p">.</span><span class="n">ring_mask</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sqes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">file_fd</span><span class="p">;</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">IORING_OP_READV</span><span class="p">;</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">;</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">;</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">user_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fi</span><span class="p">;</span>
    <span class="n">sring</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="n">next_tail</span><span class="p">;</span>

    <span class="cm">/* æ›´æ–°å°¾éƒ¨ä»¥ä¾¿å†…æ ¸èƒ½å¤Ÿçœ‹åˆ°å®ƒ. */</span>
    <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">!=</span> <span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">sring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
        <span class="n">write_barrier</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/*
    * ç”¨io_uring_enter()ç³»ç»Ÿè°ƒç”¨å‘Šè¯‰å†…æ ¸æˆ‘ä»¬å·²ç»æäº¤äº†äº‹ä»¶ã€‚
    * æˆ‘ä»¬è¿˜ä¼ é€’äº†IOURING_ENTER_GETEVENTSæ ‡å¿—ï¼Œ
    * å®ƒä½¿io_uring_enter()è°ƒç”¨ç­‰åˆ°min_completeäº‹ä»¶ï¼ˆç¬¬3ä¸ªå‚æ•°ï¼‰å®Œæˆã€‚
    * */</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span>  <span class="n">io_uring_enter</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">IORING_ENTER_GETEVENTS</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"io_uring_enter"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">submitter</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Usage: %s &lt;filename&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"malloc"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span><span class="n">app_setup_uring</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Unable to setup uring!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">submit_to_sq</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error reading file</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">read_from_cq</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="è§£é‡Š">è§£é‡Š</h2>
<p>è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶ä»£ç ä¸­ç‰¹å®šçš„ã€é‡è¦çš„é¢†åŸŸï¼Œçœ‹çœ‹è¿™ä¸ªç¤ºä¾‹ç¨‹åºæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<h2 id="åˆå§‹åŒ–è®¾ç½®">åˆå§‹åŒ–è®¾ç½®</h2>

<p>åœ¨ <strong>main()</strong> ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ <strong>app_setup_uring()</strong> ï¼Œå®ƒå®Œæˆäº†æˆ‘ä»¬ä½¿ç”¨ <strong>io_uring</strong> æ‰€éœ€çš„åˆå§‹åŒ–å·¥ä½œã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è°ƒç”¨ <strong>io_uring_setup()</strong> ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æˆ‘ä»¬éœ€è¦çš„é˜Ÿåˆ—æ·±åº¦å’Œç»“æ„ <strong>io_uring_params</strong> çš„å®ä¾‹å…¨éƒ¨è®¾ç½®ä¸º0ã€‚å½“è°ƒç”¨è¿”å›æ—¶ï¼Œå†…æ ¸å°†å¡«å……è¿™ä¸ªç»“æ„æˆå‘˜ä¸­çš„å€¼ã€‚è¿™å°±æ˜¯ <strong>io_uring_params</strong> çš„æ ·å­ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">io_uring_params</span> <span class="p">{</span>
  <span class="n">__u32</span> <span class="n">sq_entries</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">cq_entries</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">sq_thread_cpu</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">sq_thread_idle</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">resv</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">io_sqring_offsets</span> <span class="n">sq_off</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">io_cqring_offsets</span> <span class="n">cq_off</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<p>åœ¨å°†è¿™ä¸ªç»“æ„ä½œä¸º <strong><code class="language-plaintext highlighter-rouge">io_uring_setup ()</code></strong>ç³»ç»Ÿè°ƒç”¨çš„ä¸€éƒ¨åˆ†ä¼ é€’ä¹‹å‰ï¼Œæ‚¨å”¯ä¸€å¯ä»¥æŒ‡å®šçš„æ˜¯ flags ç»“æ„æˆå‘˜ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ
æˆ‘ä»¬ä¸æƒ³ä¼ é€’ä»»ä½• flag ã€‚æ­¤å¤–ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¤„ç†æ–‡ä»¶ã€‚æˆ‘ä»¬ä¸æ‰“ç®—åšä»»ä½•å¹¶è¡Œ i/oï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¸»è¦æ˜¯ä¸ºäº†äº†è§£ io_uring çš„åŸå§‹æ¥å£ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†é˜Ÿåˆ—æ·±åº¦è®¾ç½®ä¸º1ã€‚</p>

<p>æ¥è‡ª <strong><code class="language-plaintext highlighter-rouge">io_uring_setup ()</code></strong> çš„è¿”å›å€¼ã€æ–‡ä»¶æè¿°ç¬¦å’Œ <strong>io_uring_param</strong> ç»“æ„ä¸­çš„å…¶ä»–å­—æ®µéšåå°†ç”¨äºè°ƒç”¨ <a href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2)</a>ä»¥å°†ä¸¤ä¸ªç¯ç¼“å†²åŒºå’Œä¸€ç»„æäº¤é˜Ÿåˆ—æ¡ç›®æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚çœ‹çœ‹å§ã€‚æˆ‘å·²ç»åˆ é™¤äº†ä¸€äº›å‘¨å›´çš„ä»£ç ï¼Œä»¥ä¾¿å°†é‡ç‚¹æ”¾åœ¨ <a href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2)</a> è°ƒç”¨ä¸Šã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* submission å’Œ completion é˜Ÿåˆ—ä¸­æ˜ å°„ç¯å½¢ç¼“å†²åŒº.
 * ä¸è¿‡æ—§çš„å†…æ ¸åªåœ¨æäº¤é˜Ÿåˆ—ä¸­æ˜ å°„ã€‚
 * */</span>
<span class="n">sq_ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sring_sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
        <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span>
        <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="n">IORING_OFF_SQ_RING</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sq_ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">IORING_FEAT_SINGLE_MMAP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cq_ptr</span> <span class="o">=</span> <span class="n">sq_ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="cm">/* åœ¨æ—§å†…æ ¸ä¸­å•ç‹¬æ˜ å°„å®Œæˆé˜Ÿåˆ—ç¯å½¢ç¼“å†²åŒº */</span>
    <span class="n">cq_ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cring_sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
            <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="n">IORING_OFF_CQ_RING</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cq_ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* æ˜ å°„åˆ°æäº¤é˜Ÿåˆ—æ¡ç›®æ•°ç»„ä¸­ */</span>
<span class="n">s</span><span class="o">-&gt;</span><span class="n">sqes</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">sq_entries</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring_sqe</span><span class="p">),</span>
        <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span><span class="p">,</span>
        <span class="n">s</span><span class="o">-&gt;</span><span class="n">ring_fd</span><span class="p">,</span> <span class="n">IORING_OFF_SQES</span><span class="p">);</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å°†é‡è¦çš„ç»†èŠ‚ä¿å­˜åœ¨ <strong><code class="language-plaintext highlighter-rouge">app_io_sq_ring</code></strong> å’Œ <strong><code class="language-plaintext highlighter-rouge">app_io_cq_ring</code></strong> ä¸­ï¼Œä»¥ä¾¿ä»¥åå‚è€ƒã€‚
å½“æˆ‘ä»¬å°†ä¸¤ä¸ªç¯ç¼“å†²åŒºåˆ†åˆ«æ˜ å°„ä¸ºæäº¤å’Œå®Œæˆæ—¶ï¼Œæ‚¨å¯èƒ½æƒ³çŸ¥é“ç¬¬ä¸‰ä¸ªæ˜ å°„æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ã€‚
å®Œæˆé˜Ÿåˆ—ç¯ç›´æ¥å¯¹ CQEs çš„å…±äº«æ•°ç»„å»ºç«‹ç´¢å¼•ï¼Œè€Œæäº¤ç¯åœ¨ä¸¤è€…ä¹‹é—´æœ‰ä¸€ä¸ªé—´æ¥æ•°ç»„ã€‚
æäº¤ç«¯ç¯å½¢ç¼“å†²åŒºæ˜¯è¯¥æ•°ç»„çš„ç´¢å¼•ï¼Œè¯¥æ•°ç»„åˆåŒ…å« SQEs ä¸­çš„ç´¢å¼•ã€‚è¿™å¯¹äºå°†æäº¤è¯·æ±‚åµŒå…¥å†…éƒ¨æ•°æ®ç»“æ„çš„æŸäº›åº”ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚
è¿™ç§è®¾ç½®å…è®¸ä»–ä»¬ä¸€æ¬¡æäº¤å¤šä¸ªæäº¤æ¡ç›®ï¼ŒåŒæ—¶å…è®¸ä»–ä»¬æ›´å®¹æ˜“åœ°é‡‡ç”¨io_uringã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># æ³¨æ„
åœ¨å†…æ ¸ç‰ˆæœ¬5.4åŠä»¥ä¸Šï¼Œå•ä¸ª mmap (2)æ˜ å°„æäº¤é˜Ÿåˆ—å’Œå®Œæˆé˜Ÿåˆ—ã€‚ç„¶è€Œï¼Œåœ¨è¾ƒè€çš„å†…æ ¸ä¸­ï¼Œ
å®ƒä»¬éœ€è¦å•ç‹¬æ˜ å°„ã€‚ä¸æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ä¸åŒï¼Œ
æ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥ IORING_FEAT_SINGLE_MMAP  åŠŸèƒ½æ ‡å¿—æ¥æ£€æŸ¥å†…æ ¸ä½¿ç”¨ä¸€ä¸ª mmap (2)æ˜ å°„ä¸¤ä¸ªé˜Ÿåˆ—çš„èƒ½åŠ›ï¼Œå°±åƒæˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç ä¸­æ‰€åšçš„é‚£æ ·ã€‚

# å‚è€ƒ
- [io_uring_setup](https://unixism.net/loti/ref-iouring/io_uring_setup.html#io-uring-setup)
</code></pre></div></div>

<h2 id="å¤„ç†å…±äº«-ring-ç¼“å†²å™¨">å¤„ç†å…±äº« ring ç¼“å†²å™¨</h2>

<p>åœ¨å¸¸è§„ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºå¤„ç†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ä¹‹é—´éå¸¸æ¸…æ™°çš„æ¥å£: ç³»ç»Ÿè°ƒç”¨ã€‚ç„¶è€Œï¼Œ
ç³»ç»Ÿè°ƒç”¨ç¡®å®æœ‰æˆæœ¬ï¼Œå¯¹äºåƒ <strong>io_uring</strong> è¿™æ ·çš„é«˜æ€§èƒ½æ¥å£ï¼Œå¸Œæœ›å°½å¯èƒ½å»æ‰ç³»ç»Ÿè°ƒç”¨ã€‚
æˆ‘ä»¬åœ¨å‰é¢çœ‹åˆ°ï¼Œä¸é€šå¸¸çš„å¤šä¸ªç³»ç»Ÿè°ƒç”¨ä¸åŒï¼Œä½¿ç”¨ io_uring 
å…è®¸æˆ‘ä»¬æ‰¹å¤„ç†å¤šä¸ª i/o è¯·æ±‚ï¼Œå¹¶å¯¹ <strong><code class="language-plaintext highlighter-rouge">[io_uring_enter ()](https://unixism.net/loti/ref-iouring/io_uring_enter.html#c.io_uring_enter)</code></strong> ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå•ä¸ªè°ƒç”¨ã€‚æˆ–è€…åœ¨<a href="https://unixism.net/loti/tutorial/sq_poll.html#sq-poll">è½®è¯¢æ¨¡å¼</a>ä¸‹ï¼Œç”šè‡³ä¸éœ€è¦è°ƒç”¨ã€‚</p>

<p>å½“ä»ç”¨æˆ·ç©ºé—´è¯»å–æˆ–æ›´æ–°å…±äº« ring ç¼“å†²åŒºæ—¶ï¼Œéœ€è¦æ³¨æ„ä¸€äº›äº‹é¡¹ï¼Œä»¥ç¡®ä¿åœ¨è¯»å–æ—¶çœ‹åˆ°æœ€æ–°çš„æ•°æ®ï¼Œ
å¹¶åœ¨æ›´æ–°ä¹‹åâ€œåˆ·æ–°â€æˆ–â€œåŒæ­¥â€å†™æ“ä½œï¼Œä»¥ä¾¿å†…æ ¸çœ‹åˆ°æ‚¨çš„æ›´æ–°ã€‚è¿™æ˜¯å› ä¸º CPU å¯ä»¥é‡æ–°å®‰æ’è¯»å†™é¡ºåºï¼Œ
ç¼–è¯‘å™¨ä¹Ÿå¯ä»¥ã€‚å½“è¯»å†™æ“ä½œå‘ç”Ÿåœ¨åŒä¸€ä¸ª CPU ä¸Šæ—¶ï¼Œè¿™é€šå¸¸ä¸æ˜¯é—®é¢˜ã€‚ä½†æ˜¯åœ¨ <strong><code class="language-plaintext highlighter-rouge">io_uring</code></strong> çš„æƒ…å†µä¸‹ï¼Œ
å½“ä¸€ä¸ªå…±äº«ç¼“å†²åŒºæ¶‰åŠåˆ°ä¸¤ä¸ªä¸åŒçš„ä¸Šä¸‹æ–‡: ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ï¼Œå¹¶ä¸”å®ƒä»¬åœ¨ä¸Šä¸‹æ–‡
åˆ‡æ¢ä¹‹åå¯ä»¥åœ¨ä¸åŒçš„ cpu ä¸Šè¿è¡Œã€‚æ‚¨éœ€è¦ç¡®ä¿ä»ç”¨æˆ·ç©ºé—´è¯»å–ä¹‹å‰ï¼Œå…ˆå‰çš„å†™æ“ä½œæ˜¯å¯è§çš„ã€‚
æˆ–è€…ï¼Œå½“æ‚¨åœ¨ SQE ä¸­å¡«å……ç»†èŠ‚å¹¶æ›´æ–°æäº¤ç¼“å†²åŒºçš„å°¾éƒ¨æ—¶ï¼Œæ‚¨å¸Œæœ›ç¡®ä¿åœ¨æ›´æ–°ç¯ç¼“å†²åŒºå°¾éƒ¨çš„å†™å…¥ä¹‹å‰ï¼Œ
å¯¹ SQE æˆå‘˜è¿›è¡Œçš„å†™å…¥æ˜¯æœ‰åºçš„ã€‚å¦‚æœè¿™äº›å†™æ“ä½œæ²¡æœ‰è¢«æ’åºï¼Œå†…æ ¸å¯èƒ½ä¼šçœ‹åˆ°å°¾éƒ¨è¢«æ›´æ–°ï¼Œ
ä½†æ˜¯å½“å®ƒè¯»å– SQE æ—¶ï¼Œå®ƒå¯èƒ½æ— æ³•åœ¨è¯»å– SQE æ—¶æ‰¾åˆ°æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚åœ¨è½®è¯¢æ¨¡å¼ä¸­ï¼Œ
å†…æ ¸æ­£åœ¨æŸ¥æ‰¾å¯¹å°¾éƒ¨çš„æ›´æ”¹ï¼Œè¿™å°±æˆäº†ä¸€ä¸ªçœŸæ­£çš„é—®é¢˜ã€‚
è¿™éƒ½æ˜¯å› ä¸º cpu å’Œç¼–è¯‘å™¨ä¸ºäº†ä¼˜åŒ–è€Œå¯¹è¯»å†™è¿›è¡Œé‡æ–°æ’åºã€‚</p>

<h2 id="è¯»å–å®Œæˆé˜Ÿåˆ—æ¡ç›®">è¯»å–å®Œæˆé˜Ÿåˆ—æ¡ç›®</h2>

<p>ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘ä»¬é¦–å…ˆå¤„ç†äº‹æƒ…çš„å®Œæˆæ–¹é¢ï¼Œå› ä¸ºå®ƒæ¯”æäº¤æ–¹é¢æ›´ç®€å•ã€‚
è¿™äº›è§£é‡Šç”šè‡³æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è®¨è®ºå†…å­˜çš„é¡ºåºå’Œæˆ‘ä»¬éœ€è¦å¦‚ä½•å¤„ç†å®ƒã€‚
å¦åˆ™ï¼Œæˆ‘ä»¬åªæƒ³çœ‹çœ‹å¦‚ä½•å¤„ç†ç¯å½¢ç¼“å†²åŒºã€‚å¯¹äºå®Œæˆäº‹ä»¶ï¼Œå†…æ ¸å°† CQEs æ·»åŠ åˆ°å¾ªç¯ç¼“å†²åŒºå¹¶æ›´æ–°å°¾éƒ¨ï¼Œ
è€Œæˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´ä¸­ä»å¤´éƒ¨è¯»å–ã€‚åœ¨ä»»ä½•ç¯å½¢ç¼“å†²åŒºä¸­ï¼Œå¦‚æœå¤´éƒ¨å’Œå°¾éƒ¨ç›¸ç­‰ï¼Œåˆ™è¡¨ç¤ºç¯å½¢ç¼“å†²åŒºä¸ºç©ºã€‚çœ‹çœ‹ä¸‹é¢çš„ä»£ç :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="n">head</span><span class="p">;</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">cqring</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
<span class="n">read_barrier</span><span class="p">();</span> <span class="cm">/* ç¡®ä¿ä»¥å‰çš„å†™å…¥å¯è§ */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="n">cqring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* ç¯å½¢ç¼“å†²åŒºä¸­æœ‰å¯ç”¨çš„æ•°æ® */</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">index</span><span class="p">;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">head</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cqring</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
    <span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cqring</span><span class="o">-&gt;</span><span class="n">cqes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="cm">/* åœ¨æ­¤å¤„å®Œæˆcqeè¿‡ç¨‹ */</span>
     <span class="p">...</span>
    <span class="cm">/* æˆ‘ä»¬ç°åœ¨å·²ç»æ¶ˆè€—äº†è¿™ä¸€é¡¹ */</span>
    <span class="n">head</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">cqring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="n">write_barrier</span><span class="p">();</span>
</code></pre></div></div>

<p>ä¸ºäº†å¾—åˆ°å¤´éƒ¨çš„ç´¢å¼•ï¼Œåº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºçš„å¤§å°æ©ç æ¥æ©ç å¤´éƒ¨ã€‚è¯·è®°ä½ï¼Œ
ä¸Šé¢ä»£ç ä¸­çš„ä»»ä½•ä¸€è¡Œéƒ½å¯èƒ½åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹‹åè¿è¡Œã€‚å› æ­¤ï¼Œåœ¨æ¯”è¾ƒä¹‹å‰ï¼Œ
æˆ‘ä»¬æœ‰ä¸€ä¸ª <strong><code class="language-plaintext highlighter-rouge">read_barrier()</code></strong> ï¼Œè¿™æ ·ï¼Œå¦‚æœå†…æ ¸ç¡®å®æ›´æ–°äº†å°¾éƒ¨ï¼Œ
æˆ‘ä»¬å¯ä»¥åœ¨ if è¯­å¥ä¸­å°†å…¶ä½œä¸ºæ¯”è¾ƒçš„ä¸€éƒ¨åˆ†æ¥è¯»å–ã€‚ä¸€æ—¦æˆ‘ä»¬è·å¾—äº† CQE å¹¶å¤„ç†å®ƒï¼Œ
æˆ‘ä»¬å°±æ›´æ–° headï¼Œè®©å†…æ ¸çŸ¥é“æˆ‘ä»¬å·²ç»ä½¿ç”¨äº†æ¥è‡ª ring ç¼“å†²åŒºçš„æ¡ç›®ã€‚æœ€åä¸€ä¸ª <strong><code class="language-plaintext highlighter-rouge">write_barrier()</code></strong>ç¡®ä¿æˆ‘ä»¬çš„å†™æ“ä½œå¯è§ï¼Œè¿™æ ·å†…æ ¸å°±å¯ä»¥çŸ¥é“å®ƒã€‚</p>

<h2 id="æäº¤-submission">æäº¤ submission</h2>

<p>åšä¸€ä¸ªæäº¤å’Œè¯»å–ä¸€ä¸ªå®Œæˆæ˜¯ç›¸åçš„ã€‚åœ¨å¤„ç† completion æ—¶ï¼Œå†…æ ¸å°†æ¡ç›®æ·»åŠ åˆ°å°¾éƒ¨ï¼Œ
æˆ‘ä»¬ä»å¾ªç¯ç¼“å†²åŒºçš„å¤´éƒ¨è¯»å–æ¡ç›®ï¼Œå½“ submission æ—¶ï¼Œæˆ‘ä»¬æ·»åŠ åˆ°å°¾éƒ¨ï¼Œå†…æ ¸ä»å¾ªç¯ç¼“å†²åŒºçš„å¤´éƒ¨è¯»å–æ¡ç›®ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="n">tail</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
<span class="n">tail</span> <span class="o">=</span> <span class="n">sqring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">sqring</span><span class="o">-&gt;</span><span class="n">ring_mask</span><span class="p">);</span>
<span class="n">sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sqring</span><span class="o">-&gt;</span><span class="n">sqes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="cm">/* æ­¤å‡½æ•°è°ƒç”¨å¡«å†™æ­¤IOè¯·æ±‚çš„SQEè¯¦ç»†ä¿¡æ¯ */</span>
<span class="n">app_init_io</span><span class="p">(</span><span class="n">sqe</span><span class="p">);</span>
<span class="cm">/* å°†SQEç´¢å¼•å¡«å……åˆ°SQç¯æ•°ç»„ä¸­ */</span>
<span class="n">sqring</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
<span class="n">tail</span><span class="o">++</span><span class="p">;</span>
<span class="n">write_barrier</span><span class="p">();</span>
<span class="n">sqring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
<span class="n">write_barrier</span><span class="p">();</span>
</code></pre></div></div>

<p>åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œåº”ç”¨ç¨‹åºä¸­çš„ <strong><code class="language-plaintext highlighter-rouge">app_init_io()</code></strong> å‡½æ•°å°†å¡«å……æäº¤è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ã€‚åœ¨å°¾éƒ¨æ›´æ–°ä¹‹å‰ï¼Œ
æˆ‘ä»¬æœ‰ä¸€ä¸ª <strong><code class="language-plaintext highlighter-rouge">write_barrier()</code></strong> æ¥ç¡®ä¿å‰é¢çš„å†™æ“ä½œæ˜¯æœ‰åºçš„ã€‚ç„¶åæˆ‘ä»¬æ›´æ–° tail å¹¶å†æ¬¡è°ƒç”¨ <strong><code class="language-plaintext highlighter-rouge">write_barrier()</code></strong> ä»¥ç¡®ä¿æˆ‘ä»¬çš„æ›´æ–°è¢«çœ‹åˆ°ã€‚æˆ‘ä»¬åœ¨è¿™é‡ŒæŒ‰ç…§æ­£ç¡®çš„é¡ºåºå¤„ç†ã€‚</p>

<h2 id="æºä»£ç ">æºä»£ç </h2>
<p>æœ¬æ–‡æ¡£ä¸­çš„ä»£ç å’Œå…¶ä»–ç¤ºä¾‹å¯ä»¥åœ¨è¿™ä¸ª <a href="https://github.com/shuveb/loti-examples">Github</a> å­˜å‚¨åº“ä¸­æ‰¾åˆ°ã€‚</p>

<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<ul>
  <li><a href="https://unixism.net/loti/low_level.html">The Low-level io_uring Interface</a></li>
  <li><a href="https://kernel.dk/io_uring.pdf">Efficient IO with io_uring PDF</a></li>
  <li><a href="https://github.com/axboe/liburing">Efficient IO with io_uring github</a></li>
</ul>
:ET