I"„r<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1>

<p><code class="language-plaintext highlighter-rouge">kube-proxy</code> æ˜¯è´Ÿè´£ k8s é›†ç¾¤å†…é€šä¿¡è§„åˆ™åˆ›å»ºçš„ç»„å»ºï¼Œk8s å®˜æ–¹æ–‡æ¡£è§£é‡Š</p>

<blockquote>
  <p>Kubernetes ç½‘ç»œä»£ç†åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ç½‘ç»œä»£ç†åæ˜ äº†æ¯ä¸ªèŠ‚ç‚¹ä¸Š Kubernetes API ä¸­å®šä¹‰çš„æœåŠ¡ï¼Œ
å¹¶ä¸”å¯ä»¥æ‰§è¡Œç®€å•çš„ TCPã€UDP å’Œ SCTP æµè½¬å‘ï¼Œæˆ–è€…åœ¨ä¸€ç»„åç«¯è¿›è¡Œ å¾ªç¯ TCPã€UDP å’Œ SCTP è½¬å‘ã€‚</p>
</blockquote>

<p>ä½†æ˜¯ kube-proxy æœ¬èº«å¹¶ä¸è´Ÿè´£æµé‡è½¬å‘ç­‰å·¥ä½œã€‚</p>

<h1 id="åŸç†">åŸç†</h1>

<p><code class="language-plaintext highlighter-rouge">kube-proxy</code> çš„å·¥ä½œå°±æ˜¯ <code class="language-plaintext highlighter-rouge">watch</code> APIServer ä¸­çš„ <code class="language-plaintext highlighter-rouge">svc</code> å’Œ <code class="language-plaintext highlighter-rouge">endpoint</code> çš„åˆ›å»ºã€‚åœ¨ <code class="language-plaintext highlighter-rouge">watch</code> åˆ°
åç«¯æœ‰ç›¸åº”çš„ <code class="language-plaintext highlighter-rouge">svc</code> å’Œ <code class="language-plaintext highlighter-rouge">Endpoint</code>åˆ›å»ºä¹‹åä¼šåœ¨å½“å‰èŠ‚ç‚¹åˆ›å»ºç›¸åº”çš„è§„åˆ™ï¼Œå¦‚æœå½“å‰é€šä¿¡æœºåˆ¶ä½¿ç”¨çš„æ˜¯ <code class="language-plaintext highlighter-rouge">iptables</code>
é‚£ä¹ˆä¹…åˆ›å»ºç›¸åº”çš„ <code class="language-plaintext highlighter-rouge">iptables rules</code> ã€‚å¦‚æœé€šä¿¡ç»„ä»¶ä½¿ç”¨çš„æ˜¯ <code class="language-plaintext highlighter-rouge">ipvs</code> é‚£ä¹ˆä¹…åˆ›å»ºç›¸åº”çš„ <code class="language-plaintext highlighter-rouge">ipvs</code> è§„åˆ™ã€‚
ç”¨ä½œæµé‡è½¬å‘å’Œè´Ÿè½½å‡è¡¡ã€‚</p>

<p>å…³äº ipvs ç›¸å…³åŸç†å‚è€ƒï¼š<a href="https://xie.infoq.cn/article/89e58c81cd2b1f13a5a847445">https://xie.infoq.cn/article/89e58c81cd2b1f13a5a847445</a></p>

<p><code class="language-plaintext highlighter-rouge">iptables</code> åŸç†ç›¸å¯¹çš„ç®€å•ï¼Œä½†æ˜¯è§„åˆ™æ¯”è¾ƒå¤æ‚è€Œä¸”å¤šã€‚å°†é’ˆå¯¹æ€§çš„æŒ‘é€‰è¿›è¡Œè§£é‡Šã€‚
éƒ¨ç½² <code class="language-plaintext highlighter-rouge">yaml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.14.2</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>ç°åœ¨æœ‰å¦‚ä¸‹ <code class="language-plaintext highlighter-rouge">svc</code> å’Œ <code class="language-plaintext highlighter-rouge">endpoint</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
nginx        ClusterIP   10.107.122.198   &lt;none&gt;        80/TCP    9d

<span class="nv">$ </span>kubectl get po <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE   IP                NODE    NOMINATED NODE   READINESS GATES
nginx-6fcfb8df58-mw8js   1/1     Running   0          45h   192.168.236.133   k8s02   &lt;none&gt;           &lt;none&gt;
nginx-6fcfb8df58-qqbbd   1/1     Running   0          45h   192.168.236.136   k8s02   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">iptables rules</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å…¥å£é“¾</span>
Chain PREROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target         prot     opt     <span class="nb">source           </span>destination         
KUBE-SERVICES  all      <span class="nt">--</span>    0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> kubernetes service portals <span class="k">*</span>/
<span class="c"># å‡ºå£é“¾</span>
Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target         prot     opt   <span class="nb">source              </span>destination         
KUBE-SERVICES  all      <span class="nt">--</span>    0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> kubernetes service portals <span class="k">*</span>/
<span class="c"># Endpoint è§„åˆ™</span>
Chain KUBE-SEP-UGFJDGWZKFFMLNCL <span class="o">(</span>1 references<span class="o">)</span>
target          prot      opt     <span class="nb">source              </span>destination         
KUBE-MARK-MASQ  all       <span class="nt">--</span>    192.168.236.133       0.0.0.0/0            /<span class="k">*</span> default/nginx: <span class="k">*</span>/
DNAT            tcp       <span class="nt">--</span>    0.0.0.0/0             0.0.0.0/0            /<span class="k">*</span> default/nginx: <span class="k">*</span>/ tcp to:192.168.236.133:80
<span class="c"># Endpoint è§„åˆ™</span>
Chain KUBE-SEP-ATB57SP3HHRBIRYE <span class="o">(</span>1 references<span class="o">)</span>
target          prot      opt     <span class="nb">source              </span>destination         
KUBE-MARK-MASQ  all       <span class="nt">--</span>    192.168.236.136       0.0.0.0/0            /<span class="k">*</span> default/nginx: <span class="k">*</span>/
DNAT            tcp       <span class="nt">--</span>     0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/nginx: <span class="k">*</span>/ tcp to:192.168.236.136:80
<span class="c"># Service è§„åˆ™</span>
Chain KUBE-SERVICES <span class="o">(</span>2 references<span class="o">)</span>
target                      prot    opt   <span class="nb">source              </span>destination     
KUBE-MARK-MASQ              tcp     <span class="nt">--</span>    <span class="o">!</span>192.168.0.0/16      10.107.122.198       /<span class="k">*</span> default/nginx: cluster IP <span class="k">*</span>/ tcp dpt:80
KUBE-SVC-4N57TFCL4MD7ZTDA   tcp     <span class="nt">--</span>    0.0.0.0/0            10.107.122.198       /<span class="k">*</span> default/nginx: cluster IP <span class="k">*</span>/ tcp dpt:80
<span class="c"># Service è´Ÿè½½å‡è¡¡</span>
Chain KUBE-SVC-4N57TFCL4MD7ZTDA <span class="o">(</span>1 references<span class="o">)</span>
target                     prot    opt    <span class="nb">source             </span>destination         
KUBE-SEP-UGFJDGWZKFFMLNCL  all      <span class="nt">--</span>   0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/nginx: <span class="k">*</span>/ statistic mode random probability 0.50000000000
KUBE-SEP-ATB57SP3HHRBIRYE  all      <span class="nt">--</span>   0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/nginx: <span class="k">*</span>/

</code></pre></div></div>

<p>é¦–å…ˆ <code class="language-plaintext highlighter-rouge">iptalbes</code> å¯¹åº”çš„å·¥ä½œæµç¨‹å°±æ˜¯åˆ›å»ºä¸€ä¸ªä¸€ä¸ª <code class="language-plaintext highlighter-rouge">chain</code> æ¥å®ŒæˆæŒ‡å®šçš„å·¥ä½œã€‚</p>

<p>iptables å‘½ä»¤è§„åˆ™å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="o">[</span><span class="nt">-t</span> table] <span class="nb">command</span> <span class="o">[</span>match] <span class="o">[</span>target/jump] 
</code></pre></div></div>
<p>è¡¨æœ‰: <code class="language-plaintext highlighter-rouge">nat</code>ã€<code class="language-plaintext highlighter-rouge">mangle</code>ã€<code class="language-plaintext highlighter-rouge">filter</code>ã€<code class="language-plaintext highlighter-rouge">raw</code></p>

<p>æ ¹æ® <code class="language-plaintext highlighter-rouge">svc</code> å’Œ <code class="language-plaintext highlighter-rouge">Endpoint</code> å’Œå±•ç¤ºå‡ºçš„ <code class="language-plaintext highlighter-rouge">iptables</code> ä¿¡æ¯ã€‚å¯ä»¥å‚è€ƒè§„åˆ™å¦‚ä¸‹ï¼š
æ·»åŠ  <code class="language-plaintext highlighter-rouge">root</code> <strong>Chain</strong>ï¼š<code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code>
å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-N</span> KUBE-SERVICES
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> æ˜¯æ€»é“¾ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">k8s</code> è§„åˆ™é“¾çš„ <code class="language-plaintext highlighter-rouge">root</code>ã€‚ä»è€Œä¹Ÿå°±è¯´æ˜æ‰€æœ‰å‡ºå…¥çš„æµé‡éƒ½éœ€è¦ç»è¿‡å½“å‰ <code class="language-plaintext highlighter-rouge">Chain</code> çš„éå†ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> all <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> KUBE-SERVICES
iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> OUTPUT <span class="nt">-p</span> all <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> KUBE-SERVICES
</code></pre></div></div>

<p>ä»»æ„åè®®ã€ä»»æ„æ¥æºã€ä»»æ„ç›®æ ‡ï¼Œä»»æ„æµé‡åªè¦ä¸å½“å‰èŠ‚ç‚¹æ¥è§¦å°±ä¼šè§¦å‘è·³è½¬ <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> <strong>Chain</strong>ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> ä¸»è¦å°±æ˜¯ä¸ºäº†ä¸ <code class="language-plaintext highlighter-rouge">k8s</code> çš„ <code class="language-plaintext highlighter-rouge">svc</code> æƒ³å¯¹åº”ã€‚æ¯ä¸ª <code class="language-plaintext highlighter-rouge">svc</code> éœ€è¦åˆ›å»ºè‡ªå·±çš„è§„åˆ™ <strong>Chain</strong>ã€‚æ‰€ä»¥é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">nginx</code> <strong>Chain</strong>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-N</span> KUBE-SVC-NGINX
</code></pre></div></div>

<p>é™¤äº† <code class="language-plaintext highlighter-rouge">svc</code> ä¹‹å¤–è¿˜æœ‰ <code class="language-plaintext highlighter-rouge">endpoint</code> åº”ä¸ºå½“å‰ <code class="language-plaintext highlighter-rouge">Endpoint</code> å¯¹å¤–çš„åœ°å€åªé™äºå¯¹å¤–è®¿é—®ï¼Œå¯¹å†…å¹¶ä¸å­˜åœ¨åœ°å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ·»åŠ ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">Endpoint</code> å¯¹åº”çš„
<code class="language-plaintext highlighter-rouge">iptables</code> è§„åˆ™ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-N</span> KUBE-SEP-NGINX-1
iptables <span class="nt">-t</span> nat <span class="nt">-N</span> KUBE-SEP-NGINX-2
</code></pre></div></div>

<p>å±•ç¤ºä¸‹ç›®å‰çš„è§„åˆ™åˆ—è¡¨ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-L</span>  <span class="nt">-t</span> nat <span class="nt">-n</span> 
Chain PREROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-SERVICES  all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0           

Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-SERVICES  all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain KUBE-SEP-NGINX-1 <span class="o">(</span>0 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain KUBE-SEP-NGINX-2 <span class="o">(</span>0 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain KUBE-SERVICES <span class="o">(</span>2 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain KUBE-SVC-NGINX <span class="o">(</span>0 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination 
</code></pre></div></div>

<p>åŸºæœ¬å·®ä¸å¤šæˆå‹äº†ï¼Œåªè¦åœ¨æ¯ä¸ª <strong>Chain</strong> ä¸‹é¢æ·»åŠ å¯¹åº”çš„å®ä¾‹ä¿¡æ¯å³å¯
<code class="language-plaintext highlighter-rouge">KUBE-SEP-NGINX-1</code>ã€<code class="language-plaintext highlighter-rouge">KUBE-SEP-NGINX-2</code> ç›‘å¬å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">IP</code> åœ°å€ï¼Œç„¶åè½¬å‘åˆ°å½“å‰ <code class="language-plaintext highlighter-rouge">Node</code> çš„ <code class="language-plaintext highlighter-rouge">Port</code>ã€‚
ä¸Šæ–¹ <code class="language-plaintext highlighter-rouge">Service</code> è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
  <li>ç›‘å¬ <code class="language-plaintext highlighter-rouge">tcp</code> åè®®</li>
  <li>è®¿é—® <code class="language-plaintext highlighter-rouge">Service</code> Port è½¬å‘è‡³ <code class="language-plaintext highlighter-rouge">Node</code> Port
åˆ†åˆ«æ·»åŠ ï¼š</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># DNAT            tcp       --    0.0.0.0/0             0.0.0.0/0   tcp to:192.168.236.133:80</span>

iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> KUBE-SEP-NGINX-1 <span class="nt">-p</span> tcp <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-m</span> tcp <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> 192.168.236.133:80
iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> KUBE-SEP-NGINX-2 <span class="nt">-p</span> tcp <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-m</span> tcp <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> 192.168.236.136:80
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">KUBE-SEP-NGINX-1</code>ã€<code class="language-plaintext highlighter-rouge">KUBE-SEP-NGINX-2</code> ä¸‹é¢éƒ½æœ‰å®ä¾‹äº†ï¼Œä¸‹é¢åªè¦å®šåˆ¶åœ¨è®¿é—® SVC æ˜¯é‡å®šå‘åˆ° <code class="language-plaintext highlighter-rouge">KUBE-SEP-NGINX-1</code>ã€
<code class="language-plaintext highlighter-rouge">KUBE-SEP-NGINX-2</code> å³å¯ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> KUBE-SVC-NGINX <span class="nt">-p</span> all  <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> KUBE-SEP-NGINX-1
iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> KUBE-SVC-NGINX <span class="nt">-p</span> all  <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> KUBE-SEP-NGINX-2
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">svc</code> çš„è§„åˆ™ä¸‹é¢ä¹Ÿæœ‰å®ä¾‹ï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰è¢«æ·»åŠ åˆ° <code class="language-plaintext highlighter-rouge">root</code> ä¹Ÿå°±æ˜¯ <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> ä¸‹æ— æ³•è¢«éå†åˆ°ï¼Œæ·»åŠ å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat  <span class="nt">-A</span> KUBE-SERVICES <span class="nt">-p</span> tcp <span class="o">!</span> <span class="nt">-s</span> 192.168.0.0/16 <span class="nt">-d</span> 10.107.122.198 <span class="nt">--dport</span> 80 <span class="nt">-j</span> KUBE-SVC-NGINX
</code></pre></div></div>

<p>æœ€ç»ˆè§„åˆ™å¦‚ä¸‹ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>iptables <span class="nt">-L</span> <span class="nt">-n</span> <span class="nt">-t</span> nat

</code></pre></div></div>

<p>å½“ç„¶è¿™é‡Œè¿˜æ²¡æœ‰ç»“æŸï¼Œè¿˜éœ€è¦æ·»åŠ  Mark æ ‡è®°</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-N</span> KUBE-MARK-MASQ
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> KUBE-MARK-MASQ <span class="nt">-p</span> all <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> MARK <span class="nt">--or-mark</span> 0x4000
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> KUBE-SERVICES <span class="nt">-p</span> TCP <span class="nt">-s</span> 0.0.0.0/0 <span class="nt">-d</span> 10.107.122.198 <span class="nt">--dport</span> 80 <span class="nt">-j</span> KUBE-MARK-MASQ
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> KUBE-SEP-NGINX-1 <span class="nt">-p</span> all <span class="nt">-s</span> 192.168.236.133 <span class="nt">-j</span> KUBE-MARK-MASQ 
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> KUBE-SEP-NGINX-2 <span class="nt">-p</span> all <span class="nt">-s</span> 192.168.236.136 <span class="nt">-j</span> KUBE-MARK-MASQ
</code></pre></div></div>

<p>è¿è¡Œç»“æœï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain PREROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-SERVICES  all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0           

Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-SERVICES  all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         

Chain KUBE-MARK-MASQ <span class="o">(</span>3 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
MARK       all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000

Chain KUBE-SEP-NGINX-1 <span class="o">(</span>1 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-MARK-MASQ  all  <span class="nt">--</span>  192.168.236.133      0.0.0.0/0           
DNAT       tcp  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0            tcp to:192.168.236.133:80

Chain KUBE-SEP-NGINX-2 <span class="o">(</span>1 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-MARK-MASQ  all  <span class="nt">--</span>  192.168.236.136      0.0.0.0/0           
DNAT       tcp  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0            tcp to:192.168.236.136:80

Chain KUBE-SERVICES <span class="o">(</span>2 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-MARK-MASQ  tcp  <span class="nt">--</span>  0.0.0.0/0            10.107.122.198       tcp dpt:80
KUBE-SVC-NGINX  tcp  <span class="nt">--</span> <span class="o">!</span>192.168.0.0/16       10.107.122.198       tcp dpt:80

Chain KUBE-SVC-NGINX <span class="o">(</span>1 references<span class="o">)</span>
target     prot opt <span class="nb">source               </span>destination         
KUBE-SEP-NGINX-1  all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0           
KUBE-SEP-NGINX-2  all  <span class="nt">--</span>  0.0.0.0/0            0.0.0.0/0 
</code></pre></div></div>

<h1 id="è´Ÿè½½å‡è¡¡ç­–ç•¥">è´Ÿè½½å‡è¡¡ç­–ç•¥</h1>

<p>åœ¨æ²¡æœ‰è´Ÿè½½å‡è¡¡çš„ç­–ç•¥ä¸‹ <code class="language-plaintext highlighter-rouge">iptables</code> åŒ¹é…åˆ°è§„åˆ™å°±ä¼šå‘ç”Ÿè·³è½¬å’Œæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´æ°¸è¿œä¼šè§¦å‘ç¬¬ä¸€æ¡è§„åˆ™ï¼Œ
è¿™æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬æ‰€æœŸæœ›çš„è´Ÿè½½å‡è¡¡ã€‚</p>

<p>è§£å†³è¿™ä¸ªé—®é¢˜éœ€è¦å¼•å…¥ <code class="language-plaintext highlighter-rouge">iptables</code> çš„è´Ÿè½½å‡è¡¡æ¨¡å—ï¼š<code class="language-plaintext highlighter-rouge">statistic</code> ï¼Œè¿™ä¸ªæ¨¡å—ä¼šæ ¹æ®ç»Ÿè®¡çš„ä¿¡æ¯è·³è¿‡æˆ–è€…æ‰§è¡Œ
å…¶ä¸­ä¸€æ¡è§„åˆ™ã€‚</p>

<p>è¿™ä¸ªæ¨¡å—åªæœ‰ä¸¤ä¸ªåŸºæœ¬çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š</p>

<ul>
  <li>randomï¼šåŸºäºæ¦‚ç‡è·³è¿‡è¿™ä¸ªè§„åˆ™</li>
  <li>nthï¼šåŸºäºè½®è¯¢è·³è¿‡è¿™ä¸ªè§„åˆ™</li>
</ul>

<blockquote>
  <p><strong>è¿™ä¸ªè´Ÿè½½å‡è¡¡ä»…åœ¨TCPé“¾æ¥å»ºç«‹é˜¶æ®µç”Ÿæ•ˆï¼Œä¸€æ—¦é“¾æ¥å»ºç«‹äº†ï¼Œè¿™ä¸ªé“¾æ¥å°†ä¼šä¸€ç›´è¢«è½¬å‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨</strong></p>
</blockquote>

<h1 id="éšæœº">éšæœº</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-A</span> KUBE-SVC-4N57TFCL4MD7ZTDA <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"default/nginx:"</span> <span class="nt">-m</span> statistic <span class="nt">--mode</span> random <span class="nt">--probability</span> 0.50000000000 <span class="nt">-j</span> KUBE-SEP-UGFJDGWZKFFMLNCL
iptables <span class="nt">-A</span> KUBE-SVC-4N57TFCL4MD7ZTDA <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"default/nginx:"</span> <span class="nt">-j</span> KUBE-SEP-ATB57SP3HHRBIRYE
</code></pre></div></div>

<p><strong>â€“mode random</strong>: åŸºäºæ¦‚ç‡è·³è¿‡è¿™ä¸ªè§„åˆ™
<strong>â€“probability 0.50000000000</strong>ï¼šæœ‰ <code class="language-plaintext highlighter-rouge">50%</code> æ¦‚ç‡è·³è¿‡è¿™ä¸ªè§„åˆ™</p>

<h1 id="è½®è¯¢">è½®è¯¢</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> mangle <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">-m</span> state <span class="nt">--state</span> NEW <span class="nt">-m</span> statistic <span class="nt">--mode</span> nth <span class="nt">--every</span> 2 <span class="nt">--packet</span> 0 <span class="nt">-j</span> CONNMARK1
iptables <span class="nt">-t</span> mangle <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">-m</span> state <span class="nt">--state</span> NEW <span class="nt">-m</span> statistic <span class="nt">--mode</span> nth <span class="nt">--every</span> 2 <span class="nt">--packet</span> 1 <span class="nt">-j</span> CONNMARK2
</code></pre></div></div>

<p><strong>â€“mode nth</strong>ï¼šä½¿ç”¨è½®è¯¢ç®—æ³•
<strong>â€“every 2 â€“packet 0</strong>ï¼šæ¯<code class="language-plaintext highlighter-rouge">2</code>ä¸ªåŒ…åŒ¹é… <code class="language-plaintext highlighter-rouge">0</code> ä¸ª</p>

<h1 id="çœ‹çœ‹æºç ">çœ‹çœ‹æºç </h1>

<p>kube-proxy çš„ä¸»è¦åŠŸèƒ½æ˜¯ç›‘å¬æœåŠ¡å’Œç«¯ç‚¹äº‹ä»¶ï¼Œç„¶åå°†ä»£ç†ç­–ç•¥å§”æ‰˜ç»™æœºå™¨ã€‚åº•å±‚è°ƒç”¨<code class="language-plaintext highlighter-rouge">docker/libnetwork</code>å’Œl<code class="language-plaintext highlighter-rouge">ibnetwork</code>
æœ€åè°ƒç”¨<code class="language-plaintext highlighter-rouge">netlink</code>å’Œ<code class="language-plaintext highlighter-rouge">netns</code>æ¥å®ç°åˆ›å»ºipvsç­‰åŠ¨ä½œ</p>

<p><strong>ä»£ç å…¥å£ï¼š<code class="language-plaintext highlighter-rouge">cmd/kube-proxy/app/server.go Run()</code> å‡½æ•°</strong>ï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°åˆå§‹åŒ–proxyServerçš„é…ç½®</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proxyServer</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">NewProxyServer</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="k">type</span> <span class="n">ProxyServer</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="c">// k8s client</span>
  <span class="n">Client</span>                 <span class="n">clientset</span><span class="o">.</span><span class="n">Interface</span>
  <span class="n">EventClient</span>            <span class="n">v1core</span><span class="o">.</span><span class="n">EventsGetter</span>
  <span class="c">// iptables and ipvs related interface</span>
  <span class="n">IptInterface</span>           <span class="n">utiliptables</span><span class="o">.</span><span class="n">Interface</span>
  <span class="n">IpvsInterface</span>          <span class="n">utilipvs</span><span class="o">.</span><span class="n">Interface</span>
  <span class="n">IpsetInterface</span>         <span class="n">utilipset</span><span class="o">.</span><span class="n">Interface</span>
  <span class="n">execer</span>                 <span class="n">exec</span><span class="o">.</span><span class="n">Interface</span>
  <span class="c">// åŒæ­¥å™¨å¤„ç†</span>
  <span class="n">Proxier</span>                <span class="n">proxy</span><span class="o">.</span><span class="n">Provider</span>
  <span class="n">Broadcaster</span>            <span class="n">events</span><span class="o">.</span><span class="n">EventBroadcaster</span>
  <span class="n">Recorder</span>               <span class="n">events</span><span class="o">.</span><span class="n">EventRecorder</span>
  <span class="c">// k8s çŠ¶æ€è·Ÿè¸ªé…ç½®</span>
  <span class="n">ConntrackConfiguration</span> <span class="n">kubeproxyconfig</span><span class="o">.</span><span class="n">KubeProxyConntrackConfiguration</span>
  <span class="n">Conntracker</span>            <span class="n">Conntracker</span> <span class="c">// if nil, ignored</span>
  <span class="c">// ä»£ç†æ¨¡å¼</span>
  <span class="n">ProxyMode</span>              <span class="kt">string</span>
  <span class="n">NodeRef</span>                <span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">ObjectReference</span>
  <span class="n">MetricsBindAddress</span>     <span class="kt">string</span>
  <span class="n">BindAddressHardFail</span>    <span class="kt">bool</span>
  <span class="n">EnableProfiling</span>        <span class="kt">bool</span>
  <span class="n">UseEndpointSlices</span>      <span class="kt">bool</span>
  <span class="n">OOMScoreAdj</span>            <span class="o">*</span><span class="kt">int32</span>
  <span class="n">ConfigSyncPeriod</span>       <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
  <span class="n">HealthzServer</span>          <span class="n">healthcheck</span><span class="o">.</span><span class="n">ProxierHealthUpdater</span>
<span class="p">}</span>

</code></pre></div></div>

:ET