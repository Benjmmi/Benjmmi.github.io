I"€Œ<h1 id="netfilter-hook">netfilter HOOK</h1>

<p>netfilter æä¾›äº† 5 ä¸ª hook ç‚¹ã€‚åŒ…ç»è¿‡åè®®æ ˆæ—¶å°±ä¼šè§¦å‘å†…æ ¸æ¨¡å—æ³¨å†Œåœ¨è¿™é‡Œçš„å¤„ç†å‡½æ•°ã€‚è§¦å‘å“ªä¸ª hook å–å†³äºåŒ…çš„æ–¹å‘ã€
åŒ…çš„ç›®çš„åœ°å€ã€ä»¥åŠåŒ…åœ¨ä¸Šä¸€ä¸ª hook ç‚¹æ—¶ä¸¢å¼ƒè¿˜æ˜¯æ‹’ç»ç­‰ã€‚</p>

<ul>
  <li>NF_IP_PRE_ROUTING: æ¥æ”¶åˆ°çš„åŒ…è¿›å…¥åè®®æ ˆåç«‹å³è§¦å‘æ­¤ hookï¼Œåœ¨è¿›è¡Œä»»ä½•è·¯ç”±åˆ¤æ–­ ï¼ˆå°†åŒ…å‘å¾€å“ªé‡Œï¼‰ä¹‹å‰</li>
  <li>NF_IP_LOCAL_IN: æ¥æ”¶åˆ°çš„åŒ…ç»è¿‡è·¯ç”±åˆ¤æ–­ï¼Œå¦‚æœç›®çš„æ˜¯æœ¬æœºï¼Œå°†è§¦å‘æ­¤ hook</li>
  <li>NF_IP_FORWARD: æ¥æ”¶åˆ°çš„åŒ…ç»è¿‡è·¯ç”±åˆ¤æ–­ï¼Œå¦‚æœç›®çš„æ˜¯å…¶ä»–æœºå™¨ï¼Œå°†è§¦å‘æ­¤ hook</li>
  <li>NF_IP_LOCAL_OUT: æœ¬æœºäº§ç”Ÿçš„å‡†å¤‡å‘é€çš„åŒ…ï¼Œåœ¨è¿›å…¥åè®®æ ˆåç«‹å³è§¦å‘æ­¤ hook</li>
  <li>NF_IP_POST_ROUTING: æœ¬æœºäº§ç”Ÿçš„å‡†å¤‡å‘é€çš„åŒ…æˆ–è€…è½¬å‘çš„åŒ…ï¼Œåœ¨ç»è¿‡è·¯ç”±åˆ¤æ–­ä¹‹åï¼Œ å°†è§¦å‘æ­¤ hook</li>
</ul>

<p>netfilter æ¡†æ¶ï¼Œæç¤ºè¯¥å¯¹è¿™ä¸ªåŒ…åšä»¥ä¸‹å‡ ä¸ªæ“ä½œä¹‹ä¸€ï¼š</p>
<ul>
  <li>NF_ACCEPT: ç»§ç»­æ­£å¸¸éå†</li>
  <li>NF_DROP: ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œä¸å†è¿›è¡Œéå†</li>
  <li>NF_STOLEN: è¯¥æ¨¡å—æ¥æ”¶äº†è¯¥åŒ…ï¼Œä¸å†è¿›è¡Œéå†</li>
  <li>NF_QUEUE: å°†æ•°æ®åŒ…æ’é˜Ÿï¼ˆé€šå¸¸ç”¨äºç”¨æˆ·ç©ºé—´å¤„ç†ï¼‰</li>
  <li>NF_REPEAT: å†æ¬¡è°ƒç”¨æ­¤hook</li>
</ul>

<h1 id="netfilter-æºç é˜…è¯»">netfilter æºç é˜…è¯»</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ¥æ”¶åˆ°çš„æŠ¥æ–‡</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ip_rcv_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span> <span class="c1">// å®šä¹‰ ip æŠ¥æ–‡çš„æ•°æ®å¤´</span>
  <span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

  
  <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_OTHERHOST</span><span class="p">)</span>
    <span class="k">goto</span> <span class="n">drop</span><span class="p">;</span> <span class="c1">// ä¸æ˜¯è‡ªå·±çš„æ•°æ®åŒ…å°±åˆ é™¤</span>

  <span class="n">__IP_UPD_PO_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_IN</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

  <span class="n">skb</span> <span class="o">=</span> <span class="n">skb_share_check</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span> <span class="c1">// å¦‚æœæ•°æ®åŒ…æ˜¯å…±äº«çš„ï¼Œåˆ™å¤åˆ¶ä¸€ä¸ªå‡ºæ¥ï¼Œå¤åˆ¶å‡ºæ¥çš„ skb å°±å’Œ socket æ²¡æœ‰å•¥å…³ç³»äº†</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__IP_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INDISCARDS</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)))</span> <span class="c1">// æ£€æŸ¥iphdr é•¿åº¦æ˜¯å¦æ­£ç¡®ï¼Œæ€»çš„é•¿åº¦ - æ•°æ®æŠ¥æ–‡é•¿åº¦</span>
    <span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>

  <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span> <span class="c1">// æŒ‡é’ˆç§»å‘å¤´éƒ¨ä½ç½®</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">// å¤´éƒ¨é•¿åº¦æˆ–è€…åè®®ç‰ˆæœ¬å·ä¸å¯¹ï¼Œè¿™é‡Œçš„ 5 ä»£è¡¨ 20 å­—èŠ‚</span>
    <span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>

  <span class="n">__IP_ADD_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span>
           <span class="n">IPSTATS_MIB_NOECTPKTS</span> <span class="o">+</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="n">INET_ECN_MASK</span><span class="p">),</span>
           <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_segs</span><span class="p">));</span> <span class="c1">// æ•°æ®åŒ…ç»Ÿè®¡åŠ 1</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>  <span class="c1">// æ£€æŸ¥å¤´éƒ¨é•¿åº¦</span>
    <span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>

  <span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ip_fast_csum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">)))</span><span class="c1">// æ£€éªŒæ ¡éªŒå’Œ</span>
    <span class="k">goto</span> <span class="n">csum_error</span><span class="p">;</span>

  <span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// æ€»é•¿åº¦å°äºæŠ¥æ–‡å¤´é•¿åº¦</span>
    <span class="n">__IP_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INTRUNCATEDPKTS</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span> <span class="c1">// æŠ¥æ–‡å¤´é•¿åº¦å°äºåº”è¯¥çš„æŠ¥æ–‡å¤´é•¿åº¦</span>
    <span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>


  <span class="k">if</span> <span class="p">(</span><span class="n">pskb_trim_rcsum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">__IP_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INDISCARDS</span><span class="p">);</span> <span class="c1">// **å¯¹æ•°æ®åŒ…åŒ…è¿›è¡Œå‰ªè£ï¼Œé˜²æ­¢åˆ†ç‰‡æ•°æ®å‘é€è¿‡æ¥çš„æ•°æ®æœ‰é‡å¤æ•°æ®**</span>
    <span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ip_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span>
     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="n">skb</span> <span class="o">=</span> <span class="n">ip_rcv_core</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NET_RX_DROP</span><span class="p">;</span> <span class="c1">// åˆ é™¤æ¥æ”¶çš„åŒ…</span>

  <span class="k">return</span> <span class="n">NF_HOOK</span><span class="p">(</span><span class="n">NFPROTO_IPV4</span><span class="p">,</span> <span class="n">NF_INET_PRE_ROUTING</span><span class="p">,</span>
           <span class="n">net</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
           <span class="n">ip_rcv_finish</span><span class="p">);</span> <span class="c1">// è§¦å‘ NF_INET_PRE_ROUTING hook ç‚¹ï¼Œé€šè¿‡å›æ‰å‡½æ•°è°ƒç”¨ ip_rcv_finish</span>
<span class="p">}</span>

</code></pre></div></div>

<p>æŸ¥çœ‹ NF_HOOK å¦‚ä½•å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥äº† netfilter å¤„ç†è¿‡ç¨‹ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">NF_HOOK</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">pf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hook</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">okfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)){</span>

  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">nf_hook</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">hook</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">okfn</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// å¦‚æœæ²¡æœ‰ HOOK ç‚¹å°±ç›´æ¥è°ƒç”¨ okfn ï¼Œç›¸å¯¹ NF_INET_PRE_ROUTING æ¥è¯´å°±æ˜¯ ip_rcv_finish</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">okfn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nf_hook</span><span class="p">(</span><span class="n">u_int8_t</span> <span class="n">pf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hook</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
        <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">indev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">outdev</span><span class="p">,</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">okfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">nf_hook_entries</span> <span class="o">*</span><span class="n">hook_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">rcu_read_lock</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="p">{</span>   
    <span class="c1">// æ ¹æ®åè®®è·å–ä¸åŒçš„ nf_hookfn         å–å¾—å¯¹åº”çš„ hookï¼Œ </span>
    <span class="c1">// #define NF_IP_PRE_ROUTING 0        è·¯ç”±å‰ï¼Œè¿›å…¥æœ¬æœºçš„æ•°æ®</span>
    <span class="c1">// #define NF_IP_LOCAL_IN 1           è·¯ç”±åï¼Œè¿›å…¥æœ¬æœºçš„æ•°æ®</span>
    <span class="c1">// #define NF_IP_FORWARD 2            è·¯ç”±åï¼Œæœ¬æœºè½¬å‘çš„æ•°æ®</span>
    <span class="c1">// #define NF_IP_LOCAL_OUT 3          è·¯ç”±å‰ï¼Œæœ¬æœºæœ¬åœ°è¿›ç¨‹å‘å‡ºçš„æ•°æ®</span>
    <span class="c1">// #define NF_IP_POST_ROUTING 4       è·¯ç”±åï¼Œæœ¬æœºå‘å‡ºçš„æ•°æ®</span>
  <span class="k">case</span> <span class="n">NFPROTO_IPV4</span><span class="p">:</span>
    <span class="n">hook_head</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">nf</span><span class="p">.</span><span class="n">hooks_ipv4</span><span class="p">[</span><span class="n">hook</span><span class="p">]);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">NFPROTO_IPV6</span><span class="p">:</span>
    <span class="n">hook_head</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">nf</span><span class="p">.</span><span class="n">hooks_ipv6</span><span class="p">[</span><span class="n">hook</span><span class="p">]);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="nl">default:</span>
    <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">hook_head</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// å¦‚æœå­˜åœ¨ hook</span>
    <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="n">state</span><span class="p">;</span>

    <span class="n">nf_hook_state_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">hook</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">indev</span><span class="p">,</span> <span class="n">outdev</span><span class="p">,</span>
           <span class="n">sk</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">okfn</span><span class="p">);</span> <span class="c1">// åˆå§‹åŒ– state</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">nf_hook_slow</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">hook_head</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">rcu_read_unlock</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>      


<span class="kt">int</span> <span class="nf">nf_hook_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nf_hook_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
     <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_entries</span> <span class="o">*</span><span class="n">hook_head</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verdict</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
  <span class="c1">// éå† hook åˆ—è¡¨</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">hook_head</span><span class="o">-&gt;</span><span class="n">num_hook_entries</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è°ƒç”¨ hook å¯¹åº”çš„ å‡½æ•°ï¼Œä¾æ¬¡è°ƒç”¨æŒ‡å®š hook ç‚¹ä¸‹çš„æ‰€æœ‰ entry-&gt;hook å‡½æ•°ã€‚</span>
    <span class="c1">// èµ„æ–™é™åˆ¶ entry å…³è”äº† filter å’Œ mangle è¡¨</span>
    <span class="n">verdict</span> <span class="o">=</span> <span class="n">nf_hook_entry_hookfn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hook_head</span><span class="o">-&gt;</span><span class="n">hooks</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">skb</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">verdict</span> <span class="o">&amp;</span> <span class="n">NF_VERDICT_MASK</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// æ ¹æ®å‡½æ•°è¿”å›çš„ç»“æœåšå¯¹åº”çš„å¤„ç†</span>
    <span class="k">case</span> <span class="n">NF_ACCEPT</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">NF_DROP</span><span class="p">:</span>
      <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>  <span class="c1">// é‡Šæ”¾ skb</span>
    <span class="p">...</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">å…³é”®æ•°æ®ç»“æ„</code></strong>ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">nf_hook_entry</span> <span class="p">{</span>
  <span class="n">nf_hookfn</span>     <span class="o">*</span><span class="n">hook</span><span class="p">;</span>  <span class="c1">// æ³¨å†Œçš„å‡½æ•°</span>
  <span class="kt">void</span>        <span class="o">*</span><span class="n">priv</span><span class="p">;</span>    <span class="c1">// ä¼˜å…ˆçº§</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nf_hook_entries</span> <span class="p">{</span>
  <span class="n">u16</span>       <span class="n">num_hook_entries</span><span class="p">;</span>           <span class="c1">// æ€»å…±ç”±å¤šå°‘ hook ç»Ÿè®¡</span>
  <span class="k">struct</span> <span class="n">nf_hook_entry</span>    <span class="n">hooks</span><span class="p">[];</span>      <span class="c1">// hook è¡¨</span>
<span class="p">};</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹è§æ•´ä¸ª NF_HOOK çš„è°ƒç”¨è¿‡ç¨‹ï¼Œä½†æ˜¯å¦ä¸€ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å¼€å°±æ˜¯ï¼š<strong>â€œ<code class="language-plaintext highlighter-rouge">å†…æ ¸æ˜¯å¦‚ä½•æ³¨å†Œ HOOK å‡½æ•°çš„</code>â€</strong>ã€‚
è§£ç­”è¿™ä¸ªé—®é¢˜å‰ï¼šå…ˆçœ‹ä¸‹ netfilter æœ‰å‡ ä¸ªè¡¨ã€‚
iptable æ€»å…±æœ‰äº”ä¸ªè¡¨ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">[filter](https://elixir.bootlin.com/linux/v5.11.2/source/net/ipv4/netfilter/iptable_filter.c)</code>ï¼š æœ€å¸¸ç”¨çš„ table ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å…è®¸ä¸€ä¸ªåŒ…é€šè¿‡</li>
  <li><code class="language-plaintext highlighter-rouge">[nat](https://elixir.bootlin.com/linux/v5.11.2/source/net/ipv4/netfilter/iptable_nat.c)</code>ï¼š ç”¨äºå®ç°ç½‘ç»œåœ°å€è§„åˆ™è½¬æ¢</li>
  <li><code class="language-plaintext highlighter-rouge">[mangle](https://elixir.bootlin.com/linux/v5.11.2/source/net/ipv4/netfilter/iptable_mangle.c)</code>ï¼›ç”¨äºä¿®æ”¹åŒ…çš„ IP å¤´ã€‚ä¾‹å¦‚ï¼šä¿®æ”¹ TTL</li>
  <li><code class="language-plaintext highlighter-rouge">[raw](https://elixir.bootlin.com/linux/v5.11.2/source/net/ipv4/netfilter/iptable_raw.c)</code>ï¼šiptables é˜²ç«å¢™æ˜¯æœ‰çŠ¶æ€çš„ï¼šå¯¹æ¯ä¸ªåŒ…è¿›è¡Œåˆ¤æ–­çš„æ—¶å€™ä¾èµ–ä»¥åŠåˆ¤æ–­è¿‡çš„åŒ…ã€‚æ ¹æ® è¿æ¥è·Ÿè¸ª ct ä½¿å¾— iptables å°†åŒ…çœ‹ä½œå·²æœ‰çš„è¿æ¥æˆ–è€…ä¼šè¯çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯ç‹¬ç«‹çš„åŒ…</li>
  <li><code class="language-plaintext highlighter-rouge">[security](https://elixir.bootlin.com/linux/v5.11.2/source/net/ipv4/netfilter/iptable_security.c#L114)</code>ï¼štable çš„ä½œç”¨æ˜¯ç»™åŒ…åš SELinux æ ‡è®°ï¼Œä»¥æ­¤å½±å“ SELinux</li>
</ul>

<p><strong>é€šè¿‡ iptable å¸¸è§çš„ 4 ä¸ªè¡¨ï¼šfilterã€natã€mangleã€rawã€‚æ’ä¸ªåº Raw &gt; mangle &gt; nat &gt; filter</strong>
<strong>netfilter å¯¹åº”çš„ 5 ä¸ª HOOK ï¼š PREROUTINGã€INPUTã€FORWARDã€OUTPUTã€POSTROUTING</strong></p>

<p>åœ¨å†…æ ¸ä»£ç ä¸­çš„ç»“æ„ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">nf_inet_hooks</span> <span class="p">{</span>
  <span class="n">NF_INET_PRE_ROUTING</span><span class="p">,</span>  <span class="c1">//  PREROUTING</span>
  <span class="n">NF_INET_LOCAL_IN</span><span class="p">,</span>     <span class="c1">//  INPUT</span>
  <span class="n">NF_INET_FORWARD</span><span class="p">,</span>      <span class="c1">//  FORWARD</span>
  <span class="n">NF_INET_LOCAL_OUT</span><span class="p">,</span>    <span class="c1">//  OUTPUT</span>
  <span class="n">NF_INET_POST_ROUTING</span><span class="p">,</span> <span class="c1">// POSTROUTING</span>
  <span class="n">NF_INET_NUMHOOKS</span><span class="p">,</span>
  <span class="n">NF_INET_INGRESS</span> <span class="o">=</span> <span class="n">NF_INET_NUMHOOKS</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è¿™äº”ä¸ªè¡¨åˆ†åˆ«è§¦å‘çš„å¯¹åº”çš„ HOOKï¼š</p>

<ol>
  <li>filter -&gt; INPUTã€FORWARDã€OUTPUT</li>
  <li>Nat -&gt; PREROUTINGã€POSTROUTINGã€OUTPUT</li>
  <li>Mangle -&gt;  PREROUTINGã€POSTROUTINGã€INPUTã€OUTPUTã€FORWARD</li>
  <li>Raw -&gt; OUTPUTã€PREROUTING</li>
</ol>

<h2 id="å†…æ ¸æ˜¯å¦‚ä½•æ³¨å†Œ-hook-å‡½æ•°çš„filter">å†…æ ¸æ˜¯å¦‚ä½•æ³¨å†Œ HOOK å‡½æ•°çš„ï¼šfilter</h2>

<p>è¦åœ¨å†…æ ¸ä¸­ä½¿ç”¨filterè¡¨ï¼Œé¦–å…ˆè¦å‘å†…æ ¸æ³¨å†Œè¿™ä¸ªè¡¨ï¼Œç„¶åè¯¥è¡¨åœ¨<code class="language-plaintext highlighter-rouge">NF_IP_LOCAL_IN</code>ã€<code class="language-plaintext highlighter-rouge">NF_IP_FORWARD</code>ã€ <code class="language-plaintext highlighter-rouge">NF_IP_LOCAL_OUT</code>ä¸‰ä¸ªHookç‚¹
æ³¨å†Œç›¸åº”çš„é’©å­å‡½æ•°ï¼Œåœ¨å†…æ ¸filteræ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ï¼ˆiptable_filter.cï¼‰ï¼Œå®Œæˆäº†è¿™ä¸€åŠŸèƒ½ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">iptable_filter_table_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">repl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="cm">/* Entry 1 is the FORWARD hook */</span>
  <span class="p">((</span><span class="k">struct</span> <span class="n">ipt_standard</span> <span class="o">*</span><span class="p">)</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">target</span><span class="p">.</span><span class="n">verdict</span> <span class="o">=</span>
    <span class="n">forward</span> <span class="o">?</span> <span class="o">-</span><span class="n">NF_ACCEPT</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="n">NF_DROP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// æ³¨å†Œ filter è¡¨</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">ipt_register_table</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_filter</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span> <span class="n">filter_ops</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ipv4</span><span class="p">.</span><span class="n">iptable_filter</span><span class="p">);</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">repl</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ipt_register_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
           <span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_replace</span> <span class="o">*</span><span class="n">repl</span><span class="p">,</span>
           <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_table</span> <span class="o">**</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>

  <span class="c1">// æ³¨å†Œ filter è¡¨çš„ hook</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">nf_register_net_hooks</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">valid_hooks</span><span class="p">));</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nf_register_net_hooks</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">nf_register_net_hook</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="è¡¨æ³¨å†Œ">è¡¨æ³¨å†Œ</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">xt_table</span> <span class="p">{</span>
  <span class="c1">// é“¾è¡¨æˆå‘˜</span>
  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

  <span class="cm">/* ä½å‘é‡ï¼Œè¡¨ç¤ºå½“å‰è¡¨å½±å“äº†å“ªäº›ï¼ˆä¸ªï¼‰HOOK ç±»å‹ */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valid_hooks</span><span class="p">;</span>

  <span class="cm">/* iptableçš„æ•°æ®åŒº */</span>
  <span class="k">struct</span> <span class="n">xt_table_info</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

  <span class="cm">/* æ˜¯å¦åœ¨æ¨¡å—ä¸­å®šä¹‰ï¼Œè‹¥å¦ï¼Œåˆ™ä¸ºNULL */</span>
  <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">me</span><span class="p">;</span>

  <span class="n">u_int8_t</span> <span class="n">af</span><span class="p">;</span>    <span class="cm">/* address/protocol family */</span>
  <span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>   <span class="cm">/* ä¼˜å…ˆçº§ */</span>

  <span class="cm">/* åœ¨ç»™å®šçš„ç½‘ç»œä¸­éœ€è¦è¡¨æ˜¯è°ƒç”¨ */</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">table_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">);</span>

  <span class="cm">/* è¡¨åï¼Œå¦‚â€œfilterâ€ã€â€œnatâ€ */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">XT_TABLE_MAXNAMELEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xt_table_info</span> <span class="p">{</span>
  <span class="cm">/* æ¯ä¸ªè¡¨çš„å¤§å° */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
  <span class="cm">/* è¡¨ä¸­çš„è§„åˆ™æ•°. --RR */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
  <span class="cm">/*  åˆå§‹çš„è§„åˆ™æ•°ï¼Œç”¨äºæ¨¡å—è®¡æ•° */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">initial_entries</span><span class="p">;</span>

  <span class="cm">/* è®°å½•æ‰€å½±å“çš„HOOKçš„è§„åˆ™å…¥å£ç›¸å¯¹äºä¸‹é¢çš„entrieså˜é‡çš„åç§»é‡ */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hook_entry</span><span class="p">[</span><span class="n">NF_INET_NUMHOOKS</span><span class="p">];</span>
  <span class="c1">// ä¸hook_entryç›¸å¯¹åº”çš„è§„åˆ™è¡¨ä¸Šé™åç§»é‡ï¼Œå½“æ— è§„åˆ™å½•å…¥æ—¶ï¼Œç›¸åº”çš„hook_entryå’Œunderflowå‡ä¸º0</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">underflow</span><span class="p">[</span><span class="n">NF_INET_NUMHOOKS</span><span class="p">];</span>

  <span class="cm">/*
   * Number of user chains. Since tables cannot have loops, at most
   * @stacksize jumps (number of user chains) can possibly be made.
   */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stacksize</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">***</span><span class="n">jumpstack</span><span class="p">;</span>
  <span class="c1">// æ¯ä¸ªCPUçš„Hookç‚¹è§„åˆ™è¡¨å…¥å£</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">entries</span><span class="p">[]</span> <span class="n">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<h1 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h1>
<p><a href="http://blog.chinaunix.net/uid-26744085-id-3086405.html">Linuxä¸­Netfilterçš„åŸç†ä»‹ç»</a></p>
:ET