I"«•<h1 id="cilium-æºç é˜…è¯»-å¦‚ä½•åˆ¶å®šå’Œæ‰§è¡Œ-l3-ç­–ç•¥-ç»­">Cilium æºç é˜…è¯»ï¼š å¦‚ä½•åˆ¶å®šå’Œæ‰§è¡Œ L3 ç­–ç•¥ ç»­</h1>

<p>debug äº†é‚£ä¹ˆä¹…å¤§æ¦‚çŸ¥é“äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œä½†æ˜¯ä¸çŸ¥é“è¯¦ç»†æ“çºµã€‚æ‰€ä»¥æ¯”è¾ƒå…³å¿ƒ regenerateBPF ç”Ÿæˆäº†ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Œ
æ³¨é‡Šä¸Šå†™åˆ° 
<code class="language-plaintext highlighter-rouge">//regenerateBPF é‡å†™æ‰€æœ‰æ ‡å¤´å¹¶æ›´æ–°æ‰€æœ‰BPF Mapä»¥åæ˜ æŒ‡å®šçš„ç«¯ç‚¹ã€‚ ReloadDatapathå¼ºåˆ¶æ•°æ®è·¯å¾„ç¨‹åºè¢«é‡æ–°åŠ è½½ã€‚</code></p>

<p>è·Ÿè¸ªè§‚å¯Ÿåå‘ç°ä¼šä» Temp ç”Ÿæˆæ–‡ä»¶ï¼Œæ–‡ä»¶å¯ä»¥ä» <code class="language-plaintext highlighter-rouge">/run/cilium/state/templates/</code> ç›®å½•ä¸‹æ‰¾åˆ°ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>tree /run/cilium/state/templates
/run/cilium/state/templates
â”œâ”€â”€ 25df1a420976f38f9816d470bf855db02aae2781
â”‚Â Â  â”œâ”€â”€ bpf_host.o
â”‚Â Â  â””â”€â”€ ep_config.h
â””â”€â”€ 9c049fd667d887a78a9fa5569ec628f318b57cde
    â”œâ”€â”€ bpf_lxc.o
    â””â”€â”€ ep_config.h
</code></pre></div></div>

<p>ç„¶å regenerateBPF çš„æ“ä½œå°±æ˜¯ä¸ºæ¯ä¸ª docker å®ä¾‹å•ç‹¬ç”Ÿæˆä¸€ä¸ª BPF ç¨‹åºåŠ è½½ï¼ŒåŠ å…¥å½“å‰å®ä¾‹å…³è”çš„ ID æ˜¯ 2665ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/run/cilium/state/2665
â”œâ”€â”€ bpf_lxc.o
â”œâ”€â”€ ep_config.h
</code></pre></div></div>
<p>å…·ä½“çœ‹ä¸‹å„ä¸ªæ–‡ä»¶å†…å®¹ï¼š/run/cilium/state/2665/ep_config.h</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * CILIUM_BASE64_IjEuOC4xMCBmOThmOGI0ODkgMjAyMS0wNi0xNFQyMDoyMjo1NiswODowMCBnbyB2ZXJzaW9uIGdvMS4xNC4zIGxpbnV4L2FtZDY0Ig==:eyJJRCI6MjY2NSwiQ29udGFpbmVyTmFtZSI6ImFwcDEiLCJkb2NrZXJJRCI6IjMyMzI3ZjdiNGNmOTA0MGFmODBhZmU5NjA3ZThiN2Y0MzA1NzAxZDc1ZTU4NWFlMjE2YzM1ZjliNDgxNDA1YjIiLCJEb2NrZXJOZXR3b3JrSUQiOiJmMWU4ODk3MGQ1NWU2MzJhNmYxMzBiY2FjYjRhOWUzMjhhMzQ4OWQ4OGMyMzFiMTkxZmNmZjk0ZTA1M2QzMGVkIiwiRG9ja2VyRW5kcG9pbnRJRCI6ImU4YTNlNDZmNTZiOTY0ZDBkMDUxMjBhZWYwMzQ3MDEyNjRiNDgzZWQwYTZiOGRkYjdiMzE1ZTEwM2IyOGE2OGYiLCJEYXRhcGF0aE1hcElEIjowLCJJZk5hbWUiOiJseGM4MDc2MzNiZmVkZWEiLCJJZkluZGV4IjoxOSwiT3BMYWJlbHMiOnsiQ3VzdG9tIjp7fSwiT3JjaGVzdHJhdGlvbklkZW50aXR5Ijp7ImlkIjp7ImtleSI6ImlkIiwidmFsdWUiOiJhcHAxIiwic291cmNlIjoiY29udGFpbmVyIn0sImlkLnNlcnZpY2UxIjp7ImtleSI6ImlkLnNlcnZpY2UxIiwic291cmNlIjoiY29udGFpbmVyIn19LCJEaXNhYmxlZCI6e30sIk9yY2hlc3RyYXRpb25JbmZvIjp7fX0sIkxYQ01BQyI6IjZlOmIwOjdkOjRlOjZiOmU1IiwiSVB2NiI6IiIsIklQdjQiOiIxMC4xMS4yNTUuMTA0IiwiTm9kZU1BQyI6IjQyOjIzOmRjOjRkOjc5OmIxIiwiU2VjTGFiZWwiOnsiaWQiOjEyMDIyLCJsYWJlbHMiOnsiaWQiOnsia2V5IjoiaWQiLCJ2YWx1ZSI6ImFwcDEiLCJzb3VyY2UiOiJjb250YWluZXIifSwiaWQuc2VydmljZTEiOnsia2V5IjoiaWQuc2VydmljZTEiLCJzb3VyY2UiOiJjb250YWluZXIifX0sImxhYmVsc1NIQTI1NiI6IiJ9LCJPcHRpb25zIjp7Im1hcCI6eyJDb25udHJhY2siOjEsIkNvbm50cmFja0FjY291bnRpbmciOjEsIkNvbm50cmFja0xvY2FsIjowLCJEZWJ1ZyI6MCwiRGVidWdMQiI6MCwiRGVidWdQb2xpY3kiOjAsIkRyb3BOb3RpZmljYXRpb24iOjEsIk1vbml0b3JBZ2dyZWdhdGlvbkxldmVsIjowLCJOQVQ0NiI6MCwiUG9saWN5QXVkaXRNb2RlIjowLCJQb2xpY3lWZXJkaWN0Tm90aWZpY2F0aW9uIjoxLCJUcmFjZU5vdGlmaWNhdGlvbiI6MX19LCJETlNSdWxlcyI6bnVsbCwiRE5TSGlzdG9yeSI6W10sIkROU1pvbWJpZXMiOnt9LCJLOHNQb2ROYW1lIjoiIiwiSzhzTmFtZXNwYWNlIjoiIiwiRGF0YXBhdGhDb25maWd1cmF0aW9uIjp7fX0=
 * 
 * Container ID: 32327f7b4cf9040af80afe9607e8b7f4305701d75e585ae216c35f9b481405b2
 * IPv6 address: 
 * IPv4 address: 10.11.255.104
 * Identity: 12022
 * PolicyMap: cilium_policy_02665
 * NodeMAC: 42:23:dc:4d:79:b1
 */</span>

<span class="cm">/*
 * Labels:
 * - {id app1 container}
 * - {id.service1  container}
 */</span>

<span class="cp">#include</span> <span class="cpf">"lib/utils.h"</span><span class="cp">
</span>
<span class="n">DEFINE_U32</span><span class="p">(</span><span class="n">LXC_IPV4</span><span class="p">,</span> <span class="mh">0x68ff0b0a</span><span class="p">);</span> <span class="cm">/* 1761544970 */</span>
<span class="cp">#define LXC_IPV4 fetch_u32(LXC_IPV4)
</span><span class="n">DEFINE_U32</span><span class="p">(</span><span class="n">LXC_ID</span><span class="p">,</span> <span class="mh">0x00000a69</span><span class="p">);</span> <span class="cm">/* 2665 */</span>
<span class="cp">#define LXC_ID fetch_u32(LXC_ID)
</span><span class="n">DEFINE_MAC</span><span class="p">(</span><span class="n">NODE_MAC</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">);</span>
<span class="cp">#define NODE_MAC fetch_mac(NODE_MAC)
</span><span class="n">DEFINE_U32</span><span class="p">(</span><span class="n">SECLABEL</span><span class="p">,</span> <span class="mh">0x00002ef6</span><span class="p">);</span> <span class="cm">/* 12022 */</span>
<span class="cp">#define SECLABEL fetch_u32(SECLABEL)
</span><span class="n">DEFINE_U32</span><span class="p">(</span><span class="n">SECLABEL_NB</span><span class="p">,</span> <span class="mh">0xf62e0000</span><span class="p">);</span>  <span class="cm">/* 4130209792 */</span>
<span class="cp">#define SECLABEL_NB fetch_u32(SECLABEL_NB)
</span><span class="n">DEFINE_U32</span><span class="p">(</span><span class="n">POLICY_VERDICT_LOG_FILTER</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>  <span class="cm">/* 0 */</span>
<span class="cp">#define POLICY_VERDICT_LOG_FILTER fetch_u32(POLICY_VERDICT_LOG_FILTER)
#define POLICY_MAP cilium_policy_02665
#define CALLS_MAP cilium_calls_02665
#define FORCE_LOCAL_POLICY_EVAL_AT_SOURCE 1
#define ENABLE_ROUTING 1
#define ENABLE_ARP_RESPONDER 1
#define ENABLE_HOST_REDIRECT 1
#define CT_MAP_TCP4 cilium_ct4_global
#define CT_MAP_ANY4 cilium_ct_any4_global
#define CT_MAP_TCP6 cilium_ct6_global
#define CT_MAP_ANY6 cilium_ct_any6_global
#define CT_MAP_SIZE_TCP 524288
#define CT_MAP_SIZE_ANY 262144
#define LOCAL_DELIVERY_METRICS 1
#define CONNTRACK 1
#define CONNTRACK_ACCOUNTING 1
#undef CONNTRACK_LOCAL
#undef DEBUG
#undef LB_DEBUG
#undef POLICY_DEBUG
#define DROP_NOTIFY 1
#undef MONITOR_AGGREGATION
#undef ENABLE_NAT46
#undef POLICY_AUDIT_MODE
#define POLICY_VERDICT_NOTIFY 1
#define TRACE_NOTIFY 1
#define IPCACHE6_PREFIXES 128,0,
#define IPCACHE4_PREFIXES 32,0,
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps <span class="nt">-l</span>
CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS              PORTS               NAMES
32327f7b4cf9        cilium/demo-httpd   <span class="s2">"httpd-foreground"</span>   16 minutes ago      Up 15 minutes                           app1
</code></pre></div></div>

<p>çœ‹åˆ°è¿™å¤§æ¦‚å°±æ˜ç™½äº†ï¼Œä½†æ˜¯ä¸Šé¢ BASE64 éšè—äº†ä»€ä¹ˆå†…å®¹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"ID"</span><span class="p">:</span><span class="w"> </span><span class="mi">2665</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ContainerName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dockerID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32327f7b4cf9040af80afe9607e8b7f4305701d75e585ae216c35f9b481405b2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"DockerNetworkID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f1e88970d55e632a6f130bcacb4a9e328a3489d88c231b191fcff94e053d30ed"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"DockerEndpointID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e8a3e46f56b964d0d05120aef034701264b483ed0a6b8ddb7b315e103b28a68f"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"DatapathMapID"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"IfName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lxc807633bfedea"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"IfIndex"</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w">
  </span><span class="nl">"OpLabels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Custom"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="nl">"OrchestrationIdentity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"container"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"id.service1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id.service1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"container"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"Disabled"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="nl">"OrchestrationInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"LXCMAC"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6e:b0:7d:4e:6b:e5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"IPv6"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"IPv4"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.11.255.104"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"NodeMAC"</span><span class="p">:</span><span class="w"> </span><span class="s2">"42:23:dc:4d:79:b1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"SecLabel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">12022</span><span class="p">,</span><span class="w">
    </span><span class="nl">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"container"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"id.service1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id.service1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"container"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"labelsSHA256"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"Options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"map"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Conntrack"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ConntrackAccounting"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ConntrackLocal"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Debug"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DebugLB"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DebugPolicy"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DropNotification"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"MonitorAggregationLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"NAT46"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"PolicyAuditMode"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"PolicyVerdictNotification"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"TraceNotification"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"DNSRules"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"DNSHistory"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"DNSZombies"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nl">"K8sPodName"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"K8sNamespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"DatapathConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>åˆæ˜ç™½äº†ä¸€ç‚¹ï¼Œè—äº†å®ä¾‹çš„åŸºæœ¬ä¿¡æ¯ã€‚æ³¨é‡Šçš„å¤´éƒ¨æœ‰å¾ˆå¤šçš„ä¿¡æ¯ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">*</span> Container ID: 32327f7b4cf9040af80afe9607e8b7f4305701d75e585ae216c35f9b481405b2
 <span class="k">*</span> IPv6 address:  //IPv6 åœ°å€
 <span class="k">*</span> IPv4 address: 10.11.255.104   // IPv4 åœ°å€
 <span class="k">*</span> Identity: 12022  // å½“å‰å®ä¾‹èº«ä»½æ ‡è¯†
 <span class="k">*</span> PolicyMap: cilium_policy_02665  // å½“å‰å®ä¾‹å¯¹åº”çš„ç­–ç•¥ Map
 <span class="k">*</span> NodeMAC: 42:23:dc:4d:79:b1  // å½“å‰å®ä¾‹çš„ Mac åœ°å€
</code></pre></div></div>

<p>çŸ¥é“äº† Policy å¯¹åº”çš„ Map  çŸ¥é“äº† BPF ç¨‹åºæ˜¯ Docker å®ä¾‹ä¸€ä¸€å¯¹åº”çš„é‚£ä¹ˆä¹…å¯ä»¥åˆ†æä¸€ä¸‹  BPF ç¨‹åºåšäº†äº›å•¥ï¼Œç›´æ¥åˆ†æ bpf_host.c å’Œ  bpf_lxc.c æ–‡ä»¶å§ã€‚</p>

<p>å¤§è‡´çœ‹äº†ä¸‹ bpf ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š</p>

<pre><code class="language-language">__section("sockops")

__section("from-netdev")
__section("from-host")
__section("to-netdev")
__section("to-host")

__section("from-container")
__section("to-container")

__section("from-network")
__section("from-overlay")
__section("to-overlay")

__section("connect4")
__section("post_bind4")
__section("sendmsg4")
__section("recvmsg4")
__section("getpeername4")

__section("post_bind6")
__section("connect6")
__section("sendmsg6")
__section("recvmsg6")
__section("getpeername6")

__section("from-netdev")
__section("sk_msg")
</code></pre>
<p>æ¯ä¸ª section ä»£è¡¨ä¸€ä¸ªå•ç‹¬çš„ç¨‹åºï¼Œå³ä½¿å¤šä¸ª section æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</p>

<p>æ€è€ƒï¼šeBPF å·¥ä½œåœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿè¢«åŠ è½½åˆ°å“ªå»ï¼Ÿä¸å¾—ä¸æçš„å…·ä½“å·¥ä½œå†…å®¹ï¼Ÿ</p>

<p>æ®ç›®å‰äº†è§£çš„ eBPF ç¨‹åºçš„åŠ è½½æ–¹å¼æœ‰ä¸‰ç§ï¼štcã€iproute2ã€bpfload</p>

<p>å‰ä¸¤ç§éƒ½æ˜¯ç½‘ç»œç”¨åˆ°çš„ eBPF ã€‚æ‰€ä»¥å°±ä» tcã€iproute2 ä¸‹æ‰‹ã€‚æ—¢ç„¶ä¸»è¦ç¨‹åºæ˜¯ç”¨æ¥è§£å†³è¿›æµé‡çš„è¿‡æ»¤ï¼Œä¸Šå±‚å±•ç¤ºæ˜¯ç”¨ label æ¥ç®¡ç†æµé‡è¿›å‡ºæƒé™ã€‚ä½†æ˜¯åº•å±‚ä¾ç„¶ä½¿ç”¨çš„æ˜¯ IP æƒé™ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">docker start demo1</code> -&gt; <code class="language-plaintext highlighter-rouge">request cilium-ipam</code> -&gt; <code class="language-plaintext highlighter-rouge">request cilium-cni</code> -&gt; <code class="language-plaintext highlighter-rouge">load demo1-bpf</code>  -&gt; <code class="language-plaintext highlighter-rouge">pin demo1-bpf-map</code>     <br />
åˆ¶å®šç­–ç•¥ ç¦æ­¢ demo2 è®¿é—® demo1
<code class="language-plaintext highlighter-rouge">docker start demo2 request demo1</code> -&gt; â†‘       -&gt;         â†‘            -&gt;     â†‘             -&gt;      â†‘             -&gt;  <code class="language-plaintext highlighter-rouge">request demo1-server</code>
                                      â†“ 
                                      <code class="language-plaintext highlighter-rouge">async policy</code> -&gt; <code class="language-plaintext highlighter-rouge">demo2-ip to demo1-bpf-map</code> 
                                                                                                   â†“
                                   <code class="language-plaintext highlighter-rouge">demo2 request timeout</code>      &lt;-   <code class="language-plaintext highlighter-rouge">package drop</code>       &lt;-    <code class="language-plaintext highlighter-rouge">demo1 ingress</code></p>

<p>è¿è¡Œå‘½ä»¤:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip addr

4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
    <span class="nb">link</span>/ether 02:42:62:0a:04:14 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:62ff:fe0a:414/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
6: veth6bf49a1@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default 
    <span class="nb">link</span>/ether 82:e0:f5:1a:8d:ca brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::80e0:f5ff:fe1a:8dca/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
8: veth20f4c3f@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default 
    <span class="nb">link</span>/ether ee:48:81:af:5e:7b brd ff:ff:ff:ff:ff:ff link-netnsid 1
    inet6 fe80::ec48:81ff:feaf:5e7b/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
9: cilium_net@cilium_host: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    <span class="nb">link</span>/ether 02:36:d7:87:c5:9b brd ff:ff:ff:ff:ff:ff
    inet6 fe80::36:d7ff:fe87:c59b/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
10: cilium_host@cilium_net: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    <span class="nb">link</span>/ether 3e:ac:d1:3d:fe:30 brd ff:ff:ff:ff:ff:ff
    inet 10.11.53.10/32 scope <span class="nb">link </span>cilium_host
       valid_lft forever preferred_lft forever
    inet6 fd01::b/128 scope global 
       valid_lft forever preferred_lft forever
    inet6 fe80::3cac:d1ff:fe3d:fe30/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
11: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/ether 16:96:5a:55:b7:43 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::1496:5aff:fe55:b743/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
13: lxc_health@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
    <span class="nb">link</span>/ether fe:17:fd:39:83:39 brd ff:ff:ff:ff:ff:ff link-netns cilium-health
    inet6 fe80::fc17:fdff:fe39:8339/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
19: lxc807633bfedea@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
    <span class="nb">link</span>/ether 42:23:dc:4d:79:b1 brd ff:ff:ff:ff:ff:ff link-netnsid 3
    inet6 fe80::4023:dcff:fe4d:79b1/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">lxcfd196ec6df51@if20</code> åº”è¯¥å°±æ˜¯å½“å‰ demo1 çš„ç½‘å¡äº†ã€‚é€šè¿‡  <code class="language-plaintext highlighter-rouge">ip link |grep xdp</code> å‘ç°å¹¶æ²¡æœ‰ <code class="language-plaintext highlighter-rouge">XDP</code> è¿è¡Œã€‚å¯èƒ½æ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œçš„åŸå› ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tc filter show dev lxcfd196ec6df51@if20 ingress
filter protocol all pref 1 bpf
filter protocol all pref 1 bpf handle 0x1 bpf_lxc.o:[from-container] direct-action
</code></pre></div></div>
<p>tc çš„å‘½ä»¤æ˜¾ç¤ºå…·æœ‰ eBPF ç¨‹åºåŠ è½½ã€‚åŠ è½½ <code class="language-plaintext highlighter-rouge">bpf_lxc.o:[from-container]</code> è¿˜æ˜¯ da æ¨¡å¼ ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">from-container</code> ä»£ç æŸ¥çœ‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__section</span><span class="p">(</span><span class="s">"from-container"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">handle_xgress</span><span class="p">(</span><span class="k">struct</span> <span class="n">__ctx_buff</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u16</span> <span class="n">proto</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

  <span class="n">bpf_clear_meta</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

  <span class="n">send_trace_notify</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">TRACE_FROM_LXC</span><span class="p">,</span> <span class="n">SECLABEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">TRACE_PAYLOAD_LEN</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">validate_ethertype</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proto</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">DROP_UNSUPPORTED_L2</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">):</span>
    <span class="n">invoke_tailcall_if</span><span class="p">(</span><span class="n">__or</span><span class="p">(</span><span class="n">__and</span><span class="p">(</span><span class="n">is_defined</span><span class="p">(</span><span class="n">ENABLE_IPV4</span><span class="p">),</span> <span class="n">is_defined</span><span class="p">(</span><span class="n">ENABLE_IPV6</span><span class="p">)),</span>
          <span class="n">is_defined</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)),</span>
           <span class="n">CILIUM_CALL_IPV6_FROM_LXC</span><span class="p">,</span> <span class="n">tail_handle_ipv6</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">):</span>
    <span class="n">invoke_tailcall_if</span><span class="p">(</span><span class="n">__or</span><span class="p">(</span><span class="n">__and</span><span class="p">(</span><span class="n">is_defined</span><span class="p">(</span><span class="n">ENABLE_IPV4</span><span class="p">),</span> <span class="n">is_defined</span><span class="p">(</span><span class="n">ENABLE_IPV6</span><span class="p">)),</span>
          <span class="n">is_defined</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)),</span>
           <span class="n">CILIUM_CALL_IPV4_FROM_LXC</span><span class="p">,</span> <span class="n">tail_handle_ipv4</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_ARP</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">CTX_ACT_OK</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="nl">default:</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">DROP_UNKNOWN_L3</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">out:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">send_drop_notify</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SECLABEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">CTX_ACT_DROP</span><span class="p">,</span>
          <span class="n">METRIC_EGRESS</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é—®é¢˜è¿˜æ˜¯æŒºå¤šçš„ï¼Œæ¯”å¦‚å…¥å‚ä¸ºä»€ä¹ˆä¸æ˜¯ <code class="language-plaintext highlighter-rouge">__skb_buff </code> è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥å¸¦ç€é—®é¢˜æœç´¢äº†ä¸€ä¸‹ï¼Œç„¶å¹¶æš–ã€‚ç›´æ¥å¤ä¹ ä¸‹ <code class="language-plaintext highlighter-rouge">Cilium æ¶æ„</code> å’Œ <code class="language-plaintext highlighter-rouge">eBPF ç¼–ç¨‹æŒ‡å—</code> å§ã€‚</p>

<h2 id="ebpf-ä¸‹å¾®æœåŠ¡ç½‘ç»œå®‰å…¨">eBPF ä¸‹å¾®æœåŠ¡ç½‘ç»œå®‰å…¨</h2>

<p>eBPF é€‚ç”¨äºç›‘æ§ã€å®‰å…¨å’Œç½‘ç»œé¢†åŸŸï¼š</p>

<p>Cilium é¡¹ç›®å¤§é‡ä½¿ç”¨äº† eBPF ï¼Œä¸ºåŸºäºå®¹å™¨çš„ç³»ç»Ÿæä¾›äº†è·¯ç”±å’Œç½‘ç»œæµé‡çš„è¿‡æ»¤ã€‚å¯ä»¥åœ¨ä¸ä¿®æ”¹å†…æ ¸çš„å‰æä¸‹åŠ¨æ€çš„ç”Ÿæˆå’Œåº”ç”¨è§„åˆ™ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      _______d:app1__________
      /    x         x
  :80/     |:22       <span class="se">\</span>
    <span class="nb">id</span>:app2          <span class="nb">id</span>:app3
</code></pre></div></div>

<p>ä¸Šé¢å°±åº”ç”¨äº† L3/L4 ç­–ç•¥å…è®¸ app2 é€šè¿‡ 80ç«¯å£è®¿é—® app1ï¼Œä¸å…è®¸ app3 è®¿é—® app1</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="w">
  </span><span class="nl">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"l3-rule"</span><span class="w">
  </span><span class="p">}],</span><span class="w">
  </span><span class="nl">"endpointSelector"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"matchLabels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app1"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ingress"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"fromEndpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
      </span><span class="nl">"matchLabels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app2"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"toPorts"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
      </span><span class="nl">"ports"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
        </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="s2">"80"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TCP"</span><span class="w">
      </span><span class="p">}]</span><span class="w">
    </span><span class="p">}]</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Cilium å…·ä½“æ˜¯å¦‚ä½•å®Œæˆä¸Šé¢çš„å·¥ä½œçš„ï¼Ÿ
<img src="https://img2020.cnblogs.com/blog/1334952/202004/1334952-20200418113727982-621490951.png" alt="æ¶æ„å›¾" /></p>

<p>Cilium ä¸ºæ¯ä¸ªä¸»æœºè¿è¡Œä¸€ä¸ª agentï¼Œå°†ç½‘ç»œç­–ç•¥å®šä¹‰è½¬æ¢æˆ BPF ç¨‹åºã€‚è¿™äº›ç¨‹åºä¼šè¢«åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚è¿™é‡Œä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¯æ¬¡æ³¨å…¥æ–°çš„ç­–ç•¥éƒ½ä¼šè§¦å‘ BPF é‡æ–°ç”Ÿæˆçš„é—®é¢˜ã€‚ä½†æ˜¯æ²¡æœ‰è§£å†³æ ¹æœ¬çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ¯æ¬¡ç­–ç•¥ä¿®æ”¹éƒ½éœ€è¦é‡æ–°ç”Ÿæˆ BPF ç¨‹åºï¼Œéš¾é“ä¸èƒ½ä¼˜åŒ–ä¹ˆï¼Ÿ
å½“ BPF ç¨‹åºè¢«åŠ è½½åˆ°å®¹å™¨çš„è™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡ä¸Šåï¼Œæ¯æ¬¡å‘é€å’Œæ¥æ”¶çš„æŠ¥æ–‡éƒ½ä¼šåº”ç”¨è¿™äº›è§„åˆ™ã€‚</p>

<p>Cilium ä½¿ç”¨ Hook åˆ—è¡¨ï¼š</p>
<ul>
  <li>XDPï¼š XDP Hoot æœ€æ—©å¯ä»¥åœ¨ç½‘ç»œé©±åŠ¨ä¸­ä½¿ç”¨ï¼Œåœ¨æŠ¥æ–‡æ¥æ”¶æ—¶è§¦å‘ BPF ç¨‹åºã€‚å¯ä»¥ä¿®æ”¹åŒ…åœ°å€å’Œç«¯å£</li>
  <li>Ingress/Egress æµæ§: ä¸ XDP ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é™„åŠ åˆ°ç½‘ç»œé©±åŠ¨ç¨‹åºä¸Šè§¦å‘ã€‚ä½†æ˜¯åœ¨ç½‘ç»œæ ˆå®Œæˆåˆå§‹åŒ–çš„æŠ¥æ–‡ä¹‹åè¿è¡Œã€‚è¯¥ Hook  åœ¨åè®®æ ˆçš„ L3 å±‚ä¹‹å‰è¿è¡Œï¼Œä½†å¯ä»¥è®¿é—®ä¸æŠ¥æ–‡ç›¸å…³çš„å¤§å¤šæ•°å…ƒæ•°æ®ã€‚</li>
  <li>socket æ“ä½œï¼šsocket Hook é™„åŠ åˆ°ä¸€ä¸ªç‰¹å®šçš„ cgroup ä¸Šï¼Œæ ¹æ® TCP äº‹ä»¶è¿è¡Œã€‚Cilium å°† BPF Socket æ“ä½œç¨‹åºé™„åŠ åˆ° cgroup ä¸Šï¼Œç›‘å¬ TCP çŠ¶æ€å˜æ›´ï¼Œç‰¹åˆ«æ˜¯å¯¹ ESTABLISHED çŠ¶æ€å˜æ›´ã€‚å½“ä¸€ä¸ª
socket çŠ¶æ€å˜åŒ–ä¸º ESTABLISHED æ—¶ï¼Œå¦‚æœ TCP socket çš„è¿æ¥çš„è¿œç¨‹ä½äºæœ¬èŠ‚ç‚¹ï¼Œå°±é™„åŠ  socket send/recv ç¨‹åºã€‚</li>
  <li>
    <p>socket å‘é€æ¥æ”¶ï¼šå•å°å·²ç»™ TCP socket æ‰§è¡Œå‘é€æ“ä½œæ—¶ä¼šè¿è¡Œ socket send/recv hookã€‚ è¿™ä¸ªæ—¶å€™ hook ä¼šæ£€æŸ¥æ¶ˆæ¯æˆ–è€…ä¸¢å¼ƒæ¶ˆæ¯ã€‚å°†æ¶ˆæ¯å‘é€è‡³ TCP å±‚æˆ–è€…ç›´æ¥é‡å®šå‘åˆ°å¦ä¸€ä¸ªå¥—æ¥å­—ã€‚Cilium ä½¿ç”¨å®ƒæ¥åŠ é€Ÿæ•°æ®è·¯å¾„é‡å®šå‘ã€‚</p>

    <p>æ€»ç»“ä¸€ä¸‹ï¼šå°±æ˜¯ XDP å±‚å·¥ä½œåœ¨ sk_buff å½¢æˆä¹‹å‰ï¼Œå¯ä»¥å¯¹åŸå§‹æ•°æ®åŒ…è¿›è¡Œæ“ä½œå¹¶ä¸”åªæœ‰è¿›è¿™ä¸ªå•å‘å¯ä»¥æ“ä½œã€‚Ingress/Egress æ˜¯åœ¨ sk_buff ä¸Šæ“ä½œï¼Œä¾‹å¦‚ï¼šIngress æ˜¯åœ¨ sk_buff å½¢æˆä¹‹åè¿›å…¥ä¸‰å±‚ä¹‹å‰è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯ä¸å¯ä»¥åœ¨ä¿®æ”¹é‡å®šå‘æ•°æ®åŒ…ã€‚å‰é¢ä¸¤ä¸ªéƒ½æ˜¯åœ¨é©±åŠ¨å±‚è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯ XDP æ“ä½œæ›´æå‰æ‰€ä»¥çœ‹èµ·æ¥æ•ˆç‡æ›´é«˜ã€‚äºŒè€…å¯ä»¥äº’è¡¥ã€‚
Cilium å¯¹ Socket çš„æ”¯æŒåˆ™æ˜¯æ”¾åœ¨ cgroup ä¸Šï¼Œç›‘å¬ TCP çš„çŠ¶æ€ï¼Œåªè¦ TCP è¿›å…¥ ESTABLISHED çŠ¶æ€ï¼Œå°±ä¼šé™„åŠ  BPF ç¨‹åºï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šç®¡ç† socket çŠ¶æ€ã€è¿æ¥å»ºç«‹ã€è¿æ¥é”€æ¯æ“ä½œã€‚åªä¼šåœ¨
socket å½¢æˆè¿æ¥ä¹‹ååˆ¤æ–­æ•°æ®åŒ…å‘å¾€çš„æ–¹å‘æ˜¯å¦åœ¨æœ¬æœºä¸Šï¼Œå¦‚æœæ˜¯å°±ä¼šç›´æ¥è½¬å‘åˆ°å¯¹åº”çš„ socketï¼Œå¦‚æœä¸æ˜¯å°±æŒ‰ç…§æ­£å¸¸çš„æµç¨‹ã€‚</p>
  </li>
</ul>

<p>æ‰€ä»¥ Cilium å®šä¹‰äº†ä¸‰ä¸ªè™šæ‹Ÿç½‘å¡æ¥å£ï¼Œcilium_netã€cilium_hostã€cilium_vxlan ï¼Œæ ¹æ®ä¸Šé¢çš„ Hook ä¸è¿™ä¸‰ä¸ªè™šæ‹Ÿç½‘å¡æ¥å£ç»“å©šï¼Œå¯ä»¥åˆ›å»ºä¸‹é¢çš„ç½‘ç»œå¯¹è±¡ï¼š</p>

<ul>
  <li>é¢„è¿‡æ»¤ï¼ˆprefilterï¼‰ï¼šprefilter ä¼šè¿è¡Œä¸€ä¸ª XDP ç¨‹åºï¼Œè¿‡æ»¤ç½‘ç»œä¸Šçš„æµé‡ã€‚æ ¹æ®ç›®çš„åœ°é€‰æ‹©ä¸¢å¼ƒæŠ¥æ–‡ã€å…è®¸ç½‘ç»œåè®®æ ˆå¤„ç†æŠ¥æ–‡ç­‰æ“ä½œã€‚å¯æ‰©å±•è¿‡æ»¤è§„åˆ™</li>
  <li>Endpoint ç­–ç•¥ï¼šEndpoint Policyå¯¹è±¡å®ç°Ciliumç«¯ç‚¹å¼ºåˆ¶ã€‚ä½¿ç”¨æ˜ å°„æŸ¥æ‰¾ä¸æ ‡è¯†å’Œç­–ç•¥ç›¸å…³çš„æ•°æ®åŒ…ï¼Œè¯¥å±‚å¯ä»¥å¾ˆå¥½åœ°æ‰©å±•åˆ°è®¸å¤šç«¯ç‚¹ã€‚æ ¹æ®ç­–ç•¥ï¼Œ
è¯¥å±‚å¯ä»¥ä¸¢å¼ƒæ•°æ®åŒ…ã€è½¬å‘åˆ°æœ¬åœ°ç«¯ç‚¹ã€è½¬å‘åˆ°æœåŠ¡å¯¹è±¡æˆ–è½¬å‘åˆ°L7ç­–ç•¥å¯¹è±¡ä»¥è·å¾—è¿›ä¸€æ­¥çš„L7è§„åˆ™ã€‚è¿™æ˜¯Ciliumæ•°æ®è·¯å¾„ä¸­çš„ä¸»è¦å¯¹è±¡ï¼Œè´Ÿè´£å°†æ•°æ®åŒ…æ˜ å°„åˆ°æ ‡è¯†å¹¶å¼ºåˆ¶æ‰§è¡ŒL3å’ŒL4ç­–ç•¥ã€‚</li>
  <li>Service: Serviceå¯¹è±¡å¯¹è¯¥å¯¹è±¡æ¥æ”¶åˆ°çš„æ¯ä¸ªåŒ…æ‰§è¡Œç›®çš„åœ°IPå’Œå¯é€‰ç›®çš„åœ°ç«¯å£ä¸Šçš„æ˜ å°„æŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„è¡¨é¡¹ï¼ŒæŠ¥æ–‡å°†è¢«è½¬å‘åˆ°é…ç½®
çš„L3/L4ç«¯ç‚¹ä¹‹ä¸€ã€‚Serviceå—å¯ä»¥ç”¨äºåœ¨ä½¿ç”¨TCå…¥å£é’©å­çš„ä»»ä½•æ¥å£ä¸Šå®ç°ç‹¬ç«‹çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä¹Ÿå¯ä»¥é›†æˆåˆ°ç«¯ç‚¹ç­–ç•¥å¯¹è±¡ä¸­ã€‚</li>
  <li>socket layer Enforcementï¼šsocket layer Enforcementä¼šä½¿ç”¨ä¸¤ä¸ªé’©å­ï¼Œsocket æ“ä½œé’©å­å’Œsocket å‘é€/æ¥æ”¶é’©å­æ¥ç›‘æ§å¹¶é™„åŠ åˆ°æ‰€æœ‰ä¸Ciliumç®¡ç†çš„endpointç›¸å…³çš„TCP socketï¼Œ
åŒ…æ‹¬L7ä»£ç†ã€‚socketæ“ä½œé’©å­ä¼šè¯†åˆ«è¦åŠ é€Ÿçš„å€™é€‰å¥—æ¥å­—ï¼Œè¿™äº›å€™é€‰å¥—æ¥å­—åŒ…æ‹¬æ‰€æœ‰çš„æœ¬åœ°èŠ‚ç‚¹è¿æ¥(endpointåˆ°endpoint)ä»¥åŠæ‰€æœ‰åˆ°Ciliumä»£ç†çš„è¿æ¥ã€‚è¿™äº›æ ‡è¯†çš„è¿æ¥å°†ä¼šåŒ…å«æ‰€æœ‰
ç”±socket å‘é€/æ¥æ”¶é’©å­å¤„ç†çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ä½¿ç”¨sockmapå¿«é€Ÿé‡å®šå‘è¿›è¡ŒåŠ é€Ÿã€‚å¿«é€Ÿé‡å®šå‘ä¿è¯Ciliumä¸­å®ç°çš„æ‰€æœ‰ç­–ç•¥å¯¹äºå…³è”çš„socket/endpointæ˜ å°„å‡æœ‰æ•ˆï¼Œå¹¶å‡è®¾
å®ƒä»¬ä¼šç›´æ¥å‘å¯¹ç«¯socketå‘é€æ¶ˆæ¯ã€‚sockmap send/recvé’©å­ç¡®ä¿æ¶ˆæ¯ä¸ä¼šè¢«ä¸Šé¢æåˆ°çš„ä»»ä½•å¯¹è±¡å¤„ç†ã€‚</li>
  <li>
    <p>L7ç­–ç•¥ï¼šL7ç­–ç•¥å¯¹è±¡å°†ä»£ç†çš„æµé‡é‡å®šå‘åˆ°ä¸€ä¸ªCiliumç”¨æˆ·ç©ºé—´ä»£ç†å®ä¾‹ä¸­ã€‚Ciliumä½¿ç”¨ä¸€ä¸ªEnvoyä½œä¸ºå®ƒçš„ç”¨æˆ·ç©ºé—´ä»£ç†ã€‚Envoyè¦ä¹ˆè½¬å‘æµé‡ï¼Œè¦ä¹ˆä¼šæ ¹æ®é…ç½®çš„L7ç­–ç•¥ç”Ÿæˆæ‹’ç»æ¶ˆæ¯ã€‚</p>

    <p>æ€»ç»“ï¼šæ°”æ°›éƒ½è½°åˆ°è¿™äº†ï¼Œè¯´å®è¯è¿™æ®µæ²¡çœ‹æ‡‚ã€‚çŒœæµ‹ä¸€ä¸‹å§ï¼Œå°±æ˜¯æ ¹æ®ä¸Šé¢çš„æåˆ°çš„æ¦‚å¿µåšäº†ä¸€ä¸ªå…·ä½“çš„å®ç°å’ŒåŠŸèƒ½åˆ’åˆ†ï¼Œå…·ä½“å®ç°åˆ†ä¸º
cilium_netã€cilium_hostã€cilium_vxlan ä¸‰ä¸ªè™šæ‹Ÿæ¥å£ï¼Œè™šæ‹Ÿæ¥å£å°±æ˜¯ ipvlan ç›¸å…³æ¦‚å¿µäº†ï¼Œç„¶åè„‘æŠ½çš„å»å­¦ä¹ äº†ä¸€ä¸‹ ipvlanã€‚ä¸‹é¢ç»§ç»­ç¬”è®°ã€‚
é¢„è¿‡æ»¤å°±æ˜¯ XDP å±‚æåˆ°çš„åŠŸèƒ½æ›´ï¼ŒEndpoint ç­–ç•¥å°±æ˜¯å±äºæµé‡æ²»ç†äº†ï¼Œä¸€ä¸ªæ²»ç† L3ã€L4 æµé‡ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯å°†æµé‡è½¬å‘åˆ°ç”¨æˆ·ç©ºé—´å»å¤„ç† L7 æµé‡ã€‚
Service ç›®æµ‹æ˜¯åšäº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡ï¼Œä¸ k8s çš„ Service å¥½åƒæ˜¯ä¸€æ ·çš„ï¼Œå½“æµé‡è¿›æ¥äº†ä»¥åæŸ¥æ‰¾è‡ªå·±æ‰€ä»£ç†çš„å®ä¾‹ç„¶åå°†æµé‡è½¬å‘è¿‡å»ï¼Œè¿™é‡Œæ²¡æœ‰è¯´æ˜æµé‡
æ˜¯æœ‰çŠ¶æ€çš„è¿˜æ˜¯æ— çŠ¶æ€çš„ã€‚
socket å°±æ˜¯çŸ­è·¯å¾„çš„æ¦‚å¿µäº†ï¼Œä¸å‚ä¸è¿æ¥çš„å»ºç«‹ã€é”€æ¯ã€‚å»ºç«‹å®Œæˆä¹‹åç›‘å¬æ•°æ®çš„å‘é€å’Œè½¬å‘ã€‚</p>
  </li>
</ul>

<p>å¤ªé•¿äº† 400è¡Œäº†ï¼Œå»ç»­ç»­çœ‹ ipvlan</p>

:ET