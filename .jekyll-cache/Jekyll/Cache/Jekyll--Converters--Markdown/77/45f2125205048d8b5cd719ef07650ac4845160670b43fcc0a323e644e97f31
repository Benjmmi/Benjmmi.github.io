I"÷<h1 id="bpf-co-re">BPF CO-RE</h1>
<p>å‚è€ƒ:<a href="https://blog.gmem.cc/ebpf">https://blog.gmem.cc/ebpf</a></p>

<p>BPF CO-RE ä¸ Java åˆå§‹ç›®çš„ä¸€è‡´ï¼Œä¸€æ¬¡ç¼–è¯‘å¯¼å‡ºè¿è¡Œã€‚
äº§ç”Ÿçš„åŸå› å°±æ˜¯å› ä¸ºå†…æ ¸ç‰ˆæœ¬ç›´æ¥å­˜åœ¨çš„å·®å¼‚å¯èƒ½å¯¼è‡´æŸäº›å­—æ®µã€ç»“æ„é¡ºåºçš„æ”¹å˜ï¼Œå¯¼è‡´å†è¿™ä¸ªå†…æ ¸ä¸Šå¯ä»¥è¿è¡Œï¼Œä½†æ˜¯åˆ°å¦ä¸€ä¸ªå†…æ ¸å‡ºç°è¿è¡Œæ˜¯å¤±è´¥çš„æƒ…å†µã€‚</p>

<p>åˆå§‹ BCC è§£å†³æ–¹æ¡ˆï¼š
BCC æ˜¯å¾ˆå¥½çš„ä¸€æ¬¾ eBPF ç¼–ç¨‹å·¥å…·ï¼Œå†ä½¿ç”¨ BCC æ—¶ BPF å†…æ ¸ç¨‹åºçš„ c ä»£ç è¢«åµŒå…¥åˆ°å‰ç«¯è¯­è¨€ä¸­ã€‚è€Œä¸” BCC åªä¼šåœ¨ç›®æ ‡æœºå™¨ä¸Šç¼–è¯‘æºç è¿è¡Œä¸ä¼šäº§ç”Ÿç¼–è¯‘å¥½çš„è¾“å‡ºæ–‡ä»¶ã€‚BCC çš„ç¡®å½“</p>
<ol>
  <li>Clang/LLVM å†ç¼–è¯‘æ—¶å¾ˆè€—èµ„æºï¼Œå¦‚æœå†ç¨‹åºå¯åŠ¨æ—¶ç¼–è¯‘ BPF ä»£ç ï¼Œå¯¹ç”Ÿäº§ç¯å¢ƒä¸å‹å¥½</li>
  <li>ç›®æ ‡æœºå™¨å¯èƒ½ä¸åŒ…å«æŒ‡å®šçš„å†…æ ¸æ–‡ä»¶</li>
  <li>è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰ç¼–è¯‘é”™è¯¯</li>
  <li>è¯»å†™ BPF Map æ—¶éœ€è¦ç¼–å†™é¢å‘å¯¹è±¡çš„ C ä»£ç ã€‚</li>
</ol>

<h2 id="co-be-åŸç†">CO-BE åŸç†ï¼š</h2>
<p>å°†å¿…è¦çš„åŠŸèƒ½æ•°æ®ç‰‡æ•´åˆåˆ°ä¸€èµ·ï¼Œé™ä½å¯ä»¥ç§»æ¤ BPF ç¨‹åºçš„éš¾åº¦ã€‚</p>
<ol>
  <li>BTFç±»å‹ä¿¡æ¯ï¼šå…è®¸æ•è·å…³äºå†…æ ¸ã€BPFç¨‹åºçš„ç±»å‹/ä»£ç çš„å…³é”®ä¿¡æ¯</li>
  <li>Clangä¸ºBPFç¨‹åºCä»£ç æä¾›äº†express the intentå’Œè®°å½•relocationä¿¡æ¯çš„æ‰‹æ®µ</li>
  <li>BPF loaderï¼ˆlibbpfï¼‰æ ¹æ®å†…æ ¸çš„BTFå’ŒBPFç¨‹åºï¼Œè°ƒæ•´ç¼–è¯‘åçš„BPFä»£ç ï¼Œä½¿å…¶é€‚åˆåœ¨ç›®æ ‡å†…æ ¸ä¸Šè¿è¡Œ</li>
  <li>å¯¹äºBPF CO-REä¸å¯çŸ¥çš„å†…æ ¸ï¼Œæä¾›äº†ä¸€äº›é«˜çº§çš„BPFç‰¹æ€§ï¼Œæ»¡è¶³é«˜çº§åœºæ™¯</li>
</ol>

<h2 id="btf">BTF</h2>
<p>å³BPF Type Formatï¼Œç±»ä¼¼äºDWARFè°ƒè¯•ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰é‚£ä¹ˆgenericå’Œverboseã€‚BTFèƒ½å¤Ÿç”¨æ¥å¢å¼ºBPF verifierçš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå…è®¸BPFä»£ç ç›´æ¥è®¿é—®å†…æ ¸å†…å­˜ã€‚
å¯¹äºCO-REæ¥è¯´ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå†…æ ¸é€šè¿‡ /sys/kernel/btf/vmlinuxæš´éœ²äº†æƒå¨çš„ã€è‡ªæè¿°çš„BTFä¿¡æ¯ã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å¯ä»¥å¾—åˆ°ä¸€ä¸ªå¯ç¼–è¯‘çš„Cå¤´æ–‡ä»¶ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">bpftool btf dump file /sys/kernel/btf/vmlinux format c</code></p>

<h2 id="ç¼–è¯‘æ”¯æŒ">ç¼–è¯‘æ”¯æŒ</h2>
<p>ä¸ºäº†å¯ç”¨CO-REï¼Œå¹¶ä¸”è®©BPF loaderï¼ˆlibbpfï¼‰æ¥ä¸ºæ­£åœ¨è¿è¡Œçš„ï¼ˆç›®æ ‡ï¼‰å†…æ ¸è°ƒæ•´BPFç¨‹åºï¼ŒClangè¢«æ‰©å±•ï¼Œå¢åŠ äº†ä¸€äº›built-insã€‚</p>

<p>è¿™äº›built-insä¼šå‘å‡ºï¼ˆemitï¼‰BTF relocationsï¼ŒBTF relocationsæ˜¯BPFç¨‹åºéœ€è¦è¯»å–ä»€ä¹ˆä¿¡æ¯çš„é«˜å±‚æè¿°ã€‚å‡è®¾ç¨‹åºéœ€è¦è®¿é—®task_struct-&gt;pidï¼ŒClangä¼šå°†å…¶è®°å½•ï¼š
éœ€è¦è®¿é—®pid_tç±»å‹çš„ã€åä¸ºpidã€ä½äºtask_structç»“æ„ä¸­çš„å­—æ®µã€‚è¿™æ ·ï¼Œå³ä½¿å­—æ®µé¡ºåºè°ƒæ•´ï¼Œç”šè‡³pidå­—æ®µè¢«æ”¾å…¥ä¸€ä¸ªå†…åµŒçš„åŒ¿åç»“æ„ä½“/è”åˆä½“ä¸­ï¼ŒBPFç¨‹åºä»ç„¶èƒ½å¤Ÿæ­£ç¡®è®¿é—®åˆ°pidå­—æ®µã€‚
æé«˜äº†å†…æ ¸ä¹‹é—´çš„å…¼å®¹æ€§ã€‚</p>

<p>èƒ½ä¸æ•è·ï¼ˆè¿›è€Œé‡å®šä½ï¼‰çš„ä¿¡æ¯ä¸å•å•æ˜¯å­—æ®µåç§»é‡ï¼Œè¿˜åŒ…æ‹¬å­—æ®µæ˜¯å¦å­˜åœ¨ã€å­—æ®µçš„sizeã€‚ç”šè‡³å¯¹äºä½åŸŸï¼ˆbitfieldï¼‰å­—æ®µï¼Œä¹Ÿèƒ½å¤Ÿæ•è·è¶³å¤Ÿå¤šçš„ä¿¡æ¯ï¼Œè®©å¯¹å®ƒçš„è®¿é—®èƒ½å¤Ÿè¢«é‡å®šä½ã€‚</p>

<h2 id="bpf-loader">BPF loader</h2>
<p>BPF loaderåœ¨åŠ è½½ç¨‹åºæ—¶ï¼Œä¼šåˆ©ç”¨å‰è¿°çš„ï¼ˆæ„å»ºæœºçš„ï¼‰å†…æ ¸BTFä¿¡æ¯ã€Clangé‡å®šä½ä¿¡æ¯ï¼Œå¹¶è¯»å–å½“å‰å†…æ ¸çš„BTFä¿¡æ¯ï¼Œå¯¹BPFç¨‹åºï¼ˆELF objectæ–‡ä»¶ï¼‰è¿›è¡Œè£å‡ï¼ˆcustom tailoredï¼‰ â€”â€” è§£æå’ŒåŒ¹é…æ‰€æœ‰ç±»å‹ã€å­—æ®µï¼Œæ›´æ–°å­—æ®µåç§»é‡ï¼Œä»¥åŠå…¶å®ƒå¯é‡å®šä½æ•°æ® â€”â€” ç¡®ä¿ç¨‹åºåœ¨å½“å‰å†…æ ¸ä¸Šèƒ½å¤Ÿæ­£ç¡®è¿è¡Œã€‚</p>

<p>æè¿°ï¼šCO-RE é€šè¿‡ç¼–è¯‘æˆç±»ä¼¼ä¸­é—´ä»£ç çš„ BTF æ–‡ä»¶ï¼Œåœ¨ BPF Loader åŠ è½½çš„æ—¶å€™æ ¹æ®å½“å‰å†…æ ¸ä¿¡æ¯å¯¹ç¨‹åºè¿›è¡Œè£å‰ªã€‚ä¹Ÿå°±æ˜¯è¯´æƒ³è¦å¼„æ‡‚ libbpf åº•å±‚å¯èƒ½éœ€è¦ä¸€äº›ç¼–è¯‘åŸç†çš„å®æ“èƒ½åŠ›ã€‚</p>

<h1 id="å†…æ ¸">å†…æ ¸</h1>
<p>è¦æ”¯æŒCO-REï¼Œå†…æ ¸ä¸éœ€è¦æ›´å¤šçš„æ”¹å˜ï¼ˆé™¤äº†å¼€å¯CONFIG_DEBUG_INFO_BTFï¼‰ã€‚è¢«BPF loaderï¼ˆlibbpfï¼‰å¤„ç†è¿‡çš„BPFç¨‹åºï¼Œå¯¹äºå†…æ ¸æ¥è¯´ï¼Œå’Œåœ¨æœ¬æœºç¼–è¯‘çš„BPFç¨‹åºæ˜¯å®Œå…¨ç­‰ä»·çš„ã€‚</p>

<h2 id="å¯ç§»æ¤æ€§æ¼”ç¤º">å¯ç§»æ¤æ€§æ¼”ç¤ºï¼š</h2>

<p>å‡è®¾æˆ‘ä»¬æœŸæœ›è¯»å–task_structç»“æ„ä½“çš„pidå­—æ®µã€‚ä½¿ç”¨BCCæ—¶ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®ï¼š
pid_t pid = task-&gt;pid;
BCCä¼šè‡ªåŠ¨å°†å…¶é‡å†™ä¸ºå¯¹ bpf_probe_read()çš„è°ƒç”¨ã€‚</p>

<ol>
  <li>å¦‚æœæ·»åŠ äº† <strong><a href="https://patchwork.ozlabs.org/project/netdev/list/?series=139747&amp;state=*">BTF_PROG_TYPE_TRACING</a></strong> ç¨‹åº
ä½¿ç”¨CO-REçš„æ—¶å€™ï¼Œç”±äºæ²¡æœ‰BCCè¿™ç§ä»£ç é‡å†™æœºåˆ¶ï¼Œä¸ºäº†æ‰“æˆåŒæ ·æ•ˆæœï¼Œä½ å¯èƒ½éœ€è¦ï¼š
libbpf + BPF_PROG_TYPE_TRACINGï¼šå¦‚æœç¼–å†™çš„æ˜¯è¿™ç±»ç¨‹åºï¼Œä½ å¯ä»¥ç›´æ¥å†™ï¼š
<code class="language-plaintext highlighter-rouge">pid_t pid = task-&gt;pid;</code>
è€Œä¸éœ€è¦bpf_probe_read()è°ƒç”¨ã€‚è¦å®ç°å¯ç§»æ¤æ€§ï¼Œåˆ™éœ€è¦å°†ä¸Šè¿°ä»£ç åŒ…å›´åˆ° __builtin_preserve_access_indexä¸­ï¼š
<code class="language-plaintext highlighter-rouge">pid_t pid = __builtin_preserve_access_index(({ task-&gt;pid; }));</code></li>
</ol>

<p><strong><code class="language-plaintext highlighter-rouge">ä½†æ˜¯</code></strong>
<strong><a href="https://patchwork.ozlabs.org/project/netdev/list/?series=139747&amp;state=*">BTF_PROG_TYPE_TRACING</a></strong> ç¨‹åº è¿‡äºè¶…å‰ï¼Œå¯¹äºä½ç‰ˆæœ¬çš„å†…æ ¸
è¿˜æ˜¯éœ€è¦æ˜¾å¼åœ°è°ƒç”¨ <code class="language-plaintext highlighter-rouge">bpf_probe_read()</code> 
ç°åœ¨ï¼Œä½¿ç”¨CO-RE+libbpfï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼æ¥å®ç°è®¿é—®pidå­—æ®µçš„å€¼ã€‚ä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">bpf_core_read()</code>æ›¿æ¢ <code class="language-plaintext highlighter-rouge">bpf_probe_read()</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<span class="n">bpf_core_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</code></pre></div></div>

<p>åŸå› ï¼šbpf_core_read()æ˜¯ä¸€ä¸ªç®€å•çš„å®ï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„å‚æ•°ç›´æ¥ä¼ é€’ç»™bpf_probe_read()ï¼Œ<strong>ä½†ä¹Ÿä¼šä½¿Clangé€šè¿‡__builtin_preserve_access_index()è®°å½•ç¬¬ä¸‰ä¸ªå‚æ•°(&amp;task-&gt;pid)çš„å­—æ®µçš„åç§»é‡ã€‚</strong>
æ‰€ä»¥æœ€ç»ˆç¿»è¯‘ä¹‹åçš„è°ƒç”¨ä»£ç ï¼š<code class="language-plaintext highlighter-rouge">bpf_probe_read(&amp;pid, **sizeof**(pid), __builtin_preserve_access_index(&amp;task-&gt;pid));</code></p>

<p>ä½†æ˜¯ è¿›è¡Œpointer chasingæ—¶ï¼Œä½¿ç”¨bpf_probe_read()/bpf_core_read()ä¼šå˜å¾—ç—›è‹¦ã€‚ å¹¸è¿çš„æ˜¯ï¼ŒCO-REæä¾›äº†<em><code class="language-plaintext highlighter-rouge">åŠ©æ‰‹å®</code></em>ï¼Œä½¿ç”¨ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u64</span> <span class="n">inode</span> <span class="o">=</span> <span class="n">BPF_CORE_READ</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">exe_file</span><span class="p">,</span> <span class="n">f_inode</span><span class="p">,</span> <span class="n">i_ino</span><span class="p">);</span>
 
<span class="c1">// æˆ–è€…</span>
<span class="n">u64</span> <span class="n">inode</span><span class="p">;</span>
<span class="n">BPF_CORE_READ_INTO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">exe_file</span><span class="p">,</span> <span class="n">f_inode</span><span class="p">,</span> <span class="n">i_ino</span><span class="p">);</span>
</code></pre></div></div>

<p>ç±»ä¼¼çš„ï¼Œå’Œ bpf_probe_read_str()å¯¹åº”çš„CO-REå‡½æ•°æ˜¯ bpf_core_read_str()ï¼Œä»¥åŠåŠ©æ‰‹å® BPF_CORE_READ_STR_INTO()ã€‚</p>

<p>å½“ç„¶å¯ä»¥é¿å…ä¸Šé¢çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥å­—æ®µæ˜¯å¦åœ¨ç›®æ ‡å†…æ ¸å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨ bpf_core_field_exists()å®ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">pid_t pid = bpf_core_field_exists(task-&gt;pid) ? BPF_CORE_READ(task, pid) : -1;</code></p>

<p>æ­¤å¤–ï¼Œå¯ä»¥é€šè¿‡bpf_core_field_size()å®æ•è·ä»»æ„å­—æ®µçš„å¤§å°ï¼Œä»¥æ­¤æ¥ä¿è¯ä¸åŒå†…æ ¸ç‰ˆæœ¬é—´çš„å­—æ®µå¤§å°æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">u32 comm_sz = bpf_core_field_size(task-&gt;comm);</code></p>

<p>ä½åŸŸå­—æ®µçš„è¯»å–ï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">...;</span>
 
<span class="c1">// è¯»å–s-&gt;is_cwnd_limitedå¯¹åº”çš„ä½åŸŸå­—æ®µ</span>
<span class="n">bool</span> <span class="n">is_cwnd_limited</span> <span class="o">=</span> <span class="n">BPF_CORE_READ_BITFIELD</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">is_cwnd_limited</span><span class="p">);</span>
 
<span class="c1">// æˆ–è€…</span>
<span class="n">u64</span> <span class="n">is_cwnd_limited</span><span class="p">;</span>
<span class="n">BPF_CORE_READ_BITFIELD_PROBED</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">is_cwnd_limited</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_cwnd_limited</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="å†…æ ¸ç‰ˆæœ¬å’Œé…ç½®å·®å¼‚-æ ¹æ®ç”¨æˆ·é…ç½®ä¿®æ”¹è¡Œä¸º-è¿™ä¸¤ç§ä¸€èˆ¬é‡ä¸åˆ°å…ˆè·³è¿‡">å†…æ ¸ç‰ˆæœ¬å’Œé…ç½®å·®å¼‚ æ ¹æ®ç”¨æˆ·é…ç½®ä¿®æ”¹è¡Œä¸º è¿™ä¸¤ç§ä¸€èˆ¬é‡ä¸åˆ°ï¼Œå…ˆè·³è¿‡</h1>

<h1 id="æ€»ç»“">æ€»ç»“</h1>

<p>libbpf é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å¸®ç»„ç”¨æˆ·å®ç° CO-RE çš„ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">vmlinux.h</code> æ¶ˆé™¤äº†å¯¹å†…æ ¸å¤´æ–‡ä»¶çš„ä¾èµ–</li>
  <li>å­—æ®µé‡å®šä½(å­—æ®µåç§»ï¼Œå­˜åœ¨æ€§ï¼Œå¤§å°ç­‰)ä½¿å¾—å¯ä»¥ä»å†…æ ¸ä¸­æŠ½å–æ•°æ®ï¼›</li>
  <li>libbpfæä¾›çš„Kconfigå¤–éƒ¨å˜é‡å…è®¸BPFç¨‹åºé€‚åº”å„ç§å†…æ ¸ç‰ˆæœ¬ä»¥åŠç‰¹å®šé…ç½®çš„æ›´æ”¹ï¼›</li>
  <li>å½“ä¸Šè¿°éƒ½ä¸é€‚åˆæ—¶ï¼Œappæä¾›äº†åªè¯»çš„é…ç½®å’Œstruct flavorsï¼Œä½œä¸ºè§£å†³ä»»ä½•åº”ç”¨ç¨‹åºå¿…é¡»å¤„ç†çš„å¤æ‚åœºæ™¯çš„æœ€ç»ˆå¤§é”¤ã€‚</li>
</ul>

<h1 id="libbpf-bootstrap">libbpf-bootstrap</h1>
<p>libbpf-bootstrap æä¾›äº† ä½¿ç”¨ libbpf æŠ½è±¡å‡ºæ¥çš„å¼€å‘ bpf çš„æ‰‹è„šæ¶å·¥å…·ã€‚
libbpf-bootstrap ç›®å‰æœ‰ä¸¤ä¸ªæ¼”ç¤º BPF åº”ç”¨ç¨‹åºå¯ç”¨ï¼šminimal å’Œbootstrap. minimalå°±æ˜¯è¿™æ ·â€”â€”ç¼–è¯‘ã€åŠ è½½å’Œè¿è¡Œä¸€ä¸ªç®€å•çš„ BPF ç­‰ä»·ç‰©çš„æœ€å° BPF åº”ç”¨ç¨‹åºprintf(â€œHello, World!â€)ã€‚ä½œä¸ºæœ€å°çš„ä¸€ä¸ªï¼Œå®ƒä¹Ÿæ²¡æœ‰å¯¹ Linux å†…æ ¸çš„æœ€æ–°æ€§å¼ºåŠ å¤ªå¤šè¦æ±‚ï¼Œå¹¶ä¸”åº”è¯¥åœ¨ç›¸å½“æ—§çš„å†…æ ¸ç‰ˆæœ¬ä¸Šè¿è¡Œè‰¯å¥½ã€‚</p>

<p>æ­¤å¤–ï¼Œbootstrapæ¼”ç¤ºäº† BPF å…¨å±€å˜é‡çš„ä½¿ç”¨ï¼ˆLinux 5.5+ï¼‰å’ŒBPF ç¯å½¢ç¼“å†²åŒºçš„ä½¿ç”¨ï¼ˆLinux 5.8+ï¼‰ã€‚è¿™äº›ç‰¹æ€§éƒ½ä¸æ˜¯æ„å»ºæœ‰ç”¨çš„ BPF åº”ç”¨ç¨‹åºæ‰€å¿…éœ€çš„ï¼Œä½†å®ƒä»¬å¸¦æ¥äº†å·¨å¤§çš„å¯ç”¨æ€§æ”¹è¿›ï¼Œå¹¶ä¸”æ˜¯æ„å»ºç°ä»£ BPF åº”ç”¨ç¨‹åºçš„æ–¹å¼ï¼Œå› æ­¤æˆ‘åœ¨åŸºæœ¬bootstrapç¤ºä¾‹ä¸­æ·»åŠ äº†ä½¿ç”¨å®ƒä»¬çš„ç¤ºä¾‹ã€‚</p>

<p>libbpf-bootstrap ä¸ libbpfï¼ˆä½œä¸º Git å­æ¨¡å—ï¼‰å’Œ bpftoolï¼ˆä»…é€‚ç”¨äº x86-64 æ¶æ„ï¼‰æ†ç»‘åœ¨ä¸€èµ·ï¼Œä»¥é¿å…ä¾èµ– Linux å‘è¡Œç‰ˆä¸­å¯ç”¨çš„ä»»ä½•ç‰¹å®šï¼ˆå¹¶ä¸”å¯èƒ½å·²è¿‡æ—¶ï¼‰ç‰ˆæœ¬ã€‚æ‚¨çš„ç³»ç»Ÿè¿˜åº”å®‰è£…zlib(libz-devæˆ–zlib-develåŒ…) å’Œlibelf (libelf-devæˆ–elfutils-libelf-develåŒ…) ã€‚è¿™äº›æ˜¯libbpfæ­£ç¡®ç¼–è¯‘å’Œè¿è¡Œå®ƒæ‰€å¿…éœ€çš„ä¾èµ–é¡¹ã€‚</p>

<h1 id="libbpf-bootstrap-æ¦‚è¿°">Libbpf-bootstrap æ¦‚è¿°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree
<span class="nb">.</span>
â”œâ”€â”€ libbpf
â”‚   â”œâ”€â”€ ...
â”‚   ... 
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ bootstrap.bpf.c
â”‚   â”œâ”€â”€ bootstrap.c
â”‚   â”œâ”€â”€ bootstrap.h
â”‚   â”œâ”€â”€ Makefile
â”‚   â”œâ”€â”€ minimal.bpf.c
â”‚   â”œâ”€â”€ minimal.c
â”‚   â”œâ”€â”€ vmlinux_508.h
â”‚   â””â”€â”€ vmlinux.h -&gt; vmlinux_508.h
â””â”€â”€ tools
    â”œâ”€â”€ bpftool
    â””â”€â”€ gen_vmlinux_h.sh

16 directories, 85 files
</code></pre></div></div>
<p>tools/åŒ…å«bpftooläºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºæ„å»º BPF ä»£ç çš„BPF éª¨æ¶ã€‚ä¸ libbpf ç±»ä¼¼ï¼Œå®ƒè¢«æ†ç»‘ä»¥é¿å…ä¾èµ–äºç³»ç»ŸèŒƒå›´çš„ bpftool å¯ç”¨æ€§åŠå…¶ç‰ˆæœ¬æ˜¯å¦è¶³å¤Ÿæœ€æ–°ã€‚</p>

<p>bpftool å¯ç”¨äºç”Ÿæˆæ‚¨è‡ªå·±çš„vmlinux.håŒ…å«æ‰€æœ‰ Linux å†…æ ¸ç±»å‹å®šä¹‰çš„å¤´æ–‡ä»¶ã€‚
BPF CO-REï¼Œvmlinux.hä¸å¿…å®Œå…¨åŒ¹é…æ‚¨çš„å†…æ ¸é…ç½®å’Œç‰ˆæœ¬ã€‚
<strong>ä½†æ˜¯</strong>ï¼Œå¦‚æœæ‚¨ç¡®å®éœ€è¦ç”Ÿæˆè‡ªå®šä¹‰vmlinux.hï¼Œè¯·éšæ—¶æ£€æŸ¥ tools/gen_vmlinux_h.sh è„šæœ¬ä»¥äº†è§£å¦‚ä½•å®Œæˆã€‚</p>

<p>Makefile å®šä¹‰äº†å¿…è¦çš„æ„å»ºè§„åˆ™æ¥ç¼–è¯‘æ‰€æœ‰æä¾›çš„ï¼ˆå’Œä½ è‡ªå®šä¹‰çš„ï¼‰BPF åº”ç”¨ç¨‹åºã€‚å®ƒéµå¾ªä¸€ä¸ªç®€å•çš„æ–‡ä»¶å‘½åçº¦å®šï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;app&gt;.bpf.c</code> æ–‡ä»¶æ˜¯åŒ…å«è¦åœ¨å†…æ ¸ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„é€»è¾‘çš„ BPF C ä»£ç ï¼›</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;app&gt;.c</code> æ˜¯ç”¨æˆ·ç©ºé—´çš„ C ä»£ç ï¼Œå®ƒåœ¨åº”ç”¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åŠ è½½ BPF ä»£ç å¹¶ä¸ä¹‹äº¤äº’ï¼›</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;app&gt;.h</code> æ˜¯å¯é€‰å…·æœ‰é€šç”¨ç±»å‹å®šä¹‰çš„å¤´æ–‡ä»¶ï¼Œç”±åº”ç”¨ç¨‹åºçš„ BPF å’Œç”¨æˆ·ç©ºé—´ä»£ç å…±äº«ã€‚</li>
</ul>

<p>minimal.cå¹¶minimal.bpf.cå½¢æˆminimalBPF æ¼”ç¤ºåº”ç”¨ç¨‹åºã€‚
bootstrap.cã€bootstrap.bpf.cå’Œbootstrap.hæ˜¯bootstrap-bpfåº”ç”¨ç¨‹åºã€‚å¾ˆç®€å•ã€‚</p>

<h1 id="minimal-åº”ç”¨ç¨‹åº">minimal åº”ç”¨ç¨‹åº</h1>

<p>minimalæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚è¿™ä¸æ˜¯æ„å»ºç”Ÿäº§å°±ç»ªåº”ç”¨ç¨‹åºå’Œå·¥å…·çš„æœ€ä½³æ–¹æ³•ï¼Œä½†å¯¹äºæœ¬åœ°å®éªŒæ¥è¯´å·²ç»è¶³å¤Ÿäº†ã€‚
BPF ä»£ç ï¼š</p>

<p>minimum.bpf.c</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: GPL-2.0 OR BSD-3-Clause</span>
<span class="cm">/* Copyright (c) 2020 Facebook */</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">LICENSE</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"license"</span><span class="p">)</span> <span class="o">=</span> <span class="s">"Dual BSD/GPL"</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">my_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"tp/syscalls/sys_enter_write"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">handle_tp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">my_pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"BPF triggered from PID %d.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">#include &lt;linux/bpf.h&gt;</code> å¼•å…¥äº†ä¸€äº›åŸºæœ¬çš„BPF ç›¸å…³ç±»å‹å’Œä½¿ç”¨å†…æ ¸ç«¯ BPF API æ‰€éœ€è¦çš„é•¿äº†ï¼ˆä¾‹å¦‚ï¼ŒBPF è¾…åŠ©å‡½æ•°æ ‡å¿—ï¼‰ã€‚ 
<code class="language-plaintext highlighter-rouge">#include &lt;bpf/bpf_helpers.h&gt;</code> æ˜¯ libbpf æœ€å¸¸ç”¨çš„å®ã€å¸¸é‡å’Œ BPF è¾…åŠ©å‡½æ•°ï¼ŒåŸºæœ¬ç°æœ‰çš„ BPF åº”ç”¨ç¨‹åºéƒ½ä¼šä½¿ç”¨ä»–ä»¬ã€‚
<code class="language-plaintext highlighter-rouge">bpf_get_current_pid_tgid()</code> å°±æ˜¯ä¸Šé¢ BPF è¾…åŠ©å‡½æ•°çš„ä¸€ä¸ª Demoã€‚</p>

<p><code class="language-plaintext highlighter-rouge">LICENSE</code> å˜é‡å®šä¹‰äº† BPF ä»£ç çš„è®¸å¯ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">int my_pid = 0;</code> æ˜¯å…¨å±€å˜é‡ï¼ŒBPF ä»£ç å¯ä»¥è¯»å–å’Œä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œå°±åƒç”¨æˆ·ç©ºé—´çš„ä»£ç ä¿®æ”¹å…¨å±€å˜é‡ä¸€æ ·ã€‚è€Œä¸” Linux 5.5 åŠä»¥ä¸Šç‰ˆæœ¬å¯ä»¥ä»ç”¨æˆ·ç©ºé—´
ç¨‹åºç›´æ¥è¯»å–ã€‚ä¹Ÿå°±æ˜¯è¯´  <strong><code class="language-plaintext highlighter-rouge">å®ƒè¿˜å¯ä»¥ç”¨äºåœ¨å†…æ ¸ BPF ä»£ç å’Œç”¨æˆ·ç©ºé—´æ§åˆ¶ä»£ç ä¹‹é—´æ¥å›ä¼ é€’æ•°æ®</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">SEC("tp/syscalls/sys_enter_write") int handle_tp(void *ctx) { ... }</code> å®šä¹‰å°†åŠ è½½å†…æ ¸ä¸­çš„ BPF ç¨‹åºã€‚å®ƒçš„ <code class="language-plaintext highlighter-rouge">SEC</code> å®šä¹‰äº†åº”è¯¥åˆ›å»ºä»€ä¹ˆç±»å‹çš„ BPF ç¨‹åº
ä»¥åŠå‘Šè¯‰ libbpf åº”è¯¥å°†è¯¥ç¨‹åº attach åˆ°å†…æ ¸ä¸­çš„é‚£ä¸ªä½ç½®ã€‚</p>

<p>å½“å‰å®šä¹‰çš„æ˜¯ä¸€ä¸ª BPF è·Ÿè¸ªç¨‹åºï¼Œæ¯æ¬¡ <code class="language-plaintext highlighter-rouge">write()</code> ä»ä»»ä½•ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶éƒ½ä¼šè°ƒç”¨è¯¥ç¨‹åºã€‚</p>

<p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">handle_tp</code> BPF ç¨‹åºåœ¨åšä»€ä¹ˆï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">my_pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>è¿™éƒ¨åˆ†è·å–ä»¥bpf_get_current_pid_tgid()çš„è¿”å›å€¼çš„é«˜ 32 ä½ç¼–ç çš„ PIDï¼ˆæˆ–å†…éƒ¨å†…æ ¸æœ¯è¯­ä¸­çš„â€œTGIDâ€ï¼‰ã€‚ç„¶åå®ƒæ£€æŸ¥è§¦å‘ <code class="language-plaintext highlighter-rouge">write()</code>ç³»ç»Ÿè°ƒç”¨çš„minimalè¿›ç¨‹æ˜¯å¦æ˜¯æˆ‘ä»¬çš„è¿›ç¨‹ã€‚
ä½†æ˜¯æŒ‰ç…§è¿™ç§æ–¹å¼ä¸€èˆ¬æŸ¥çœ‹ä¸åˆ°æ•ˆæœï¼Œæ‰€ä»¥è¾“å‡ºåˆ°æ§åˆ¶å°æœ€æ¸…æ¥šã€‚</p>

<p>` bpf_printk(â€œBPF triggered from PID %d.\nâ€, pid);`</p>

<p>è¿™æ˜¯ BPF ç­‰ä»· <code class="language-plaintext highlighter-rouge">printf("Hello, world!\n")</code> å®ƒå°†æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²å‘é€åˆ°ä½äº çš„ç‰¹æ®Šæ–‡ä»¶ä¸­ <code class="language-plaintext highlighter-rouge">/sys/kernel/debug/tracing/trace_pipe</code> å¯ä»¥é€šè¿‡ cat å‘½ä»¤ä»æ§åˆ¶å°æŸ¥çœ‹å…¶å†…å®¹ï¼ˆç¡®ä¿æ‚¨sudoåœ¨ root ä¸‹ä½¿ç”¨æˆ–è¿è¡Œï¼‰ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo cat</span> /sys/kernel/debug/tracing/trace_pipe
  &lt;...&gt;-3840345 <span class="o">[</span>010] d... 3220701.101143: bpf_trace_printk: BPF triggered from PID 3840345.
  &lt;...&gt;-3840345 <span class="o">[</span>010] d... 3220702.101265: bpf_trace_printk: BPF triggered from PID 3840345.
</code></pre></div></div>

<h1 id="include-vmlinuxhlibbpf-å’Œ-åº”ç”¨-headers-æ–‡ä»¶">include: vmlinux.hã€libbpf å’Œ åº”ç”¨ headers æ–‡ä»¶</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"vmlinux.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_tracing.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_core_read.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"bootstrap.h"</span><span class="cp">
</span></code></pre></div></div>

<p>è¿™é‡Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">vmlinux.h</code> ä¸æ™®é€šå¼•å…¥ <code class="language-plaintext highlighter-rouge">linux/bpf.h</code> ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">vmlinux.h</code> å°†å†…æ ¸ä¸­æ‰€æœ‰ç±»å‹æŠ–åŒ…å«åœ¨ä¸€ä¸ªæ–‡ä»¶æ±‡æ€»ã€‚å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">libbpf-bootstrap</code> ç”Ÿäº§ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">bpftool</code> ç”Ÿæˆã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">vmlinux.hå®ƒä¸èƒ½ä¸å…¶ä»–ç³»ç»ŸèŒƒå›´çš„å†…æ ¸å¤´æ–‡ä»¶ç»“åˆä½¿ç”¨ï¼Œå› ä¸ºæ‚¨å°†ä¸å¯é¿å…åœ°é‡åˆ°ç±»å‹é‡æ–°å®šä¹‰å’Œå†²çª</code></strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">bpf_tracing.hå’Œbpf_core_read.hï¼Œå®ƒä»¬ä¸ºç¼–å†™åŸºäºBPF CO-REçš„è¿½è¸ªBPFåº”ç”¨ç¨‹åºæä¾›äº†ä¸€äº›é¢å¤–çš„å®æ–‡ä»¶</code></strong></p>

<h1 id="libbpf--bpf-map--æ“ä½œ">libbpf  BPF Map  æ“ä½œ</h1>

<p>å®šä¹‰ä¸€ä¸ªåä¸º <code class="language-plaintext highlighter-rouge">exec_start</code> çš„ BPF Mapï¼š ` struct { â€¦ }exec_start SEC(â€œ.mapsâ€);<code class="language-plaintext highlighter-rouge">
ç±»å‹ä¸º </code>BPF_MAP_TYPE_HASH<code class="language-plaintext highlighter-rouge"> ï¼ˆHashMapï¼‰ï¼š</code>__uint(type, BPF_MAP_TYPE_HASH);<code class="language-plaintext highlighter-rouge">
å®¹é‡æœ€å¤§ä¸ºï¼š8192 ä¸ªæ¡ç›® </code>__uint(max_entries, 8192);<code class="language-plaintext highlighter-rouge">
Key ä¸º </code>pid_t<code class="language-plaintext highlighter-rouge"> ç±»å‹ï¼š </code>__type(key, pid_t);<code class="language-plaintext highlighter-rouge">  (</code>pid_t<code class="language-plaintext highlighter-rouge"> ä¸º 64 ä½æ— ç¬¦å·æ•°å­—)
Value ä¸º </code>u64<code class="language-plaintext highlighter-rouge"> ç±»å‹ï¼š </code>__type(value, u64);` ç”¨äºå­˜å‚¨çº³ç§’çº§æ—¶é—´æˆ³</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="p">{</span>
        <span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_HASH</span><span class="p">);</span>
        <span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
        <span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pid_t</span><span class="p">);</span>
        <span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">u64</span><span class="p">);</span>
<span class="p">}</span> <span class="n">exec_start</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">".maps"</span><span class="p">);</span>
</code></pre></div></div>

<p>æ›´æ–°æˆ–ç€æ·»åŠ ä¸€ä¸ªè®°å½•ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">ts</span><span class="p">;</span>

        <span class="cm">/* remember time exec() was executed for this PID */</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
        <span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exec_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="n">BPF_ANY</span><span class="p">);</span>
</code></pre></div></div>

<p>è·å–ä¸€ä¸ªè®°å½•å¹¶åˆ é™¤:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
  <span class="n">u64</span> <span class="o">*</span><span class="n">start_ts</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="n">start_ts</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exec_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">start_ts</span><span class="p">)</span>
    <span class="n">duration_ns</span> <span class="o">=</span> <span class="n">bpf_ktime_get_ns</span><span class="p">()</span> <span class="o">-</span> <span class="o">*</span><span class="n">start_ts</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="n">bpf_map_delete_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exec_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="ç”¨æˆ·æ€åªè¯»-bpf-å˜é‡">ç”¨æˆ·æ€åªè¯» BPF å˜é‡</h1>

<p>libbpf å¯ä»¥iå½“ä»¥åªè¯»å˜é‡</p>

<p><code class="language-plaintext highlighter-rouge">const volatile unsigned long long min_duration_ns = 0;</code></p>

<p>å…³é”®ç‚¹å°±åœ¨äºå‰é¢çš„ <code class="language-plaintext highlighter-rouge">const volatile</code> ï¼Œå°†å˜é‡æ ‡è®°ä¸º BPF ä»£ç å’Œç”¨æˆ·ç©ºé—´ä»£ç çš„åªè¯»ã€‚
æ‰€ä»¥åœ¨ BPF éªŒè¯å°±çŸ¥é“äº† min_duration_ns çš„å…·ä½“æ•°å€¼ã€‚è€Œä¸”ä¿è¯äº† clang åœ¨ä¼˜åŒ–ä»£ç æ—¶è¿™ä¸ªä¸ä¼šä¼˜åŒ–æ‰è¿™ä¸ªå˜é‡åã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">åªè¯»</code></strong> å˜é‡åœ¨ç”¨æˆ·ç©ºé—´è¢«åˆå§‹åŒ–äº BPF ä¸­åˆå§‹åŒ–æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œé€‰å“¦åœ¨åŠ è½½ä¹‹å‰ <code class="language-plaintext highlighter-rouge">å®Œæˆåˆå§‹åŒ–</code> ã€‚è€Œä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ‰“å¼€
BPF å’Œ åŠ è½½ BPF éœ€è¦åŒºåˆ†å¼€ä¸èƒ½å†ä½¿ç”¨å•ä¸ªæ–¹æ³•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cm">/* åŠ è½½å’ŒéªŒè¯ BPF åº”ç”¨ */</span>
  <span class="n">skel</span> <span class="o">=</span> <span class="n">bootstrap_bpf__open</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skel</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to open and load BPF skeleton</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* ç”¨æœ€å°æŒç»­æ—¶é—´å‚æ•°å‚æ•°åŒ–BPFä»£ç  */</span>
  <span class="n">skel</span><span class="o">-&gt;</span><span class="n">rodata</span><span class="o">-&gt;</span><span class="n">min_duration_ns</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">min_duration_ms</span> <span class="o">*</span> <span class="mi">1000000ULL</span><span class="p">;</span>

  <span class="cm">/* åŠ è½½éªŒè¯BPFç¨‹åº */</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">bootstrap_bpf__load</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to load and verify BPF skeleton</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">åªè¯»å˜é‡æ˜¯æ¡†æ¶ä¸­rodataéƒ¨åˆ†çš„ä¸€éƒ¨åˆ†(è€Œä¸æ˜¯dataæˆ–bss)ï¼šskel-&gt;rodata-&gt;min_uration_ns</code></strong></p>

<h1 id="ç”¨æˆ·æ€ä¾§-è®¤è¯†-skelh">ç”¨æˆ·æ€ä¾§ è®¤è¯† <code class="language-plaintext highlighter-rouge">*.skel.h</code></h1>

<p><code class="language-plaintext highlighter-rouge">*.skel.h</code> æ˜¯è°ƒç”¨ <code class="language-plaintext highlighter-rouge">make</code> å‘½ä»¤åç”Ÿæˆçš„ libbpf-bootstrap BPF éª¨æ¶ã€‚æ˜¯ç”± bpftool æ ¹æ® <code class="language-plaintext highlighter-rouge">*.bpf.c</code> æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„ã€‚
å¹¶ä¸”å·²ç»å°† BPF ç¨‹åºç¼–è¯‘æˆç›®æ ‡ä»£ç åµŒå…¥åˆ°äº† <code class="language-plaintext highlighter-rouge">*.skel.h</code> ä¸­ã€‚ç®€åŒ–äº†ç”¨æˆ·ç¨‹åºéƒ¨ç½²ï¼Œä¸åœ¨éœ€è¦é¢å¤–çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªéœ€è¦åŒ…å«è¿™ä¸ª <code class="language-plaintext highlighter-rouge">*.skel.h</code> å¤´æ–‡ä»¶å°±å¯ä»¥äº†ã€‚</p>

<p>æŸ¥çœ‹ <code class="language-plaintext highlighter-rouge">minimal.skel.h</code> æ–‡ä»¶ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef __MINIMAL_BPF_SKEL_H__
#define __MINIMAL_BPF_SKEL_H__
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">bpf_object_skeleton</span> <span class="o">*</span><span class="n">skeleton</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">bpf_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>    <span class="c1">// ä¼ é€’ç»™ libbpf API å‡½æ•°ã€‚</span>
  <span class="k">struct</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">maps</span><span class="p">;</span>
  <span class="k">struct</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">bpf_program</span> <span class="o">*</span><span class="n">handle_tp</span><span class="p">;</span>   <span class="c1">// æä¾›å¯¹ BPF Map å’Œ BPF ä»£ç çš„ç›´æ¥æ–¹æ³•</span>
  <span class="p">}</span> <span class="n">progs</span><span class="p">;</span>
  <span class="k">struct</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">bpf_link</span> <span class="o">*</span><span class="n">handle_tp</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">links</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">minimal_bpf__bss</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">my_pid</span><span class="p">;</span>   <span class="c1">// å…¨å±€å˜é‡</span>
  <span class="p">}</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">minimal_bpf__destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="nf">minimal_bpf__open_opts</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_object_open_opts</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="nf">minimal_bpf__open</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">minimal_bpf__load</span><span class="p">(</span><span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="nf">minimal_bpf__open_and_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">minimal_bpf__attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">minimal_bpf__detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __MINIMAL_BPF_SKEL_H__ */</span><span class="cp">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">main</code> å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ol>
  <li>é¦–å…ˆå£°æ˜ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">minimal_bpf</code> ç»“æ„</li>
  <li>è®¾ç½® <code class="language-plaintext highlighter-rouge">libbpf_set_print</code> æ—¥å¿—æ‰“å°å›æ‰å‡½æ•°ã€‚</li>
  <li>é‡Šæ”¾å†…æ ¸å¯¹ BPF ç¨‹åºå†…å­˜çš„é™åˆ¶</li>
  <li>è°ƒç”¨ <code class="language-plaintext highlighter-rouge">minimal_bpf__open</code> æ‰“å¼€ BPF ç¨‹åºçš„æ–¹æ³•ï¼Œå°†è¿”å›å€¼èµ‹å€¼ç»™ <code class="language-plaintext highlighter-rouge">minimal_bpf</code> ç»“æ„</li>
  <li>è¿™é‡Œå¯ä»¥ä¿®æ”¹å’Œè®¾ç½®å…¨å±€å˜é‡</li>
  <li>è°ƒç”¨ <code class="language-plaintext highlighter-rouge">minimal_bpf__load</code> åŠ è½½å¹¶éªŒè¯ BPF ç¨‹åº</li>
  <li>è°ƒç”¨ <code class="language-plaintext highlighter-rouge">minimal_bpf__attach</code> å°† BPF ç¨‹åºé™„åŠ åˆ° <code class="language-plaintext highlighter-rouge">SEC</code> æŒ‡å®šçš„ tracepointsã€kprobes  ä½ç½®</li>
</ol>

<p>å¤§æ¦‚ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">minimal_bpf</span> <span class="o">*</span><span class="n">skel</span><span class="p">;</span>
        <span class="n">libbpf_set_print</span><span class="p">(</span><span class="n">libbpf_print_fn</span><span class="p">);</span>
        <span class="n">bump_memlock_rlimit</span><span class="p">();</span>
        <span class="n">skel</span> <span class="o">=</span> <span class="n">minimal_bpf__open</span><span class="p">();</span>
        <span class="cm">/* è®¾ç½®å…¨å±€å˜é‡ */</span>
        <span class="n">skel</span><span class="o">-&gt;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">my_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
        <span class="n">minimal_bpf__load</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
        <span class="n">minimal_bpf__attach</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
        <span class="n">minimal_bpf__destroy</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>        
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">main</code> å‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦çš„è¿˜æ˜¯çœ‹ <code class="language-plaintext highlighter-rouge">*.skel.h</code> æ–‡ä»¶ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹ï¼šMakefile</p>

<p><code class="language-plaintext highlighter-rouge">.output</code> ä¸‹æ–‡ä»¶ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.output<span class="nv">$ </span>tree
<span class="nb">.</span>
â”œâ”€â”€ bpf
â”‚      â”œâ”€â”€ bpf_core_read.h
â”‚      â”œâ”€â”€ bpf_endian.h
â”‚      â”œâ”€â”€ bpf.h
â”‚      â”œâ”€â”€ bpf_helper_defs.h
â”‚      â”œâ”€â”€ bpf_helpers.h
â”‚      â”œâ”€â”€ bpf_tracing.h
â”‚      â”œâ”€â”€ btf.h
â”‚      â”œâ”€â”€ libbpf_common.h
â”‚      â”œâ”€â”€ libbpf.h
â”‚      â”œâ”€â”€ libbpf_legacy.h
â”‚      â”œâ”€â”€ skel_internal.h
â”‚      â””â”€â”€ xsk.h
â”œâ”€â”€ libbpf
â”‚      â”œâ”€â”€ libbpf.a
â”‚      â”œâ”€â”€ libbpf.pc
â”‚      â””â”€â”€ staticobjs
â”‚          â”œâ”€â”€ bpf.o
â”‚          â”œâ”€â”€ bpf_prog_linfo.o
â”‚          â”œâ”€â”€ btf_dump.o
â”‚          â”œâ”€â”€ btf.o
â”‚          â”œâ”€â”€ gen_loader.o
â”‚          â”œâ”€â”€ hashmap.o
â”‚          â”œâ”€â”€ libbpf_errno.o
â”‚          â”œâ”€â”€ libbpf.o
â”‚          â”œâ”€â”€ libbpf_probes.o
â”‚          â”œâ”€â”€ linker.o
â”‚          â”œâ”€â”€ netlink.o
â”‚          â”œâ”€â”€ nlattr.o
â”‚          â”œâ”€â”€ ringbuf.o
â”‚          â”œâ”€â”€ str_error.o
â”‚          â”œâ”€â”€ strset.o
â”‚          â””â”€â”€ xsk.o
â”œâ”€â”€ libbpf.a
â”œâ”€â”€ minimal.bpf.o
â”œâ”€â”€ minimal.o
â”œâ”€â”€ minimal.skel.h
â””â”€â”€ pkgconfig
    â””â”€â”€ libbpf.pc
</code></pre></div></div>
<p>æŸ¥çœ‹ Makefileï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å®šä¹‰æ‰€æœ‰ä¸­é—´æ–‡ä»¶å†™åˆ° .outpt æ–‡ä»¶å¤¹ä¸‹</span>
INCLUDES :<span class="o">=</span> <span class="nt">-I</span><span class="si">$(</span>OUTPUT<span class="si">)</span>
<span class="c"># å®šä¹‰ä½¿ç”¨ -g è°ƒè¯•ä¿¡æ¯ç¼–è¯‘</span>
CFLAGS :<span class="o">=</span> <span class="nt">-g</span> <span class="nt">-Wall</span>
<span class="c"># å®šä¹‰ç›®æ ‡æ¶æ„</span>
ARCH :<span class="o">=</span> <span class="si">$(</span>shell <span class="nb">uname</span> <span class="nt">-m</span> | <span class="nb">sed</span> <span class="s1">'s/x86_64/x86/'</span><span class="si">)</span>

APPS <span class="o">=</span> minimal bootstrap

<span class="c"># å°† libbpf æ„å»ºä¸ºé™æ€åº“ï¼Œå°† API å¤´æ–‡ä»¶å®‰è£…åˆ° .output ä¸‹ã€‚å¯ä»¥ä½¿ç”¨å…±äº«åº“è·³è¿‡è¯¥æ­¥éª¤</span>
<span class="si">$(</span>LIBBPF_OBJ<span class="si">)</span>: <span class="si">$(</span>wildcard <span class="si">$(</span>LIBBPF_SRC<span class="si">)</span>/<span class="k">*</span>.[ch] <span class="si">$(</span>LIBBPF_SRC<span class="si">)</span>/Makefile<span class="si">)</span> | <span class="si">$(</span>OUTPUT<span class="si">)</span>/libbpf
        <span class="si">$(</span>call msg,LIB,<span class="nv">$@</span><span class="si">)</span>
        <span class="si">$(</span>Q<span class="si">)$(</span>MAKE<span class="si">)</span> <span class="nt">-C</span> <span class="si">$(</span>LIBBPF_SRC<span class="si">)</span> <span class="nv">BUILD_STATIC_ONLY</span><span class="o">=</span>1                      <span class="se">\</span>
                    <span class="nv">OBJDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dir</span> <span class="nv">$@</span><span class="si">)</span>/libbpf <span class="nv">DESTDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dir</span> <span class="nv">$@</span><span class="si">)</span>                 <span class="se">\</span>
                    <span class="nv">INCLUDEDIR</span><span class="o">=</span> <span class="nv">LIBDIR</span><span class="o">=</span> <span class="nv">UAPIDIR</span><span class="o">=</span>                              <span class="se">\</span>
                    <span class="nb">install</span>
<span class="c"># ç¼–è¯‘ bpf æ–‡ä»¶ï¼Œ-D__TARGET_ARCH_$(ARCH) ç”¨æˆ·å¤„ç†ä½çº§ struct pt_regs å®å®šä¹‰</span>
<span class="si">$(</span>OUTPUT<span class="si">)</span>/%.bpf.o: %.bpf.c <span class="si">$(</span>LIBBPF_OBJ<span class="si">)</span> <span class="si">$(</span>wildcard %.h<span class="si">)</span> <span class="si">$(</span>VMLINUX<span class="si">)</span> | <span class="si">$(</span>OUTPUT<span class="si">)</span>
        <span class="si">$(</span>call msg,BPF,<span class="nv">$@</span><span class="si">)</span>
        <span class="si">$(</span>Q<span class="si">)$(</span>CLANG<span class="si">)</span> <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-target</span> bpf <span class="nt">-D__TARGET_ARCH_</span><span class="si">$(</span>ARCH<span class="si">)</span> <span class="si">$(</span>INCLUDES<span class="si">)</span> <span class="si">$(</span>CLANG_BPF_SYS_INCLUDES<span class="si">)</span> <span class="nt">-c</span> <span class="si">$(</span>filter %.c,<span class="nv">$^</span><span class="si">)</span> <span class="nt">-o</span> <span class="nv">$@</span>
        <span class="si">$(</span>Q<span class="si">)$(</span>LLVM_STRIP<span class="si">)</span> <span class="nt">-g</span> <span class="nv">$@</span>

<span class="c"># ä½¿ç”¨ bpftool å·¥å…·ç”Ÿæˆ skel.h å¤´æ–‡ä»¶</span>
<span class="si">$(</span>OUTPUT<span class="si">)</span>/%.skel.h: <span class="si">$(</span>OUTPUT<span class="si">)</span>/%.bpf.o | <span class="si">$(</span>OUTPUT<span class="si">)</span>
        <span class="si">$(</span>call msg,GEN-SKEL,<span class="nv">$@</span><span class="si">)</span>
        <span class="si">$(</span>Q<span class="si">)$(</span>BPFTOOL<span class="si">)</span> gen skeleton <span class="nv">$&lt;</span> <span class="o">&gt;</span> <span class="nv">$@</span> 

</code></pre></div></div>

<p>æ‰§è¡Œ make minimal åå°† Makefile å‘½ä»¤æ‹†å¼€çœ‹å°±æ¸…æ¥šäº†ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ›å»º .outputä¸‹ æ–‡ä»¶å¤¹</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> .output

<span class="nb">mkdir</span> <span class="nt">-p</span> .output/libbpf

make <span class="nt">-C</span> /home/vagrant/ebpf/libbpf-bootstrap/libbpf/src <span class="nv">BUILD_STATIC_ONLY</span><span class="o">=</span>1                    <span class="se">\</span>
            <span class="nv">OBJDIR</span><span class="o">=</span>/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf <span class="nv">DESTDIR</span><span class="o">=</span>/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output/                     <span class="se">\</span>
            <span class="nv">INCLUDEDIR</span><span class="o">=</span> <span class="nv">LIBDIR</span><span class="o">=</span> <span class="nv">UAPIDIR</span><span class="o">=</span>                              <span class="se">\</span>
            <span class="nb">install

</span>make[1]: Entering directory <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/libbpf/src'</span>

<span class="nb">mkdir</span> <span class="nt">-p</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs

<span class="c"># å°† libbpf ä¸‹çš„æ–‡ä»¶ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶</span>
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> bpf.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/bpf.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> btf.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/btf.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> libbpf.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/libbpf.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> libbpf_errno.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/libbpf_errno.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> netlink.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/netlink.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> nlattr.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/nlattr.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> str_error.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/str_error.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> libbpf_probes.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/libbpf_probes.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> bpf_prog_linfo.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/bpf_prog_linfo.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> xsk.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/xsk.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> btf_dump.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/btf_dump.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> hashmap.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/hashmap.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> ringbuf.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/ringbuf.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> strset.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/strset.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> linker.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/linker.o
cc <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-I</span>../include <span class="nt">-I</span>../include/uapi <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-Werror</span> <span class="nt">-Wall</span> <span class="nt">-D_LARGEFILE64_SOURCE</span> <span class="nt">-D_FILE_OFFSET_BITS</span><span class="o">=</span>64   <span class="nt">-c</span> gen_loader.c <span class="nt">-o</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/gen_loader.o

<span class="c"># åˆ›å»ºé™æ€åº“æ–‡ä»¶ï¼Œå°†ç›®æ ‡æ–‡ä»¶å‹ç¼©åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­å¹¶æ·»åŠ æ‰€æ¬²</span>
ar rcs /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/libbpf.a /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/bpf.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/btf.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/libbpf.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/libbpf_errno.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/netlink.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/nlattr.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/str_error.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/libbpf_probes.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/bpf_prog_linfo.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/xsk.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/btf_dump.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/hashmap.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/ringbuf.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/strset.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/linker.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/staticobjs/gen_loader.o

<span class="c"># cat libbpf.pc.template </span>
<span class="c"># # SPDX-License-Identifier: (LGPL-2.1 OR BSD-2-Clause)</span>
<span class="c"># </span>
<span class="c"># prefix=@PREFIX@</span>
<span class="c"># libdir=@LIBDIR@</span>
<span class="c"># includedir=${prefix}/include</span>
<span class="c"># </span>
<span class="c"># Name: libbpf</span>
<span class="c"># Description: BPF library</span>
<span class="c"># Version: @VERSION@</span>
<span class="c"># Libs: -L${libdir} -lbpf</span>
<span class="c"># Requires.private: libelf zlib</span>
<span class="c"># Cflags: -I${includedir}</span>

<span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s|@PREFIX@|/usr|"</span> <span class="se">\</span>
        <span class="nt">-e</span> <span class="s2">"s|@LIBDIR@|</span><span class="nv">$\</span><span class="s2">{prefix</span><span class="se">\}</span><span class="s2">/lib64|"</span> <span class="se">\</span>
        <span class="nt">-e</span> <span class="s2">"s|@VERSION@|0.5.0|"</span> <span class="se">\</span>
        &lt; libbpf.pc.template <span class="o">&gt;</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/libbpf.pc

<span class="c"># åˆ›å»ºæ–‡ä»¶å¤¹</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//bpf'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then 
  </span><span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 755 <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//bpf'</span><span class="p">;</span> 
<span class="k">fi</span><span class="p">;</span>
<span class="c"># å®‰è£…æ‰€æœ‰å¤´æ–‡ä»¶</span>
<span class="nb">install</span> <span class="nt">-m</span> 644 bpf.h libbpf.h btf.h libbpf_common.h libbpf_legacy.h xsk.h bpf_helpers.h bpf_helper_defs.h bpf_tracing.h bpf_endian.h bpf_core_read.h skel_internal.h <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//bpf'</span>

<span class="c"># åˆ›å»ºæ–‡ä»¶å¤¹</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//pkgconfig'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then 
  </span><span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 755 <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//pkgconfig'</span><span class="p">;</span> 
<span class="k">fi</span><span class="p">;</span>

<span class="c"># å®‰è£…åº“æ–‡ä»¶</span>
<span class="nb">install</span> <span class="nt">-m</span> 644 /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/libbpf.pc <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//pkgconfig'</span>

<span class="c"># åˆ›å»ºæ–‡ä»¶å¤¹</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output/'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then 
  </span><span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 755 <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output/'</span><span class="p">;</span> 
<span class="k">fi</span><span class="p">;</span>

<span class="c"># å°†é™æ€åº“æ·»åŠ åˆ°æ–‡ä»¶å¤¹ä¸‹</span>
<span class="nb">cp</span> <span class="nt">-fR</span> /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output//libbpf/libbpf.a  <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output/'</span>

make[1]: Leaving directory <span class="s1">'/home/vagrant/ebpf/libbpf-bootstrap/libbpf/src'</span>

<span class="c"># ç¼–è¯‘ bpf  ç¨‹åº</span>
clang <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-target</span> bpf <span class="nt">-D__TARGET_ARCH_x86</span> <span class="nt">-I</span>.output <span class="nt">-I</span>../../libbpf/include/uapi <span class="nt">-I</span>../../vmlinux/ <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/local/include <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/lib/llvm-11/lib/clang/11.1.0/include <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/include/x86_64-linux-gnu <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/include <span class="se">\</span>
<span class="nt">-c</span> minimal.bpf.c <span class="se">\</span>
<span class="nt">-o</span> .output/minimal.bpf.o

<span class="c"># åˆ é™¤æ‰€æœ‰è°ƒè¯•éƒ¨åˆ†</span>
llvm-strip <span class="nt">-g</span> .output/minimal.bpf.o <span class="c"># strip useless DWARF info</span>
<span class="c"># é€šè¿‡ BPF æ–‡ä»¶æå–ä¸ºå¤´æ–‡ä»¶ï¼Œè¿™ä¸ªå¯ä»¥å¤§æ¦‚ç ”ç©¶ä¸‹</span>
/home/vagrant/ebpf/libbpf-bootstrap/tools/bpftool gen skeleton .output/minimal.bpf.o <span class="o">&gt;</span> .output/minimal.skel.h

libbpf: elf: skipping unrecognized data section<span class="o">(</span>5<span class="o">)</span> .rodata.str1.1

<span class="c"># ç¼–è¯‘ç”¨æˆ·ç¨‹åº</span>
cc <span class="nt">-g</span> <span class="nt">-Wall</span> <span class="nt">-I</span>.output <span class="nt">-I</span>../../libbpf/include/uapi <span class="nt">-I</span>../../vmlinux/ <span class="nt">-c</span> minimal.c <span class="nt">-o</span> .output/minimal.o
<span class="c"># è¿æ¥ç›®æ ‡æ–‡ä»¶ç»„æˆå¯æ‰§è¡Œæ–‡ä»¶</span>
cc <span class="nt">-g</span> <span class="nt">-Wall</span> .output/minimal.o /home/vagrant/ebpf/libbpf-bootstrap/examples/c/.output/libbpf.a <span class="nt">-lelf</span> <span class="nt">-lz</span> <span class="nt">-o</span> minimal

</code></pre></div></div>

<h1 id="bootstrap-æ¼”ç¤º-bpf-map-ä½¿ç”¨"><code class="language-plaintext highlighter-rouge">bootstrap.*</code> æ¼”ç¤º BPF Map ä½¿ç”¨</h1>

<p>å†…æ ¸æ€å®šä¹‰ Map ç»“æ„ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="p">{</span>
        <span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_HASH</span><span class="p">);</span>
        <span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
        <span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pid_t</span><span class="p">);</span>
        <span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">u64</span><span class="p">);</span>
<span class="p">}</span> <span class="n">exec_start</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">".maps"</span><span class="p">);</span>

<span class="k">struct</span> <span class="p">{</span>
        <span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_RINGBUF</span><span class="p">);</span>
        <span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
<span class="p">}</span> <span class="n">rb</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">".maps"</span><span class="p">);</span>
</code></pre></div></div>

<p>è§£é‡Šï¼š
map åç§°ï¼š<code class="language-plaintext highlighter-rouge">exec_start</code>ï¼Œmap ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">BPF_MAP_TYPE_HASH</code>ï¼Œæœ€å¤§æ¡ç›®ï¼š<code class="language-plaintext highlighter-rouge">8192</code>ï¼Œkey ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">pid_t</code>ï¼Œvalue ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">u64</code>
map åç§°ï¼š<code class="language-plaintext highlighter-rouge">rb</code>ï¼Œmap ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">BPF_MAP_TYPE_RINGBUF</code>ï¼Œæœ€å¤§æ¡ç›®ï¼š<code class="language-plaintext highlighter-rouge">8192</code></p>

<p>#NOTE
è®¿é—®å…¨å±€å˜é‡ï¼šåªè¯»å˜é‡æ˜¯ skel ä¸­rodataéƒ¨åˆ†çš„ä¸€éƒ¨åˆ†</p>

<h1 id="é—®é¢˜åˆ†åˆ«ä»€ä¹ˆæ—¶å€™ä½¿ç”¨-bssrodatalinks-è®¿é—®å…¨å±€å˜é‡">é—®é¢˜ï¼šåˆ†åˆ«ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ bssã€rodataã€links è®¿é—®å…¨å±€å˜é‡</h1>
<p>ç­”ï¼š
  skel-&gt;rodata ç”¨äºåªè¯»å˜é‡ï¼›
  skel-&gt;bss ç”¨äºå¯å˜çš„é›¶åˆå§‹åŒ–å˜é‡ï¼›
  skel-&gt;data ç”¨äºéé›¶åˆå§‹åŒ–çš„å¯å˜å˜é‡ã€‚</p>

<h1 id="é—®é¢˜sec-èŒƒå›´æ€ä¹ˆæ‰¾">é—®é¢˜ï¼šSEC èŒƒå›´æ€ä¹ˆæ‰¾</h1>
<h1 id="è¾…åŠ©å‡½æ•°çš„å¸®åŠ©æ–‡æ¡£é˜…è¯»">è¾…åŠ©å‡½æ•°çš„å¸®åŠ©æ–‡æ¡£é˜…è¯»</h1>
<h1 id="æ˜¯å¦è¿˜å­˜åœ¨å°¾è°ƒç”¨">æ˜¯å¦è¿˜å­˜åœ¨å°¾è°ƒç”¨</h1>
:ET