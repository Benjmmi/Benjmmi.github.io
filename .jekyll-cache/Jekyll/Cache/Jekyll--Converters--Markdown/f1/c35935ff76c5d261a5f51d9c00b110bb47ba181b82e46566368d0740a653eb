I"œ5<h1 id="cilium-æºç é˜…è¯»cilium-docker-å·¥ä½œæµç¨‹">Cilium æºç é˜…è¯»ï¼šcilium-docker å·¥ä½œæµç¨‹</h1>

<h1 id="cilium-docker">cilium-docker</h1>

<p>å®ç°ç½‘ç»œå’ŒIPAM APIçš„Dockeræ’ä»¶ã€‚è¯¥æ’ä»¶å¤„ç†æ¥è‡ªæœ¬åœ°Dockerè¿è¡Œæ—¶çš„è¯·æ±‚ï¼Œä»¥æä¾›å®¹å™¨çš„ç½‘ç»œè¿æ¥å’ŒIPåœ°å€ç®¡ç†çš„è¯·æ±‚ã€‚è¿æ¥åˆ° â€œcilium â€œç±»å‹çš„Dockerç½‘ç»œã€‚</p>

<p>è¿è¡Œï¼š</p>

<p><code class="language-plaintext highlighter-rouge">docker network create --driver cilium --ipam-driver cilium cilium-net</code></p>

<p>å½“è¯·æ±‚ä»£ç†åˆ›å»ºç½‘ç»œæ—¶ï¼Œè¿œç¨‹è¿›ç¨‹å°†æ”¶åˆ°ä¸€ä¸ªå‘é€åˆ°URL <code class="language-plaintext highlighter-rouge">/NetworkDriver.CreateNetwork</code> çš„POSTè¡¨å•</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /NetworkDriver.CreateNetwork HTTP/1.1
Host: 
User-Agent: Go-http-client/1.1
Content-Length: 269
Accept: application/vnd.docker.plugins.v1.2+json

<span class="o">{</span>
	<span class="s2">"NetworkID"</span>: <span class="s2">"501239d1d45a2eafb1874ad440e92397f6a154acea93af636aec4a57d9547b25"</span>, // NetworkIDå€¼ç”±LibNetworkç”Ÿæˆï¼Œä»£è¡¨ä¸€ä¸ªå”¯ä¸€çš„ç½‘ç»œã€‚
	<span class="s2">"Options"</span>: <span class="o">{</span> // Optionså€¼æ˜¯LibNetworkç»™ä»£ç†çš„ä»»æ„æ˜ å°„ã€‚
		<span class="s2">"com.docker.network.enable_ipv6"</span>: <span class="nb">false</span>, 
		<span class="s2">"com.docker.network.generic"</span>: <span class="o">{}</span>
	<span class="o">}</span>,
	<span class="s2">"IPv4Data"</span>: <span class="o">[{</span> // IPv4Dataå’ŒIPv6Dataæ˜¯ç”¨æˆ·é…ç½®å¹¶ç”±IPAMé©±åŠ¨ç®¡ç†çš„ipåœ°å€æ•°æ®ã€‚ç½‘ç»œé©±åŠ¨ç¨‹åºéœ€è¦æ”¯æŒIPAMé©±åŠ¨ç¨‹åºæä¾›çš„ipå¯»å€æ•°æ®ã€‚
		<span class="s2">"AddressSpace"</span>: <span class="s2">"CiliumLocal"</span>, // AddressSpace:ä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸²è¡¨ç¤ºIPåœ°å€çš„éš”ç¦»ç©ºé—´
		<span class="s2">"Gateway"</span>: <span class="s2">"10.11.72.123/32"</span>, // å¯é€‰ï¼ŒIPAMé©±åŠ¨ç¨‹åºå¯ä»¥ä¸ºæ± æ‰€ä»£è¡¨çš„å­ç½‘æä¾›CIDRæ ¼å¼çš„ç½‘å…³IPåœ°å€ã€‚ç½‘ç»œé©±åŠ¨ç¨‹åºå¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯å®ç°ç½‘ç»œç®¡é“åŠŸèƒ½ã€‚
		<span class="s2">"Pool"</span>: <span class="s2">"0.0.0.0/0"</span> // åœ°å€æ± :ä»¥CIDRæ ¼å¼è¡¨ç¤ºçš„åœ°å€/æ©ç ã€‚å› ä¸ºIPAMé©±åŠ¨ç¨‹åºè´Ÿè´£åˆ†é…å®¹å™¨ipåœ°å€ï¼Œæ‰€ä»¥ç½‘ç»œé©±åŠ¨ç¨‹åºå¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯å®ç°ç½‘ç»œç®¡é“åŠŸèƒ½ã€‚
	<span class="o">}]</span>,
	<span class="s2">"IPv6Data"</span>: <span class="o">[]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>çœ‹åˆ°è¯·æ±‚è¿›æ¥çš„æ—¶å€™å·²ç»åˆ†é…å¥½äº† IP ï¼Œè¿™ä¸ª IP æ˜¯ä»å“ªåˆ†é…çš„å‘¢ï¼Ÿ</p>

<p>libnetwork åˆ›å»ºç½‘ç»œå·¥ä½œæµç¨‹ï¼š</p>
<ul>
  <li>å…ˆè¯·æ±‚ IPAM drive è·å– ippoolï¼Œciliumï¼š
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"PoolID"</span><span class="p">:</span><span class="s2">"CiliumPoolv4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Pool"</span><span class="p">:</span><span class="s2">"0.0.0.0/0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Data"</span><span class="p">:[{</span><span class="nl">"com.docker.network.gateway"</span><span class="p">:</span><span class="s2">"10.11.72.123/32"</span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>è¿”å›åé¦–å…ˆç¡®å®šlen(ipV4Data)ä¸ä¸º0</li>
  <li>è°ƒç”¨config, err := parseNetworkOptions(id, option)ç¡®è®¤é…ç½®ä¸å’Œå½“å‰çš„networksçš„é…ç½®çŸ›ç›¾</li>
  <li>è°ƒç”¨err = config.processIPAM(id, ipV4Data, ipV6Data)</li>
  <li>è°ƒç”¨err = d.createNetwork(config)è¿›è¡Œå…·ä½“çš„ç½‘ç»œåˆ›å»º</li>
  <li>æœ€åè°ƒç”¨return d.storeUpdate(config)</li>
</ul>

<p>æ€è€ƒï¼šå¦‚æœéƒ½æ˜¯ç”¨ç¬¬ä¸‰æ–¹é©±åŠ¨çš„è¯é‚£ä¹ˆä¸»è¦çš„é€»è¾‘åº”è¯¥æ˜¯æŸ¥çœ‹ï¼šç½‘ç»œçš„é…ç½®æ˜¯å¦ä¸å½“å‰å…·æœ‰çš„é…ç½®çŸ›ç›¾ã€ä¿å­˜æˆ–è€…æ›´æ–°é…ç½®ç­‰å¾…ä¸‹ä¸€æ¬¡æ¯”è¾ƒã€åˆ†é…IPç”¨äºæ ¡éªŒã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹æ’ä»¶ä¹Ÿåªå‰©ä¸‹ ifâ€¦elseâ€¦ é€»è¾‘ã€‚åœ¨ cilium é‡Œé¢ ipv4 å¯å˜çš„åªæœ‰ <code class="language-plaintext highlighter-rouge">com.docker.network.gateway</code> çš„å†…å®¹å¯ä»¥é€šè¿‡é…ç½®æ”¹å˜ï¼Œé‚£ä¹ˆ IPv4 é€šä¿¡è§„åˆ™åœ¨ Cilium å·²ç»æ²¡é‚£ä¹ˆé‡è¦äº†ã€‚IPv4 å¯ä»¥å¤§å¹…åº¦å®šåˆ¶åœ°å€ç©ºé—´ã€ç½‘å…³ã€‚æ‰€ä»¥ Cilium ä¸»è¦é¢å‘çš„ IP åœ°å€æ˜¯ IPv6ã€‚</p>

<p>æ€è€ƒé‰´äºä»£ç ã€‚ç›´æ¥çœ‹ä»£ç ï¼š</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">Init</span><span class="p">(</span><span class="n">dc</span> <span class="n">driverapi</span><span class="o">.</span><span class="n">DriverCallback</span><span class="p">,</span> <span class="n">config</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">newPluginHandler</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">client</span> <span class="o">*</span><span class="n">plugins</span><span class="o">.</span><span class="n">Client</span><span class="p">)</span> <span class="p">{</span>
		<span class="c">// negotiate driver capability with client</span>
		<span class="n">d</span> <span class="o">:=</span> <span class="n">newDriver</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
		<span class="n">c</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">getCapabilities</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">RegisterDriver</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
	<span class="p">}</span>
    <span class="o">...</span>
	<span class="n">handleFunc</span><span class="p">(</span><span class="n">driverapi</span><span class="o">.</span><span class="n">NetworkPluginEndpointType</span><span class="p">,</span> <span class="n">newPluginHandler</span><span class="p">)</span>

	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>newDriver æ˜¯æ–°å»ºä¸€ä¸ªé©±åŠ¨ç±»ï¼ŒgetCapabilities å°±æ˜¯è°ƒç”¨é©±åŠ¨çš„ getCapabilities æ¥å£ï¼Œå¯¹åº”æ¥å£åº”è¯¥æ˜¯ï¼š<code class="language-plaintext highlighter-rouge">NetworkDriver.GetCapabilities</code> ã€‚åº”è¯¥æ˜¯åœ¨åˆå§‹åŒ–çš„æƒ…å†µæ‰è¢«è°ƒç”¨ï¼Œä¹‹ä¸Šé¢çš„å‘½ä»¤å¹¶æ²¡è§¦å‘ã€‚RegisterDriverï¼šåœ¨å‘ç°ç½‘ç»œé©±åŠ¨ç¨‹åºæ—¶æ³¨å†Œå®ƒã€‚çœ‹ä»£ç å°±æ˜¯åšä¸€ä¸ªé©±åŠ¨ç»‘å®šï¼Œå¯èƒ½ä¼šä½¿ç”¨å¤šä¸ª driverã€‚</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">DrvRegistry</span><span class="p">)</span> <span class="n">RegisterDriver</span><span class="p">(</span><span class="n">ntype</span> <span class="kt">string</span><span class="p">,</span> <span class="n">driver</span> <span class="n">driverapi</span><span class="o">.</span><span class="n">Driver</span><span class="p">,</span> <span class="n">capability</span> <span class="n">driverapi</span><span class="o">.</span><span class="n">Capability</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">dData</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">driverData</span><span class="p">{</span><span class="n">driver</span><span class="p">,</span> <span class="n">capability</span><span class="p">}</span>
	<span class="n">r</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="n">ntype</span><span class="p">]</span> <span class="o">=</span> <span class="n">dData</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è°ƒç”¨å‘½ä»¤ä¼šè°ƒç”¨åˆ›å»º CreateNetwork æ¥å£ï¼Œä½†æ˜¯åœ¨è°ƒç”¨ä¹‹å‰ä¼šè°ƒç”¨ IPAM é©±åŠ¨ç¨‹åºæ¥å£ï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/moby/libnetwork/blob/64b7a4574d1426139437d20e81c0b6d391130ec8/controller.go#L709">libnetwork/controller.go</a> æ•´ä¸ªæ¥å£é€»è¾‘ç‚¹ï¼Œæ•´ä¸ªæµç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°ç®€å•çš„ã€‚</p>

<p>å¤§æ¦‚é€»è¾‘ï¼š
docker å‘½ä»¤æ‰§è¡Œåï¼šå…ˆæ³¨å†Œ IPAM é©±åŠ¨å’Œ network é©±åŠ¨ï¼Œç„¶ådocker è°ƒç”¨ï¼ŒNewNetwork æ¥å£åˆ›å»ºç½‘ç»œï¼Œåˆ›å»ºç½‘ç»œä¼šä¼˜å…ˆåŠ è½½ IPAM é©±åŠ¨è·å–åŸºæœ¬ç½‘ç»œç®¡ç†IPv4 å’Œ IPv6 åˆ†åˆ«è¯·æ±‚ï¼ŒGateway æ˜¯å¿…å¡«é¡¹ï¼Œå¦‚æœåœ¨è¯·æ±‚ IPAM çš„ RequestPool æ¥å£æ²¡æœ‰è¿”å›æ—¶ï¼Œä¼šå†æ¬¡è¯·æ±‚ IPAM RequestAddress æ¥å£ï¼Œç„¶ååœ¨è°ƒç”¨åˆ›å»º  ç½‘ç»œé©±åŠ¨ CreateNetwork æ¥å£åˆ›å»ºç½‘ç»œã€‚</p>

<h1 id="åˆ›å»ºå®ä¾‹ä½¿ç”¨ç½‘ç»œæ’ä»¶">åˆ›å»ºå®ä¾‹ä½¿ç”¨ç½‘ç»œæ’ä»¶</h1>
<p>æ¥ä¸‹æ¥çœ‹çœ‹ï¼šåˆ›å»ºå®ä¾‹æ—¶å¦‚æœè·å– IPAddressã€Macã€‚</p>

<p><code class="language-plaintext highlighter-rouge">docker run -d --name app1 --net cilium-net -l "id=app1" cilium/demo-httpd</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /IpamDriver.RequestAddress HTTP/1.1
Host: 
User-Agent: Go-http-client/1.1
Content-Length: 54
Accept: application/vnd.docker.plugins.v1.2+json

<span class="o">{</span><span class="s2">"PoolID"</span>:<span class="s2">"CiliumPoolv4"</span>,<span class="s2">"Address"</span>:<span class="s2">""</span>,<span class="s2">"Options"</span>:null<span class="o">}</span>

</code></pre></div></div>

<p>è¯·æ±‚ IPAM åˆ†é…ä¸€ä¸ª IPv4 åœ°å€ï¼Œé€šè¿‡ <a href="https://github.com/moby/libnetwork/blob/64b7a4574d1426139437d20e81c0b6d391130ec8/endpoint.go#L1088">docker æºä»£ç </a> å¯ä»¥çœ‹åˆ°åˆ›å»º Endpoint çš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p>

<p>IPAM è¯·æ±‚å°†è½¬ä¸ºï¼š</p>

<p>cilium-docker</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST <span class="nt">--unix-socket</span> /var/run/cilium/cilium.sock <span class="se">\</span>
  <span class="s1">'http:///var/run/cilium/cilium.sock/v1/ipam?family=ipv4&amp;owner=docker-ipam'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Accept: application/json'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Expiration: false'</span> 
</code></pre></div></div>

<p>å…ˆè¯·æ±‚ IP  åœ°å€ï¼Œç„¶åè¯·æ±‚ åˆ›å»º Endpoint æ¥å£ï¼Œè¯·æ±‚å‚æ•°å¦‚ä¸‹</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /NetworkDriver.CreateEndpoint HTTP/1.1
Host: 
User-Agent: Go-http-client/1.1
Content-Length: 348
Accept: application/vnd.docker.plugins.v1.2+json

<span class="o">{</span>
	<span class="s2">"NetworkID"</span>: <span class="s2">"f1e88970d55e632a6f130bcacb4a9e328a3489d88c231b191fcff94e053d30ed"</span>,
	<span class="s2">"EndpointID"</span>: <span class="s2">"f33feeba0d0ba23ba6abb659f2306f6f393919279842cbf2ed0050641ded5664"</span>,
	<span class="s2">"Interface"</span>: <span class="o">{</span>
		<span class="s2">"Address"</span>: <span class="s2">"10.11.197.102/32"</span>,
		<span class="s2">"AddressIPv6"</span>: <span class="s2">""</span>,
		<span class="s2">"MacAddress"</span>: <span class="s2">""</span>
	<span class="o">}</span>,
	<span class="s2">"Options"</span>: <span class="o">{</span>
		<span class="s2">"com.docker.network.endpoint.exposedports"</span>: <span class="o">[{</span>
			<span class="s2">"Proto"</span>: 6,
			<span class="s2">"Port"</span>: 80
		<span class="o">}]</span>,
		<span class="s2">"com.docker.network.portmap"</span>: <span class="o">[]</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å¦‚æœè¿œç¨‹driverå·²ç»æä¾›äº†ä¸€ä¸ªéç©ºçš„Interfaceé‚£ä¹ˆå¿…é¡»å›å¤ä¸€ä¸ªç©ºçš„Interfaceå€¼ï¼Œå› ä¸º å¦‚æœLibnetworkæä¾›ä¸€ä¸ªéç©ºçš„å€¼ï¼Œæ¥æ”¶äº†ä¸€ä¸ªéç©ºå€¼å°†ä¼šè¢«è§†ä¸ºé”™è¯¯ã€‚æ‰€ä»¥åˆ›å»º  Endpoint IP åœ°å€å°±æ˜¯ä¸Šé¢çš„è¿™æ ·ï¼ŒIP å·²ç»ç”± IPAM åˆ†é…ã€‚</p>

<p>å®è·µæ“ä½œï¼Œè¿™é‡Œ Endpoint å¹¶æ²¡æœ‰ mac åœ°å€ï¼Œæ‰€ä»¥ mac åœ°å€æ˜¯åœ¨å“ªé‡Œåˆ†é…çš„ï¼Ÿ
ç»è¿‡ä¸Šé¢çš„è°ƒç”¨æœ€ç»ˆè¯·æ±‚è¿˜æ˜¯è¿›å…¥äº† cilium-agent ç¨‹åºçš„ IPAM æ¨¡å—ï¼Œè¿™é‡Œå°† IP å…·ä½“åˆ†é…å‡ºæ¥ã€‚æ‰€ä»¥å¦‚æœè¦ä½¿å…¶æ‹¥æœ‰ Mac åœ°å€åªéœ€è¦åœ¨ Cilium-agent IPAM æ¨¡å—ç¨å¾®ä¿®æ”¹å³å¯ã€‚</p>

<p>è¿™è¾¹ä¸æ˜¯å¾ˆæ ¸å¿ƒçš„é‡ç‚¹å°±åˆ†æåˆ°è¿™ã€‚</p>

<p>å‚è€ƒï¼š
<a href="https://segmentfault.com/a/1190000017000822">https://segmentfault.com/a/1190000017000822</a>
<a href="https://guanjunjian.github.io/2017/10/13/study-6-docker-6-libnetwork-excuting-flow/">DOCKERæºç åˆ†æ6 ç½‘ç»œéƒ¨åˆ†æ‰§è¡Œæµåˆ†æ</a>
<a href="https://github.com/moby/libnetwork/blob/master/docs/remote.md">Dockeré©±åŠ¨è§„èŒƒ</a>
<a href="http://ninjadq.com/2015/09/29/3rd-party-net-plugin-in-docker">Dockeré©±åŠ¨è§„èŒƒä¸­æ–‡</a>
<a href="https://github.com/moby/libnetwork/blob/master/drivers/remote/driver.go">Dockerè¿œç¨‹é©±åŠ¨æ¥å£</a></p>

:ET