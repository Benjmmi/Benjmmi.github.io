I"	™<p>ç¿»è¯‘ï¼š<a href="https://ssup2.github.io/theory_analysis/Kubernetes_Service_Proxy/">Kubernetes Service Proxy</a></p>

<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1>

<p><code class="language-plaintext highlighter-rouge">kube-proxy</code> æ˜¯è´Ÿè´£ k8s é›†ç¾¤å†…é€šä¿¡è§„åˆ™åˆ›å»ºçš„ç»„å»ºï¼Œk8s å®˜æ–¹æ–‡æ¡£è§£é‡Š</p>

<blockquote>
  <p>Kubernetes ç½‘ç»œä»£ç†åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ç½‘ç»œä»£ç†åæ˜ äº†æ¯ä¸ªèŠ‚ç‚¹ä¸Š Kubernetes API ä¸­å®šä¹‰çš„æœåŠ¡ï¼Œ
å¹¶ä¸”å¯ä»¥æ‰§è¡Œç®€å•çš„ TCPã€UDP å’Œ SCTP æµè½¬å‘ï¼Œæˆ–è€…åœ¨ä¸€ç»„åç«¯è¿›è¡Œ å¾ªç¯ TCPã€UDP å’Œ SCTP è½¬å‘ã€‚</p>
</blockquote>

<p>ä½†æ˜¯ kube-proxy æœ¬èº«å¹¶ä¸è´Ÿè´£æµé‡è½¬å‘ç­‰å·¥ä½œã€‚
Kubernetes æ”¯æŒä¸‰ç§ Service Proxy æ¨¡å¼ï¼šiptablesã€IPVS å’Œ Userspaceã€‚æ ¹æ®æœåŠ¡ä»£ç†æ–¹å¼åˆ†ææœåŠ¡è¯·æ±‚æŠ¥æ–‡è·¯å¾„ã€‚</p>

<h1 id="service-å’Œ-pod-ä¿¡æ¯">Service å’Œ Pod ä¿¡æ¯</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
NAME                              READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE
my-nginx-756f645cd7-gh7sq         1/1     Running   14         15d   192.167.2.231   kube03   &lt;none&gt;
my-nginx-756f645cd7-hm7rg         1/1     Running   17         20d   192.167.2.206   kube03   &lt;none&gt;
my-nginx-756f645cd7-qfqbp         1/1     Running   16         20d   192.167.1.123   kube02   &lt;none&gt;

<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                           AGE     SELECTOR
my-nginx-cluster        ClusterIP      10.103.1.234     &lt;none&gt;         80/TCP                            15d     <span class="nv">run</span><span class="o">=</span>my-nginx
my-nginx-loadbalancer   LoadBalancer   10.96.98.173     172.35.0.200   80:30781/TCP                      15d    <span class="nv">run</span><span class="o">=</span>my-nginx
my-nginx-nodeport       NodePort       10.97.229.148    &lt;none&gt;         80:30915/TCP 
</code></pre></div></div>
<p>è¿™é‡Œå±•ç¤ºäº† <code class="language-plaintext highlighter-rouge">Kubernetes Service Proxy</code> çš„ <code class="language-plaintext highlighter-rouge">Service</code> å’Œ <code class="language-plaintext highlighter-rouge">Pod</code> ä¿¡æ¯ã€‚å¯ä»¥ä»ä¸Šé¢çš„ä¿¡æ¯çœ‹å‡ºéƒ¨ç½²äº†ä¸‰ä¸ª <code class="language-plaintext highlighter-rouge">nginx</code> Podã€‚å¹¶æ·»åŠ äº†
<code class="language-plaintext highlighter-rouge">ClusterIP</code> ç±»å‹çš„ <code class="language-plaintext highlighter-rouge">my-nginx-cluster</code> ã€<code class="language-plaintext highlighter-rouge">NodePort</code> ç±»å‹çš„ <code class="language-plaintext highlighter-rouge">nginx-nodeport</code> å’Œ <code class="language-plaintext highlighter-rouge">LoadBalancer</code> çš„ <code class="language-plaintext highlighter-rouge">my-nginx-loadbalancer</code>ã€‚</p>

<h1 id="iptables-æ¨¡å¼">Iptables æ¨¡å¼</h1>

<p><img src="/images/k8s/iptables_Mode_Service_Packet_Path.png" alt="iptablesæ¨¡å¼ä¸‹çš„æœåŠ¡è¯·æ±‚åŒ…è·¯å¾„" /></p>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-SERVICES <span class="o">(</span>2 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 KUBE-MARK-MASQ  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>      <span class="o">!</span>192.167.0.0/16       10.96.98.173         /<span class="k">*</span> default/my-nginx-loadbalancer: cluster IP <span class="k">*</span>/ tcp dpt:80
    0     0 KUBE-SVC-TNQCJ2KHUMKABQTD  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.96.98.173         /<span class="k">*</span> default/my-nginx-loadbalancer: cluster IP <span class="k">*</span>/ tcp dpt:80
    0     0 KUBE-FW-TNQCJ2KHUMKABQTD  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            172.35.0.200         /<span class="k">*</span> default/my-nginx-loadbalancer: loadbalancer IP <span class="k">*</span>/ tcp dpt:80
    0     0 KUBE-MARK-MASQ  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>      <span class="o">!</span>192.167.0.0/16       10.103.1.234         /<span class="k">*</span> default/my-nginx-cluster: cluster IP <span class="k">*</span>/ tcp dpt:80
    0     0 KUBE-SVC-52FY5WPFTOHXARFK  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.103.1.234         /<span class="k">*</span> default/my-nginx-cluster: cluster IP <span class="k">*</span>/ tcp dpt:80 
    0     0 KUBE-MARK-MASQ  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>      <span class="o">!</span>192.167.0.0/16       10.97.229.148        /<span class="k">*</span> default/my-nginx-nodeport: cluster IP <span class="k">*</span>/ tcp dpt:80
    0     0 KUBE-SVC-6JXEEPSEELXY3JZG  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.97.229.148        /<span class="k">*</span> default/my-nginx-nodeport: cluster IP <span class="k">*</span>/ tcp dpt:80
    0     0 KUBE-NODEPORTS  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> kubernetes service nodeports<span class="p">;</span> NOTE: this must be the last rule <span class="k">in </span>this chain <span class="k">*</span>/ ADDRTYPE match dst-type LOCAL
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-NODEPORTS <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 KUBE-MARK-MASQ  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:30781
    0     0 KUBE-SVC-TNQCJ2KHUMKABQTD  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:30781
    0     0 KUBE-MARK-MASQ  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-nodeport: <span class="k">*</span>/ tcp dpt:30915
    0     0 KUBE-SVC-6JXEEPSEELXY3JZG  tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-nodeport: <span class="k">*</span>/ tcp dpt:30915 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-FW-XXX</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-FW-TNQCJ2KHUMKABQTD <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 KUBE-MARK-MASQ  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: loadbalancer IP <span class="k">*</span>/
    0     0 KUBE-SVC-TNQCJ2KHUMKABQTD  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: loadbalancer IP <span class="k">*</span>/
    0     0 KUBE-MARK-DROP  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: loadbalancer IP <span class="k">*</span>/
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-SVC-XXX</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-SVC-TNQCJ2KHUMKABQTD <span class="o">(</span>2 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 KUBE-SEP-6HM47TA5RTJFOZFJ  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.33332999982
    0     0 KUBE-SEP-AHRDCNDYGFSFVA64  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.50000000000
    0     0 KUBE-SEP-BK523K4AX5Y34OZL  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0      
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-SEP-XXX</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-SEP-6HM47TA5RTJFOZFJ <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 KUBE-MARK-MASQ  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       192.167.2.231        0.0.0.0/0
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            tcp to:192.167.2.231:80 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-POSTROUTING</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-POSTROUTING <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 MASQUERADE  all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> kubernetes service traffic requiring SNAT <span class="k">*</span>/ mark match
0x4000/0x4000 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-MARK-MASQ</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-MARK-MASQ <span class="o">(</span>23 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 MARK       all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹çš„ <code class="language-plaintext highlighter-rouge">KUBE-MARK-DROP</code>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-MARK-DROP <span class="o">(</span>10 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 MARK       all  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            MARK or 0x8000
</code></pre></div></div>

<p>è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">Service Proxy</code> ä½¿ç”¨æ˜¯ <code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ã€‚è¿™æ˜¯ <code class="language-plaintext highlighter-rouge">Kubernetes</code> å½“å‰ä½¿ç”¨çš„é»˜è®¤ä»£ç†æ¨¡å¼ã€‚
åœ¨ä¸Šæ–¹å›¾ä¸­å±•ç¤ºäº† <code class="language-plaintext highlighter-rouge">iptables</code> æ¨¡å¼ä¸‹æœåŠ¡è¯·æ±‚åŒ…çš„è·¯å¾„ã€‚ä¸Šæ–¹çš„ <code class="language-plaintext highlighter-rouge">bash</code> æ˜¯å±•ç¤ºäº†ä¸»è¦ <code class="language-plaintext highlighter-rouge">NAT</code> è¡¨çš„å†…å®¹ã€‚</p>

<p>ç”±äºå¤§å¤šæ•° <code class="language-plaintext highlighter-rouge">Pod</code> ä¼ è¾“çš„è¯·æ±‚åŒ…æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">Pod</code> çš„ <code class="language-plaintext highlighter-rouge">veth</code> ä¼ é€’åˆ°ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå› æ­¤è¯·æ±‚åŒ…é€šè¿‡ <code class="language-plaintext highlighter-rouge">PREROUTING</code> è¡¨ä¼ é€’åˆ° <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> è¡¨ã€‚
<code class="language-plaintext highlighter-rouge">Pod</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">Host</code>è¿›ç¨‹ ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Host</code> çš„ç½‘ç»œå‘½åç©ºé—´ä¼ è¾“çš„è¯·æ±‚æ•°æ®åŒ…ç”± <code class="language-plaintext highlighter-rouge">OUTPUT</code> è¡¨ä¼ é€’åˆ° <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> è¡¨ã€‚</p>

<p>å¦‚æœ<code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> è¡¨ä¸­è¯·æ±‚åŒ…çš„ç›®æ ‡<code class="language-plaintext highlighter-rouge">IP</code>å’Œç›®æ ‡<code class="language-plaintext highlighter-rouge">Port</code>ä¸<code class="language-plaintext highlighter-rouge">ClusterIP Service</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>å’Œ<code class="language-plaintext highlighter-rouge">Port</code>åŒ¹é…ï¼Œåˆ™è¯·æ±‚çš„åŒ…
è¢«è½¬å‘åˆ°<code class="language-plaintext highlighter-rouge">KUBE-SVC-XXX</code> è¡¨ï¼Œå³<code class="language-plaintext highlighter-rouge">ClusterIP Service</code>çš„<code class="language-plaintext highlighter-rouge">NAT</code>è¡¨.</p>

<p>å¦‚æœ <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> è¡¨ä¸­è¯·æ±‚åŒ…çš„ç›®æ ‡ <code class="language-plaintext highlighter-rouge">IP</code> æ˜¯èŠ‚ç‚¹è‡ªå·±çš„ <code class="language-plaintext highlighter-rouge">IP</code>ï¼Œåˆ™å°†è¯·æ±‚åŒ…è½¬å‘åˆ° <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code> è¡¨ã€‚
å¦‚æœ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code> è¡¨ä¸­è¯·æ±‚æŠ¥æ–‡çš„ç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code> ä¸ <code class="language-plaintext highlighter-rouge">NodePort Service</code> çš„ <code class="language-plaintext highlighter-rouge">Port</code>åŒ¹é…ï¼Œåˆ™å°†è¯·æ±‚æŠ¥æ–‡ä¼ é€åˆ° <code class="language-plaintext highlighter-rouge">KUBE-SVC-XXX</code> è¡¨ï¼Œ
å³ <code class="language-plaintext highlighter-rouge">NodePort Service</code> çš„ <code class="language-plaintext highlighter-rouge">NAT</code> è¡¨ã€‚</p>

<p>å¦‚æœ<code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> è¡¨ä¸­è¯·æ±‚åŒ…çš„ç›®æ ‡ <code class="language-plaintext highlighter-rouge">IP</code>å’Œç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code>ä¸<code class="language-plaintext highlighter-rouge">LoadBalancer Service</code> çš„<code class="language-plaintext highlighter-rouge">External IP</code>å’Œ<code class="language-plaintext highlighter-rouge">Port</code>åŒ¹é…ï¼Œ
åˆ™å°†è¯·æ±‚åŒ…è½¬å‘åˆ°<code class="language-plaintext highlighter-rouge">KUBE-FW-XXX</code> è¡¨ï¼Œ<code class="language-plaintext highlighter-rouge">LoadBalancer Service</code>çš„<code class="language-plaintext highlighter-rouge">NAT</code>è¡¨ï¼Œç„¶åå†å°† <code class="language-plaintext highlighter-rouge">LoadBalancer Service</code> ä¼ é€
åˆ° <code class="language-plaintext highlighter-rouge">KUBE-SVC-XXX</code> è¡¨ï¼Œä¹Ÿå°±æ˜¯ <code class="language-plaintext highlighter-rouge">NAT</code> è¡¨</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">KUBE-SVC-XXX</code> è¡¨ä¸­ï¼Œè¯·æ±‚åŒ…é€šè¿‡<code class="language-plaintext highlighter-rouge">iptables</code>çš„ç»Ÿè®¡åŠŸèƒ½ï¼Œåœ¨æ„æˆ<code class="language-plaintext highlighter-rouge">Service</code>çš„<code class="language-plaintext highlighter-rouge">Pod</code>ä¹‹é—´èµ·åˆ°éšæœºå‡åŒ€è´Ÿè½½å‡è¡¡çš„ä½œç”¨ã€‚
åœ¨ <em><code class="language-plaintext highlighter-rouge">KUBE-SVC-TNQCJ2KHUMKABQTD</code></em> ä¸­ï¼Œç”±äº<code class="language-plaintext highlighter-rouge">Service</code>ç”±ä¸‰ä¸ª<code class="language-plaintext highlighter-rouge">pod</code>ç»„æˆï¼Œå¯ä»¥çœ‹å‡ºè¯·æ±‚åŒ…è®¾ç½®ä¸ºéšæœºå‡è¡¡è´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨ä¸‰ä¸ª<code class="language-plaintext highlighter-rouge">KUBE-SEP-XXX</code>è¡¨ã€‚
åœ¨ <code class="language-plaintext highlighter-rouge">KUBE-SEP-XXX</code> è¡¨ä¸­ï¼Œè¯·æ±‚åŒ…ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Pod</code> çš„ <code class="language-plaintext highlighter-rouge">IP</code> å’Œ <code class="language-plaintext highlighter-rouge">Service</code> ä¸­è®¾ç½®çš„ <code class="language-plaintext highlighter-rouge">Port</code> è¿›è¡Œ <code class="language-plaintext highlighter-rouge">DNAT</code>ã€‚
ç”±<code class="language-plaintext highlighter-rouge">Pod</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>å‘å‡ºçš„<code class="language-plaintext highlighter-rouge">DNAT</code>è¯·æ±‚åŒ…é€šè¿‡<code class="language-plaintext highlighter-rouge">CNI Plugin</code>æ„å»ºçš„å®¹å™¨ç½‘ç»œä¼ é€’ç»™è¯¥<code class="language-plaintext highlighter-rouge">Pod</code>ã€‚</p>

<p>ç”±äºä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">service</code>çš„è¯·æ±‚åŒ…æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">iptables</code>çš„<code class="language-plaintext highlighter-rouge">DNAT</code>ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">Pod</code>çš„ï¼Œæ‰€ä»¥<code class="language-plaintext highlighter-rouge">Pod</code>å‘å‡ºçš„å“åº”åŒ…çš„<code class="language-plaintext highlighter-rouge">Src IP</code>åº”è¯¥<code class="language-plaintext highlighter-rouge">SNAT</code>åˆ°<code class="language-plaintext highlighter-rouge">Service IP</code>ï¼Œ
è€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">Pod IP</code> ã€‚<code class="language-plaintext highlighter-rouge">iptables</code> ä¸­æœªæŒ‡å®š <code class="language-plaintext highlighter-rouge">Serivce</code> çš„ <code class="language-plaintext highlighter-rouge">SNAT</code> è§„åˆ™ã€‚ä½†æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">iptables</code>æ ¹æ®<code class="language-plaintext highlighter-rouge">Linux Kernel</code> çš„<code class="language-plaintext highlighter-rouge">Conntrack</code>ï¼ˆè¿æ¥è·Ÿè¸ªï¼‰çš„ 
<code class="language-plaintext highlighter-rouge">TCP</code> è¿æ¥ä¿¡æ¯å¯¹ä» <code class="language-plaintext highlighter-rouge">Service Pod</code> æ”¶åˆ°çš„å“åº”æ•°æ®åŒ…è¿›è¡Œ <code class="language-plaintext highlighter-rouge">SNAT</code>ã€‚</p>

<h1 id="source-ip">Source IP</h1>

<p><code class="language-plaintext highlighter-rouge">Service</code>è¯·æ±‚åŒ…çš„<code class="language-plaintext highlighter-rouge">Src IP</code>å°†è¢«ç•™å­˜ï¼Œæˆ–é€šè¿‡<code class="language-plaintext highlighter-rouge">Masquerade</code>ä½œä¸º<code class="language-plaintext highlighter-rouge">Host</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>è¿›è¡Œ<code class="language-plaintext highlighter-rouge">SNAT</code>ã€‚
<code class="language-plaintext highlighter-rouge">KUBE-MARK-MASQ</code> æ˜¯ä¸€ä¸ªè¡¨ï¼Œå°†ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Masquerade</code> å¯¹è¯·æ±‚åŒ…è¿›è¡Œæ ‡è®°ã€‚
<code class="language-plaintext highlighter-rouge">Marking</code>çš„<code class="language-plaintext highlighter-rouge">Packet</code>åœ¨<code class="language-plaintext highlighter-rouge">KUBE-POSTROUTING</code> è¡¨ä¸­æˆä¸º<code class="language-plaintext highlighter-rouge">Masquerade</code>ï¼Œ<code class="language-plaintext highlighter-rouge">Src IP</code>ä½œä¸º<code class="language-plaintext highlighter-rouge">Host</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>æˆä¸º<code class="language-plaintext highlighter-rouge">SNAT</code>ã€‚
åœ¨<code class="language-plaintext highlighter-rouge">iptables</code> è¡¨ä¸­ï¼Œä½ ä¼šå‘ç°<code class="language-plaintext highlighter-rouge">KUBE-MARK-MASQ</code> è¡¨ä¼šæ£€æµ‹å‡ºè¢«<code class="language-plaintext highlighter-rouge">Masquerade</code>æ ‡è®°è¿‡çš„åŒ…ã€‚</p>

<p><img src="/images/k8s/NodePort_Policy.png" alt="æ ¹æ®NodePortã€LoadBalancer Serviceçš„externalTrafficPolicyçš„æ•°æ®åŒ…è·¯å¾„" />
<strong>æ ¹æ®NodePortã€LoadBalancer Serviceçš„externalTrafficPolicyçš„æ•°æ®åŒ…è·¯å¾„å›¾</strong></p>

<p><em>å›¾ä¸­å·¦ä¾§ä¸º<code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code>å€¼ä¸º<code class="language-plaintext highlighter-rouge">Cluster</code>ï¼Œæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">Masquerade</code>ã€‚</em>
<code class="language-plaintext highlighter-rouge">LoadBalancer Service</code> çš„ <code class="language-plaintext highlighter-rouge">NodePort</code> å’Œ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code> çš„ <code class="language-plaintext highlighter-rouge">Cluster</code>ã€‚
å¦‚æœ<code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code>å€¼è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">Cluster</code>ï¼Œåˆ™è¯·æ±‚åŒ…çš„<code class="language-plaintext highlighter-rouge">Src IP</code>é€šè¿‡<code class="language-plaintext highlighter-rouge">Masquerade</code> è¢« <code class="language-plaintext highlighter-rouge">SNAT</code>åˆ°<code class="language-plaintext highlighter-rouge">Host</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>ã€‚
åœ¨ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code> è¡¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">KUBE-MARK-MASQ</code> è¡¨æ£€æŸ¥æ‰€æœ‰ä»¥ <code class="language-plaintext highlighter-rouge">NodePort</code> å’Œ <code class="language-plaintext highlighter-rouge">LoadBalancer Service Port</code> 
ä½œä¸º <code class="language-plaintext highlighter-rouge">Dest Port</code> çš„æ•°æ®åŒ…ã€‚</p>

<p><em>å›¾å³ä¾§æ˜¯é€šè¿‡å°†<code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code>è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">Local</code>ï¼Œä¸æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">Masquerade</code></em>
å¦‚æœå°† <code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code> å€¼è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">Local</code>ï¼Œåˆ™ <code class="language-plaintext highlighter-rouge">KUBE-MARK-MASQ</code> è¡¨ä¸­ç›¸å…³è§„åˆ™å°†ä¸ä¼šå‡ºç°åœ¨ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code> è¡¨ä¸­ï¼Œ
æ‰€ä»¥å°±ä¸ä¼šæ‰§è¡Œåˆ° <code class="language-plaintext highlighter-rouge">Masquerade</code>ã€‚è¯·æ±‚æ•°æ®åŒ…çš„ <code class="language-plaintext highlighter-rouge">Src IP</code> ä¸ä¼šè¢«ä¿®æ”¹ã€‚å¦å¤–ï¼Œè¯·æ±‚åŒ…åœ¨å®¿ä¸»æœºä¸­ä¸ä¼šè¢«è´Ÿè½½å‡è¡¡ï¼Œè€Œæ˜¯å°†è¯·æ±‚åŒ…å‘é€
åˆ°çš„ <code class="language-plaintext highlighter-rouge">Host</code> ä¸­çš„ç›®æ ‡<code class="language-plaintext highlighter-rouge">pod</code>ã€‚å¦‚æœè¯·æ±‚æ•°æ®åŒ…è¢«å‘é€åˆ°ä¸»æœºä¸å­˜åœ¨ç›®æ ‡ <code class="language-plaintext highlighter-rouge">pod</code>ï¼Œé‚£ä¹ˆè¯·æ±‚æ•°æ®åŒ…å°†è¢«ä¸¢å¼ƒã€‚</p>

<p><code class="language-plaintext highlighter-rouge">ExternalTrafficPolicy Local</code>ä¸»è¦ç”¨äº<code class="language-plaintext highlighter-rouge">LoadBalancer Service</code>ã€‚å› ä¸ºç”± <code class="language-plaintext highlighter-rouge">Cloud Provider</code> çš„è´Ÿè½½å‡è¡¡å™¨æ‰§è¡Œè´Ÿè½½å‡è¡¡ï¼Œ
æ‰€ä»¥ä¸»æœºä¸éœ€è¦è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥å¯ä»¥ä¿ç•™è¯·æ±‚åŒ…çš„<code class="language-plaintext highlighter-rouge">Src IP</code>ã€‚
å¦‚æœ<code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code>å€¼ä¸º<code class="language-plaintext highlighter-rouge">Local</code>ï¼Œäº‘æœåŠ¡æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨ä¼šå¯¹ç›®æ ‡ Pod æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼Œå¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥
æˆ–è€…ç›®æ ‡ Pod ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå‘é€åˆ°ä¸»æœºä¸Šçš„æ•°æ®åŒ…å°†ä¼šè¢«ä¸¢å¼ƒåˆ é™¤ã€‚</p>

<p><img src="/images/k8s/iptables_Mode_Hairpinning.png" alt="iptablesæ¨¡å¼ä¸‹å‘å¤¹å‰/åçš„æ•°æ®åŒ…è·¯å¾„" /></p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">Pod</code>ä¸­å‘è‡ªå·±æ‰€å±çš„<code class="language-plaintext highlighter-rouge">Service</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>å‘é€è¯·æ±‚æ•°æ®åŒ…ï¼Œåœ¨è¯·æ±‚æ•°æ®åŒ…è¿”å›æ—¶ä¹Ÿéœ€è¦ <code class="language-plaintext highlighter-rouge">Masquerade</code>ã€‚å›¾ä¸­å·¦è¾¹å°±æ ‡è¯†è¿™ç§æƒ…å†µã€‚
è¯·æ±‚æ•°æ®åŒ…è¢«DNAT, æ•°æ®åŒ…çš„<code class="language-plaintext highlighter-rouge">Src IP</code>å’Œ<code class="language-plaintext highlighter-rouge">Dest IP</code>éƒ½æ˜¯<code class="language-plaintext highlighter-rouge">Pod</code>æœ¬èº«çš„<code class="language-plaintext highlighter-rouge">IP</code>ã€‚
å› æ­¤ï¼Œ<code class="language-plaintext highlighter-rouge">Pod</code>è¿”å›å“åº”æ•°æ®åŒ…æ—¶ï¼Œå“åº”æ•°æ®åŒ…ä¸é€šè¿‡<code class="language-plaintext highlighter-rouge">Host</code>çš„<code class="language-plaintext highlighter-rouge">NAT</code>è¡¨ï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">SNAT</code>ï¼Œç›´æ¥åœ¨ <code class="language-plaintext highlighter-rouge">Pod</code> ä¸­å¤„ç†ã€‚</p>

<p>å¦‚æœä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Masquerade</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡å°†è¿”å› <code class="language-plaintext highlighter-rouge">Pod</code> çš„è¯·æ±‚åŒ…å¼ºåˆ¶ä¼ é€’ç»™ Host æ¥æ‰§è¡Œ SNATã€‚è¿™ç§é€šè¿‡æ•…æ„ç»•è¿‡æ•°æ®åŒ…æ¥æ¥æ”¶æ•°æ®åŒ…çš„æ–¹æ³•ç§°ä¸º<code class="language-plaintext highlighter-rouge">Hairpinning</code>ã€‚
å›¾ä¸­çš„å³ä¾§æ˜¾ç¤ºäº†ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Masqurade</code>åº”ç”¨<code class="language-plaintext highlighter-rouge">Hairpinning</code>çš„æƒ…å†µã€‚å¦‚æœ<code class="language-plaintext highlighter-rouge">KUBE-SEP-XXX</code>è¡¨ä¸­è¯·æ±‚æ•°æ®åŒ…çš„Src IPä¸DNATçš„IPç›¸åŒï¼Œ
å³<code class="language-plaintext highlighter-rouge">Pod</code>å‘é€åˆ°<code class="language-plaintext highlighter-rouge">Service</code>çš„æ•°æ®åŒ…ç”±è‡ªå·±æ¥æ”¶æ—¶ï¼Œåˆ™è¯·æ±‚çš„æ•°æ®åŒ…ç»è¿‡<code class="language-plaintext highlighter-rouge">KUBE-MARK-MASQ</code> è¡¨æ˜¯è¢« <code class="language-plaintext highlighter-rouge">Marking</code>ï¼Œ
åœ¨<code class="language-plaintext highlighter-rouge">KUBE-POSTROUTING</code> è¡¨ä¸­è¢«<code class="language-plaintext highlighter-rouge">Masquerade</code>
å› ä¸º<code class="language-plaintext highlighter-rouge">Pod</code>æ¥æ”¶åˆ°çš„æ•°æ®åŒ…çš„<code class="language-plaintext highlighter-rouge">Src IP</code>è¢«è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">Host</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>ï¼Œå› æ­¤<code class="language-plaintext highlighter-rouge">Pod</code>çš„å“åº”è¢«å‘é€åˆ°<code class="language-plaintext highlighter-rouge">Host</code>çš„<code class="language-plaintext highlighter-rouge">NAT</code> è¡¨ï¼Œç„¶åè¿›è¡Œ<code class="language-plaintext highlighter-rouge">SNAT</code>å’Œ<code class="language-plaintext highlighter-rouge">DNAT</code>ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">Pod</code>ã€‚</p>

<h1 id="ç”¨æˆ·ç©ºé—´">ç”¨æˆ·ç©ºé—´</h1>

<p>Userspace Modeä¸‹çš„æœåŠ¡è¯·æ±‚æŠ¥æ–‡è·¯å¾„å›¾ï¼š
<img src="/images/k8s/Userspace_Mode_Service_Packet_Path.png" alt="Userspace_Mode_Service_Packet_Path.png" /></p>

<p>ç”¨æˆ·ç©ºé—´æ¨¡å¼ä¸‹çš„ KUBE-PORTALS-CONTAINERï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-PORTALS-CONTAINER <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 REDIRECT   tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.96.98.173         /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:80 redir ports 38023
    0     0 REDIRECT   tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            172.35.0.200         /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:80 redir ports 38023
    0     0 REDIRECT   tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.103.1.234         /<span class="k">*</span> default/my-nginx-cluster: <span class="k">*</span>/ tcp dpt:80 redir ports 36451
    0     0 REDIRECT   tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.97.229.148        /<span class="k">*</span> default/my-nginx-nodeport: <span class="k">*</span>/ tcp dpt:80 redir ports 44257
</code></pre></div></div>

<p>ç”¨æˆ·ç©ºé—´æ¨¡å¼ä¸‹çš„ KUBE-NODEPORT-CONTAINERï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-NODEPORT-CONTAINER <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 REDIRECT   tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:30781 redir ports 38023
    0     0 REDIRECT   tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-nodeport: <span class="k">*</span>/ tcp dpt:30915 redir ports 44257
</code></pre></div></div>

<p>ç”¨æˆ·ç©ºé—´æ¨¡å¼ä¸‹çš„ KUBE-PORTALS-HOSTï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-PORTALS-HOST <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.96.98.173         /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:80 to:172.35.0.100:38023
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            172.35.0.200         /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:80 to:172.35.0.100:38023
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.103.1.234         /<span class="k">*</span> default/my-nginx-cluster: <span class="k">*</span>/ tcp dpt:80 to:172.35.0.100:46635
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            10.97.229.148        /<span class="k">*</span> default/my-nginx-nodeport: <span class="k">*</span>/ tcp dpt:80 to:172.35.0.100:32847
</code></pre></div></div>

<p>ç”¨æˆ·ç©ºé—´æ¨¡å¼ä¸‹çš„ KUBE-NODEPORT-HOSTï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain KUBE-NODEPORT-HOST <span class="o">(</span>1 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-loadbalancer: <span class="k">*</span>/ tcp dpt:30781 to:172.35.0.100:38023
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="k">*</span>      <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            /<span class="k">*</span> default/my-nginx-nodeport: <span class="k">*</span>/ tcp dpt:30915 to:172.35.0.100:44257
</code></pre></div></div>

<p>Service Proxy çš„ iptables æ¨¡å¼æ˜¯ä¸€ç§è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ kube-proxy æ‰®æ¼” Service Proxy è§’è‰²çš„æ¨¡å¼ã€‚
è¿™æ˜¯ Kubernetes æä¾›çš„ç¬¬ä¸€ä¸ªä»£ç†æ¨¡å¼ã€‚ç›®å‰ä½¿ç”¨çš„ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºä¸iptablesæ¨¡å¼ç›¸æ¯”æ€§èƒ½è¾ƒå·®ã€‚
ä¸Šå›¾ä¸­å±•ç¤ºäº† Userspace æ¨¡å¼ä¸‹Service è¯·æ±‚åŒ…çš„è·¯å¾„ã€‚</p>

<p>ç”±äºå¤§å¤šæ•° <code class="language-plaintext highlighter-rouge">Pod</code> ä¼ è¾“çš„è¯·æ±‚åŒ…æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">Pod</code> çš„ <code class="language-plaintext highlighter-rouge">veth</code> ä¼ é€’åˆ° <code class="language-plaintext highlighter-rouge">Host</code> çš„ <code class="language-plaintext highlighter-rouge">Network</code> å‘½åç©ºé—´ï¼Œå› æ­¤è¯·æ±‚åŒ…é€šè¿‡ PREROUTING è¡¨ä¼ é€’åˆ°
<code class="language-plaintext highlighter-rouge">KUBE-PORTALS-CONTAINER</code> è¡¨ã€‚å¦‚æœ <code class="language-plaintext highlighter-rouge">KUBE-PORTALS-CONTAINER</code> æ ‡å‡†ä¸­è¯·æ±‚åŒ…çš„ ç›®æ ‡ <code class="language-plaintext highlighter-rouge">IP</code> å’Œç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code> ä¸ <code class="language-plaintext highlighter-rouge">ClusterIP</code> æœåŠ¡
çš„ <code class="language-plaintext highlighter-rouge">IP</code> å’Œ <code class="language-plaintext highlighter-rouge">Port</code> åŒ¹é…ï¼Œåˆ™è¯·æ±‚åŒ…è¢«é‡å®šå‘åˆ°<code class="language-plaintext highlighter-rouge">kube-proxy</code> ã€‚å¦‚æœè¯·æ±‚æ•°æ®åŒ…çš„ç›®æ ‡ <code class="language-plaintext highlighter-rouge">IP</code>æ˜¯èŠ‚ç‚¹è‡ªå·±çš„<code class="language-plaintext highlighter-rouge">IP</code>ï¼Œåˆ™å°†æ•°æ®åŒ…æŠ•é€’åˆ°
<code class="language-plaintext highlighter-rouge">KUBE-NODEPORT-CONTAINER</code>è¡¨ã€‚å¦‚æœ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORT-CONTAINER</code> è¡¨ä¸­è¯·æ±‚åŒ…çš„ ç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code> ä¸ <code class="language-plaintext highlighter-rouge">NodePort Service</code> çš„ç«¯
å£åŒ¹é…ï¼Œåˆ™è¯·æ±‚åŒ…è¢«é‡å®šå‘åˆ° <code class="language-plaintext highlighter-rouge">kube-proxy</code>ã€‚å¦‚æœè¯·æ±‚åŒ…çš„ç›®æ ‡ <code class="language-plaintext highlighter-rouge">IP</code>å’Œç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code>ä¸<code class="language-plaintext highlighter-rouge">LoadBalancer Service</code>çš„<code class="language-plaintext highlighter-rouge">External IP</code>å’Œ<code class="language-plaintext highlighter-rouge">Port</code>åŒ¹é…ï¼Œ
è¯·æ±‚åŒ…ä¹Ÿä¼šè¢«é‡å®šå‘åˆ°kube-proxyã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Pod</code> æˆ– <code class="language-plaintext highlighter-rouge">Host</code> è¿›ç¨‹ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Host</code> çš„ <code class="language-plaintext highlighter-rouge">Network Namespace</code> ä¼ è¾“çš„è¯·æ±‚æ•°æ®åŒ…ç”± <code class="language-plaintext highlighter-rouge">OUTPUT</code> è¡¨ ä¼ é€’åˆ° <code class="language-plaintext highlighter-rouge">KUBE-PORTALS-HOST</code> è¡¨ã€‚
<code class="language-plaintext highlighter-rouge">KUBE-PORTALS-HOST</code> å’Œ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORT-HOST</code> è¡¨ä¸­çš„åç»­è¯·æ±‚åŒ…å¤„ç†ç±»ä¼¼äº <code class="language-plaintext highlighter-rouge">KUBE-PORTALS-CONTAINER</code> å’Œ <code class="language-plaintext highlighter-rouge">KUBE-NODEPORT-CONTAINER</code> è¡¨
ä¸­çš„è¯·æ±‚åŒ…å¤„ç†ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼ŒDNATæ˜¯åœ¨ä¸é‡å®šå‘è¯·æ±‚åŒ…çš„æƒ…å†µä¸‹æ‰§è¡Œçš„ã€‚</p>

<p><strong>é€šè¿‡ <code class="language-plaintext highlighter-rouge">Redirect</code> å’Œ <code class="language-plaintext highlighter-rouge">DNAT</code> å‘é€åˆ° <code class="language-plaintext highlighter-rouge">Service</code> çš„æ‰€æœ‰è¯·æ±‚æ•°æ®åŒ…éƒ½è¢«ä¼ é€’åˆ° <code class="language-plaintext highlighter-rouge">kube-proxy</code></strong>ã€‚<code class="language-plaintext highlighter-rouge">kube-proxy</code> æ”¶åˆ°çš„è¯·æ±‚æ•°æ®åŒ…çš„
æ¯ä¸ªç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code> æ˜ å°„ä¸€ä¸ªæœåŠ¡ã€‚å› æ­¤ï¼Œ<code class="language-plaintext highlighter-rouge">kube-proxy</code> å¯ä»¥é€šè¿‡é‡å®šå‘å’Œ <code class="language-plaintext highlighter-rouge">NAT</code> è¯·æ±‚æ•°æ®åŒ…çš„ ç›®æ ‡ <code class="language-plaintext highlighter-rouge">Port</code> ç¡®å®šè¯·æ±‚æ•°æ®åŒ…åº”è¯¥ä¼ é€’åˆ°å“ªä¸ªæœåŠ¡ã€‚
<code class="language-plaintext highlighter-rouge">kube-proxy</code> é€šè¿‡å°†æ¥æ”¶åˆ°çš„è¯·æ±‚æ•°æ®åŒ…å‡åŒ€åœ°è´Ÿè½½å‡è¡¡åˆ°å±äºè¯·æ±‚æ•°æ®åŒ…è¦ä¼ è¾“åˆ°çš„æœåŠ¡çš„å¤šä¸ª <code class="language-plaintext highlighter-rouge">Pod</code> æ¥é‡æ–°ä¼ è¾“æ¥æ”¶åˆ°çš„è¯·æ±‚æ•°æ®åŒ…ã€‚</p>

<p>ç”±äº <code class="language-plaintext highlighter-rouge">kube-proxy</code> è¿è¡Œåœ¨ä¸»æœºçš„ <code class="language-plaintext highlighter-rouge">Network Namespace</code> ä¸­ï¼Œå› æ­¤ <code class="language-plaintext highlighter-rouge">kube-proxy</code> å‘é€çš„è¯·æ±‚åŒ…ä¹Ÿä¼šç»è¿‡ <code class="language-plaintext highlighter-rouge">Service NAT</code> è¡¨ã€‚
ä½†æ˜¯ç”±äº<code class="language-plaintext highlighter-rouge">kube-proxy</code>å‘é€çš„è¯·æ±‚åŒ…çš„ç›®æ ‡ <code class="language-plaintext highlighter-rouge">IP</code>æ˜¯<code class="language-plaintext highlighter-rouge">Pod</code>çš„<code class="language-plaintext highlighter-rouge">IP</code>ï¼Œæ‰€ä»¥è¯·æ±‚åŒ…ä¸ä¼šè¢«<code class="language-plaintext highlighter-rouge">Service NAT</code> è¡¨æ”¹å˜ï¼Œè€Œæ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">CNI Plugin</code>æ­å»º
çš„<code class="language-plaintext highlighter-rouge">Container Network</code>ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">Pod</code>ã€‚</p>

:ET