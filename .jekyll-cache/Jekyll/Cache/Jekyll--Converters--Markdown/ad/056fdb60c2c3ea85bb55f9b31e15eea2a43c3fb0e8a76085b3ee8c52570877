I"¯~<h1 id="liburing-å®ç°-cp-å‘½ä»¤">liburing å®ç° cp å‘½ä»¤</h1>

<p>åœ¨å‰é¢çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨liburingæä¾›çš„é«˜çº§æ¥å£æ¥æ„å»ºç›¸å½“äºUnix catçš„å·¥å…·ã€‚
ç„¶è€Œï¼Œåœ¨è¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é˜Ÿåˆ—æ²¡æœ‰åŒæ—¶å¤„ç†è¶…è¿‡ä¸€ä¸ªè¯·æ±‚ã€‚ io_uringçš„ç›®æ ‡ä¹‹ä¸€æ˜¯èƒ½å¤Ÿé€šè¿‡
è®©ç”¨æˆ·åŒæ—¶æ’é˜Ÿå‡ ä¸ªæ“ä½œæ¥å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡ï¼Œè¿™æ ·å†…æ ¸å°±å¯ä»¥ä¸€ä¸‹å­æ¥æ”¶å¹¶å¤„ç†è¿™äº›æ“ä½œï¼Œ
è€Œä¸éœ€è¦ç¨‹åºä¸ºæ¯ä¸ªI/Oè¯·æ±‚è¿›è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨ã€‚</p>

<p>ä¸ºæ­¤ï¼Œåœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªå¤åˆ¶æ–‡ä»¶çš„å¤åˆ¶ç¨‹åºã€‚å®ƒè¯•å›¾é€šè¿‡é˜Ÿ
åˆ—æ·±åº¦å…è®¸çš„å°½å¯èƒ½å¤šçš„è¯·æ±‚è¿›æ¥ï¼Œè¿™æ ·å°½é‡æé«˜æ•ˆç‡ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä¸€äº›ä»£ç ã€‚
è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯åŸºäº <a href="https://github.com/axboe/fio/blob/master/t/io_uring.c">fio åŒ…</a> ä¸­çš„ä¸€ä¸ªç¨‹åºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;liburing.h&gt;</span><span class="cp">
</span>
<span class="cp">#define QD  2
#define BS (16 * 1024)
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">infd</span><span class="p">,</span> <span class="n">outfd</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">io_data</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">read</span><span class="p">;</span>
    <span class="kt">off_t</span> <span class="n">first_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">first_len</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_context</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_queue_init</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"queue_init: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_file_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">off_t</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BLKGETSIZE64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_prepped</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span><span class="p">;</span>

    <span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">sqe</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
        <span class="n">io_uring_prep_readv</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">infd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">io_uring_prep_writev</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">outfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sqe</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">data</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">first_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

    <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">first_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

    <span class="n">io_uring_prep_readv</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">infd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">first_offset</span><span class="p">;</span>

    <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">first_len</span><span class="p">;</span>

    <span class="n">queue_prepped</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">copy_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">insize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reads</span><span class="p">,</span> <span class="n">writes</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
    <span class="kt">off_t</span> <span class="n">write_left</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">write_left</span> <span class="o">=</span> <span class="n">insize</span><span class="p">;</span>
    <span class="n">writes</span> <span class="o">=</span> <span class="n">reads</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">insize</span> <span class="o">||</span> <span class="n">write_left</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">had_reads</span><span class="p">,</span> <span class="n">got_comp</span><span class="p">;</span>

        <span class="cm">/* å°½å¯èƒ½å¤šåœ°æ’é˜Ÿè¯»å– */</span>
        <span class="n">had_reads</span> <span class="o">=</span> <span class="n">reads</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">insize</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">off_t</span> <span class="n">this_size</span> <span class="o">=</span> <span class="n">insize</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">reads</span> <span class="o">+</span> <span class="n">writes</span> <span class="o">&gt;=</span> <span class="n">QD</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">this_size</span> <span class="o">&gt;</span> <span class="n">BS</span><span class="p">)</span>
                <span class="n">this_size</span> <span class="o">=</span> <span class="n">BS</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_size</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">queue_read</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">this_size</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="n">insize</span> <span class="o">-=</span> <span class="n">this_size</span><span class="p">;</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">this_size</span><span class="p">;</span>
            <span class="n">reads</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">had_reads</span> <span class="o">!=</span> <span class="n">reads</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_submit</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"io_uring_submit: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* æ­¤æ—¶é˜Ÿåˆ—å·²æ»¡ã€‚è®©æˆ‘ä»¬è‡³å°‘æ‰¾åˆ°ä¸€ä¸ª completion */</span>
        <span class="n">got_comp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">write_left</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">struct</span> <span class="n">io_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">got_comp</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_wait_cqe</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
                <span class="n">got_comp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_peek_cqe</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"io_uring_peek_cqe: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">io_uring_cqe_get_data</span><span class="p">(</span><span class="n">cqe</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">queue_prepped</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
                    <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"cqe failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">));</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*çŸ­æ—¶é—´è¯»/å†™ï¼›è°ƒæ•´å¹¶é‡æ–°æ’é˜Ÿ */</span>
                <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
                <span class="n">data</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">-=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
                <span class="n">queue_prepped</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
                <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/*
             * å…¨éƒ½åšå®Œäº†ã€‚å¦‚æœå†™äº†ï¼Œå°±æ²¡åˆ«çš„äº‹å¯åšäº†ã€‚å¦‚æœè¯»å–ï¼Œåˆ™å°†ç›¸åº”çš„å†™å…¥æ’é˜Ÿã€‚
             * */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">queue_write</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
                <span class="n">write_left</span> <span class="o">-=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">first_len</span><span class="p">;</span>
                <span class="n">reads</span><span class="o">--</span><span class="p">;</span>
                <span class="n">writes</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
                <span class="n">writes</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring</span> <span class="n">ring</span><span class="p">;</span>
    <span class="kt">off_t</span> <span class="n">insize</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;infile&gt; &lt;outfile&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">infd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">infd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open infile"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">outfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_TRUNC</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open outfile"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">setup_context</span><span class="p">(</span><span class="n">QD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">get_file_size</span><span class="p">(</span><span class="n">infd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insize</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">copy_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="n">insize</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">infd</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">outfd</span><span class="p">);</span>
    <span class="n">io_uring_queue_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="ç¨‹åºç»“æ„">ç¨‹åºç»“æ„</h1>

<p>è¿™ä¸ªå¤åˆ¶ç¨‹åºåƒå¤§å¤šæ•°å…¶ä»–ç¨‹åºä¸€æ ·ï¼Œå°†ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘çš„æ–‡ä»¶å¤åˆ¶åˆ°ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘çš„æ–‡ä»¶ä¸­ã€‚
è¯¥ç¨‹åºçš„æ ¸å¿ƒæ˜¯ <strong><code class="language-plaintext highlighter-rouge">copy_ file()</code></strong> å‡½æ•°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªå¤–å±‚çš„ <code class="language-plaintext highlighter-rouge">while</code> å¾ªç¯ï¼Œè€Œè¿™ä¸ªå¾ªç¯åˆåŒ…å«äº†å¦å¤–2ä¸ªåµŒå¥—åœ¨åŒä¸€å±‚æ¬¡çš„ <code class="language-plaintext highlighter-rouge">while</code> å¾ªç¯ã€‚è™½ç„¶å¤–å±‚çš„ while å¾ªç¯æ˜¯ä¸ºäº†ç¡®ä¿æºæ–‡ä»¶çš„æ‰€æœ‰å­—èŠ‚éƒ½è¢«å¤åˆ¶ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªåµŒå¥— <code class="language-plaintext highlighter-rouge">while</code> å¾ªç¯çš„ä»»åŠ¡æ˜¯åˆ›å»ºå°½å¯èƒ½å¤šçš„ <a href="http://man7.org/linux/man-pages/man2/readv.2.html">readv(2)</a> ç±»å‹è¯·æ±‚ã€‚äº‹å®ä¸Šï¼Œ
å®ƒæ’é˜Ÿçš„æ•°é‡æ˜¯é˜Ÿåˆ—æ·±åº¦å…è®¸çš„æ•°é‡ã€‚</p>

<p>ä¸€æ—¦é˜Ÿåˆ—æ»¡äº†ï¼Œæˆ‘ä»¬å°±è¿›å…¥ç¬¬äºŒä¸ªåµŒå¥—çš„ <code class="language-plaintext highlighter-rouge">while</code> å¾ªç¯ã€‚è¿™ä¸ªå¾ªç¯æ”¶é›†å®Œæˆé˜Ÿåˆ—æ¡ç›®ï¼Œ
å¹¶æäº¤å†™å…¥ç›®æ ‡æ–‡ä»¶çš„è¯·æ±‚ï¼Œç°åœ¨æ•°æ®å·²ç»è¢«è¯»å–ã€‚æœ‰å‡ ä¸ªå˜é‡è·Ÿè¸ªçŠ¶æ€ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹æ··ä¹±ã€‚ä½†å¼‚æ­¥æ–‡ä»¶å¤åˆ¶ç¨‹åºèƒ½æœ‰å¤šéš¾å‘¢ï¼Ÿ:)</p>

<p>åŸºäº <a href="unixism.net/2020/04/io-uring-by-example-part-2-queuing-multiple-requests/">unixism.net/2020/04/io-uring-by-example-part-2-queuing-multiple-requests/</a></p>

<h1 id="æºç ">æºç </h1>
<p>æ­¤ç¤ºä¾‹å’Œå…¶ä»–ç¤ºä¾‹çš„æºä»£ç å¯åœ¨<a href="https://github.com/shuveb/loti-examples">Github</a>ä¸Šä½¿ç”¨ã€‚</p>
:ET