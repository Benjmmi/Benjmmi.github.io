I"ê¡<h1 id="è¿æ¥è·Ÿè¸ªè¡¨">è¿æ¥è·Ÿè¸ªè¡¨</h1>

<p>è¿æ¥è·Ÿè¸ªä¹Ÿæ˜¯æœ€è¿‘å­¦ä¹ ä¸‹æ¥çš„æœ€å…³å¿ƒã€æœ€æœ‰ç–‘é—®çš„çš„ä¸€ä¸ªé—®é¢˜äº†ï¼Œä½†æ˜¯åº”è¯¥å±äºä¸€åŠ³æ°¸é€¸çš„é—®é¢˜ã€‚</p>

<p>é—®é¢˜å¦‚ä¸‹ï¼š
lvs æ˜¯ä¸ªå››å±‚è´Ÿè½½å‡è¡¡è½¬å‘å™¨ï¼Œè´Ÿè´£å°†æ•°æ®åŒ…è½¬ç»™åç«¯çš„æœåŠ¡å™¨ã€‚æ ¹æ®è°ƒåº¦è§„åˆ™å°†æ•°æ®åŒ…è½¬å‘ç»™æ­£ç¡®çš„åç«¯ Serverã€‚
å› ä¸ºæ¯ä¸ª TCP è¿æ¥éœ€è¦åŒ…å«è‹¥å¹²çš„æ•°æ®åŒ…è¿›è¡Œäº¤äº’ï¼Œå¦‚æœæ¯ä¸ª Packet éƒ½æŒ‰ç…§è°ƒåº¦è§„åˆ™æ¥è°ƒåº¦ï¼Œæ¯”å¦‚æŒ‰ç…§ RR æ¨¡å¼æ¥è¿›è¡Œè°ƒåº¦ï¼Œ
é‚£ä¹ˆè¯¥ TCP è¿æ¥ç›¸å…³çš„è‹¥å¹²æ•°æ®åŒ…åˆ™è¢«è½®è¯¢è½¬å‘ç»™äº† N ä¸ªåç«¯æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæ•´ä¸ªæ•°æ®åŒ…å°±ä¹±å¥—äº†ã€‚æ˜¾ç„¶è´Ÿè½½å‡è¡¡éœ€è¦å°†åŒå±
äºåŒä¸€ä¸ª TCP è¿æ¥çš„æ•°æ®æµçš„è‹¥å¹²æ•°æ®åŒ…è½¬å‘è‡³å…¶ä¸­ä¸€å°åç«¯æœåŠ¡å™¨ä¸Šï¼Œè€Œä¸æ˜¯åˆ†æ•£åˆ°å¤šä¸ªæœåŠ¡å™¨ã€‚</p>

<p>è§£å†³æ–¹æ¡ˆï¼š
lvs è‹¥æƒ³æ­£ç¡®è½¬å‘æ•°æ®åŒ…ï¼Œéœ€è¦ç»´æŠ¤è®°å½•æ•°æ®åŒ…äº”å…ƒç»„ä»£è¡¨çš„è¿æ¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬é¦–æ¬¡å»ºç«‹è¿æ¥æ—¶è°ƒåº¦çš„ RSã€‚
é‚£ä¹ˆåç»­çš„åŒä¸€ä¸ªè¿æ¥ï¼ˆä¼šè¯ï¼‰çš„æ•°æ®åŒ…åˆ°æ¥åï¼ŒæŸ¥è¯¢ç³»ç»Ÿç»´æŠ¤çš„è¿æ¥ä¿¡æ¯ï¼ŒæŸ¥åˆ°è¯¥è¿æ¥åå°±èƒ½ç¡®å®šè¿™æ¡è¿æ¥å¯¹åº”çš„ RS æœåŠ¡å™¨ï¼Œ
æœ€ç»ˆå°†æ•°æ®åŒ…æ­£ç¡®è½¬å‘ç»™æœåŠ¡å™¨ï¼Œè¿™æ ·å°±å®Œæˆäº†å°†ä¸€ä¸ª TCP è¿æ¥è½¬å‘ç»™åç«¯æœåŠ¡å™¨äº†ã€‚</p>

<p><strong>å¤åˆ¶åšå®¢ https://www.linuxblogs.cn/articles/20011018.html</strong></p>

<p>çœ‹è¿™ä¸ªå­—é¢æ„æ€å¥½åƒæ ¹æ®äº”å…ƒç»„å°†åŒä¸€ä¸ªè¿æ¥çš„è¯·æ±‚æ‰“åˆ°åŒä¸€ä¸ªæœåŠ¡å…¶ä¸Šï¼Œä» L4 è´Ÿè½½æ„Ÿè§‰ä¸æ˜¯å¾ˆå‡è¡¡å•Šã€‚ å’Œç†æƒ³çš„æœ‰ç‚¹å·®å¼‚çš„æ ·å­</p>

<p>lvs æ ‡è¯†ä¸€ä¸ªè¿æ¥ä¿¡æ¯ï¼Œç»“æ„ä½“å¦‚ä¸‹:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">c_list</span><span class="p">;</span>         <span class="cm">/* å“ˆå¸Œé“¾è¡¨å¤´ */</span>
  <span class="cm">/* Protocol, addresses and port numbers */</span>
  <span class="n">__be16</span>                  <span class="n">cport</span><span class="p">;</span>          <span class="cm">/* å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£ */</span>
  <span class="n">__be16</span>                  <span class="n">dport</span><span class="p">;</span>          <span class="cm">/* åç«¯æœåŠ¡å™¨çš„ç«¯å£ï¼Œå¯ä»¥ä¸åŒäº vport */</span>
  <span class="n">__be16</span>                  <span class="n">vport</span><span class="p">;</span>          <span class="cm">/* è®¿é—®çš„ä¸šåŠ¡ç«¯å£ï¼Œä¸€èˆ¬ä¸º 80 æˆ– 443 */</span>
  <span class="n">u16</span>     <span class="n">af</span><span class="p">;</span>   <span class="cm">/* åè®®æ—ï¼Œä»£è¡¨ v4 æˆ– v6 */</span>
  <span class="k">union</span> <span class="n">nf_inet_addr</span>      <span class="n">caddr</span><span class="p">;</span>          <span class="cm">/* å®¢æˆ·ç«¯ IP åœ°å€ */</span>
  <span class="k">union</span> <span class="n">nf_inet_addr</span>      <span class="n">vaddr</span><span class="p">;</span>          <span class="cm">/* å®¢æˆ·ç«¯è®¿é—®çš„ vip */</span>
  <span class="k">union</span> <span class="n">nf_inet_addr</span>      <span class="n">daddr</span><span class="p">;</span>          <span class="cm">/* åç«¯ RS æœåŠ¡å™¨ IP åœ°å€ */</span>
  <span class="k">volatile</span> <span class="n">__u32</span>          <span class="n">flags</span><span class="p">;</span>          <span class="cm">/* status flags */</span>
  <span class="n">__u16</span>                   <span class="n">protocol</span><span class="p">;</span>       <span class="cm">/* Which protocol (TCP/UDP) */</span>
  <span class="n">__u16</span>     <span class="n">daf</span><span class="p">;</span>    <span class="cm">/* dest åè®®æ—ï¼Œä»£è¡¨ v4 æˆ– v6 */</span>
  <span class="k">struct</span> <span class="n">netns_ipvs</span> <span class="o">*</span><span class="n">ipvs</span><span class="p">;</span>

  <span class="cm">/* counter and timer */</span>
  <span class="n">refcount_t</span>    <span class="n">refcnt</span><span class="p">;</span>   <span class="cm">/* å¼•ç”¨è®¡æ•° */</span>
  <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>    <span class="cm">/* è¿æ¥å¯¹åº”çš„å®šæ—¶å™¨ */</span>
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">timeout</span><span class="p">;</span>  <span class="cm">/* è¶…æ—¶æ—¶é—´ */</span>

  <span class="cm">/* Flags and state transition */</span>
  <span class="n">spinlock_t</span>              <span class="n">lock</span><span class="p">;</span>           <span class="cm">/* çŠ¶æ€è½¬åŒ–æ—¶éœ€è¦é”æ“ä½œ */</span>
  <span class="k">volatile</span> <span class="n">__u16</span>          <span class="n">state</span><span class="p">;</span>          <span class="cm">/* çŠ¶æ€ä¿¡æ¯ */</span>
  <span class="k">volatile</span> <span class="n">__u16</span>          <span class="n">old_state</span><span class="p">;</span>      <span class="cm">/* ä¿å­˜ä¸Šä¸€ä¸ªçŠ¶æ€
             */</span>
  <span class="n">__u32</span>     <span class="n">fwmark</span><span class="p">;</span>   <span class="cm">/* Fire wall mark from skb */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">sync_endtime</span><span class="p">;</span> <span class="cm">/* jiffies + sent_retries */</span>

  <span class="cm">/* Control members */</span>
  <span class="k">struct</span> <span class="n">ip_vs_conn</span>       <span class="o">*</span><span class="n">control</span><span class="p">;</span>       <span class="cm">/* Master control connection */</span>
  <span class="n">atomic_t</span>                <span class="n">n_control</span><span class="p">;</span>      <span class="cm">/* Number of controlled ones */</span>
  <span class="k">struct</span> <span class="n">ip_vs_dest</span>       <span class="o">*</span><span class="n">dest</span><span class="p">;</span>          <span class="cm">/* real server */</span>
  <span class="n">atomic_t</span>                <span class="n">in_pkts</span><span class="p">;</span>        <span class="cm">/* incoming packet counter */</span>

  <span class="cm">/* Packet transmitter for different forwarding methods.  If it
   * mangles the packet, it must return NF_DROP or better NF_STOLEN,
   * otherwise this must be changed to a sk_buff **.
   * NF_ACCEPT can be returned when destination is local.
   */</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">packet_xmit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
         <span class="k">struct</span> <span class="n">ip_vs_protocol</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ip_vs_iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">);</span>

  <span class="k">struct</span> <span class="n">ip_vs_app</span>        <span class="o">*</span><span class="n">app</span><span class="p">;</span>           <span class="cm">/* bound ip_vs_app object */</span>
  <span class="kt">void</span>                    <span class="o">*</span><span class="n">app_data</span><span class="p">;</span>      <span class="cm">/* Application private data */</span>
  <span class="k">struct</span> <span class="n">ip_vs_seq</span>        <span class="n">in_seq</span><span class="p">;</span>         <span class="cm">/* incoming seq. struct */</span>
  <span class="k">struct</span> <span class="n">ip_vs_seq</span>        <span class="n">out_seq</span><span class="p">;</span>        <span class="cm">/* outgoing seq. struct */</span>

  <span class="k">const</span> <span class="k">struct</span> <span class="n">ip_vs_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
  <span class="kt">char</span>      <span class="o">*</span><span class="n">pe_data</span><span class="p">;</span>
  <span class="n">__u8</span>      <span class="n">pe_data_len</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">rcu_head</span>   <span class="n">rcu_head</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<p>é€šè¿‡è¿™äº›ä¿¡æ¯å°±å®Œæˆäº†ä¸€ä¸ªé“¾æ¥è¡¨ç®¡ç†ã€‚
<strong>åæ€ï¼šå¥½åƒå’Œ conntrack ä¸å¤ªä¸€æ ·</strong></p>

<p>lvs ä¸ºäº†æé«˜æ€§èƒ½ï¼Œé‡‡ç”¨äº† hash è¡¨å­˜å‚¨ï¼Œæ ¹æ® <code class="language-plaintext highlighter-rouge">caddr</code>ã€<code class="language-plaintext highlighter-rouge">cport</code>ã€<code class="language-plaintext highlighter-rouge">proto</code> å…³é”®å­—è®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª hash å€¼ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">ip_vs_conn_hashkey</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ipvs</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ip_vs_conn_hashkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">netns_ipvs</span> <span class="o">*</span><span class="n">ipvs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span>
               <span class="k">const</span> <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
               <span class="n">__be16</span> <span class="n">port</span><span class="p">)</span>
</code></pre></div></div>
<p>ç„¶åå†æ ¹æ® hash ä¸‹é¢çš„é“¾è¡¨è®¡ç®—é™¤æ§½ä½ï¼Œç›¸å½“äº äºŒæ¬¡ hash çš„æ„æ€ã€‚æ‰¾å¯¹åº”çš„è¿æ¥ã€‚</p>

<p>å…³äºè¿æ¥è¡¨çš„å»ºç«‹ï¼šå®¢æˆ·ç«¯å‘èµ·  <code class="language-plaintext highlighter-rouge">syn</code> å»ºç«‹è¿æ¥çš„æ—¶å€™è§¦å‘æ–°å»ºè¿æ¥ï¼Œç›¸åŒè¿æ¥çš„è¯å…¶ä»–æ•°æ®åŒ…åˆ°æ¥æ—¶ï¼Œåªéœ€è¦æŸ¥æ‰¾å­˜åœ¨çš„è¿æ¥è¡¨å³å¯ç»§ç»­åé¢çš„è½¬å‘å·¥ä½œã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="p">...</span>
  <span class="c1">// åªæœ‰åœ¨æˆåŠŸè°ƒåº¦å¯ç”¨çš„åç«¯ RS æœåŠ¡å™¨åæ‰å»æ–°å»ºè¿æ¥</span>
  <span class="n">cp</span> <span class="o">=</span> <span class="n">ip_vs_conn_new</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span>
            <span class="n">fwmark</span><span class="p">);</span>
  <span class="p">...</span>


<span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span>
<span class="n">ip_vs_conn_new</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ip_vs_conn_param</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest_af</span><span class="p">,</span>
         <span class="k">const</span> <span class="k">union</span> <span class="n">nf_inet_addr</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">dport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
         <span class="k">struct</span> <span class="n">ip_vs_dest</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">fwmark</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿æ¥åˆ›å»ºæ­¥éª¤ï¼š</p>
<ol>
  <li>åˆ†é… <code class="language-plaintext highlighter-rouge">è¿æ¥</code> æ‰€éœ€è¦çš„å†…å­˜èµ„æºç©ºé—´</li>
  <li>åˆå§‹åŒ–é“¾è¡¨ç›¸å…³å­—æ®µ</li>
  <li>è®¾ç½®æ³¨å†Œå®šæ—¶å™¨å·¥ä½œå‡½æ•°</li>
  <li>å¡«å……æ ¸å¿ƒå…³é”®å­—æ®µ</li>
  <li>å…³è”ç»‘å®šè°ƒåº¦åˆ°çš„åç«¯ RS æœåŠ¡å™¨</li>
  <li>åˆå§‹åŒ–çŠ¶æ€ã€è¶…æ—¶æ—¶é—´ã€ç»‘å®š xmit å‡½æ•°</li>
  <li>å‡†å¤‡å°±ç»ªï¼Œå°† new_conn æŒ‚å†å…¨å±€çš„å“ˆå¸Œè¡¨ä¸Š</li>
</ol>

<p>åç»­çš„æ•°æ®åŒ…å°±å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">æ ‡è¯†å‚æ•°</code> æŸ¥æ‰¾<strong>è¿æ¥è¡¨</strong>ã€‚ æ‰¾åˆ°æ”¹æ•°æ®åŒ…æ‰€å±çš„è¿æ¥ä¿¡æ¯ï¼Œä¹Ÿå°±èƒ½ç¡®å®šæœ¬æ¬¡æ•°æ®åŒ…éœ€è¦è½¬å‘ç»™åç«¯å†…çš„é‚£ä¸€å° RS æœåŠ¡å™¨ï¼Œ
é€šè¿‡ç›¸å…³æ“ä½œåå°†æ•°æ®åŒ…è½¬å‘ç»™è¿æ¥æ‰€å¯¹åº”çš„ ç›®æ ‡æœåŠ¡å™¨ã€‚</p>

<p>å¦‚æœä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DR æ¨¡å¼</code> ï¼Œåªæœ‰å®¢æˆ·ç«¯è¯·æ±‚çš„æµé‡ä¼šç»è¿‡ LVS æœåŠ¡å™¨ï¼Œæ•°æ®åŒ…åˆ°è¾¾ LVS ä¼šè§¦å‘ä¸‹é¢çš„å‡½æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ip_vs_conn_param</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">netns_ipvs</span>   <span class="o">*</span><span class="n">ipvs</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">union</span> <span class="n">nf_inet_addr</span>  <span class="o">*</span><span class="n">caddr</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">union</span> <span class="n">nf_inet_addr</span>  <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
  <span class="n">__be16</span>        <span class="n">cport</span><span class="p">;</span>
  <span class="n">__be16</span>        <span class="n">vport</span><span class="p">;</span>
  <span class="n">__u16</span>       <span class="n">protocol</span><span class="p">;</span>
  <span class="n">u16</span>       <span class="n">af</span><span class="p">;</span>

  <span class="k">const</span> <span class="k">struct</span> <span class="n">ip_vs_pe</span>   <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
  <span class="kt">char</span>        <span class="o">*</span><span class="n">pe_data</span><span class="p">;</span>
  <span class="n">__u8</span>        <span class="n">pe_data_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="nf">ip_vs_conn_in_get</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ip_vs_conn_param</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>


<span class="c1">// æŸ¥æ‰¾è¡¨è¾¾å¼</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span>
<span class="n">__ip_vs_conn_in_get</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ip_vs_conn_param</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">ip_vs_conn</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
  <span class="c1">// è·å–hash</span>
  <span class="n">hash</span> <span class="o">=</span> <span class="n">ip_vs_conn_hashkey_param</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

  <span class="n">rcu_read_lock</span><span class="p">();</span>
  <span class="c1">// æ ¹æ®hash æŸ¥æ‰¾é“¾è¡¨æ¡¶</span>
  <span class="n">hlist_for_each_entry_rcu</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip_vs_conn_tab</span><span class="p">[</span><span class="n">hash</span><span class="p">],</span> <span class="n">c_list</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cport</span> <span class="o">==</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">cport</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">==</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">&amp;&amp;</span>
        <span class="n">cp</span><span class="o">-&gt;</span><span class="n">af</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">af</span> <span class="o">&amp;&amp;</span>
        <span class="n">ip_vs_addr_equal</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">caddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">caddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">ip_vs_addr_equal</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">af</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">((</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cport</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IP_VS_CONN_F_NO_CPORT</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
        <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ipvs</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ipvs</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ip_vs_conn_get</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="cm">/* HIT */</span>
      <span class="n">rcu_read_unlock</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">rcu_read_unlock</span><span class="p">();</span>

  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<ol>
  <li>é€šè¿‡ç»™å®šå‚æ•°è·å– hash å€¼ï¼Œæ ¹æ®å“ˆå¸Œå€¼è·å–é“¾è¡¨æ•°æ®</li>
  <li>éå† <code class="language-plaintext highlighter-rouge">ip_vs_conn_tab[hash]</code> é“¾è¡¨æ•°æ®ï¼ŒæŸ¥æ‰¾é™¤çœŸå®çš„è¿æ¥</li>
</ol>

<p>å…³äºé”çš„é—®é¢˜ï¼š</p>

<p>æˆ‘ä»¬ç°åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„æœåŠ¡å™¨éƒ½æ˜¯å¤šæ ¸å¤„ç†å™¨ï¼Œåœ¨ lvs è½¬å‘å¤„ç†é€»è¾‘ä¸­éœ€è¦é¢‘ç¹çš„æŸ¥è¿æ¥è¡¨ï¼Œç”±äºè¿æ¥è¡¨æ˜¯å…¨å±€çš„ä¸€å¼ è¡¨ç»“æ„ï¼Œ
ç»å¤§éƒ¨åˆ†æ—¶é—´ N ä¸ª cpu ä¼šåŒæ—¶æ“ä½œï¼ˆåŒ…æ‹¬æŸ¥æ‰¾ã€æ–°å»ºå’Œåˆ é™¤ï¼‰è¿æ¥è¡¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´è¿æ¥è¡¨ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å› æ­¤ï¼Œæ¯ä¸ª cpu 
å¯¹è¿æ¥è¡¨è¿›è¡Œç›¸å…³æ“ä½œæ—¶éœ€è¦åŠ ä¸Šç›¸åº”çš„ <strong><code class="language-plaintext highlighter-rouge">ReadLock æˆ– WriteLock</code></strong>ï¼Œæ‰èƒ½ä¿è¯è¿æ¥è¡¨çš„åŸå­æ€§æ“ä½œã€‚</p>

<ul>
  <li>
    <p><strong>å…¨å±€é”æ“ä½œ</strong>ã€‚å‡å¦‚æˆ‘ä»¬ä¸ºè¿æ¥è¡¨å®šä¹‰ä¸€ä¸ªå…¨å±€é”ï¼Œæ¯ä¸ª cpu åœ¨å¯¹è¿æ¥è¡¨åšè¯»å†™æ“ä½œæ—¶ï¼Œ
éƒ½éœ€è¦å…ˆåŠ é”ï¼Œè·å–é”åè¿›è¡Œç›¸å…³æ“ä½œï¼Œæ“ä½œå®Œæ¯•å†é‡Šæ”¾é”èµ„æºã€‚è¿™æ ·åœ¨é«˜å¹¶å‘çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œ
åŒä¸€æ—¶åˆ»é”åªèƒ½è¢«ä¸€ä¸ª cpu å ç”¨ï¼Œå› æ­¤å„ cpu ä¹‹é—´å¯¹é”çš„ç«äº‰ä¼šéå¸¸ä¸¥é‡ï¼Œå¯¼è‡´æ•´ä½“ lvs æ€§èƒ½ä¼šéšç€ cpu ä¸ªæ•°å¢åŠ è€Œé€æ¸ä¸‹é™ã€‚</p>
  </li>
  <li>
    <p><strong>å±€éƒ¨é”ä¼˜åŒ–</strong>ã€‚lvs åœ¨è®¾è®¡ä¸Šæ²¡æœ‰ä½¿ç”¨å…¨å±€çš„é”ï¼Œè€Œæ˜¯æ ¹æ®è¿æ¥è¡¨çš„å“ˆå¸Œç»“æ„ï¼Œä¸º N ä¸ªå“ˆå¸Œæ¡¶è®¾ç½®ä¸€ä¸ª Lockï¼Œè¿™é‡Œçš„ N ä¸º 256ï¼Œ
ä¹Ÿå°±æ˜¯ 256 ä¸ªæ¡¶ä½¿ç”¨ä¸€ä¸ªé”ï¼Œæ€»å…±æœ‰ 4096 ä¸ªå“ˆå¸Œæ¡¶ã€‚å¦‚æœæœ‰ 16 ä¸ª cpu çš„è¯ï¼Œé‚£ä¹ˆåŒä¸€æ—¶é—´å†…å¹³å‡æ¯ä¸ª cpu éƒ½å¯èƒ½å æœ‰ä¸€ä¸ªé”ï¼Œ
ä»ç³»ç»Ÿæ•´ä½“ä¸Šçœ‹ï¼Œcpu å¯¹é”æ“ä½œçš„ç«äº‰å°±ä¼šå¤§å¤§å‡å¼±ï¼Œæé«˜äº†ç³»ç»Ÿæ•´ä½“çš„è½¬å‘èƒ½åŠ›ã€‚</p>
  </li>
  <li>
    <p><strong>ä¸ºæ¯ä¸ªæ¡¶ç»‘å®šä¸€ä¸ªé”ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–</strong>ã€‚å±€éƒ¨ä¼˜åŒ–èƒ½å¤Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼ŒåŒæ ·æ€è·¯ï¼Œç³»ç»Ÿèµ„æºå…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯
ä¸ªå“ˆå¸Œæ¡¶åˆ†é…è®¾ç½®ä¸€ä¸ª â€œé”â€ï¼Œé‚£ä¹ˆå„ cpu ä¹‹é—´é”ç«äº‰å°±ä¼šå˜å¾—æ›´å°å•¦ï¼Œç³»ç»Ÿæ€§èƒ½è‚¯å®šä¼šæœ‰æ›´å¥½åœ°ä¼˜åŒ–ã€‚</p>
  </li>
  <li>
    <p><strong>æ— é”åŒ–ï¼Œæ¯ä¸ª cpu ä¸€å¼ è¿æ¥è¡¨</strong>ã€‚æ—¢ç„¶æ¯ä¸ª cpu éƒ½è¦è®¿é—®è¿æ¥è¡¨ï¼Œä¸”ä¼šå¼•èµ·é”çš„ç«äº‰æ¶åŒ–ï¼Œä¸ºä½•ä¸ç»™æ¯ä¸ª cpu ç»´æŠ¤ä¸€å¼ è¿æ¥è¡¨ï¼Œ
æ¯ä¸ª cpu åªç»´æŠ¤è‡ªå·±ç›¸å…³æ•°æ®è¿æ¥ç»„æˆçš„è¿æ¥è¡¨ï¼Œæ¯ä¸ª cpu è¯»å†™ è¿æ¥è¡¨æ—¶äº’ä¸å¹²æ‰°ï¼Œè¿™æ ·å°±å®ç°æ— é”åŒ–ï¼Œå®Œç¾çš„é¿å¼€äº†é”ã€‚</p>
    <ul>
      <li>æ¯ä¸ª cpu ä¸€å¼ è¿æ¥è¡¨</li>
      <li>ç½‘å¡æŒ‰ç…§ 4 å…ƒç»„å“ˆå¸Œï¼ŒåŒä¸€ä¸ªæ•°æ®æµè‚¯å®šä¼šæ‰“åˆ°åŒä¸€ä¸ª cpu ä¸Šå»</li>
      <li><em>å¯¹äº NAT æ¨¡å¼æ¥è¯´ï¼Œå°±æ¯”è¾ƒéº»çƒ¦ä¸å¥½å¤„ç†</em>
  ä¸»è¦åŸå› ï¼š NAT å›åŒ…è¿˜ä¼šç»è¿‡ lvsï¼Œå›åŒ…åˆ°è¾¾ lvs ç½‘å¡æ—¶ï¼ŒæŒ‰ç…§ 4 å…ƒå“ˆå¸Œåï¼Œæ•°æ®åŒ…å¯èƒ½åˆ°è¾¾ç½‘å¡é˜Ÿåˆ— 2 äº†ï¼Œ
  è€Œè¿‘æ¥çš„è¯·æ±‚æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡é˜Ÿåˆ— 1 äº†ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªè¿æ¥çš„æ•°æ®åŒ…ä¸åœ¨åŒä¸ª cpu ä¸Šå°±ä¼šå‡ºç°å¼‚å¸¸ç°è±¡äº†ï¼Œ
  å› ä¸ºå›åŒ…åˆ°è¾¾çš„ cpu æ— æ³•å¤„ç†è¯¥æ•°æ®åŒ…</li>
    </ul>
  </li>
</ul>

<p>æ€»ç»“ï¼šæ€»ä½“æ¥è¯´ conntrack çŠ¶æ€ç»´æŠ¤æœ€åŸºç¡€é€šè¿‡äº”å…ƒç»„æ¥å®Œæˆã€‚å°†ä¸€ä¸ª TCP å†…çš„æµé‡æ‰“åˆ°åŒä¸€å°æœºå™¨ï¼Œä¸åŒæ¬¡çš„è¯·æ±‚ä¹ŸåŒæ ·ä¼š
æ‰“åˆ°åŒä¸€å°ï¼Œåˆå§‹æ„Ÿè§‰ä¸åˆç†ï¼Œå¯èƒ½å’Œæ€ç»´å®šä½åœ¨ L7 æœ‰å…³ç³»ã€‚å°†æ¯æ¬¡è¯·æ±‚éƒ½è½¬å‘è‡³ä¸åŒ RS ä¸Šï¼Œä½†æ˜¯ç›¸å¯¹ L4 å±‚ï¼Œæ¯ä¸ªè¿æ¥å°±æ˜¯æ¯æ¬¡
è¯·æ±‚ï¼Œé€šè¿‡ä¸¤ä¸ªäº”å…ƒç»„å†³å®šè½¬å‘æ–¹å‘å’Œè½¬å‘ç›®æ ‡ã€‚ä¹Ÿä¸ä¼šå½±å“åˆ°æµé‡ã€‚
è€ƒè™‘ï¼šä¼˜åŒ–å¦‚æœæ¯æ¬¡æŠ¥æ–‡å‘é€éƒ½æ˜¯è¿ç»­æ€§çš„</p>

<h1 id="æºç åˆ†æ">æºç åˆ†æ</h1>

<p>æ€»ç»“ä¸‹æ¥ LVS ä¾ç„¶æ˜¯åœ¨ netfilter ä¸Šå±•å¼€çš„ï¼Œä½†æ˜¯ç›¸å¯¹äº LVS æ¥è¯´æ ¸å¿ƒæ¦‚å¿µä¸»è¦æ¶‰åŠè¿æ¥è¡¨å’Œè°ƒåº¦ç®—æ³•ã€‚å®ƒä»¬æ˜¯ LVS çš„æ ¸å¿ƒå†…å®¹</p>

<p>netfilter çš„ HOOK ç‚¹å¯¹åº”äºå†…æ ¸ä¸­çš„æ–¹æ³•ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">NF_INET_PRE_ROUTING</code> è¿™æ˜¯æ‰€æœ‰å…¥æ ˆæ•°æ®åŒ…çš„ç¬¬ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼ŒæŒ‚è½½ç‚¹ä½äº <code class="language-plaintext highlighter-rouge">ip_rcv</code> ä¸­ï¼Œv6 çš„æ˜¯ <code class="language-plaintext highlighter-rouge">ip6_rcf</code></li>
  <li><code class="language-plaintext highlighter-rouge">NF_INET_LOCAL_IN</code> å¯¹äºæ‰€æœ‰å‘é€åˆ°å½“å‰ä¸»æœºçš„å…¥æ ˆæ•°æ®åŒ…ï¼Œç»è¿‡æŒ‚è½½ç‚¹ <code class="language-plaintext highlighter-rouge">NF_INET_PRE_ROUTING</code> å¹¶æ‰§è¡Œè·¯ç”±é€‰æ‹©ï¼ŒæŒ‚è½½ç‚¹ä½äºæ–¹æ³• <code class="language-plaintext highlighter-rouge">ip_local_deliver</code> ä¸­</li>
  <li><code class="language-plaintext highlighter-rouge">NF_INET_FORWARD</code> å¯¹äºæ‰€æœ‰è½¬å‘çš„æ•°æ®åŒ…ï¼Œç»è¿‡æŒ‚è½½ç‚¹ <code class="language-plaintext highlighter-rouge">NF_INET_PRE_ROUTING</code> å¹¶æ‰§è¡Œè·¯ç”±é€‰æ‹©å­ç³»ç»ŸæŸ¥æ‰¾åã€‚æŒ‚è½½ç‚¹ä½äº <code class="language-plaintext highlighter-rouge">ip_forward</code> ä¸­</li>
  <li><code class="language-plaintext highlighter-rouge">NF_INET_POST_ROUTING</code> æ‰€æœ‰è¦è½¬å‘çš„æ•°æ®åŒ…å’Œå½“å‰ä¸»æœºç”Ÿæˆçš„æ•°æ®åŒ…éƒ½ç»è¿‡è¿™ä¸ªæŒ‚è½½ç‚¹ï¼ŒæŒ‚è½½ç‚¹ä½äº <code class="language-plaintext highlighter-rouge">ip_output</code> ä¸­</li>
  <li><code class="language-plaintext highlighter-rouge">NF_INET_LOCAL_OUT</code> å½“å‰ä¸»æœºç”Ÿæˆçš„æ‰€æœ‰å‡ºæˆ˜æ•°æ®åŒ…éƒ½ç»è¿‡è¿™ä¸ªæŒ‚è½½ç‚¹ï¼ŒæŒ‚è½½ç‚¹ä½äºæ–¹æ³• <code class="language-plaintext highlighter-rouge">__ip_local_out</code> ä¸­</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nf_hook_ops</span> <span class="n">ip_vs_ops4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="cm">/* åŒ…è¿‡æ»¤åï¼Œåªæ›´æ”¹VS/NATçš„ source */</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">hook</span>   <span class="o">=</span> <span class="n">ip_vs_reply4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pf</span>   <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hooknum</span>  <span class="o">=</span> <span class="n">NF_INET_LOCAL_IN</span><span class="p">,</span>
    <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_NAT_SRC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="cm">/* åŒ…è¿‡æ»¤åï¼Œé€šè¿‡VS/DRã€VS/TUNæˆ–VS/NAT(change destination)è½¬å‘åŒ…ï¼Œ
   * è¿™æ ·è¿‡æ»¤è§„åˆ™å°±å¯ä»¥åº”ç”¨äºIPVSã€‚ */</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">hook</span>   <span class="o">=</span> <span class="n">ip_vs_remote_request4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pf</span>   <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hooknum</span>  <span class="o">=</span> <span class="n">NF_INET_LOCAL_IN</span><span class="p">,</span>
    <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_NAT_SRC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="cm">/* åœ¨ ip_vs_in ä¹‹å‰ï¼Œåªä¸º VS/NAT æ›´æ”¹source */</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">hook</span>   <span class="o">=</span> <span class="n">ip_vs_local_reply4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pf</span>   <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hooknum</span>  <span class="o">=</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_NAT_DST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="cm">/* åœ¨ mangle ä¹‹åï¼Œè°ƒåº¦å’Œè½¬å‘æœ¬åœ°è¯·æ±‚ */</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">hook</span>   <span class="o">=</span> <span class="n">ip_vs_local_request4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pf</span>   <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hooknum</span>  <span class="o">=</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NF_IP_PRI_NAT_DST</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="cm">/* åœ¨åŒ…è¿‡æ»¤ä¹‹åï¼ˆä½†åœ¨ ip_vs_out_icmp ä¹‹å‰ï¼‰ï¼Œ
  *  æ•è·å‘å¾€ 0.0.0.0/0 çš„ icmpï¼Œç”¨äºä¼ å…¥çš„ IPVS è¿æ¥ */</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">hook</span>   <span class="o">=</span> <span class="n">ip_vs_forward_icmp</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pf</span>   <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hooknum</span>  <span class="o">=</span> <span class="n">NF_INET_FORWARD</span><span class="p">,</span>
    <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="cm">/* åŒ…è¿‡æ»¤åï¼Œåªæ›´æ”¹VS/NATçš„ source */</span>
  <span class="p">{</span>
    <span class="p">.</span><span class="n">hook</span>   <span class="o">=</span> <span class="n">ip_vs_reply4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pf</span>   <span class="o">=</span> <span class="n">NFPROTO_IPV4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hooknum</span>  <span class="o">=</span> <span class="n">NF_INET_FORWARD</span><span class="p">,</span>
    <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„ hook å‡½æ•°æ˜¯ <code class="language-plaintext highlighter-rouge">ip_vs_in</code> æ˜¯æ•°æ®åŒ…çš„å…¥å£ä½ç½®ã€‚ä»ä¸Šè¾¹æ³¨å†Œä»£ç æ®µä¸­ï¼Œå¯ä»¥çŸ¥é“å®ƒæ³¨å†Œçš„æŒ‚è½½ç‚¹ä½ç½®æ˜¯ <code class="language-plaintext highlighter-rouge">NF_INET_LOCAL_IN</code> å·²ç»é€šè¿‡äº†
prerouting å’Œ filter è·¯ç”±æŸ¥æ‰¾çš„è¿‡ç¨‹ã€‚
å‡è®¾åœ¨ DR æ¨¡å¼ä¸‹ï¼Œæ•°æ®åŒ…è½¬å‘å°†ä¼šç»è¿‡å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">[pp = ip_vs_proto_get(iph.protocol);](https://elixir.bootlin.com/linux/v5.11.2/source/net/netfilter/xt_ipvs.c#L81)</code> æŸ¥æ‰¾æ˜¯å¦æ˜¯ LVS æ‰€æ”¯æŒçš„åè®®
lvs æ‰€æ”¯æŒã€‚lvs èƒ½å¤Ÿæ”¯æŒ tcpã€udpã€ahã€esp åè®®ï¼Œå¦‚æœä¸æ˜¯ LVS  æ‰€æ”¯æŒçš„åè®®ï¼Œé‚£ä¹ˆå°†ç›´æ¥è¿”å› NF_ACCEPT ä¹Ÿå°±æ²¡æœ‰ç»§ç»­æ‰§è¡Œä¸‹å»çš„æ„ä¹‰äº†</li>
  <li>è°ƒåº¦å¹¶æ–°å»ºè¿æ¥ä¿¡æ¯ 
  æ ¹æ®æ•°æ®åŒ… 5 å…ƒç»„ç›¸å…³å­—æ®µè¿›è¡ŒæŸ¥æ‰¾ <code class="language-plaintext highlighter-rouge">conn_in_get</code>ï¼Œè¿™é‡Œå‡è®¾æ˜¯ä¸€ä¸ªæ–°è¿æ¥çš„è¯·æ±‚æ•°æ®åŒ…ï¼Œé‚£ä¹ˆåœ¨è¿æ¥è¡¨ä¸­æ˜¯æŸ¥ä¸åˆ°è¿æ¥è¡¨é¡¹ï¼Œå°†ä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">conn_schedule</code> æ–°å»ºè¡¨é¡¹
  æ–°å»ºè¡¨ç°çš„æ¡ä»¶ï¼š
    <ul>
      <li>æ•°æ®åŒ…å¿…é¡»æºå¸¦ SYN æ ‡è®°</li>
      <li>æ•°æ®åŒ…æ‰€è®¿é—®è¯·æ±‚å¿…é¡»æ˜¯æˆ‘ä»¬å®šä¹‰çš„ service æ‰è¡Œ
  æ»¡è¶³ä¸Šè¿°æ¡ä»¶ä¹‹åï¼Œä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">ip_vs_schedule</code> æ–¹æ³•ï¼Œä» svc æŒ‡å‘çš„ dests ä¸­æ›´å…·è°ƒåº¦ç®—æ³•é€‰å‡ºä¸€ä¸ªåˆé€‚çš„åç«¯æœåŠ¡å™¨</li>
    </ul>
  </li>
  <li>åœ¨æˆåŠŸè°ƒåº¦ dest åï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">ip_vs_conn_new</code> å‡½æ•°æ¥å¸¸è§çœŸæ­£çš„è¿æ¥æ¡ç›®ï¼š
    <ul>
      <li>åˆ†é… cp å†…å­˜èµ„æº</li>
      <li>è®¾ç½®å®šæ—¶å™¨</li>
      <li>å¡«å……ç›¸å…³å­—æ®µ</li>
      <li>ç»‘å®šå¹¶è®¾ç½® dest ç›¸å…³ä¿¡æ¯ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">ip_vs_bind_dest</code> å‡½æ•°</li>
      <li>ç»‘å®š conn æ‰€éœ€çš„ xmit å‡½æ•°ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">ip_vs_bind_xmit</code> å‡½æ•°</li>
      <li>å°† cp è¿æ¥æ¡ç›® hash åˆ°å…¨å±€çš„è¿æ¥è¡¨ä¸­</li>
    </ul>
  </li>
</ol>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_app</span><span class="p">.</span><span class="n">c</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_conn</span><span class="p">.</span><span class="n">c</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_core</span><span class="p">.</span><span class="n">c</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_ctl</span><span class="p">.</span><span class="n">c</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_dh</span><span class="p">.</span><span class="n">c</span>         <span class="err">ç›®çš„åœ°å€å“ˆå¸Œè°ƒåº¦</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_est</span><span class="p">.</span><span class="n">c</span>        <span class="err">ç®€å•çš„é€Ÿç‡ä¼°è®¡</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_fo</span><span class="p">.</span><span class="n">c</span>         <span class="err">æ·»åŠ äº†åŸºäºæƒé‡çš„åˆå§‹åŠŸèƒ½</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_ftp</span><span class="p">.</span><span class="n">c</span>        <span class="n">ftp</span><span class="err">åº”ç”¨æ¨¡å—</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_lblc</span><span class="p">.</span><span class="n">c</span>           <span class="err">åŸºäºå±€éƒ¨æ€§çš„æœ€å°‘è¿æ¥</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_lblcr</span><span class="p">.</span><span class="n">c</span>      <span class="err">å¸¦å¤åˆ¶çš„åŸºäºå±€éƒ¨æ€§æœ€å°‘é“¾æ¥</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_lc</span><span class="p">.</span><span class="n">c</span>         <span class="err">æœ€å°‘è¿æ¥è°ƒåº¦</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_mh</span><span class="p">.</span><span class="n">c</span>         <span class="err">ç£æ‚¬æµ®å“ˆå¸Œè°ƒåº¦æ¨¡å—</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_nfct</span><span class="p">.</span><span class="n">c</span>       <span class="err">æ”¯æŒ</span><span class="n">IPVS</span><span class="err">çš„</span><span class="n">Netfilter</span><span class="err">è¿æ¥è·Ÿè¸ª</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_nq</span><span class="p">.</span><span class="n">c</span>         <span class="err">æ°¸ä¸æ’é˜Ÿè°ƒåº¦ç®—æ³•</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_ovf</span><span class="p">.</span><span class="n">c</span>        <span class="err">æº¢å‡ºè¿æ¥è°ƒåº¦æ¨¡å—</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_pe</span><span class="p">.</span><span class="n">c</span>         <span class="err">æŒä¹…åŒ–æ¨¡å—</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_pe_sip</span><span class="p">.</span><span class="n">c</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_proto</span><span class="p">.</span><span class="n">c</span>      <span class="n">transport</span><span class="err">åè®®æ”¯æŒ</span><span class="n">ipv4</span><span class="err">è´Ÿè½½å‡è¡¡</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_proto_ah_esp</span><span class="p">.</span><span class="n">c</span>   <span class="err">é’ˆå¯¹</span><span class="n">IPV</span><span class="err">çš„</span><span class="n">AH</span><span class="o">/</span><span class="n">ESP</span> <span class="n">IPSec</span><span class="err">è´Ÿè½½å¹³è¡¡æ”¯æŒ</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_proto_tcp</span><span class="p">.</span><span class="n">c</span>      <span class="n">IPVS</span><span class="err">çš„</span><span class="n">TCP</span><span class="err">è´Ÿè½½å¹³è¡¡æ”¯æŒ</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_proto_udp</span><span class="p">.</span><span class="n">c</span>    <span class="n">IPVS</span><span class="err">çš„</span><span class="n">UDP</span><span class="err">è´Ÿè½½å¹³è¡¡æ”¯æŒ</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_rr</span><span class="p">.</span><span class="n">c</span>           <span class="err">è½®è¯¢è°ƒåº¦ç®—æ³•</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_sched</span><span class="p">.</span><span class="n">c</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_sed</span><span class="p">.</span><span class="n">c</span>          <span class="err">æœ€å°‘æœŸæœ›å»¶è¿Ÿè°ƒåº¦ç®—æ³•</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_sh</span><span class="p">.</span><span class="n">c</span>           <span class="err">æºåœ°å€å“ˆå¸Œè°ƒåº¦</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_sync</span><span class="p">.</span><span class="n">c</span>       
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_wlc</span><span class="p">.</span><span class="n">c</span>          <span class="err">åŠ æƒæœ€å°‘è¿æ¥</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_wrr</span><span class="p">.</span><span class="n">c</span>          <span class="err">åŠ æƒè½®è¯¢è°ƒåº¦</span>
<span class="n">net</span><span class="o">/</span><span class="n">netfilter</span><span class="o">/</span><span class="n">ipvs</span><span class="o">/</span><span class="n">ip_vs_xmit</span><span class="p">.</span><span class="n">c</span>
</code></pre></div></div>
<p><a href="https://elixir.bootlin.com/linux/v5.11.2/C/ident/KMSG_COMPONENT">KMSG_COMPONENT</a></p>

:ET