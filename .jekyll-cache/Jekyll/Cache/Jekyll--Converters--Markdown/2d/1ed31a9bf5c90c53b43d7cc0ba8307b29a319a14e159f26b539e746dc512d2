I"ôe<h1 id="libbpf-co-re-åŸç†">libbpf CO-RE åŸç†</h1>

<p>libbpf CO-RE åŸç†å°†è½¯ä»¶æ ˆæ‰€æœ‰å±‚æ¬¡ â€“ å†…æ ¸ã€ç”¨æˆ·ç©ºé—´ BPF Loaderåº“ã€ç¼–è¯‘å™¨ è¿›è¡Œäº†æŠ½è±¡å°†å¿…è¦çš„åŠŸèƒ½ã€æ•°æ®æ®µæ•´åˆåˆ°äº†ä¸€èµ·ï¼Œæ¥é™ä½ç¼–å†™å¯ç§»æ¤æ€§ BPF ç¨‹åºçš„éš¾åº¦ã€‚</p>

<ol>
  <li>å†…æ ¸å±‚ï¼šå°† BPF ç¨‹åºç¼–è¯‘æˆ BTF å­—èŠ‚ç å…è®¸æ•è·å…³äºå†…æ ¸ã€BPF ç¨‹åºçš„ç±»å‹ã€ä»£ç ç­‰å…³é”®ä¿¡æ¯</li>
  <li>Clangä¸ºBPFç¨‹åºCä»£ç æä¾›äº†express the intentå’Œè®°å½•relocationä¿¡æ¯çš„æ‰‹æ®µ</li>
  <li>BPF Loader æ ¹æ®å†…æ ¸ç‰ˆæœ¬å¯¹ BTF è¿›è¡Œå‰ªè£ï¼Œè®©å…¶é€‚åˆäºå½“å‰å†…æ ¸ç‰ˆæœ¬è¿è¡Œ</li>
  <li>æ•´åˆå¤´æ–‡ä»¶ vlinux.h ï¼Œå°†æ‰€éœ€è¦çš„å¤§å¤šæ•°éƒ½æ–‡ä»¶åŠ è½½åˆ°æœŸï¼Œæ–¹ä¾¿ç¨‹åºç¼–è¯‘</li>
</ol>

<p>å®æˆ˜ï¼šbcc <code class="language-plaintext highlighter-rouge">http-parse-simple</code> è½¬  libbpf</p>

<p>è°ƒç ” bcc <code class="language-plaintext highlighter-rouge">http-parse-simple</code> åŠŸèƒ½ï¼š</p>

<p>eBPFåº”ç”¨ç¨‹åºï¼Œå®ƒè§£æHTTPåŒ…å¹¶æå–(å¹¶åœ¨å±å¹•ä¸Šæ‰“å°)GET/POSTè¯·æ±‚ä¸­åŒ…å«çš„URLã€‚</p>

<p>ä½¿ç”¨æ–¹å¼ï¼š
  $ sudo python http-parse-complete.py 
  GET /pipermail/iovisor-dev/ HTTP/1.1
  HTTP/1.1 200 OK
  GET /favicon.ico HTTP/1.1
  HTTP/1.1 404 Not Found
  GET /pipermail/iovisor-dev/2016-January/thread.html HTTP/1.1
  HTTP/1.1 200 OK
  GET /pipermail/iovisor-dev/2016-January/000046.html HTTP/1.1
  HTTP/1.1 200 OK</p>

<p>å®ç°æ–¹å¼
ä¸€ã€åˆ©ç”¨ BPF ä»£ç ï¼Œå°†æ•°æ®åŒ…å­˜å‚¨åˆ° Map
äºŒã€ç”¨æˆ·ç©ºé—´æ‰§è¡Œé¢å¤–çš„å¤„ç†</p>

<p>é¦–å…ˆä½¿ç”¨ BPF è¿‡æ»¤åŒ…å« HTTPã€GETã€POST ç­‰å­—ç¬¦ä¸² IP å’Œ TCP åŒ…ï¼Œä»¥åŠå±äºåŒä¸€ä¼šè¯çš„åç»­åŒ…ï¼Œå…·æœ‰ç›¸åŒå…ƒç»„æ•°æ®çš„ <code class="language-plaintext highlighter-rouge">ip.src,ip.dst,port.src,port.dst</code></p>

<p>ç¨‹åºä»¥ï¼š<code class="language-plaintext highlighter-rouge">PROG_TYPE_SOCKET_FILTER</code> æ–¹å¼åŠ è½½ï¼ŒåµŒå…¥åˆ° socket ä¸Šé¢ï¼Œç»‘å®šåˆ° eth0</p>

<p>åŒ¹é…çš„æŠ¥æ–‡è½¬å‘åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå…¶ä»–çš„å…¨éƒ¨åˆ é™¤æ‰</p>

<p>ç”¨æˆ·ç©ºé—´å°†è¿‡æ»¤å‡ºæ¥çš„æ•°æ®åŒ…å±äºåŒä¸€ä¼šè¯çš„è¿›è¡Œé‡æ–°ç»„è£…ã€‚</p>

<h1 id="xdp-åŒºåˆ«">XDP åŒºåˆ«</h1>
<p>åŸºäº libbpf å†™ XDPã€Socketã€tc ç›¸å…³æ¥å£ä¸å†™æ™®é€šçš„ tracepoints æ–¹å¼è¿˜ä¸å¤ªä¸€æ ·ï¼Œtracepoints è¢« libbpf å°è£…çš„æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯
XDP å°±éœ€è¦äº†è§£ä¸€ä¸‹åº•å±‚çš„æ–¹æ³•å’Œç³»ç»Ÿè°ƒç”¨
å¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
  <li>ç¼–è¯‘å†…æ ¸ BPF ç¨‹åº</li>
  <li>åŠ è½½æ–‡ä»¶</li>
  <li>å°† BPF attach åˆ°æŒ‡å®šè®¾å¤‡</li>
</ol>

<p>http_xdp.bpf.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* SPDX-License-Identifier: GPL-2.0 */</span>
<span class="cp">#include</span> <span class="cpf">"vmlinux.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"xdp"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">xdp_prog_simple</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"monitor xdp entry</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="n">_license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"license"</span><span class="p">)</span> <span class="o">=</span> <span class="s">"GPL"</span><span class="p">;</span>
</code></pre></div></div>
<p>æ‰§è¡Œç¼–è¯‘å‘½ä»¤:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-target</span> bpf <span class="nt">-D__TARGET_ARCH_x86</span> <span class="nt">-I</span>.output <span class="nt">-I</span>../../libbpf/include/uapi <span class="nt">-I</span>../../vmlinux/ <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/local/include <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/lib/llvm-11/lib/clang/11.1.0/include <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/include/x86_64-linux-gnu <span class="se">\</span>
<span class="nt">-idirafter</span> /usr/include <span class="se">\</span>
<span class="nt">-c</span> http_xdp.bpf.c <span class="se">\</span>
<span class="nt">-o</span> .output/http_xdp.bpf.o
</code></pre></div></div>

<p>ç”¨æˆ·ç©ºé—´ä»£ç </p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: (LGPL-2.1 OR BSD-2-Clause)</span>
<span class="cm">/* Copyright (c) 2020 Facebook */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;getopt.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;net/if.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/if_link.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">load_bpf_file</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">first_prog_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">bpf_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

  <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_prog_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">BPF_PROG_TYPE_XDP</span><span class="p">,</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="n">first_prog_fd</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERR: loading BPF-OBJ file(%s) (%d): %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">filename</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>
  <span class="p">}</span>
  

  <span class="k">return</span> <span class="n">first_prog_fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">xdp_attach</span><span class="p">(</span><span class="kt">int</span> <span class="n">ifindex</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">xdp_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prog_fd</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
  <span class="c1">// è®¾ç½® link fd</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span><span class="n">prog_fd</span><span class="p">,</span><span class="n">xdp_flags</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">xdp_flags</span> <span class="o">&amp;</span> <span class="n">XDP_FLAGS_UPDATE_IF_NOEXIST</span><span class="p">))</span> <span class="p">{</span>
    
    <span class="n">__u32</span> <span class="n">old_flags</span> <span class="o">=</span> <span class="n">xdp_flags</span><span class="p">;</span>

    <span class="n">xdp_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XDP_FLAGS_MODES</span><span class="p">;</span>
    <span class="n">xdp_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">old_flags</span> <span class="o">&amp;</span> <span class="n">XDP_FLAGS_SKB_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="n">XDP_FLAGS_DRV_MODE</span> <span class="o">:</span> <span class="n">XDP_FLAGS_SKB_MODE</span><span class="p">;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xdp_flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
      <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">prog_fd</span><span class="p">,</span> <span class="n">old_flags</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERR: "</span>
      <span class="s">"ifindex(%d) link set xdp fd failed (%d): %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">ifindex</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>

    <span class="k">switch</span> <span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">EBUSY</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"EBUSY</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">EEXIST</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"EEXIST</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">EOPNOTSUPP</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"EOPNOTSUPP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"default</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>



  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">bpf_prog_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">__u32</span> <span class="n">info_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
  
  <span class="c1">// æŒ‡å®š BPF ç¼–è¯‘æ–‡ä»¶ å’Œ è®¾å¤‡</span>
  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="s">"http_xdp.bpf.o"</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dev_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// eth0</span>
  <span class="n">__u32</span> <span class="n">xdp_flags</span> <span class="o">=</span> <span class="n">XDP_FLAGS_UPDATE_IF_NOEXIST</span> <span class="o">|</span> <span class="n">XDP_FLAGS_DRV_MODE</span><span class="p">;</span>

  <span class="c1">// åŠ è½½æ–‡ä»¶</span>
  <span class="kt">int</span> <span class="n">prog_fd</span> <span class="o">=</span> <span class="n">load_bpf_file</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">prog_fd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Load BPF %s Faile.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// attach æ–‡ä»¶</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">xdp_attach</span><span class="p">(</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">xdp_flags</span><span class="p">,</span> <span class="n">prog_fd</span><span class="p">);</span>
  <span class="c1">// é€€å‡º detach</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` "</span>
         <span class="s">"to see output of the BPF programs.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>


    <span class="k">for</span> <span class="p">(;;)</span>
  <span class="p">{</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ‰§è¡Œç¼–è¯‘å‘½ä»¤ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cc</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="n">output</span> <span class="o">-</span><span class="n">I</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">libbpf</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">vmlinux</span><span class="o">/</span> <span class="o">-</span><span class="n">c</span> <span class="n">http_xdp</span><span class="p">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">http_xdp</span><span class="p">.</span><span class="n">o</span>
<span class="n">cc</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">Wall</span> <span class="p">.</span><span class="o">/</span><span class="n">http_xdp</span><span class="p">.</span><span class="n">o</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vagrant</span><span class="o">/</span><span class="n">libbpf</span><span class="o">-</span><span class="n">bootstrap</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="p">.</span><span class="n">output</span><span class="o">/</span><span class="n">libbpf</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span><span class="n">lelf</span> <span class="o">-</span><span class="n">lz</span> <span class="o">-</span><span class="n">o</span> <span class="n">http_xdp</span>
</code></pre></div></div>

<p>ç„¶åè¿è¡Œ <code class="language-plaintext highlighter-rouge">http_xdp</code> å°±å¯ä»¥äº†ï¼Œé€šè¿‡å¦ä¸€ä¸ªå‘½ä»¤è¡Œå¯ä»¥çœ‹åˆ° xdp è¢«æ­£ç¡®åŠ è½½å¹¶è¿è¡Œã€‚</p>

<p>ä¸Šé¢çš„ç¨‹åºè¿è¡Œç›®å‰åªèƒ½ç›‘æ§åˆ° ingress æµé‡ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½ç›‘æ§åˆ°å…¥å£æµé‡ï¼Œä¸èƒ½ç›‘æ§åˆ°å‡ºå£æµé‡ï¼Œæ‰€ä»¥ä¸ºäº†ç›‘æ§åˆ°å‡ºå£æµé‡ï¼Œéœ€è¦é‡æ–°ç¼–å†™æ–°çš„ä¸€å¥—å·¥å…·åœ¨ tc å±‚åšæµé‡ç›‘æ§ã€‚</p>

<p>ä¸€å¼€å§‹å¯¹ tc æœ‰ç‚¹è¯¯è§£ï¼Œè®¤ä¸º filter &gt; class &gt; qdisc ï¼Œä½†æ˜¯é€šè¿‡æ–‡ç«  <a href="https://blog.csdn.net/wuruixn/article/details/8210760">ã€ŠLinux æµé‡æ§åˆ¶å·¥å…· TC è¯¦è§£ã€‹</a> 
äº†è§£çŸ¥é“ï¼Œæ–¹å‘æ°å¥½åè¿‡æ¥ã€‚ qdisc &gt; class &gt; filter</p>

<p>ä¸»è¦å…¥å£æµé‡åˆ†ä¸ºåˆ†ç±»é˜Ÿåˆ—å’Œæ— ç±»é˜Ÿåˆ—è§„å®šã€‚æ‰€ä»¥ tc å±‚æœ€æ—©æ¥å…¥æµé‡çš„åº”è¯¥æ˜¯åœ¨ qdisc å±‚ã€‚æœ‰ qdisc è§„å®šæ‰ä¼šè¡ç”Ÿå‡º classã€filterã€‚å¦‚æœæ—  qdisc å°±ä¸èƒ½åˆ›å»º classã€filter ä¹Ÿå°±æ˜¯ä¸èƒ½
ä½¿ç”¨ tc åŠ è½½ bpf ç¨‹åºã€‚</p>

<p>ç¼–å†™ BPF ç¨‹åºå¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: GPL-2.0 OR BSD-3-Clause</span>
<span class="cm">/* Copyright (c) 2020 Facebook */</span>

<span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_endian.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/tcp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/if_ether.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/pkt_cls.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">eth_hdr</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h_dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h_source</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">h_proto</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"ingress"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">tc_ingress</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// è·å–æ•°æ®ä½ç½®</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">data_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
            
            <span class="c1">// è·å– ç½‘å¡ header</span>
            <span class="k">struct</span> <span class="n">eth_hdr</span> <span class="o">*</span><span class="n">eth</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
            <span class="c1">// è·å– ip header</span>
            <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">);</span>
            <span class="c1">// è·å– tcp header</span>
            <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// åªå…³å¿ƒ IPv4 </span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">eth</span> <span class="o">&amp;&amp;</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">==</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
            <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// åªè¿‡æ»¤ TCP </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// åˆ¤æ–­æ•°æ®æ˜¯å¦å……è¶³</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">27</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// å¼€å§‹è¯»å–æŠ¥æ–‡ä¿¡æ¯</span>
                <span class="kt">char</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcp</span><span class="p">);</span>
                <span class="c1">// HTTP</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'H'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'P'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"HTTP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// GET </span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'G'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"GET</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// POST</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'P'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'O'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'S'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"POST</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// PUT</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'P'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'U'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"PUT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// DELETE</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'D'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'L'</span> 
                <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"DELETe</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">out:</span>
    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"egress"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">tc_egress</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="n">_license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"license"</span><span class="p">)</span> <span class="o">=</span> <span class="s">"GPL"</span><span class="p">;</span>
</code></pre></div></div>

<p>é€šè¿‡ä»¥ä¸‹ç¼–è¯‘å‘½ä»¤ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang <span class="nt">-O2</span> <span class="nt">-target</span> bpf <span class="nt">-D__TARGET_ARCH_x86</span> <span class="nt">-I</span>.output <span class="nt">-I</span>../../libbpf/include/uapi <span class="nt">-I</span>../../vmlinux/ <span class="nt">-idirafter</span> /usr/local/include <span class="nt">-idirafter</span> /usr/lib/llvm-11/lib/clang/11.1.0/include <span class="nt">-idirafter</span> /usr/include/x86_64-linux-gnu <span class="nt">-idirafter</span> /usr/include <span class="nt">-c</span> tc_http.bpf.c <span class="nt">-o</span> tc_http.bpf.o
</code></pre></div></div>

<p>é€šè¿‡å‘½ä»¤åŠ è½½ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>tc filter add dev eth0 ingress bpf da obj tc_http.bpf.o sec ingress
</code></pre></div></div>

<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¾“å‡ºï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cat</span> /sys/kernel/debug/tracing/trace_pipe
          &lt;idle&gt;-0       <span class="o">[</span>001] ..s. 90146.929668: 0: GET
          &lt;idle&gt;-0       <span class="o">[</span>001] ..s. 90209.748481: 0: GET
          &lt;idle&gt;-0       <span class="o">[</span>001] ..s. 90209.971206: 0: GET
          &lt;idle&gt;-0       <span class="o">[</span>001] ..s. 90210.146610: 0: GET
</code></pre></div></div>

<p>å¦‚æœä¸æ˜¯ç”¨ libbpf çš„è¯é‚£ä¹ˆå¯ä»¥ç”¨å‘½ä»¤è¡Œæ¥åŠ è½½ï¼Œä½†æ˜¯ libbpf å°†æ•´ä¸ªè¿‡ç¨‹ç®€åŒ–äº†å¾ˆå¤šä¸éœ€è¦è®°ä½è¿™ä¹ˆå¤šå‘½ä»¤å°±å¯ä»¥ç›´æ¥åŠ è½½åˆ° tc è§¦å‘è¿è¡Œã€‚æ‰€ä»¥éœ€è¦ç¼–å†™ç”¨æˆ·ç©ºé—´ä»£ç ã€‚</p>

<p>å…ˆäº†è§£ä¸‹å¦‚ä½•é€šè¿‡æŒ‡å®š section æ¥åŠ è½½ ebpf ç¨‹åºï¼š</p>

<p><code class="language-plaintext highlighter-rouge">sec_xdp.bpf.c</code></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"xdp_pass"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">xdp_pass_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdp_md</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"XDP_PASS ---------&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"xpd_drop"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">xdp_drop_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">xdp_md</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"XDP_DROP ---------&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="n">_license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"license"</span><span class="p">)</span> <span class="o">=</span> <span class="s">"GPL"</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sec_xdp.c</code> åŠ è½½ç¨‹åº</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;getopt.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;net/if.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/if_link.h&gt;</span><span class="c1"> </span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"common_defines.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">xdp_link_attach</span><span class="p">(</span><span class="kt">int</span> <span class="n">ifindex</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">xdp_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prog_fd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

  <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">prog_fd</span><span class="p">,</span> <span class="n">xdp_flags</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">xdp_flags</span> <span class="o">&amp;</span> <span class="n">XDP_FLAGS_UPDATE_IF_NOEXIST</span><span class="p">))</span> <span class="p">{</span>

    <span class="n">__u32</span> <span class="n">old_flags</span> <span class="o">=</span> <span class="n">xdp_flags</span><span class="p">;</span>

    <span class="n">xdp_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XDP_FLAGS_MODES</span><span class="p">;</span>
    <span class="n">xdp_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">old_flags</span> <span class="o">&amp;</span> <span class="n">XDP_FLAGS_SKB_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="n">XDP_FLAGS_DRV_MODE</span> <span class="o">:</span> <span class="n">XDP_FLAGS_SKB_MODE</span><span class="p">;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xdp_flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
      <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span> <span class="n">prog_fd</span><span class="p">,</span> <span class="n">old_flags</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERR: "</span>
      <span class="s">"ifindex(%d) link set xdp fd failed (%d): %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">ifindex</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>

    <span class="k">switch</span> <span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">EBUSY</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">EEXIST</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Hint: XDP already loaded on device"</span>
        <span class="s">" use --force to swap/replace</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">EOPNOTSUPP</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Hint: Native-XDP not supported"</span>
        <span class="s">" use --skb-mode or --auto-mode</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="s">"sec_xdp.bpf.o"</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">progsec</span> <span class="o">=</span> <span class="s">"xdp_pass"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">prog_fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">first_prog_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ifindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">bpf_object</span> <span class="o">*</span><span class="n">bpf_obj</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">bpf_program</span> <span class="o">*</span><span class="n">bpf_prog</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">xdp_flags</span> <span class="o">=</span> <span class="n">XDP_FLAGS_UPDATE_IF_NOEXIST</span> <span class="o">|</span> <span class="n">XDP_FLAGS_SKB_MODE</span><span class="p">;</span>

    <span class="c1">// define xdp attr</span>
    <span class="k">struct</span> <span class="n">bpf_prog_load_attr</span> <span class="n">prog_load_attr</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">prog_type</span> <span class="o">=</span> <span class="n">BPF_PROG_TYPE_XDP</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ifindex</span>   <span class="o">=</span> <span class="n">ifindex</span><span class="p">,</span>
  <span class="p">};</span>
    <span class="n">prog_load_attr</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"start load file %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">prog_load_attr</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>


    <span class="c1">// load xdp file</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_prog_load_xattr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prog_load_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bpf_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_prog_fd</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERR: loading BPF-OBJ file(%s) (%d): %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">filename</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// find section </span>
    <span class="n">bpf_prog</span> <span class="o">=</span> <span class="n">bpf_object__find_program_by_title</span><span class="p">(</span><span class="n">bpf_obj</span><span class="p">,</span> <span class="n">progsec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bpf_prog</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERR: finding progsec: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">progsec</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="c1">// è¯»å–æŒ‡ä»¤æ–‡ä»¶</span>
    <span class="n">prog_fd</span> <span class="o">=</span> <span class="n">bpf_program__fd</span><span class="p">(</span><span class="n">bpf_prog</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prog_fd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERR: bpf_program__fd failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
  <span class="p">}</span>    
    <span class="c1">// attach xdp file</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">xdp_link_attach</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">xdp_flags</span><span class="p">,</span> <span class="n">prog_fd</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">{</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">out:</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡è¿è¡Œ <code class="language-plaintext highlighter-rouge">sudo ./sec_xdp</code> å°±å¯ä»¥è§‚å¯Ÿåˆ° xdp ç¨‹åºå·²ç»æŒ‰ç…§ section å»åŠ è½½äº†ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> ./sec_xdp                   
start load file sec_xdp.bpf.o 
libbpf: elf: skipping unrecognized data section<span class="o">(</span>4<span class="o">)</span> .rodata.str1.1
<span class="nv">$ </span>ip addr|grep xdp
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 xdpgeneric/id:285 qdisc fq_codel state UP group default qlen 1000
<span class="nv">$ </span><span class="nb">sudo cat</span> /sys/kernel/debug/tracing/trace_pipe
          &lt;idle&gt;-0       <span class="o">[</span>001] ..s. 273632.203008: 0: XDP_PASS <span class="nt">---------</span><span class="o">&gt;</span>
          &lt;idle&gt;-0       <span class="o">[</span>001] ..s. 273632.203025: 0: XDP_PASS <span class="nt">---------</span><span class="o">&gt;</span>
</code></pre></div></div>
<p><strong><code class="language-plaintext highlighter-rouge">æœ‰ä¸ª ifindex å‚è€ƒå€¼ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ï¼Œè¦æŸ¥</code></strong></p>

<p>æ¥ä¸‹æ¥çœ‹ä¸‹å¦‚ä½•é€šè¿‡ libbpf å°†ç¨‹åºåŠ è½½åˆ° tc å±‚ï¼š</p>

<p>å…¬å…±éƒ¨åˆ† <code class="language-plaintext highlighter-rouge">tc_http_common.h</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef __TC_HTTP_COMMON
</span><span class="k">static</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">HTTP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">GET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">POST</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">PUT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">DELETE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>


<span class="k">struct</span> <span class="n">datarec</span> <span class="p">{</span>
    <span class="n">__u64</span> <span class="n">rx_packets</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>å†…æ ¸å¤„ç†éƒ¨åˆ†ï¼š <code class="language-plaintext highlighter-rouge">tc_http.bpf.c</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/bpf_endian.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/ip.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/tcp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/if_ether.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/pkt_cls.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"tc_http_common.h"</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">eth_hdr</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h_dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h_source</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">h_proto</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bpf_map_def</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"maps"</span><span class="p">)</span> <span class="n">request_map</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span>
    <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
    <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">datarec</span><span class="p">),</span>
    <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="mi">64435</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifndef lock_xadd
#define lock_xadd(ptr, val) ((void) __sync_fetch_and_add(ptr, val))
#endif
</span>
<span class="n">SEC</span><span class="p">(</span><span class="s">"classifier/read"</span><span class="p">)</span>
<span class="kt">int</span> <span class="nf">tc_ingress</span><span class="p">(</span><span class="k">struct</span> <span class="n">__sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>

    <span class="k">struct</span> <span class="n">datarec</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>    
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// è·å–æ•°æ®ä½ç½®</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">data_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
            
            <span class="c1">// è·å– ç½‘å¡ header</span>
            <span class="k">struct</span> <span class="n">eth_hdr</span> <span class="o">*</span><span class="n">eth</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
            <span class="c1">// è·å– ip header</span>
            <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">);</span>
            <span class="c1">// è·å– tcp header</span>
            <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// åªå…³å¿ƒ IPv4 </span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">eth</span> <span class="o">&amp;&amp;</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">==</span> <span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
            <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// åªè¿‡æ»¤ TCP </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// åˆ¤æ–­æ•°æ®æ˜¯å¦å……è¶³</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">27</span> <span class="o">&gt;</span> <span class="n">data_end</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// å¼€å§‹è¯»å–æŠ¥æ–‡ä¿¡æ¯</span>
                <span class="kt">char</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tcp</span><span class="p">);</span>
                <span class="c1">// HTTP</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'H'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'P'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_map</span><span class="p">,</span><span class="o">&amp;</span><span class="n">HTTP</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">rec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">lock_xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"HTTP NOT NULL  %lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// GET </span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'G'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_map</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GET</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">rec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">lock_xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"GET NOT NULL  %lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// POST</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'P'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'O'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'S'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_map</span><span class="p">,</span><span class="o">&amp;</span><span class="n">POST</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">rec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">lock_xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"POST NOT NULL  %lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// PUT</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'P'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'U'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_map</span><span class="p">,</span><span class="o">&amp;</span><span class="n">PUT</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">rec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">lock_xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"PUT NOT NULL  %lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// DELETE</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'D'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'L'</span> 
                <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'E'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_map</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DELETE</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">rec</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">lock_xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">bpf_printk</span><span class="p">(</span><span class="s">"DELETE NOT NULL  %lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">);</span>
                    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">out:</span>
    <span class="k">return</span> <span class="n">TC_ACT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="n">_license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"license"</span><span class="p">)</span> <span class="o">=</span> <span class="s">"GPL"</span><span class="p">;</span>
</code></pre></div></div>

<p>ç”¨æˆ·ç©ºé—´å¤„ç†å‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">tc_http.c</code></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;getopt.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;net/if.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/if_link.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"tc_http_common.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">load_bpf_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">find_map_value</span><span class="p">(</span><span class="kt">int</span> <span class="n">map_fd</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// æŸ¥ä¸‹å€¼</span>
    <span class="k">struct</span> <span class="n">datarec</span> <span class="n">rec</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">GET</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"GET %lld </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">PUT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"PUT %lld </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">POST</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"POST %lld </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">DELETE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"DELETE %lld </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"bpf_map_lookup_elem error %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="n">DECLARE_LIBBPF_OPTS</span><span class="p">(</span><span class="n">bpf_tc_hook</span><span class="p">,</span> <span class="n">hook</span><span class="p">,</span> <span class="p">.</span><span class="n">attach_point</span> <span class="o">=</span> <span class="n">BPF_TC_INGRESS</span><span class="p">);</span>
    <span class="n">DECLARE_LIBBPF_OPTS</span><span class="p">(</span><span class="n">bpf_tc_opts</span><span class="p">,</span> <span class="n">attach_pre</span><span class="p">);</span>
    <span class="n">DECLARE_LIBBPF_OPTS</span><span class="p">(</span><span class="n">bpf_tc_opts</span><span class="p">,</span> <span class="n">attach_post</span><span class="p">);</span>

    <span class="c1">// BPF ç¨‹åºåç§°</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="s">"tc_http.bpf.o"</span><span class="p">;</span>

    <span class="c1">// ç½‘å¡åç§°</span>
    <span class="kt">int</span> <span class="n">eth_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="c1">// é”™è¯¯ç </span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

    <span class="c1">// bpf map</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">map_name</span> <span class="o">=</span> <span class="s">"request_map"</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">map_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="c1">// open bpf file</span>
    <span class="k">struct</span> <span class="n">bpf_object</span> <span class="o">*</span><span class="n">bpf_fd</span> <span class="o">=</span> <span class="n">bpf_object__open</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">libbpf_get_error</span><span class="p">(</span><span class="n">bpf_fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Couldn't open file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// load bpf</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_object__load</span><span class="p">(</span><span class="n">bpf_fd</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"BPF Load Faile</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// read tc_ingress section</span>
    <span class="n">attach_pre</span><span class="p">.</span><span class="n">prog_fd</span> <span class="o">=</span> <span class="n">bpf_program__fd</span><span class="p">(</span><span class="n">bpf_object__find_program_by_name</span><span class="p">(</span><span class="n">bpf_fd</span><span class="p">,</span> <span class="s">"tc_ingress"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">attach_pre</span><span class="p">.</span><span class="n">prog_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Find BPF Section tc_ingress Fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hook</span><span class="p">.</span><span class="n">ifindex</span> <span class="o">=</span> <span class="n">eth_index</span><span class="p">;</span>
    <span class="c1">// åˆ›å»º hook ç‚¹  è®¾ç½®è§¦å‘ç‚¹</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_tc_hook_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hook</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Create Hook Fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// attach hook</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_tc_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hook</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attach_pre</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Attach Hook Fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` "</span>
           <span class="s">"to see output of the BPF programs.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// find map</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"find Map </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">map</span> <span class="o">=</span> <span class="n">bpf_object__find_map_by_name</span><span class="p">(</span><span class="n">bpf_fd</span><span class="p">,</span> <span class="n">map_name</span><span class="p">);</span>
    <span class="n">map_fd</span> <span class="o">=</span> <span class="n">bpf_map__fd</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">map_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"map read fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"start epoll</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">find_map_value</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span> <span class="n">GET</span><span class="p">);</span>
        <span class="n">find_map_value</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span> <span class="n">PUT</span><span class="p">);</span>
        <span class="n">find_map_value</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span> <span class="n">POST</span><span class="p">);</span>
        <span class="n">find_map_value</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n\n\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

<span class="nl">out:</span>
    <span class="n">bpf_object__close</span><span class="p">(</span><span class="n">bpf_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šå·²ç»å®Œæˆäº†ï¼Œlibbpf ç»Ÿè®¡ HTTP è¯·æ±‚éƒ¨åˆ†ã€‚ä¹Ÿå°±æ˜¯è¯´åŸºæœ¬å¯ä»¥è¯»å–åˆ° L7 çš„æ•°æ®äº†ã€‚</p>

<p>** ä¸‹ä¸€ç« çœ‹å¦‚ä½•ç›‘æ§ URL **</p>

<p>ç¼–å†™ä»£ç å’Œæµ‹è¯•æ—¶å¸¸ç”¨å‘½ä»¤ï¼š</p>

<p>clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I.output -I../../libbpf/include/uapi -I../../vmlinux/ <br />
-idirafter /usr/local/include <br />
-idirafter /usr/lib/llvm-11/lib/clang/11.1.0/include <br />
-idirafter /usr/include/x86_64-linux-gnu <br />
-idirafter /usr/include <br />
-c sec_xdp.bpf.c <br />
-o sec_xdp.bpf.o</p>

<p>cc -Wall -I../libbpf/src/build/usr/include/ -g -I../headers/ -L../libbpf/src/ -o xdp_loader ../common/common_params.o ../common/common_user_bpf_xdp.o  xdp_loader.c -l:libbpf.a -lelf</p>

<p>cc -g -Wall -I.output -I../../libbpf/include/uapi -I../../vmlinux/ -c sec_xdp.c -o .output/sec_xdp.o &amp;&amp; cc -g -Wall .output/sec_xdp.o /home/vagrant/libbpf-bootstrap/examples/c/.output/libbpf.a -lelf -lz -o sec_xdp</p>

<p>tc filter add dev eth0 ingress bpf da obj sec_xdp.bpf.o sec ingress</p>

<p>tc filter add dev eth0 ingress bpf da obj sec_xdp.bpf.o</p>

<p>sudo tc filter del dev eth0 ingress
sudo ip link set dev eth0 xdp off
sudo tc qdisc del dev eth0 clsact</p>

<p>sudo cat /sys/kernel/debug/tracing/trace_pipe</p>
:ET