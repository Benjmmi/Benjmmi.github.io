I"²<p>å†…æ ¸ä»£ç è™½ç„¶é˜…è¯»æ¯”è¾ƒå›°éš¾ï¼Œä½†æ˜¯ä¹Ÿå¾ˆæœ‰æŠ€å·§æ€§å¯è¨€ã€‚å…ˆäº†è§£åŸºæœ¬çš„æ•°æ®ç»“æ„å’Œè¿‡å¾€çš„ä¸€äº›çŸ¥è¯†ä¿¡æ¯æ•´ç†åŸºæœ¬ä¸Š
å‚è€ƒèµ„æ–™å°±å¯ä»¥äº†è§£æ•´ä¸ªå†…æ ¸è¿è¡Œçš„è¿‡ç¨‹ã€‚
è¿™é‡Œä¸»è¦ä¸ºäº†äº†è§£ç½‘ç»œæŠ€æœ¯å†…å¹•æ•°æ®éœ€è¦ä» <a href="https://elixir.bootlin.com/linux/v5.14/source/include/linux/skbuff.h#L720"><code class="language-plaintext highlighter-rouge">sk_buff</code></a> å¼€å§‹ï¼Œäº†è§£è¿™ä¸ªæ•°æ®ç»“æ„ä¸‹çš„ç»†ææœ«èŠ‚ã€‚å†…æ ¸ç‰ˆæœ¬</p>

<h1 id="sk_buff-æ•°æ®ç»“æ„"><code class="language-plaintext highlighter-rouge">sk_buff</code> æ•°æ®ç»“æ„</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">sk_buff</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="cm">/* These two members must be first. */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">next</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">prev</span><span class="p">;</span>

			<span class="k">union</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
				<span class="cm">/* Some protocols might use this space to store information,
				 * while device pointer would be NULL.
				 * UDP receive path is one user.
				 */</span>
				<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">dev_scratch</span><span class="p">;</span>
			<span class="p">};</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="n">rb_node</span>		<span class="n">rbnode</span><span class="p">;</span> <span class="cm">/* used in netem, ip4 defrag, and tcp stack */</span>
		<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="p">};</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sk_buff</code> çš„æƒ³è¦è¡¨è¾¾çš„å°±æ˜¯ <strong>socket bufffer</strong> ã€‚socket å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„å¥—æ¥å­—å·¥å…·ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">c</code> ä¸­å¯¹æ•°æ®ç»“æ„çš„è¦æ±‚æ˜¯å¾ˆä¸¥æ ¼çš„ç‰¹åˆ«æ˜¯åœ¨å¤§é¡¹ç›®ä¸­çš„å†…å­˜å¯¹é½ï¼Œå¼€å¤´å°±ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">union</code> è”åˆä½“ã€‚</p>

<p><strong>ç»“æ„ä½“(struct)</strong>ä¸­æ‰€æœ‰å˜é‡æ˜¯â€œå…±å­˜â€çš„â€”â€”ä¼˜ç‚¹æ˜¯â€œæœ‰å®¹ä¹ƒå¤§â€ï¼Œå…¨é¢ï¼›ç¼ºç‚¹æ˜¯structå†…å­˜ç©ºé—´çš„
åˆ†é…æ˜¯ç²—æ”¾çš„ï¼Œä¸ç®¡ç”¨ä¸ç”¨ï¼Œå…¨åˆ†é…ã€‚</p>

<p><strong>è”åˆä½“(union)</strong>ä¸­æ˜¯å„å˜é‡æ˜¯â€œäº’æ–¥â€çš„â€”â€”ç¼ºç‚¹å°±æ˜¯ä¸å¤Ÿâ€œåŒ…å®¹â€ï¼›ä½†ä¼˜ç‚¹æ˜¯å†…å­˜ä½¿ç”¨æ›´ä¸ºç²¾ç»†çµæ´»ï¼Œ
ä¹ŸèŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚<strong>ç‰¹ç‚¹ï¼šå…±ç”¨å†…å­˜é¦–åœ°å€ã€å†…å­˜åˆ†é…æŒ‰ç…§æœ€å¤§çš„å˜é‡åˆ†é…</strong></p>

<p>å‚è€ƒ:<a href="https://blog.csdn.net/liguangxianbin/article/details/80510669">ç»“æ„ä½“structå’Œè”åˆä½“unionæœ€å…¨è®²è§£
</a></p>

<p>è¿™é‡Œå†çœ‹ä¸‹ <code class="language-plaintext highlighter-rouge">rb_node	</code> å’Œ <code class="language-plaintext highlighter-rouge">list_head</code> ç»“æ„ä½“ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://elixir.bootlin.com/linux/v5.14/source/include/linux/rbtree.h#L24</span>
<span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">__rb_parent_color</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_left</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))));</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://elixir.bootlin.com/linux/v5.14/source/include/linux/types.h#L178</span>
<span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<p>é€šè¿‡å¯¹ <code class="language-plaintext highlighter-rouge">union</code> ä¸­çš„æ•´ä¸ªç»“æ„ä½“åˆ†æå¯ä»¥çœ‹è§æ•´ä¸ªæ•°æ®ç»“æ„çš„æœ€å¤§å ç”¨å†…å­˜ä¸º <code class="language-plaintext highlighter-rouge">ä¸¤ä¸ªæŒ‡é’ˆ+long å˜é‡é•¿åº¦</code></p>

<p>æŒ‡é’ˆçš„å ç”¨å†…å­˜å¤§å°æ˜¯è·Ÿéšç³»ç»Ÿå˜åŒ–çš„ï¼Œæ¯”å¦‚åœ¨ <code class="language-plaintext highlighter-rouge">32</code> ä½ç³»ç»Ÿä¸­å ç”¨ <code class="language-plaintext highlighter-rouge">4</code> å­—èŠ‚ï¼Œ<code class="language-plaintext highlighter-rouge">64</code> ä½ç³»ç»Ÿä¸­å  <code class="language-plaintext highlighter-rouge">8</code> å­—èŠ‚ã€‚
<code class="language-plaintext highlighter-rouge">long</code> ç±»å‹ <code class="language-plaintext highlighter-rouge">32</code> ä½ç³»ç»Ÿä¸­å ç”¨ <code class="language-plaintext highlighter-rouge">4</code> å­—èŠ‚ï¼Œ<code class="language-plaintext highlighter-rouge">64</code> ä½ç³»ç»Ÿä¸­å  <code class="language-plaintext highlighter-rouge">8</code> å­—èŠ‚
æŒ‰ç…§ <code class="language-plaintext highlighter-rouge">64</code> ä½ç³»ç»Ÿè®¡ç®—ï¼Œæœ€å¤šå ç”¨ <code class="language-plaintext highlighter-rouge">128</code>  å­—èŠ‚ã€‚</p>

:ET