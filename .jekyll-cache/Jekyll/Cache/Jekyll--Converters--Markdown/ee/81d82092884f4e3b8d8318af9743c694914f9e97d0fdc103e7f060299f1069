I"µb<h1 id="cat-ä½¿ç”¨-liburing-å®ç°">cat ä½¿ç”¨ liburing å®ç°</h1>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œç”¨io_uringæ„å»ºä¸€ä¸ªè¯»å–æ–‡ä»¶çš„ç¨‹åºè¿™ä¹ˆç®€å•çš„ä¸œè¥¿ï¼Œå¯èƒ½å¹¶ä¸é‚£ä¹ˆç®€å•ã€‚äº‹å®è¯æ˜ï¼Œä¸è¯»å–åŒæ­¥ i/o æ–‡ä»¶çš„ç¨‹åºç›¸æ¯”ï¼Œå®ƒçš„ä»£ç æ›´å¤šã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ åˆ†æä½¿ç”¨<a href="https://unixism.net/loti/low_level.html#low-level">åº•å±‚ io _ uring æ¥å£çš„ cat å®ç”¨ç¨‹åº</a>çš„ä»£ç ï¼Œä½ ä¼šå‘ç°å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯é‡å¤ä»£ç ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°éšè—åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œå®ƒåº”è¯¥ä¸ä¼šå‡ºç°åœ¨åº”ç”¨é€»è¾‘ã€‚æ— è®ºå¦‚ä½•ï¼Œæ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬å­¦ä¹ åº•å±‚çš„io_uringç»†èŠ‚æ˜¯ä¸ºäº†æ›´å¥½åœ°ç†è§£å®ƒçš„å·¥ä½œåŸç†ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ liburing å®ç°åŠŸèƒ½ç±»ä¼¼çš„ç¨‹åºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;liburing.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="cp">#define QUEUE_DEPTH 1
#define BLOCK_SZ    1024
</span>
<span class="k">struct</span> <span class="n">file_info</span> <span class="p">{</span>
    <span class="kt">off_t</span> <span class="n">file_sz</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovecs</span><span class="p">[];</span>      <span class="cm">/* Referred by readv/writev */</span>
<span class="p">};</span>

<span class="cm">/*
* è¿”å›ä¼ å…¥æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶çš„å¤§å°ã€‚ 
* æ­£ç¡®å¤„ç†å¸¸è§„æ–‡ä»¶å’Œå—è®¾å¤‡ã€‚
* */</span>

<span class="kt">off_t</span> <span class="nf">get_file_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
    <span class="c1">// åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"fstat"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">;</span>
        <span class="c1">// è·å–æ–‡ä»¶å­—èŠ‚å¤§å°64ä½</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BLKGETSIZE64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"ioctl"</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
 * è¾“å‡ºä¸€ä¸²é•¿åº¦ä¸ºlençš„å­—ç¬¦åˆ°stdoutã€‚
 * æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ç¼“å†²è¾“å‡ºæ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦é€å­—ç¬¦è¾“å‡ºã€‚
 * */</span>
<span class="kt">void</span> <span class="nf">output_to_console</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fputc</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*
 * ç­‰å¾…å®Œæˆå¯ç”¨ï¼Œä»readvæ“ä½œä¸­è·å–æ•°æ®å¹¶æ‰“å°åˆ°æ§åˆ¶å°ã€‚
 * */</span>

<span class="kt">int</span> <span class="nf">get_completion_and_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
    <span class="c1">// ç­‰å¾…å®Œæˆé˜Ÿåˆ—</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_wait_cqe</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"io_uring_wait_cqe"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// å¦‚æœå®Œæˆé˜Ÿåˆ—çš„äº‹ä»¶ä»£ç å°äº0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Async readv failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// è·å–å®Œæˆé˜Ÿåˆ—çš„æ•°æ®è¿”å›</span>
    <span class="k">struct</span> <span class="n">file_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">io_uring_cqe_get_data</span><span class="p">(</span><span class="n">cqe</span><span class="p">);</span>
    <span class="c1">// æ–‡ä»¶å­—èŠ‚å¤§å°åˆä¸€æ•°æ®å—å¤§å°ï¼ŒæŒ‰ç…§ 1024 å­—èŠ‚åˆ‡å‰²</span>
    <span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">file_sz</span> <span class="o">/</span> <span class="n">BLOCK_SZ</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">file_sz</span> <span class="o">%</span> <span class="n">BLOCK_SZ</span><span class="p">)</span> <span class="n">blocks</span><span class="o">++</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span>
        <span class="n">output_to_console</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

    <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
 * é€šè¿‡liburingæäº¤readvè¯·æ±‚
 * */</span>
<span class="kt">int</span> <span class="nf">submit_read_request</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file_path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_uring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// æ‰“å¼€æ–‡ä»¶</span>
    <span class="kt">int</span> <span class="n">file_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// è·å–æ–‡ä»¶å¤§å°</span>
    <span class="kt">off_t</span> <span class="n">file_sz</span> <span class="o">=</span> <span class="n">get_file_size</span><span class="p">(</span><span class="n">file_fd</span><span class="p">);</span>
    <span class="c1">// æ–‡ä»¶å‰©ä½™å­—èŠ‚æ•°</span>
    <span class="kt">off_t</span> <span class="n">bytes_remaining</span> <span class="o">=</span> <span class="n">file_sz</span><span class="p">;</span>
    <span class="c1">// åç§»å€¼</span>
    <span class="kt">off_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// å½“å‰å—å¤§å°</span>
    <span class="kt">int</span> <span class="n">current_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// è®¡ç®—æ–‡ä»¶å¯ä»¥åˆ‡å‰²å¤šå°‘å¿«</span>
    <span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">file_sz</span> <span class="o">/</span> <span class="n">BLOCK_SZ</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file_sz</span> <span class="o">%</span> <span class="n">BLOCK_SZ</span><span class="p">)</span> <span class="n">blocks</span><span class="o">++</span><span class="p">;</span>
    <span class="c1">// åˆ†é…æ–‡ä»¶å¤§å°ä¿¡æ¯</span>
    <span class="k">struct</span> <span class="n">file_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fi</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">)</span> <span class="o">*</span> <span class="n">blocks</span><span class="p">));</span>
    <span class="c1">// åˆ†é…ç©ºé—´</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">file_sz</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Unable to allocate memory.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*
     * å¯¹äºæˆ‘ä»¬éœ€è¦è¯»å–çš„æ–‡ä»¶çš„æ¯ä¸ªå—ï¼Œ
     * æˆ‘ä»¬åˆ†é…ä¸€ä¸ªiovecç»“æ„ï¼Œå®ƒè¢«ç´¢å¼•åˆ°iovecsæ•°ç»„ä¸­ã€‚ 
     * æ­¤æ•°ç»„ä½œä¸ºæäº¤çš„ä¸€éƒ¨åˆ†ä¼ å…¥ã€‚ å¦‚æœæ‚¨ä¸æ˜ç™½è¿™ä¸€ç‚¹ï¼Œ
     * é‚£ä¹ˆæ‚¨éœ€è¦æŸ¥æ‰¾readv()å’Œwritev()ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
     * */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">bytes_remaining</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">off_t</span> <span class="n">bytes_to_read</span> <span class="o">=</span> <span class="n">bytes_remaining</span><span class="p">;</span>
        <span class="c1">// æ¯æ¬¡æœ€å¤šè¯» 1024 å­—èŠ‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes_to_read</span> <span class="o">&gt;</span> <span class="n">BLOCK_SZ</span><span class="p">)</span>
            <span class="n">bytes_to_read</span> <span class="o">=</span> <span class="n">BLOCK_SZ</span><span class="p">;</span>
        <span class="c1">// åç§»å€¼</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">bytes_to_read</span><span class="p">;</span>

        <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">current_block</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">bytes_to_read</span><span class="p">;</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
        <span class="c1">// posix_memalign:https://blog.csdn.net/wallwind/article/details/7461701</span>
        <span class="c1">// åŠ¨æ€åˆ†é…å†…å­˜ï¼Œ1024 å­—èŠ‚å¯¹é½</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">posix_memalign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">BLOCK_SZ</span><span class="p">,</span> <span class="n">BLOCK_SZ</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"posix_memalign"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// æ•°æ®çš„åŸºåœ°åœ°å€</span>
        <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">[</span><span class="n">current_block</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
        <span class="c1">// å½“å‰å—å¤§å°åŠ ä¸€</span>
        <span class="n">current_block</span><span class="o">++</span><span class="p">;</span>
        <span class="c1">// å‰©ä½™å­—èŠ‚æ•°å‡ä¸€</span>
        <span class="n">bytes_remaining</span> <span class="o">-=</span> <span class="n">bytes_to_read</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fi</span><span class="o">-&gt;</span><span class="n">file_sz</span> <span class="o">=</span> <span class="n">file_sz</span><span class="p">;</span>

    <span class="cm">/* è·å–ä¸€ä¸ª SQE */</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
    <span class="cm">/* è®¾ç½®è¯»æ“ä½œn */</span>
    <span class="n">io_uring_prep_readv</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">file_fd</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="cm">/* è®¾ç½®ç”¨æˆ·æ•°æ® */</span>
    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">fi</span><span class="p">);</span>
    <span class="cm">/* æœ€åæäº¤è¯·æ±‚ */</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring</span> <span class="n">ring</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Usage: %s [file name] &lt;[file name] ...&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Initialize io_uring */</span>
    <span class="n">io_uring_queue_init</span><span class="p">(</span><span class="n">QUEUE_DEPTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">submit_read_request</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error reading file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">get_completion_and_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Call the clean-up function. */</span>
    <span class="n">io_uring_queue_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é‡å¤çš„ä»£ç è¢«æå–åã€‚è®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€ä¸‹ã€‚æˆ‘ä»¬åƒè¿™æ ·åˆå§‹åŒ– io_uring:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">io_uring_queue_init</span><span class="p">(</span><span class="n">QUEUE_DEPTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>
<p>åœ¨æ–¹æ³• submit_read_request()ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª SQEï¼Œå‡†å¤‡æ‰§è¡Œ readv æ“ä½œå¹¶æäº¤å®ƒã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* è·å–ä¸€ä¸ª SQE */</span>
<span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
<span class="cm">/* è®¾ç½®ä¸€ä¸ª readv æ“ä½œ */</span>
<span class="n">io_uring_prep_readv</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">file_fd</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">iovecs</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/* è®¾ç½® user_data */</span>
<span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">fi</span><span class="p">);</span>
<span class="cm">/* æœ€åæäº¤è¯·æ±‚ */</span>
<span class="n">io_uring_submit</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
</code></pre></div></div>

<p>æˆ‘ä»¬ç­‰å¾…ä¸€ä¸ªå®Œæˆäº‹ä»¶ï¼Œç„¶åå¾—åˆ°æˆ‘ä»¬åœ¨æäº¤ç«¯è®¾ç½®çš„ç”¨æˆ·æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_wait_cqe</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">file_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">io_uring_cqe_get_data</span><span class="p">(</span><span class="n">cqe</span><span class="p">);</span>
</code></pre></div></div>

<p>å½“ç„¶ï¼Œä¸ä½¿ç”¨åŸå§‹ç•Œé¢ç›¸æ¯”ï¼Œä½¿ç”¨è¿™ä¸ªç•Œé¢è¦ç®€å•å¾—å¤šã€‚</p>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ul>
  <li><a href="https://unixism.net/loti/ref-liburing/setup_teardown.html#c.io_uring_queue_init">io_uring_queue_init()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/submission.html#c.io_uring_get_sqe">io_uring_get_sqe()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/submission.html#c.io_uring_prep_readv">io_uring_prep_readv()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/submission.html#c.io_uring_sqe_set_data">io_uring_sqe_set_data()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/submission.html#c.io_uring_submit">io_uring_submit()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/completion.html#c.io_uring_wait_cqe">io_uring_wait_cqe()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/completion.html#c.io_uring_cqe_get_data">io_uring_cqe_get_data()</a></li>
  <li><a href="https://unixism.net/loti/ref-liburing/setup_teardown.html#c.io_uring_queue_exit">io_uring_queue_exit()</a></li>
</ul>
:ET