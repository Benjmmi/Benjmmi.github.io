I";<p>关于 <a href="http://man7.org/linux/man-pages/man2/eventfd.2.html">eventfd(2)</a> 系统调用的细节不在讨论范围内。你可能需要查看 <a href="http://man7.org/linux/man-pages/man2/eventfd.2.html">eventfd(2)</a> man 页面来了解该系统调用的描述。 <a href="http://man7.org/linux/man-pages/man2/eventfd.2.html">eventfd(2)</a> 是一个 Linux 特有的同步机制。</p>

<p><code class="language-plaintext highlighter-rouge">io_uring</code> 能够在事件完成时在eventfd实例上发布事件。该功能允许使用 <a href="http://man7.org/linux/man-pages/man2/poll.2.html">poll(2)</a> 或 <a href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll(7)</a> 复用I/O的进程将 <code class="language-plaintext highlighter-rouge">io_uring</code> 注册的eventfd实例文件描述符添加到兴趣列表中，以便 <a href="http://man7.org/linux/man-pages/man2/poll.2.html">poll(2)</a> 或 <a href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll(7)</a> 在完成时通过 <code class="language-plaintext highlighter-rouge">io_uring</code> 通知它们。这允许这样的程序忙于处理它们现有的事件循环，而不是在调用 <a href="http://man7.org/linux/man-pages/man7/epoll.7.html">io_uring_wait_cqe()</a> 时被阻塞。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/eventfd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;liburing.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span>
<span class="cp">#define BUFF_SZ   512
</span>
<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="n">BUFF_SZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">io_uring</span> <span class="n">ring</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">error_exit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">listener_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">efd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">eventfd_t</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s: Waiting for completion event...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">eventfd_read</span><span class="p">(</span><span class="n">efd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">error_exit</span><span class="p">(</span><span class="s">"eventfd_read"</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"%s: Got completion event.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_wait_cqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error waiting for completion: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* 现在我们有了CQE，让我们来处理它 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error in async operation: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Result of the operation: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
    <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Contents read from file:</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">setup_io_uring</span><span class="p">(</span><span class="kt">int</span> <span class="n">efd</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_queue_init</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Unable to setup io_uring: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">io_uring_register_eventfd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="n">efd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">read_file_with_io_uring</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span><span class="p">;</span>

    <span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sqe</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not get SQE.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/etc/passwd"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">io_uring_prep_read</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_t</span> <span class="n">t</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">efd</span><span class="p">;</span>

    <span class="cm">/* 创建一个eventfd实例 */</span>
    <span class="n">efd</span> <span class="o">=</span> <span class="n">eventfd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">efd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">error_exit</span><span class="p">(</span><span class="s">"eventfd"</span><span class="p">);</span>

    <span class="cm">/* 创建监听线程 */</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">listener_thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">efd</span><span class="p">);</span>

    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="cm">/* 设置 io_uring 实例和注册eventfd */</span>
    <span class="n">setup_io_uring</span><span class="p">(</span><span class="n">efd</span><span class="p">);</span>

    <span class="cm">/* 初始化读 io_uring */</span>
    <span class="n">read_file_with_io_uring</span><span class="p">();</span>

    <span class="cm">/* 等待监听线程完成 */</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="cm">/* 所有完成，清空和退出 */</span>
    <span class="n">io_uring_queue_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="它是如何工作的">它是如何工作的</h1>

<p>在主线程中，我们创建了一个<a href="http://man7.org/linux/man-pages/man2/eventfd.2.html">eventfd(2)</a>实例。然后创建一个线程，将 <code class="language-plaintext highlighter-rouge">eventfd</code> 文件描述符传递给它。在线程中，我们打印一条消息并立即从 <code class="language-plaintext highlighter-rouge">eventfd</code> 文件描述符中读取。这将导致线程阻塞，因为在 <code class="language-plaintext highlighter-rouge">eventfd</code> 实例上还没有发布任何事件。</p>

<p>当子线程在读取 <code class="language-plaintext highlighter-rouge">eventfd</code> 文件描述符时阻塞，我们在父线程中休眠2秒以清楚地感知这个序列。接下来，在 <code class="language-plaintext highlighter-rouge">setup_io_uring()</code> 中，我们创建一个 <code class="language-plaintext highlighter-rouge">io_uring</code> 实例，并向它注册 <code class="language-plaintext highlighter-rouge">eventfd</code> 文件描述符。这将导致 <code class="language-plaintext highlighter-rouge">io_uring</code> 在每一次完成事件时，都会在这个 <code class="language-plaintext highlighter-rouge">eventfd</code> 上 post 一个事件。</p>

<p>然后从main调用 <code class="language-plaintext highlighter-rouge">read_file_with_io_uring()</code> 。在这里，我们提交一个读取文件的请求。这将导致io_uring在注册的eventfd实例上发布一个事件。这现在应该会导致 <code class="language-plaintext highlighter-rouge">[read(2)](http://man7.org/linux/man-pages/man2/read.2.html)</code> 调用，在该调用中 <code class="language-plaintext highlighter-rouge">listener_thread()</code> 被阻塞，以解除阻塞并继续执行。在这个线程中，我们获取完成并打印出数据。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 注意
请注意，`eventfd_read()` 是glibc提供的一个库函数。它本质上是在eventfd上调用read。
</code></pre></div></div>

<h1 id="源代码">源代码</h1>

<p>这个和其他例子的源代码可以在 <a href="https://github.com/shuveb/loti-examples">Github</a> 上找到。</p>
:ET