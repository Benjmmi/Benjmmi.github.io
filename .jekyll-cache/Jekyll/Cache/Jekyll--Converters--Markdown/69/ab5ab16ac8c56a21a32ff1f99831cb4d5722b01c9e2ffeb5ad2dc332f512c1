I"ùU<h1 id="liburing-å®ç°-web-æœåŠ¡å™¨">liburing å®ç° web æœåŠ¡å™¨</h1>

<p>æˆ‘ä»¬åœ¨<a href="https://unixism.net/loti/async_intro.html#async-intro">ä»‹ç»</a>ä¸­è®¨è®ºè¿‡ï¼Œå› ä¸º <a href="http://man7.org/linux/man-pages/man2/select.2.html">select(2)</a>ã€ <a href="http://man7.org/linux/man-pages/man2/poll.2.html">poll(2)</a>å’Œ <a href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll(7)</a>æŠ¥å‘Šå¯¹æœ¬åœ°/å¸¸è§„æ–‡ä»¶çš„æ“ä½œå§‹ç»ˆå¤„äºå°±ç»ªçŠ¶æ€ï¼Œ
æ‰€ä»¥åƒ libuv (è¿™ä¸ª NodeJS åº•å±‚å®ç°)è¿™æ ·çš„åº“ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ± æ¥å¤„ç†æ–‡ä»¶ i/oã€‚
 <code class="language-plaintext highlighter-rouge">io_uring</code> çš„ä¸€ä¸ªå·¨å¤§ä¼˜åŠ¿æ˜¯ï¼Œå®ƒä¸ºå¤šç§ç±»å‹çš„I/Oæä¾›äº†ä¸€ä¸ªå•ä¸€çš„ã€å¹²å‡€çš„ç»Ÿä¸€çš„ã€æœ€é‡è¦çš„æ˜¯é«˜æ•ˆçš„æ¥å£ã€‚</p>

<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ä¸€ä¸ªé¢å¤–çš„æ“ä½œ accept()ä»¥åŠå¦‚ä½•ä½¿ç”¨ io_uring æ¥å®ç°å®ƒã€‚åŠ ä¸Š readv()å’Œ writev()çš„æ“ä½œï¼Œ
æ‚¨å°±æœ‰èƒ½åŠ›ç¼–å†™ä¸€ä¸ªç®€å•çš„ web æœåŠ¡å™¨äº†ï¼è¿™ä¸ªwebæœåŠ¡å™¨æ˜¯åŸºäºæˆ‘ä¸ºZeroHTTPdå†™çš„ä»£ç ï¼Œ
è¿™ä¸ªç¨‹åºçš„ç‰¹ç‚¹æ˜¯åœ¨æˆ‘å†™çš„ä¸€ç³»åˆ—æ–‡ç« ä¸­æ¢ç´¢å„ç§ Linux è¿›ç¨‹æ¨¡å‹ä»¥åŠå®ƒä»¬ç›¸äº’ä¹‹é—´çš„æ€§èƒ½æ¯”è¾ƒã€‚
å·²ç»é‡å†™äº† ZeroHTTPd æ¥ä¸“é—¨ä½¿ç”¨ io/uring æ¥å£ã€‚</p>

<p>ä¸‹é¢æ˜¯é€šè¿‡ ZeroHTTPd æä¾›çš„indexé¡µé¢:</p>

<p><img src="/jony.github.io/images/ZeroHTTPd_static.png" alt="indexé¡µé¢" title="index é¡µé¢" /></p>

<p>ç°åœ¨è®©æˆ‘ä»¬è¿›å…¥ä»£ç ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;liburing.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span>
<span class="cp">#define SERVER_STRING "Server: zerohttpd/0.1\r\n"
#define DEFAULT_SERVER_PORT 8000
#define QUEUE_DEPTH 256
#define READ_SZ 8192
</span>
<span class="cp">#define EVENT_TYPE_ACCEPT 0
#define EVENT_TYPE_READ 1
#define EVENT_TYPE_WRITE 2
</span>
<span class="k">struct</span> <span class="n">request</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">event_type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">iovec_count</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">client_socket</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">io_uring</span> <span class="n">ring</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unimplemented_content</span> <span class="o">=</span>
    <span class="s">"HTTP/1.0 400 Bad Request</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="s">"Content-type: text/html</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="s">"&lt;html&gt;"</span>
    <span class="s">"&lt;head&gt;"</span>
    <span class="s">"&lt;title&gt;ZeroHTTPd: Unimplemented&lt;/title&gt;"</span>
    <span class="s">"&lt;/head&gt;"</span>
    <span class="s">"&lt;body&gt;"</span>
    <span class="s">"&lt;h1&gt;Bad Request (Unimplemented)&lt;/h1&gt;"</span>
    <span class="s">"&lt;p&gt;Your client sent a request ZeroHTTPd did not understand and it is probably not your fault.&lt;/p&gt;"</span>
    <span class="s">"&lt;/body&gt;"</span>
    <span class="s">"&lt;/html&gt;"</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">http_404_content</span> <span class="o">=</span>
    <span class="s">"HTTP/1.0 404 Not Found</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="s">"Content-type: text/html</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="s">"&lt;html&gt;"</span>
    <span class="s">"&lt;head&gt;"</span>
    <span class="s">"&lt;title&gt;ZeroHTTPd: Not Found&lt;/title&gt;"</span>
    <span class="s">"&lt;/head&gt;"</span>
    <span class="s">"&lt;body&gt;"</span>
    <span class="s">"&lt;h1&gt;Not Found (404)&lt;/h1&gt;"</span>
    <span class="s">"&lt;p&gt;Your client is asking for an object that was not found on this server.&lt;/p&gt;"</span>
    <span class="s">"&lt;/body&gt;"</span>
    <span class="s">"&lt;/html&gt;"</span><span class="p">;</span>

<span class="cm">/*
 * ç”¨äºå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå°å†™çš„å®ç”¨å‡½æ•°ã€‚
 * */</span>

<span class="kt">void</span> <span class="nf">strtolower</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span> <span class="o">++</span><span class="n">str</span><span class="p">)</span>
        <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*
 ä¸€ä¸ªæ‰“å°ç³»ç»Ÿè°ƒç”¨å’Œé”™è¯¯è¯¦æƒ…çš„å‡½æ•°
 ç„¶åä»¥é”™è¯¯ä»£ç 1é€€å‡ºã€‚éé›¶çš„æ„æ€æ˜¯äº‹æƒ…ä¸é¡ºåˆ©ã€‚
 */</span>
<span class="kt">void</span> <span class="nf">fatal_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">syscall</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="n">syscall</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
 * ä¸ºä½¿ä»£ç çœ‹èµ·æ¥æ›´å¹²å‡€çš„è¾…åŠ©åŠŸèƒ½ã€‚
 * */</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">zh_malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Fatal error: unable to allocate memory.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
 * è¯¥å‡½æ•°è´Ÿè´£è®¾ç½®webæœåŠ¡å™¨ä½¿ç”¨çš„ä¸»ç›‘å¬å¥—æ¥å­—ã€‚
 * */</span>

<span class="kt">int</span> <span class="nf">setup_listening_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">sock</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">srv_addr</span><span class="p">;</span>

    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">"socket()"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
                   <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span>
                   <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">"setsockopt(SO_REUSEADDR)"</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srv_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">srv_addr</span><span class="p">));</span>
    <span class="n">srv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">srv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="n">srv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>

    <span class="cm">/* æˆ‘ä»¬ç»‘å®šåˆ°ä¸€ä¸ªç«¯å£ï¼Œå°†è¿™ä¸ªå¥—æ¥å­—å˜æˆä¸€ä¸ªç›‘å¬å¥—æ¥å­—ã€‚
                 * */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
             <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srv_addr</span><span class="p">,</span>
             <span class="k">sizeof</span><span class="p">(</span><span class="n">srv_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">"bind()"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">"listen()"</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">add_accept_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">server_socket</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">client_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">client_addr_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="n">io_uring_prep_accept</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">server_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">client_addr</span><span class="p">,</span> <span class="n">client_addr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EVENT_TYPE_ACCEPT</span><span class="p">;</span>
    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">add_read_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">));</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">READ_SZ</span><span class="p">);</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">READ_SZ</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EVENT_TYPE_READ</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">READ_SZ</span><span class="p">);</span>
    <span class="cm">/* Linuxå†…æ ¸5.5æ”¯æŒreadvï¼Œä½†ä¸æ”¯æŒrecv()æˆ–read() */</span>
    <span class="n">io_uring_prep_readv</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">add_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EVENT_TYPE_WRITE</span><span class="p">;</span>
    <span class="n">io_uring_prep_writev</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_send_static_string_content</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">));</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">slen</span><span class="p">);</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>
    <span class="n">add_write_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
 * å½“ZeroHTTPdé‡åˆ°é™¤GETæˆ–POSTä»¥å¤–çš„å…¶ä»–HTTPæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥é€šçŸ¥å®¢æˆ·ç«¯ã€‚
 * */</span>

<span class="kt">void</span> <span class="nf">handle_unimplemented_method</span><span class="p">(</span><span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_send_static_string_content</span><span class="p">(</span><span class="n">unimplemented_content</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
 * è¯¥å‡½æ•°ç”¨äºåœ¨è¯·æ±‚çš„æ–‡ä»¶æœªæ‰¾åˆ°æ—¶ï¼Œå‘å®¢æˆ·ç«¯å‘é€ "HTTP Not Found "ä»£ç å’Œæ¶ˆæ¯ã€‚
 * */</span>

<span class="kt">void</span> <span class="nf">handle_http_404</span><span class="p">(</span><span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_send_static_string_content</span><span class="p">(</span><span class="n">http_404_content</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
 * ä¸€æ—¦ç¡®å®šäº†è¦æœåŠ¡çš„é™æ€æ–‡ä»¶ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«ç”¨æ¥è¯»å–æ–‡ä»¶ï¼Œ
 * å¹¶ä½¿ç”¨Linuxçš„sendfile()ç³»ç»Ÿè°ƒç”¨åœ¨å®¢æˆ·ç«¯å¥—æ¥å­—ä¸Šå†™å…¥ã€‚
 * è¿™æ ·æˆ‘ä»¬å°±çœå»äº†å°†æ–‡ä»¶ç¼“å†²åŒºä»å†…æ ¸ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´å†ä¼ é€å›æ¥çš„éº»çƒ¦ã€‚
 * */</span>

<span class="kt">void</span> <span class="nf">copy_file_contents</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file_path</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">file_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">file_size</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>

    <span class="cm">/* We should really check for short reads here */</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">file_size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">file_size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Encountered a short read.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">file_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
 * ç®€å•çš„å‡½æ•°ï¼Œè·å–æˆ‘ä»¬è¦æœåŠ¡çš„æ–‡ä»¶çš„æ–‡ä»¶æ‰©å±•åã€‚
 * */</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_filename_ext</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dot</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dot</span> <span class="o">||</span> <span class="n">dot</span> <span class="o">==</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">dot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
 * å‘é€HTTP 200 OKå¤´ï¼Œå³æœåŠ¡å™¨å­—ç¬¦ä¸²ï¼Œå¯¹äºä¸€äº›ç±»å‹çš„æ–‡ä»¶ï¼Œ
 * å®ƒè¿˜å¯ä»¥æ ¹æ®æ–‡ä»¶æ‰©å±•åå‘é€å†…å®¹ç±»å‹ã€‚å®ƒè¿˜ä¼šå‘é€å†…å®¹é•¿åº¦å¤´ã€‚
 * æœ€åï¼Œå®ƒåœ¨ä¸€è¡Œä¸­å‘é€ä¸€ä¸ª'\r\n'ï¼Œè¡¨ç¤ºå¤´çš„ç»“æŸå’Œä»»ä½•å†…å®¹çš„å¼€å§‹ã€‚
 * */</span>

<span class="kt">void</span> <span class="nf">send_headers</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">small_case_path</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">send_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">small_case_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="n">strtolower</span><span class="p">(</span><span class="n">small_case_path</span><span class="p">);</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="s">"HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">slen</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>

    <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">SERVER_STRING</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">slen</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">SERVER_STRING</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>

    <span class="cm">/*
                 * æ£€æŸ¥ç½‘é¡µä¸ŠæŸäº›å¸¸è§ç±»å‹æ–‡ä»¶çš„æ–‡ä»¶æ‰©å±•åï¼Œå¹¶å‘é€é€‚å½“çš„å†…å®¹ç±»å‹å¤´ã€‚
                 * ç”±äºæ‰©å±•åå¯ä»¥æ··åˆå¤§å°å†™ï¼Œå¦‚JPGã€jpgæˆ–Jpgï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ£€æŸ¥å‰å°†æ‰©å±•åå˜æˆå°å†™ã€‚
                 * */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file_ext</span> <span class="o">=</span> <span class="n">get_filename_ext</span><span class="p">(</span><span class="n">small_case_path</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"jpg"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: image/jpeg</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"jpeg"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: image/jpeg</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"png"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: image/png</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"gif"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: image/gif</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"htm"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: text/html</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"html"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: text/html</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"js"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: application/javascript</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"css"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: text/css</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"txt"</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"Content-Type: text/plain</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">slen</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">send_buffer</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>

    <span class="cm">/* å‘é€å†…å®¹é•¿åº¦å¤´ï¼Œä¹Ÿå°±æ˜¯æœ¬ä¾‹ä¸­çš„æ–‡ä»¶å¤§å°ã€‚ */</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"content-length: %ld</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">slen</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">send_buffer</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>

    <span class="cm">/*
                 * å½“æµè§ˆå™¨çœ‹åˆ°ä¸€è¡Œä¸­çš„'\r\n'åºåˆ—æ—¶ï¼Œå®ƒå°±ä¼šæ˜ç™½æ²¡æœ‰æ›´å¤šçš„æ ‡é¢˜äº†ã€‚å†…å®¹å¯èƒ½éšä¹‹è€Œæ¥ã€‚
                 * */</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">slen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">send_buffer</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="n">slen</span><span class="p">);</span>
    <span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">send_buffer</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">handle_get_method</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">final_path</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

    <span class="cm">/*
                 å¦‚æœä¸€ä¸ªè·¯å¾„ä»¥å°¾éƒ¨çš„æ–œæ ç»“æŸï¼Œå®¢æˆ·ç«¯å¯èƒ½å¸Œæœ›ç´¢å¼•æ–‡ä»¶åœ¨è¯¥ç›®å½•å†…ã€‚
                 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="s">"public"</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="s">"index.html"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="s">"public"</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* stat()ç³»ç»Ÿè°ƒç”¨ä¼šç»™å‡ºæ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¦‚ç±»å‹ï¼ˆæ™®é€šæ–‡ä»¶ã€ç›®å½•ç­‰ï¼‰ã€å¤§å°ç­‰ã€‚ */</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">path_stat</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path_stat</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"404 Not Found: %s (%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">final_path</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
        <span class="n">handle_http_404</span><span class="p">(</span><span class="n">client_socket</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/*æ£€æŸ¥è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªæ­£å¸¸çš„/å¸¸è§„çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç›®å½•æˆ–å…¶ä»–ä¸œè¥¿ã€‚*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">path_stat</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">));</span>
            <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
            <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">;</span>
            <span class="n">send_headers</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">);</span>
            <span class="n">copy_file_contents</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"200 %s %ld bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">final_path</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
            <span class="n">add_write_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">handle_http_404</span><span class="p">(</span><span class="n">client_socket</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"404 Not Found: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">final_path</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*
 * è¿™ä¸ªå‡½æ•°æŸ¥çœ‹æ‰€ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚å› ä¸ºæˆ‘ä»¬åªå®ç°äº†GETå’ŒPOSTæ–¹æ³•ï¼Œ
 * æ‰€ä»¥å®ƒè°ƒç”¨handle_unimplemented_method()ï¼Œä»¥é˜²è¿™ä¸¤ä¸ªæ–¹æ³•ä¸åŒ¹é…ã€‚è¿™å°†å‘å®¢æˆ·å‘é€ä¸€ä¸ªé”™è¯¯ã€‚
 * */</span>

<span class="kt">void</span> <span class="nf">handle_http_method</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">method_buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">saveptr</span><span class="p">;</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">strtok_r</span><span class="p">(</span><span class="n">method_buffer</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saveptr</span><span class="p">);</span>
    <span class="n">strtolower</span><span class="p">(</span><span class="n">method</span><span class="p">);</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">strtok_r</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saveptr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">"get"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">handle_get_method</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">handle_unimplemented_method</span><span class="p">(</span><span class="n">client_socket</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest_sz</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dest_sz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">&amp;&amp;</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">handle_client_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">http_request</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="cm">/* è·å–ç¬¬ä¸€è¡Œï¼Œè¿™å°†æ˜¯è¯·æ±‚çš„å†…å®¹ */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">get_line</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">http_request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">http_request</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Malformed request</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">handle_http_method</span><span class="p">(</span><span class="n">http_request</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">server_loop</span><span class="p">(</span><span class="kt">int</span> <span class="n">server_socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">client_addr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>

    <span class="n">add_accept_request</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr_len</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_wait_cqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="p">)</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fatal_error</span><span class="p">(</span><span class="s">"io_uring_wait_cqe"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Async request failed: %s for event: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                    <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="n">EVENT_TYPE_ACCEPT</span><span class="p">:</span>
            <span class="n">add_accept_request</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr_len</span><span class="p">);</span>
            <span class="n">add_read_request</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EVENT_TYPE_READ</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Empty request!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">handle_client_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EVENT_TYPE_WRITE</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">close</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* å°†æ­¤è¯·æ±‚æ ‡è®°ä¸ºå·²å¤„ç† */</span>
        <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sigint_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"^C pressed. Shutting down.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">io_uring_queue_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">server_socket</span> <span class="o">=</span> <span class="n">setup_listening_socket</span><span class="p">(</span><span class="n">DEFAULT_SERVER_PORT</span><span class="p">);</span>

    <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint_handler</span><span class="p">);</span>
    <span class="n">io_uring_queue_init</span><span class="p">(</span><span class="n">QUEUE_DEPTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">server_loop</span><span class="p">(</span><span class="n">server_socket</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h1 id="è¿è¡Œè¿™ä¸ªç¨‹åº">è¿è¡Œè¿™ä¸ªç¨‹åº</h1>

<p>è¿™ä¸ªç¨‹åºè¦æ±‚æ‚¨ä»åŒ…å«â€œ publicâ€æ–‡ä»¶å¤¹çš„ç›®å½•ä¸­è¿è¡Œå®ƒï¼Œè¯¥æ–‡ä»¶å¤¹ä¸­æœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">index.html</code> æ–‡ä»¶å’Œä¸€ä¸ªå›¾åƒã€‚
å¦‚æœæ‚¨æŒ‰ç…§<a href="https://github.com/shuveb/loti-examples">æ„å»ºæŒ‡ä»¤</a>åˆ°ç¤ºä¾‹ç¨‹åºï¼Œé‚£ä¹ˆæ‚¨æ–°æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶åº”è¯¥ä½äº <code class="language-plaintext highlighter-rouge">build</code> ç›®å½•ä¸­ã€‚
ä½ éœ€è¦æ¢åˆ°git repoçš„æ ¹ç›®å½•ä¸‹ï¼Œâ€public â€œæ–‡ä»¶å¤¹å°±åœ¨é‚£é‡Œï¼Œç„¶åè¿è¡Œå®ƒã€‚
æ„å»ºæ‰€æœ‰ç¤ºä¾‹å¹¶è¿è¡Œè¿™ä¸ª webserver ç¤ºä¾‹çš„ç¤ºä¾‹ä¼šè¯å¦‚ä¸‹æ‰€ç¤º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir build
$ cd build
$ cmake ..
$ cmake --build .
$ cd ..
$ build/webserver_liburing
Minimum kernel version required is: 5.5
Your kernel version is: 5.6
ZeroHTTPd listening on port: 8000
</code></pre></div></div>

<h2 id="ç¨‹åºç»“æ„">ç¨‹åºç»“æ„</h2>

<p>é¦–å…ˆï¼Œmain()å‡½æ•°è°ƒç”¨ <strong>setup_listening_socket()</strong> åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šç›‘å¬ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸è°ƒç”¨accept()æ¥å®é™…æ¥å—è¿æ¥ã€‚
æˆ‘ä»¬é€šè¿‡io_uringè¯·æ±‚æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œåé¢ä¼šè§£é‡Šã€‚</p>

<p>ç¨‹åºçš„æ ¸å¿ƒæ˜¯<strong>server_loop()</strong>å‡½æ•°ï¼Œå®ƒå‘io_uringå‘é€æäº¤(è‡ªå·±å’Œé€šè¿‡å…¶ä»–å‡½æ•°)ï¼Œ
ç­‰å¾…å®Œæˆé˜Ÿåˆ—æ¡ç›®å¹¶å¤„ç†å®ƒä»¬ã€‚è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">server_loop</span><span class="p">(</span><span class="kt">int</span> <span class="n">server_socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">io_uring_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
        <span class="n">socklen_t</span> <span class="n">client_addr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
        <span class="n">add_accept_request</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr_len</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">io_uring_wait_cqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cqe</span><span class="p">);</span>
                <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="p">)</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">fatal_error</span><span class="p">(</span><span class="s">"io_uring_wait_cqe"</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Async request failed: %s for event: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                                        <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">);</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="n">EVENT_TYPE_ACCEPT</span><span class="p">:</span>
                                <span class="n">add_accept_request</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr_len</span><span class="p">);</span>
                                <span class="n">add_read_request</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
                                <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="n">EVENT_TYPE_READ</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Empty request!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                                        <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">handle_client_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
                                <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
                                <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="n">EVENT_TYPE_WRITE</span><span class="p">:</span>
                                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="n">close</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span><span class="p">);</span>
                                <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="cm">/* å°†æ­¤è¯·æ±‚æ ‡è®°ä¸ºå·²å¤„ç† */</span>
                <span class="n">io_uring_cqe_seen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨è¿›å…¥whileå¾ªç¯ä¹‹å‰ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">add_accept_request()</code> æ¥æäº¤ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">accept()</code> çš„è¯·æ±‚ã€‚è¿™æ ·å°±å¯ä»¥æ¥å—ä»»ä½•å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„è¿æ¥ã€‚è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">add_accept_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">server_socket</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">client_addr</span><span class="p">,</span>
                                        <span class="n">socklen_t</span> <span class="o">*</span><span class="n">client_addr_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
        <span class="n">io_uring_prep_accept</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">server_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">client_addr</span><span class="p">,</span>
                                                <span class="n">client_addr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EVENT_TYPE_ACCEPT</span><span class="p">;</span>
        <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
        <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª SQEï¼Œå¹¶å‡†å¤‡ä¸€ä¸ª accept ()æ“ä½œï¼Œç”¨liburingçš„io_uring_prep_accept()æäº¤ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªrequestç»“æ„ä½“æ¥è·Ÿè¸ªæˆ‘ä»¬çš„æ¯ä¸ªæäº¤ã€‚è¿™äº›å®ä¾‹å…·æœ‰æ¯ä¸ªè¯·æ±‚ä»ä¸€ä¸ªçŠ¶æ€åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€çš„ä¸Šä¸‹æ–‡ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ request ç»“æ„ä½“:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">request</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">event_type</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">iovec_count</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">client_socket</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[];</span>
<span class="p">};</span>
</code></pre></div></div>

<p>å®¢æˆ·æœºè¯·æ±‚è¦ç»è¿‡3ä¸ªçŠ¶æ€ï¼Œä¸Šé¢çš„ç»“æ„ä½“å¯ä»¥å®¹çº³è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œèƒ½å¤Ÿå¤„ç†è¿™äº›çŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚å®¢æˆ·ç«¯è¯·æ±‚çš„ä¸‰ç§çŠ¶æ€æ˜¯:</p>

<p>Accepted -&gt; Request read -&gt; Response written</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹åœ¨å®Œæˆä¾§å¤§çš„ switch/case ä»£ç å—ï¼Œä¸€æ—¦ <code class="language-plaintext highlighter-rouge">accept ()</code> æ“ä½œå®Œæˆåä¼šå‘ç”Ÿä»€ä¹ˆ:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">EVENT_TYPE_ACCEPT</span><span class="p">:</span>
     <span class="n">add_accept_request</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr_len</span><span class="p">);</span>
     <span class="n">add_read_request</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
     <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
     <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>æ—¢ç„¶å·²ç»å¤„ç†äº†å‰ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å°±åœ¨æäº¤é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„<code class="language-plaintext highlighter-rouge">accept()</code>è¯·æ±‚ã€‚å¦åˆ™æˆ‘ä»¬çš„ç¨‹åºå°†ä¸ä¼šæ¥å—ä»»ä½•æ¥è‡ªå®¢æˆ·ç«¯çš„æ–°è¿æ¥ã€‚
ç„¶åæˆ‘ä»¬è°ƒç”¨<code class="language-plaintext highlighter-rouge">add_read_request()</code>å‡½æ•°ï¼Œå®ƒä¸ºreadv()æ·»åŠ ä¸€ä¸ªæäº¤è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä»å®¢æˆ·ç«¯è¯»å–HTTPè¯·æ±‚ã€‚
è¿™é‡Œæœ‰å‡ ä»¶äº‹:</p>
<ol>
  <li>æˆ‘ä»¬æœ¬æ¥å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">read()</code>ï¼Œä½†æ˜¯<code class="language-plaintext highlighter-rouge">io_uring</code>ä¸­ç›´åˆ°å†…æ ¸ç‰ˆæœ¬5.6æ‰æ”¯æŒè¯¥æ“ä½œï¼Œè€Œåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œ
å†…æ ¸ç‰ˆæœ¬5.6æ˜¯ä¸€ä¸ªéå¸¸ç¨³å®šçš„ç‰ˆæœ¬ï¼Œè‡³å°‘å‡ ä¸ªæœˆåæ‰ä¼šåœ¨è®¸å¤šå‘è¡Œç‰ˆä¸­å‡ºç°ã€‚</li>
  <li>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">readv()</code>å’Œ<code class="language-plaintext highlighter-rouge">writev()</code>å…è®¸æˆ‘ä»¬å†…ç½®è®¸å¤šé€šç”¨é€»è¾‘ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬ç¨åä¼šçœ‹åˆ°çš„ç¼“å†²åŒºç®¡ç†ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹<code class="language-plaintext highlighter-rouge">add_read_request()</code>:</li>
</ol>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">add_read_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">client_socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">));</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">READ_SZ</span><span class="p">);</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">READ_SZ</span><span class="p">;</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EVENT_TYPE_READ</span><span class="p">;</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">READ_SZ</span><span class="p">);</span>
        <span class="cm">/* Linux kernel 5.5 has support for readv, but not for recv() or read() */</span>
        <span class="n">io_uring_prep_readv</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
        <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œè¿™æ˜¯ç›¸å½“ç›´æ¥çš„ã€‚æˆ‘ä»¬åˆ†é…ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç¼“å†²åŒºæ¥å®¹çº³å®¢æˆ·æœºè¯·æ±‚ï¼Œ
å¹¶åœ¨æäº¤è¯·æ±‚ä¹‹å‰è°ƒç”¨ <code class="language-plaintext highlighter-rouge">io_uring_prep_readv ()</code>,è¯¥è°ƒç”¨å¤„äºliburingçŠ¶æ€ã€‚å®Œæˆç«¯ç›¸åº”çš„å¤„ç†æ˜¯ç”±switch/caseå—ä¸­çš„æ¡ä»¶æ¥å®Œæˆçš„:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">EVENT_TYPE_READ</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Empty request!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">handle_client_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>è¿™é‡Œï¼Œæˆ‘ä»¬å®é™…ä¸Šè°ƒç”¨äº† <code class="language-plaintext highlighter-rouge">handle_client_request()</code> å‡½æ•°å¤„ç† HTTP è¯·æ±‚ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå®¢æˆ·ç«¯è¦æ±‚çš„æ˜¯ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ®µä»£ç è¿è¡Œå¦‚ä¸‹:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">zh_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">));</span>
<span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">;</span>
<span class="n">set_headers</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">);</span>
<span class="n">copy_file_contents</span><span class="p">(</span><span class="n">final_path</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"200 %s %ld bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">final_path</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
<span class="n">add_write_request</span><span class="p">(</span> <span class="n">req</span><span class="p">);</span>
</code></pre></div></div>
<p>å‡½æ•° set_headers() è®¾ç½®äº†æ€»å…±5ä¸ªå°ç¼“å†²åŒºï¼Œç”±5ä¸ªä¸åŒçš„ ivec ç»“æ„ä½“è¡¨ç¤ºã€‚
æœ€ç»ˆçš„ iovec å®ä¾‹åŒ…å«æ­£åœ¨è¯»å–çš„æ–‡ä»¶çš„å†…å®¹ã€‚æœ€åï¼Œè°ƒç”¨ add_write_request ()æ¥æ·»åŠ ä¸€ä¸ªæäº¤é˜Ÿåˆ—æ¡ç›®:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">add_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_uring_sqe</span> <span class="o">*</span><span class="n">sqe</span> <span class="o">=</span> <span class="n">io_uring_get_sqe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">EVENT_TYPE_WRITE</span><span class="p">;</span>
    <span class="n">io_uring_prep_writev</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">io_uring_sqe_set_data</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
    <span class="n">io_uring_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ­¤æäº¤å¯¼è‡´å†…æ ¸åœ¨å®¢æˆ·ç«¯å¥—æ¥å­—ä¸Šå†™å‡ºå“åº”å¤´å’Œæ–‡ä»¶å†…å®¹ï¼Œä»è€Œå®Œæˆè¯·æ±‚/å“åº”å¾ªç¯ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬åœ¨å®Œæˆæ–¹é¢æ‰€åšçš„:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">EVENT_TYPE_WRITE</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">client_socket</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>æˆ‘ä»¬é‡Šæ”¾æˆ‘ä»¬æ›¾ç»åˆ›å»ºçš„å¤šä¸ªæŒ‡å‘ç¼“å†²åŒºçš„iovecï¼Œé‡Šæ”¾äº†è¯·æ±‚ç»“æ„ä½“å®ä¾‹ï¼Œè¿˜å…³é—­äº†å®¢æˆ·ç«¯å¥—æ¥å­—ï¼Œä»è€Œå®Œæˆäº† HTTP è¯·æ±‚çš„æœåŠ¡ã€‚</p>

<h1 id="æºä»£ç ">æºä»£ç </h1>

<p>è¿™ä¸ªå’Œå…¶ä»–ä¾‹å­çš„æºä»£ç å¯ä»¥åœ¨ <a href="https://github.com/shuveb/loti-examples">Github</a> ä¸Šæ‰¾åˆ°ã€‚</p>

:ET